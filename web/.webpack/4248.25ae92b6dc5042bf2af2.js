"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[4248],{14571:($s,Je,b)=>{b.d(Je,{o:()=>Ee});var v=b(52322),S=b(2784);class Ee extends S.Component{state={hadError:!1};componentDidCatch(Se){this.setState({hadError:!0}),this.props.onError(Se)}render(){return this.state.hadError?(0,v.jsx)(v.Fragment,{}):this.props.children}}},89820:($s,Je,b)=>{b.d(Je,{CW:()=>H,KV:()=>ae,ZP:()=>je});var v=b(52322),S=b(2043),Ee=b(7808),st=b(12540),Se=b(32199),xe=b(72283),it=b(87037),Pe=b(96437),wt=b(41574),It=b(72970),_e=b(93812),Qe=b(2784);const re=240,Ce=(0,It.ZL)()(O=>({root:{pointerEvents:"auto",backgroundColor:O.palette.background.default,width:280},content:{position:"relative"},iconButton:{fontSize:"1rem !important",[`& svg:not(.${Ee.Z.root})`]:{fontSize:"1rem !important"}},tabs:{minHeight:"auto",[`.${st.Z.indicator}`]:{transform:"scaleX(0.75)",height:2},[`.${Se.Z.root}`]:{minHeight:"auto",minWidth:"auto",padding:O.spacing(1,1.5,1.125),color:O.palette.text.secondary,"&.Mui-selected":{color:O.palette.text.primary}}}}));function ae({children:O}){return O}function H({children:O}){return(0,v.jsx)(_e.Z,{padding:1,overflowX:"hidden",overflowY:"auto",style:{maxHeight:re},children:O})}function je({children:O,checked:Y,icon:M,onSelectTab:me,selectedTab:c,tooltip:z,dataTest:k}){const{classes:Q}=Ce();if(!(c!=null)){let ge=c;return Qe.Children.forEach(O,nt=>{ge==null&&(ge=nt.props.name)}),(0,v.jsx)(xe.Z,{square:!1,elevation:4,style:{pointerEvents:"auto"},children:(0,v.jsx)(it.Z,{className:Q.iconButton,color:Y===!0?"info":"default",title:z,"data-testid":`ExpandingToolbar-${z}`,onClick:()=>{me(ge)},children:M})})}let qe;Qe.Children.forEach(O,ge=>{(!qe||ge.props.name===c)&&(qe=ge)});const Ot=(ge,nt)=>{nt!=null&&me(nt)};return(0,v.jsxs)(xe.Z,{className:Q.root,"data-testid":k,square:!1,elevation:4,children:[(0,v.jsx)(xe.Z,{children:(0,v.jsxs)(_e.Z,{direction:"row",justifyContent:"space-between",alignItems:"center",children:[(0,v.jsx)(Pe.Z,{className:Q.tabs,textColor:"inherit",value:c,onChange:Ot,children:Qe.Children.map(O,ge=>(0,v.jsx)(wt.Z,{label:ge.props.name,value:ge.props.name}))}),(0,v.jsx)(it.Z,{className:Q.iconButton,onClick:()=>{me(void 0)},children:(0,v.jsx)(S.iRs,{})})]})}),(0,v.jsx)("div",{className:Q.content,children:qe})]})}},78324:($s,Je,b)=>{b.d(Je,{i:()=>wt});var v=b(52322),S=b(3925),Ee=b(56961),st=b(80078),Se=b(2784),xe=b(84877),it=b(2784);function Pe(It){const{getItems:_e}=It,Qe=(0,Se.useRef)(null),[re,Ce]=(0,Se.useState)(),ae=(0,Se.useCallback)(()=>{Ce(void 0)},[]),[H,je]=(0,Se.useState)([]);return(0,Se.useEffect)(()=>{const O=Qe.current?.closest(`.${xe.D}`);if(!O)return;let Y="none";const M=k=>{k.button===2&&Y==="down"&&(Ce({x:k.clientX,y:k.clientY}),je(_e()),Y="none")},me=k=>{Y="canceled"},c=k=>{k.button===2&&(Y="down")},z=k=>{k.preventDefault()};return O.addEventListener("mousedown",c),O.addEventListener("mousemove",me),O.addEventListener("mouseup",M),O.addEventListener("contextmenu",z),()=>{O.removeEventListener("mousedown",c),O.removeEventListener("mousemove",me),O.removeEventListener("mouseup",M),O.removeEventListener("contextmenu",z)}},[_e]),(0,v.jsx)("div",{ref:Qe,onContextMenu:O=>{O.preventDefault()},children:(0,v.jsx)(S.Z,{open:re!=null,onClose:ae,anchorReference:"anchorPosition",anchorPosition:re?{top:re.y,left:re.x}:void 0,MenuListProps:{dense:!0},children:H.map((O,Y)=>O.type==="divider"?(0,v.jsx)(Ee.Z,{variant:"middle"},`divider_${Y}`):(0,v.jsx)(st.Z,{onClick:()=>{ae(),O.onclick()},disabled:O.disabled,children:O.label},`item_${Y}_${O.label}`))})})}const wt=it.memo(Pe)},74248:($s,Je,b)=>{b.r(Je),b.d(Je,{ImagePanel:()=>B0,default:()=>j0});var v=b(52322),S=b(2784),Ee=b(28316),st=b(75845),Se=b(14571),xe=b(42893),it=b(12294),Pe=b(80204);function wt(){const i=(0,S.useContext)(Pe.Z),[e]=(0,S.useState)(()=>(0,xe.M)(()=>({value:i})));return(0,S.useLayoutEffect)(()=>{e.setState({value:i})},[e,i]),e}function It({forwardedAnalytics:i,children:e}){(0,st.Iq)(i);const[t]=(0,S.useState)(()=>(0,xe.M)(()=>({value:i.getState().value})));(0,S.useEffect)(()=>i.subscribe(()=>{t.setState({value:i.getState().value})}),[i,t]);const{value:s}=(0,it.oR)(t);return(0,v.jsx)(Pe.Z.Provider,{value:s,children:e})}var _e=b(75017),Qe=b(14123),re=b(67067),Ce=b(67105),ae=b(7921),H=b(65741),je=b(16003),O=b(94225),Y=b(23503),M=b(44668),me=b(93455),c=b(96995),z=b(8220);function k(i,e,t,s,n,r){r[n]=i+Math.trunc(1403*s/1e3),r[n+1]=i-Math.trunc(344*e/1e3)-Math.trunc(714*s/1e3),r[n+2]=i+Math.trunc(1770*e/1e3),r[n+3]=255,r[n+4]=t+Math.trunc(1403*s/1e3),r[n+5]=t-Math.trunc(344*e/1e3)-Math.trunc(714*s/1e3),r[n+6]=t+Math.trunc(1770*e/1e3),r[n+7]=255}function Q(i,e,t,s,n){if(s<e*2)throw new Error(`UYVY image row step (${s}) must be at least 2*width (${e*2})`);let r=0;for(let a=0;a<t;a++){const o=a*s;for(let l=0;l<e;l+=2){const d=o+l*2,h=i[d]-128,f=i[d+1],m=i[d+2]-128,p=i[d+3];k(f,h,p,m,r,n),r+=8}}}function $e(i,e,t,s,n){if(s<e*2)throw new Error(`YUYV image row step (${s}) must be at least 2*width (${e*2})`);let r=0;for(let a=0;a<t;a++){const o=a*s;for(let l=0;l<e;l+=2){const d=o+l*2,h=i[d],f=i[d+1]-128,m=i[d+2],p=i[d+3]-128;k(h,f,m,p,r,n),r+=8}}}function qe(i,e,t,s,n){if(s<e*3)throw new Error(`RGB8 image row step (${s}) must be at least 3*width (${e*3})`);let r=0;for(let a=0;a<t;a++){const o=a*s;for(let l=0;l<e;l++){const d=o+l*3,h=i[d],f=i[d+1],m=i[d+2];n[r++]=h,n[r++]=f,n[r++]=m,n[r++]=255}}}function Ot(i,e,t,s,n){if(s<e*4)throw new Error(`RGBA8 image row step (${s}) must be at least 4*width (${e*4})`);let r=0;for(let a=0;a<t;a++){const o=a*s;for(let l=0;l<e;l++){const d=o+l*4,h=i[d],f=i[d+1],m=i[d+2],p=i[d+3];n[r++]=h,n[r++]=f,n[r++]=m,n[r++]=p}}}function ge(i,e,t,s,n){if(s<e*4)throw new Error(`BGRA8 image row step (${s}) must be at least 4*width (${e*4})`);let r=0;for(let a=0;a<t;a++){const o=a*s;for(let l=0;l<e;l++){const d=o+l*4,h=i[d],f=i[d+1],m=i[d+2],p=i[d+3];n[r++]=m,n[r++]=f,n[r++]=h,n[r++]=p}}}function nt(i,e,t,s,n){if(s<e*3)throw new Error(`BGR8 image row step (${s}) must be at least 3*width (${e*3})`);let r=0;for(let a=0;a<t;a++){const o=a*s;for(let l=0;l<e;l++){const d=o+l*3,h=i[d],f=i[d+1],m=i[d+2];n[r++]=m,n[r++]=f,n[r++]=h,n[r++]=255}}}function Bi(i,e,t,s,n,r){if(s<e*4)throw new Error(`Float image row step (${s}) must be at least 4*width (${e*4})`);const a=new DataView(i.buffer,i.byteOffset);let o=0;for(let l=0;l<t;l++){const d=l*s;for(let h=0;h<e;h++){const f=a.getFloat32(d+h*4,!n)*255;r[o++]=f,r[o++]=f,r[o++]=f,r[o++]=255}}}function ji(i,e,t,s,n){if(s<e)throw new Error(`Uint8 image row step (${s}) must be at least width (${e})`);let r=0;for(let a=0;a<t;a++){const o=a*s;for(let l=0;l<e;l++){const d=i[o+l];n[r++]=d,n[r++]=d,n[r++]=d,n[r++]=255}}}function $i(i,e,t,s,n,r,a){if(s<e*2)throw new Error(`Uint16 image row step (${s}) must be at least 2*width (${e*2})`);const o=new DataView(i.buffer,i.byteOffset),l=a?.minValue??0;let d=a?.maxValue??1e4;d===l&&(d=l+1);const h=a?.colorConverter;let f=0;for(let m=0;m<t;m++){const p=m*s;for(let g=0;g<e;g++){let u=o.getUint16(p+g*2,!n);if(h){const{r:x,g:y,b:C}=h(u);r[f++]=x*255,r[f++]=y*255,r[f++]=C*255}else u=(u-l)/(d-l),u*=255,r[f++]=u,r[f++]=u,r[f++]=u;r[f++]=255}}}function Vs(i,e,t,s){return new Function("data","width","height","step","output",`
  if (step < width) {
    throw new Error(\`Bayer image row step (\${step}) must be at least width (\${width})\`);
  }
  for (let i = 0; i < height / 2; i++) {
    let inIdx = i * 2 * step;
    let outTopIdx = i * 2 * width * 4; // Addresses top row
    let outBottomIdx = (i * 2 + 1) * width * 4; // Addresses bottom row
    for (let j = 0; j < width / 2; j++) {
      const tl = data[inIdx++];
      const tr = data[inIdx++];
      const bl = data[inIdx + step - 2];
      const br = data[inIdx + step - 1];

      const ${i} = tl;
      const ${e} = tr;
      const ${t} = bl;
      const ${s} = br;

      // Top row
      output[outTopIdx++] = r;
      output[outTopIdx++] = g0;
      output[outTopIdx++] = b;
      output[outTopIdx++] = 255;

      output[outTopIdx++] = r;
      output[outTopIdx++] = g0;
      output[outTopIdx++] = b;
      output[outTopIdx++] = 255;

      // Bottom row
      output[outBottomIdx++] = r;
      output[outBottomIdx++] = g1;
      output[outBottomIdx++] = b;
      output[outBottomIdx++] = 255;

      output[outBottomIdx++] = r;
      output[outBottomIdx++] = g1;
      output[outBottomIdx++] = b;
      output[outBottomIdx++] = 255;
    }
  }`)}const Ic=Vs("r","g0","g1","b"),Cc=Vs("b","g0","g1","r"),Mc=Vs("g0","b","r","g1"),Dc=Vs("g0","r","b","g1");class Vi{D;K;P;R;width;height;constructor(e){const{binning_x:t,binning_y:s,roi:n,distortion_model:r,D:a,K:o,P:l,R:d,width:h,height:f}=e,m=l[0],p=l[5];if(h<=0||f<=0)throw new Error(`Invalid image size ${h}x${f}`);if(r.length>0&&r!=="plumb_bob"&&r!=="rational_polynomial")throw new Error(`Unrecognized distortion_model "${r}"`);if(o.length!==0&&o.length!==9)throw new Error(`K.length=${o.length}, expected 9`);if(l.length!==12)throw new Error(`P.length=${l.length}, expected 12`);if(d.length!==0&&d.length!==9)throw new Error(`R.length=${d.length}, expected 9`);if(m===0||p===0)throw new Error(`Invalid focal length (fx=${m}, fy=${p})`);const g=[...a];for(;g.length<8;)g.push(0);this.D=g,this.K=o.length===9?o:[1,0,0,0,1,0,0,0,1],this.P=l,this.R=d.length===9?d:[1,0,0,0,1,0,0,0,1],this.width=h,this.height=f;const u=t!==0?t:1,x=s!==0?s:1,y=u>1||x>1,C=n.x_offset!==0||n.y_offset!==0;if(y||C)throw new Error("Failed to initialize camera model: unable to handle adjusted binning and adjusted roi camera models.")}undistortNormalized(e,t,s=5){const{D:n}=this,[r,a,o,l,d,h,f,m]=n;let p=t.x,g=t.y;const u=p,x=g,y=r!==0||a!==0||o!==0||l!==0||d!==0?s:1;for(let C=0;C<y;++C){const T=p*p,I=g*g,_=p*g,P=T+I,L=P*P,G=L*P,Z=1+r*P+a*L+d*G,Te=(1+h*P+f*L+m*G)/Z,ts=2*o*_+l*(P+2*T),Ke=o*(P+2*I)+2*l*_;p=(u-ts)*Te,g=(x-Ke)*Te}return e.x=p,e.y=g,e}distortNormalized(e,t){const{R:s,D:n}=this,[r,a,o,l,d,h,f,m]=n,p=t.x,g=t.y,u=s[0]*p+s[3]*g+s[6],x=s[1]*p+s[4]*g+s[7],y=s[2]*p+s[5]*g+s[8],C=u/y,T=x/y,I=C*C,_=T*T,P=C*T,L=I+_,G=L*L,Z=G*L,Te=(1+r*L+a*G+d*Z)/(1+h*L+f*G+m*Z),ts=2*o*P+l*(L+2*I),Ke=2*l*P+o*(L+2*_);return e.x=C*Te+ts,e.y=T*Te+Ke,e}undistortPixel(e,t,s=5){const{K:n,P:r}=this,a=n[0],o=n[4],l=n[2],d=n[5],h=r[0],f=r[5],m=r[2],p=r[6];return e.x=(t.x-l)/a,e.y=(t.y-d)/o,this.undistortNormalized(e,e,s),e.x=e.x*h+m,e.y=e.y*f+p,e}distortPixel(e,t){e.x=t.x,e.y=t.y;const{P:s,K:n}=this,r=n[0],a=n[4],o=n[2],l=n[5],d=s[0],h=s[5],f=s[2],m=s[6];return e.x=(t.x-f)/d,e.y=(t.y-m)/h,this.distortNormalized(e,e),e.x=e.x*r+o,e.y=e.y*a+l,e}projectPixelTo3dPlane(e,t){const{K:s}=this,n=s[0],r=s[4],a=s[2],o=s[5];return e.x=(t.x-a)/n,e.y=(t.y-o)/r,this.undistortNormalized(e,e),e.z=1,e}projectPixelTo3dRay(e,t){this.projectPixelTo3dPlane(e,t);const s=1/Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);return e.x*=s,e.y*=s,e.z*=s,e}}var q=b(97984);const Wi="selected_id";class K extends c.Tme{isRenderable=!0;pickable=!0;pickableInstances=!1;renderer;userData;constructor(e,t,s){super(),this.name=e,this.renderer=t,this.userData=s}dispose(){this.children.length=0}idFromMessage(){}selectedIdVariable(){}details(){return{}}get topic(){return this.userData.topic}get pose(){return this.userData.pose}instanceDetails(e){}}var kr=b(1547);const Ac=new c.Pa4(1,0,0),Ec=new c.Pa4(0,1,0),Hi=new c.Pa4,Zi=new c.Pa4,Ft=new c.Pa4;function Pc(i,e){const t=new c._fP(0,0,0,1);Hi.copy(i).normalize(),Zi.copy(e).normalize();const s=Hi.dot(Zi);if(s>=1)return t;if(s<1e-6-1){let n=Ft.copy(Ac).cross(i);_c(n)&&(n=Ft.copy(Ec).cross(i)),n.normalize(),t.setFromAxisAngle(n,Math.PI)}else{const n=Math.sqrt((1+s)*2),r=1/n;Ft.copy(Hi).cross(Zi),t.x=Ft.x*r,t.y=Ft.y*r,t.z=Ft.z*r,t.w=n*.5,t.normalize()}return t}function _c(i){return i.lengthSq()<1e-6*1e-6}function Yi(i,e,t=1e-5){return Math.abs(i-e)<t}function Ki(i,e){for(let t=0;t<i.length;t++)if(i[t]!==e[t])return!1;return!0}function Gr(i,e,t=1e-5){return Yi(i[0],e[0],t)&&Yi(i[1],e[1],t)&&Yi(i[2],e[2],t)}function as(i,e,t){return Math.max(e,Math.min(t,i))}function Ws(i,e,t){return i+(e-i)*t}const Xi=new c.Ilk(0).convertSRGBToLinear(),Ji=new c.Ilk(16777215).convertSRGBToLinear();function F(i){return i<.04045?i*.0773993808:Math.pow(i*.9478672986+.0521327014,2.4)}function R(i,e){const t=(0,kr.Z)(e);if(!t.isValid())return i.r=i.g=i.b=i.a=1,i;const s=t.toRgb();return i.r=s.r/255,i.g=s.g/255,i.b=s.b/255,i.a=s.a,i}function ee(){return{r:0,g:0,b:0,a:0}}function Qi(i,e){const t=(0,kr.Z)(e);if(!t.isValid())return i.r=i.g=i.b=1,i;const s=t.toRgb();return i.r=s.r/255,i.g=s.g/255,i.b=s.b/255,i}function be(i,e){return i.setRGB(e.r,e.g,e.b).convertSRGBToLinear()}function oe(i){const e=Math.trunc(i.r*255),t=Math.trunc(i.g*255),s=Math.trunc(i.b*255);return`rgba(${e}, ${t}, ${s}, ${i.a})`}function Ut(i,e){return i.r=F(e.r),i.g=F(e.g),i.b=F(e.b),i.a=e.a,i}function Hs(i,e,t){return Math.hypot(.5468*i,.7662*e,.3376*t)}function qi(i,e,t,s){const n=e.r*e.a,r=e.g*e.a,a=e.b*e.a,o=t.r*t.a,l=t.g*t.a,d=t.b*t.a;return i.r=Ws(n,o,s),i.g=Ws(r,l,s),i.b=Ws(a,d,s),i.a=Ws(e.a,t.a,s),i}var Lc=b(90758);class Rc{#e;#t;constructor(){this.#e=new Worker(new URL(b.p+b.u(3050),b.b)),this.#t=Lc.Ud(this.#e)}async decode(e,t){return await this.#t.decode(e,t)}terminate(){this.#e.terminate()}}var A=b(55708),E;(function(i){i[i.ARROW=0]="ARROW",i[i.CUBE=1]="CUBE",i[i.SPHERE=2]="SPHERE",i[i.CYLINDER=3]="CYLINDER",i[i.LINE_STRIP=4]="LINE_STRIP",i[i.LINE_LIST=5]="LINE_LIST",i[i.CUBE_LIST=6]="CUBE_LIST",i[i.SPHERE_LIST=7]="SPHERE_LIST",i[i.POINTS=8]="POINTS",i[i.TEXT_VIEW_FACING=9]="TEXT_VIEW_FACING",i[i.MESH_RESOURCE=10]="MESH_RESOURCE",i[i.TRIANGLE_LIST=11]="TRIANGLE_LIST"})(E||(E={}));var le;(function(i){i[i.ADD=0]="ADD",i[i.MODIFY=0]="MODIFY",i[i.DELETE=2]="DELETE",i[i.DELETEALL=3]="DELETEALL"})(le||(le={}));var B;(function(i){i[i.UNKNOWN=0]="UNKNOWN",i[i.INT8=1]="INT8",i[i.UINT8=2]="UINT8",i[i.INT16=3]="INT16",i[i.UINT16=4]="UINT16",i[i.INT32=5]="INT32",i[i.UINT32=6]="UINT32",i[i.FLOAT32=7]="FLOAT32",i[i.FLOAT64=8]="FLOAT64"})(B||(B={}));const dt={sec:0,nsec:0},Br=new Set;X(Br,"geometry_msgs/TransformStamped");const en=new Set;X(en,"tf/tfMessage"),X(en,"tf2_msgs/TFMessage");const tn=new Set;X(tn,"visualization_msgs/Marker");const Zs=new Set;X(Zs,"visualization_msgs/MarkerArray"),X(Zs,"studio_msgs/MarkerArray");const sn=new Set;X(sn,"nav_msgs/OccupancyGrid");const Ys=new Set;X(Ys,"sensor_msgs/PointCloud2");const nn=new Set;X(nn,"sensor_msgs/LaserScan");const rn=new Set;X(rn,"velodyne_msgs/VelodyneScan");const an=new Set;X(an,"geometry_msgs/PoseStamped");const on=new Set;X(on,"geometry_msgs/PoseWithCovarianceStamped");const ln=new Set;X(ln,"geometry_msgs/PoseArray");const os=new Set;X(os,"nav_msgs/Path");const zt=new Set;X(zt,"sensor_msgs/CameraInfo");const ls=new Set;X(ls,"sensor_msgs/Image");const cs=new Set;X(cs,"sensor_msgs/CompressedImage");const cn=new Set;X(cn,"geometry_msgs/PolygonStamped");const jr=new Set;X(jr,"sensor_msgs/JointState");const $r=new Set;X($r,"visualization_msgs/ImageMarker");const Vr=new Set;X(Vr,"visualization_msgs/ImageMarkerArray");function X(i,e){i.add(e);const t=e.split("/");if(t.length>1){const s=t[0],n=t.slice(1).join("/");i.add(`${s}/msg/${n}`)}return i.add("ros."+e.split("/").join(".")),i}function ce(i){return i?{sec:i.sec??0,nsec:i.nsec??0}:{sec:0,nsec:0}}function kt(i){return i==null?new Uint8Array(0):i instanceof Uint8Array?i:Array.isArray(i)||i instanceof ArrayBuffer?new Uint8Array(i):new Uint8Array(0)}function Nc(i){return i==null?new Int8Array(0):i instanceof Int8Array?i:Array.isArray(i)||i instanceof ArrayBuffer?new Int8Array(i):new Int8Array(0)}function Ks(i){return i==null?new Float32Array(0):i instanceof Float32Array?i:Array.isArray(i)||i instanceof ArrayBuffer||i instanceof Float64Array?new Float32Array(i):new Float32Array(0)}function Ve(i){return i?{x:i.x??0,y:i.y??0,z:i.z??0}:{x:0,y:0,z:0}}function Wr(i){return i?i.map(Ve):[]}function Oc(i){return!i||i.length!==36||typeof i[0]!="number"?[1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1]:i}function dn(i){return i?{x:i.x??0,y:i.y??0,z:i.z??0,w:i.w??0}:{x:0,y:0,z:0,w:1}}function et(i){return i?{r:i.r??0,g:i.g??0,b:i.b??0,a:i.a??1}:{r:0,g:0,b:0,a:1}}function hn(i){return i?i.map(et):[]}function te(i){return{position:Ve(i?.position),orientation:dn(i?.orientation)}}function Le(i){return{frame_id:i?.frame_id??"",stamp:ce(i?.stamp),seq:i?.seq}}function Fc(i){return{translation:Ve(i?.translation),rotation:dn(i?.rotation)}}function Hr(i){return{header:Le(i?.header),child_frame_id:i?.child_frame_id??"",transform:Fc(i?.transform)}}function Uc(i){return{transforms:(i?.transforms??[]).map(Hr)}}function Zr(i){return{timestamp:ce(i?.timestamp),parent_frame_id:i?.parent_frame_id??"",child_frame_id:i?.child_frame_id??"",translation:Ve(i?.translation??i?.transform?.translation),rotation:dn(i?.rotation??i?.transform?.rotation)}}function zc(i){return{transforms:(i?.transforms??[]).map(Zr)}}function kc(i){switch(i){case A.NumericType.UINT8:return B.UINT8;case A.NumericType.INT8:return B.INT8;case A.NumericType.UINT16:return B.UINT16;case A.NumericType.INT16:return B.INT16;case A.NumericType.UINT32:return B.UINT32;case A.NumericType.INT32:return B.INT32;case A.NumericType.FLOAT32:return B.FLOAT32;case A.NumericType.FLOAT64:return B.FLOAT64;default:return B.UNKNOWN}}const Yr={x:0,y:0,z:0},Kr={x:0,y:0,z:0};function Ct(i,e,t,s){return s.planarProjectionFactor===0?t.projectPixelTo3dRay(i,e):s.planarProjectionFactor===1?t.projectPixelTo3dPlane(i,e):(t.projectPixelTo3dRay(Yr,e),t.projectPixelTo3dPlane(Kr,e),Bc(i,Yr,Kr,s.planarProjectionFactor)),jc(i,s.distance),i}function un(i,e){if(!i||!e)return i===e;if(i===e)return!0;if(!(i.header.frame_id===e.header.frame_id&&i.width===e.width&&i.height===e.height&&i.distortion_model===e.distortion_model&&i.binning_x===e.binning_x&&i.binning_y===e.binning_y&&i.roi.x_offset===e.roi.x_offset&&i.roi.y_offset===e.roi.y_offset&&i.roi.height===e.roi.height&&i.roi.width===e.roi.width&&i.roi.do_rectify===e.roi.do_rectify&&i.D.length===e.D.length))return!1;for(let t=0;t<i.D.length;t++)if(i.D[t]!==e.D[t])return!1;for(let t=0;t<9;t++)if(i.K[t]!==e.K[t])return!1;for(let t=0;t<9;t++)if(i.R[t]!==e.R[t])return!1;for(let t=0;t<12;t++)if(i.P[t]!==e.P[t])return!1;return!0}function Xs(i){const e=i.D??i.d,t=i.K??i.k,s=i.R??i.r,n=i.P??i.p,r=e?.length??0,a=t?.length??0,o=s?.length??0,l=n?.length??0;return{header:"timestamp"in i?{stamp:ce(i.timestamp),frame_id:i.frame_id??""}:Le(i.header),height:i.height??0,width:i.width??0,distortion_model:i.distortion_model??"",D:r>0?e:[],K:a===9?t:[],R:o===9?s:[],P:l===12?n:[],binning_x:i.binning_x??0,binning_y:i.binning_y??0,roi:Gc(i.roi)}}function Gc(i){return i?{x_offset:i.x_offset??0,y_offset:i.y_offset??0,height:i.height??0,width:i.width??0,do_rectify:i.do_rectify??!1}:{x_offset:0,y_offset:0,height:0,width:0,do_rectify:!1}}function Bc(i,e,t,s){i.x=e.x+(t.x-e.x)*s,i.y=e.y+(t.y-e.y)*s,i.z=e.z+(t.z-e.z)*s}function jc(i,e){i.x*=e,i.y*=e,i.z*=e}const Xr={r:0,g:0,b:0,a:0},$c={r:0,g:0,b:0,a:0},Jr=["gradient","colormap"];function Js(i,e,t){switch(i.colorMode){case"flat":{const s=R(Xr,i.flatColor);return Ut(s,s),(n,r)=>{n.r=s.r,n.g=s.g,n.b=s.b,n.a=s.a}}case"gradient":{const s=Math.max(t-e,Number.EPSILON),n=R(Xr,i.gradient[0]),r=R($c,i.gradient[1]);return Ut(n,n),Ut(r,r),(a,o)=>{const l=Math.max(0,Math.min((o-e)/s,1));qi(a,n,r,l)}}case"colormap":{const s=Math.max(t-e,Number.EPSILON);switch(i.colorMap){case"turbo":return(n,r)=>{const a=Math.max(0,Math.min((r-e)/s,1));Qc(n,a),n.a=i.explicitAlpha};case"rainbow":return(n,r)=>{const a=Math.max(0,Math.min((r-e)/s,1));Vc(n,a),n.a=i.explicitAlpha}}throw new Error(`Unrecognized color map: ${i.colorMap}`)}case"rgb":return(s,n)=>{Qr(s,n),s.a=i.explicitAlpha};case"rgba":return Qr}}function Qr(i,e){const t=e>>>0;i.a=((t&4278190080)>>>24)/255,i.r=((t&16711680)>>>16)/255,i.g=((t&65280)>>>8)/255,i.b=((t&255)>>>0)/255}function Vc(i,e){const t=(1-as(e,0,1))*5+1,s=Math.floor(t);let n=t%1;s%2<1&&(n=1-n);const r=F(1-n);s<=1?(i.r=r,i.g=0,i.b=1):s===2?(i.r=0,i.g=r,i.b=1):s===3?(i.r=0,i.g=1,i.b=r):s===4?(i.r=r,i.g=1,i.b=0):(i.r=1,i.g=r,i.b=0),i.a=1}const Wc=new c.Ltg(.13572138,4.6153926,-42.66032258,132.13108234),Hc=new c.Ltg(.09140261,2.19418839,4.84296658,-14.18503333),Zc=new c.Ltg(.1066733,12.64194608,-60.58204836,110.36276771),Yc=new c.FM8(-152.94239396,59.28637943),Kc=new c.FM8(4.27729857,2.82956604),Xc=new c.FM8(-89.90310912,27.34824973),Mt=new c.Ltg,ds=new c.FM8;function Jc(i,e){const t=as(e,0,1)*.99+.01;Mt.set(1,t,t*t,t*t*t),ds.set(Mt.z,Mt.w),ds.multiplyScalar(Mt.z),i.r=F(as(Mt.dot(Wc)+ds.dot(Yc),0,1)),i.g=F(as(Mt.dot(Hc)+ds.dot(Kc),0,1)),i.b=F(as(Mt.dot(Zc)+ds.dot(Xc),0,1)),i.a=1}let ht;const Qs=65535;function Qc(i,e){if(!ht){ht=new Float32Array(Qs*3);const s={r:0,g:0,b:0,a:0};for(let n=0;n<Qs;n++){Jc(s,n/(Qs-1));const r=n*3;ht[r+0]=s.r,ht[r+1]=s.g,ht[r+2]=s.b}}const t=Math.trunc(e*(Qs-1))*3;i.r=ht[t+0],i.g=ht[t+1],i.b=ht[t+2],i.a=1}const fn=new Set(["rgb","rgba"]),qr=new Set(["intensity","i"]);function qc(i,{supportsPackedRgbModes:e}){if(e){for(const t of i)if(fn.has(t))return t}for(const t of i)if(qr.has(t))return t;return i.find(t=>t==="x")??i[0]??""}function ea(i){let e=!1,t=!1,s=!1,n=!1;for(const r of i)switch(r){case"red":e=!0;break;case"green":t=!0;break;case"blue":s=!0;break;case"alpha":n=!0;break}return e&&t&&s&&n}function pn({msgFields:i,config:e,defaults:t,modifiers:{supportsPackedRgbModes:s,supportsRgbaFieldsMode:n,hideFlatColor:r,hideExplicitAlpha:a}}){const o=e.colorMode??(r===!0?"gradient":"flat"),l=e.flatColor??"#ffffff",d=e.gradient,h=e.colorMap??"turbo",f=e.explicitAlpha??1,m=e.minValue,p=e.maxValue,g={},u=[{label:"Color map",value:"colormap"},{label:"Gradient",value:"gradient"}];if(r!==!0&&u.push({label:"Flat",value:"flat"}),i&&i.length>0&&(s&&u.push({label:"BGR (packed)",value:"rgb"},{label:"BGRA (packed)",value:"rgba"}),n&&ea(i)&&u.push({label:"RGBA (separate fields)",value:"rgba-fields"})),g.colorMode={label:"Color mode",input:"select",value:o,options:u},o==="flat")g.flatColor={label:"Flat color",input:"rgba",value:l};else if(o!=="rgba-fields"){if(i){const x=i.map(C=>({label:C,value:C})),y=e.colorField??qc(i,{supportsPackedRgbModes:s});g.colorField={label:"Color by",input:"select",options:x,value:y}}switch(o){case"gradient":g.gradient={label:"Gradient",input:"gradient",value:d??t.gradient};break;case"colormap":g.colorMap={label:"Color map",input:"select",options:[{label:"Turbo",value:"turbo"},{label:"Rainbow",value:"rainbow"}],value:h};break;default:break}a!==!0&&(o==="colormap"||o==="rgb")&&(g.explicitAlpha={label:"Opacity",input:"number",step:.1,placeholder:"1",precision:3,min:0,max:1,value:f}),Jr.includes(o)&&(g.minValue={label:"Value min",input:"number",placeholder:"auto",precision:4,value:m},g.maxValue={label:"Value max",input:"number",placeholder:"auto",precision:4,value:p})}return g}const mn={r:0,g:0,b:0,a:0};function qs(i){switch(i.colorMode){case"flat":return R(mn,i.flatColor).a<1;case"gradient":return R(mn,i.gradient[0]).a<1||R(mn,i.gradient[1]).a<1;case"colormap":case"rgb":return i.explicitAlpha<1;case"rgba":case"rgba-fields":return!0}}const ta=`
vec3 sRGBToLinear(in vec3 value) {
	return vec3(mix(
    pow(value.rgb * 0.9478672986 + vec3(0.0521327014), vec3(2.4)),
    value.rgb * 0.0773993808,
    vec3(lessThanEqual(value.rgb, vec3(0.04045)))
  ));
}

vec4 sRGBToLinear(in vec4 value) {
  return vec4(sRGBToLinear(value.rgb), value.a);
}
`;async function sa(i,e){const t=new Blob([i.data],{type:`image/${i.format}`});return await createImageBitmap(t,{resizeWidth:e})}const ia={colorMode:"gradient",flatColor:"#ffffff",gradient:["#000000","#ffffff"],colorMap:"turbo",explicitAlpha:0},ed={minValue:0,maxValue:65535};function td(i,e,t){const{encoding:s,width:n,height:r,step:a}=i,o="is_bigendian"in i?i.is_bigendian:!1,l=i.data;switch(s){case"yuv422":case"uyvy":Q(l,n,r,a,t);break;case"yuv422_yuy2":case"yuyv":$e(l,n,r,a,t);break;case"rgb8":qe(l,n,r,a,t);break;case"rgba8":Ot(l,n,r,a,t);break;case"bgra8":ge(l,n,r,a,t);break;case"bgr8":case"8UC3":nt(l,n,r,a,t);break;case"32FC1":Bi(l,n,r,a,o,t);break;case"bayer_rggb8":Ic(l,n,r,a,t);break;case"bayer_bggr8":Cc(l,n,r,a,t);break;case"bayer_gbrg8":Mc(l,n,r,a,t);break;case"bayer_grbg8":Dc(l,n,r,a,t);break;case"mono8":case"8UC1":ji(l,n,r,a,t);break;case"mono16":case"16UC1":{const d=Ce.Z({},ia,ed,e);if(d.colorMode==="rgba-fields"||d.colorMode==="flat")throw Error(`${d.colorMode} color mode is not supported for mono16 images`);const h=d.minValue,f=d.maxValue,m={r:0,g:0,b:0,a:0},p=Js(d,h,f);$i(l,n,r,a,o,t,{minValue:e.minValue,maxValue:e.maxValue,colorConverter:g=>(p(m,g),m)});break}default:throw new Error(`Unsupported encoding ${s}`)}}var sd="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/Images/ImageRenderable.ts";const id=Y.ZP.getLogger(sd),ei="CreateBitmap",na=["imageMode","imageTopic"],Gt={visible:!1,frameLocked:!0,cameraInfoTopic:void 0,distance:1,planarProjectionFactor:0,color:"#ffffff"};class ra extends K{#e=!0;#t=!0;#s=!0;#i=!0;#n=!1;#r=!1;#a;#o;#l=0;#d=0;#c=!1;constructor(e,t,s){super(e,t,s)}dispose(){this.#c=!0,this.userData.texture?.dispose(),this.userData.material?.dispose(),this.userData.geometry?.dispose(),this.#o?.terminate(),super.dispose()}updateHeaderInfo(){(0,q.assert)(this.userData.image,"updateHeaderInfo called without image");const e=this.userData.image,t=this.userData.cameraInfo?.header.frame_id??("header"in e?e.header.frame_id:e.frame_id);this.userData.frameId=typeof t=="string"?this.renderer.normalizeFrameId(t):t,this.userData.messageTime=(0,M.toNanoSec)("header"in e?e.header.stamp:e.timestamp)}details(){return{image:this.userData.image,camera_info:this.userData.cameraInfo}}setRenderBehindScene(){this.#n=!0,this.#i=!0,this.#t=!0}setCameraModel=e=>{this.#e||=this.userData.cameraModel!==e,this.userData.cameraModel=e};setSettings(e){const t=this.userData.settings;if(t.cameraInfoTopic!==e.cameraInfoTopic&&(this.userData.mesh!=null&&this.remove(this.userData.mesh),this.userData.mesh=void 0,this.#e=!0),(t.distance!==e.distance||e.planarProjectionFactor!==t.planarProjectionFactor)&&(this.#e=!0),e.color!==t.color&&(this.#i=!0),t.colorMode!==e.colorMode||t.flatColor!==e.flatColor||t.gradient!==e.gradient||t.colorMap!==e.colorMap||t.minValue!==e.minValue||t.maxValue!==e.maxValue){this.userData.settings=e;const s=this.userData.image;s&&this.setImage(s);return}this.userData.settings=e}setImage(e,t,s){this.userData.image=e;const n=++this.#l;("format"in e?sa(e,t):(this.#o??=new Rc).decode(e,this.userData.settings)).then(a=>{this.#c||this.#d>n||(this.#d=n,this.#a=a,this.#s=!0,this.update(),s?.(a),this.renderer.settings.errors.remove(na,ei),this.renderer.settings.errors.removeFromTopic(this.userData.topic,ei),this.renderer.queueAnimationFrame())}).catch(a=>{id.error(a),!this.#c&&(this.renderer.settings.errors.add(na,ei,`Error decoding image: ${a.message}`),this.renderer.settings.errors.addToTopic(this.userData.topic,ei,`Error decoding image: ${a.message}`))})}update(){this.#r||(this.#r=!0,this.#s&&this.#a&&(this.#u(),this.#s=!1),this.userData.image&&this.updateHeaderInfo(),this.#e&&this.userData.cameraModel&&(this.#h(),this.#e=!1),this.#i&&(this.#m(),this.#i=!1),this.#t&&this.userData.texture&&this.userData.geometry&&this.userData.material&&(this.#b(),this.#t=!1),this.#r=!1)}#h(){(0,q.assert)(this.userData.cameraModel,"Camera model must be set before geometry can be updated"),this.userData.geometry?.dispose(),this.userData.geometry=void 0;const e=ad(this.userData.cameraModel,this.userData.settings);this.userData.geometry=e,this.#t=!0}#u(){(0,q.assert)(this.#a,"Decoded image must be set before texture can be updated or created");const e=this.#a;if(e instanceof ImageBitmap){const t=this.userData.texture;t==null||!(t instanceof c.ROQ)||!od(e,t.image)?(t?.image instanceof ImageBitmap&&t.image.close(),t?.dispose(),this.userData.texture=nd(e)):(t.image=e,t.needsUpdate=!0)}else{let t=this.userData.texture;t==null||!(t instanceof c.IEO)||t.image.width!==e.width||t.image.height!==e.height?(t?.dispose(),t=rd(e),this.userData.texture=t):(t.image=e,t.needsUpdate=!0)}this.#i=!0}#m(){this.userData.material||(this.#f(),this.#t=!0);const e=this.userData.material,t=this.userData.texture;t&&(e.map=t),Me=R(Me,this.userData.settings.color);const s=Me.a<1,n=new c.Ilk(Me.r,Me.g,Me.b);e.color.set(n),e.opacity=Me.a,e.transparent=s,e.depthWrite=!s,this.#n?(e.depthWrite=!1,e.depthTest=!1):e.depthTest=!0,e.needsUpdate=!0}#f(){R(Me,this.userData.settings.color);const e=Me.a<1,t=new c.Ilk(Me.r,Me.g,Me.b);this.userData.material=new c.vBJ({name:`${this.userData.topic}:Material`,color:t,side:c.ehD,opacity:Me.a,transparent:e,depthWrite:!e})}#b(){if((0,q.assert)(this.userData.geometry,"Geometry must be set before mesh can be updated or created"),(0,q.assert)(this.userData.material,"Material must be set before mesh can be updated or created"),this.userData.mesh?(this.userData.mesh.geometry=this.userData.geometry,this.userData.mesh.material=this.userData.material):(this.userData.mesh=new c.Kj0(this.userData.geometry,this.userData.material),this.add(this.userData.mesh)),!this.#n){this.userData.mesh.renderOrder=0;return}this.userData.mesh.renderOrder=-1*Number.MAX_SAFE_INTEGER}}let Me={r:0,g:0,b:0,a:0};function nd(i){const e=new c.ROQ(i,c.xfE,c.uWy,c.uWy,c.TyD,c.wem,c.wk1,c.ywz);return e.generateMipmaps=!1,e.encoding=c.knz,e}function rd(i){const e=new c.IEO(i.data,i.width,i.height,c.wk1,c.ywz,c.xfE,c.uWy,c.uWy,c.TyD,c.wem,1,c.knz);return e.needsUpdate=!0,e}function ad(i,e){const n=i.width,r=i.height,a=new c._12(1,1,10,10),o=10+1,l=10+1,d=o*l,h=n/10,f=r/10,m=.001,p={x:0,y:0},g={x:0,y:0,z:0},u=new Float32Array(d*3),x=new Float32Array(d*2);for(let y=0;y<l;y++)for(let C=0;C<o;C++){const T=(y*o+C)*3,I=(y*o+C)*2;p.x=C*h,p.y=y*f,Ct(g,p,i,e),u[T+0]=g.x,u[T+1]=g.y,u[T+2]=g.z-m,x[I+0]=C/10,x[I+1]=y/10}return a.setAttribute("position",new c.TlE(u,3)),a.setAttribute("uv",new c.TlE(x,2)),a.attributes.position.needsUpdate=!0,a.attributes.uv.needsUpdate=!0,a}const od=(i,e)=>i?.width===e?.width&&i?.height===e?.height,aa=new Set;Re(aa,"foxglove.FrameTransform");const oa=new Set;Re(oa,"foxglove.FrameTransforms");const ti=new Set;Re(ti,"foxglove.PointCloud");const gn=new Set;Re(gn,"foxglove.LaserScan");const hs=new Set;Re(hs,"foxglove.RawImage");const us=new Set;Re(us,"foxglove.CompressedImage");const Bt=new Set;Re(Bt,"foxglove.CameraCalibration");const bn=new Set;Re(bn,"foxglove.SceneUpdate");const yn=new Set;Re(yn,"foxglove.PoseInFrame");const vn=new Set;Re(vn,"foxglove.PosesInFrame");const Tn=new Set;Re(Tn,"foxglove.Grid");const la=new Set;Re(la,"foxglove.ImageAnnotations");function Re(i,e){i.add(e);const t=e.split(".");if(t.length<2)throw new Error(`Invalid Foxglove schema: ${e}`);const s=t.slice(1).join("/");return i.add(`foxglove_msgs/${s}`),i.add(`foxglove_msgs/msg/${s}`),i.add(`foxglove::${s}`),i}const ld=new Set([...zt,...Bt]);function ca(i){return"header"in i?i.header.frame_id:i.frame_id}function da(i){return"header"in i?i.header.stamp:i.timestamp}var N=b(61175);const cd={near:.001,far:1e3},dd=.5,hd=50;class ud extends c.cPb{#e;#t=cd;#s=0;#i=!1;#n=!1;#r=new c.FM8;#a=new c.FM8;#o=new c.FM8(0,0);#l=1;updateCamera(e){this.#e=e,this.#d()}setPanOffset(e){this.#o.copy(e),this.#d()}getPanOffset(e){e.copy(this.#o)}resetModifications(){this.#o.set(0,0),this.#l=1,this.#d()}setRotation(e){switch(e){case 0:case 90:case 180:case 270:this.#s=e;break;default:this.#s=0;break}this.quaternion.setFromEuler(new c.USm(Math.PI,0,c.M8C.degToRad(e))),this.resetModifications()}setFlipHorizontal(e){this.#i=e,this.resetModifications()}setFlipVertical(e){this.#n=e,this.resetModifications()}updateZoomFromWheel(e,t){const s=c.M8C.clamp(this.#l*e,dd,hd),n=s/this.#l,r=this.#a.width/2,a=this.#a.height/2;this.#o.set((r+this.#o.x-t.x)*n-r+t.x,(a+this.#o.y-t.y)*n-a+t.y),this.#l=s,this.#d()}#d(){this.#h(),this.#e?(this.#c(this.projectionMatrix,this.#e),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()):this.updateProjectionMatrix()}#c(e,t){const{width:s,height:n}=t,r=t.P[0],a=t.P[5],o=this.getEffectiveScale(),l=this.#i?-1:1,d=this.#n?-1:1;let h,f;switch(this.#s){case 0:h=this.#o.x*(r/a)*l,f=this.#o.y*d;break;case 90:h=this.#o.y*(r/a)*d,f=-this.#o.x*l;break;case 180:h=-this.#o.x*(r/a)*l,f=-this.#o.y*d;break;case 270:h=-this.#o.y*(r/a)*d,f=this.#o.x*l;break}const m=t.P[2]+h/o,p=t.P[6]+f/o,g=this.#t.near,u=this.#t.far;let x,y,C,T;const I=(1/this.#r.x-1)*s/2,_=(1/this.#r.y-1)*n/2,P=-(m+I)/r*g,L=(s-m+I)/r*g,G=(p+_)/a*g,Z=-(n-p+_)/a*g;switch(this.#s){case 0:x=P,y=L,C=G,T=Z;break;case 90:x=Z,y=G,C=-P,T=-L;break;case 180:x=-L,y=-P,C=-Z,T=-G;break;case 270:x=-G,y=-Z,C=L,T=P;break}if(this.#i){const Te=x;x=y,y=Te}if(this.#n){const Te=C;C=T,T=Te}e.makePerspective(x,y,C,T,g,u)}setCanvasSize(e,t){this.#a.set(e,t),this.#d()}getEffectiveScale(){if(!this.#e)return 1;let{width:e,height:t}=this.#a;if(this.#s===90||this.#s===270){const s=e;e=t,t=s}return Math.min(e/this.#e.width*this.#r.x,t/this.#e.height*this.#r.y)}#h(){const e=this.#e;if(!e)return;this.#r.set(this.#l,this.#l);const{width:t,height:s}=e,n=e.P[0],r=e.P[5];let a=this.#a.width/this.#a.height;const o=t/n/(s/r);(this.#s===90||this.#s===270)&&(a=1/a),o>a?this.#r.y=this.#r.y/o*a:this.#r.x=this.#r.x/a*o}}var fd=b(57525),pd=b(63296);function ha(i){return i==null?new Uint8Array(0):i instanceof Int8Array||i instanceof Uint8Array?i:new Uint8Array(0)}function ua(i){return{header:Le(i.header),height:i.height??0,width:i.width??0,encoding:i.encoding??"",is_bigendian:i.is_bigendian??!1,step:i.step??0,data:ha(i.data)}}function fa(i){return{header:Le(i.header),format:i.format??"",data:kt(i.data)}}function pa(i){return{timestamp:ce(i.timestamp),frame_id:i.frame_id??"",height:i.height??0,width:i.width??0,encoding:i.encoding??"",step:i.step??0,data:ha(i.data)}}function ma(i){return{timestamp:ce(i.timestamp),frame_id:i.frame_id??"",format:i.format??"",data:kt(i.data)}}var Ne;(function(i){i[i.CIRCLE=0]="CIRCLE",i[i.LINE_STRIP=1]="LINE_STRIP",i[i.LINE_LIST=2]="LINE_LIST",i[i.POLYGON=3]="POLYGON",i[i.POINTS=4]="POINTS",i[i.TEXT=5]="TEXT"})(Ne||(Ne={}));var ga;(function(i){i[i.ADD=0]="ADD",i[i.REMOVE=1]="REMOVE"})(ga||(ga={}));var ba=b(36537);const ya=12,va=4,X0=null;function md(i){switch(i){case A.PointsAnnotationType.UNKNOWN:case A.PointsAnnotationType.POINTS:return"points";case A.PointsAnnotationType.LINE_LOOP:return"polygon";case A.PointsAnnotationType.LINE_STRIP:return"line_strip";case A.PointsAnnotationType.LINE_LIST:return"line_list"}}function gd(i){const e=[],t=i.circles??[];for(let r=0;r<t.length;r++){const a=t[r],o=Sn(a.timestamp);e.push({type:"circle",stamp:o,fillColor:a.fill_color,outlineColor:a.outline_color,radius:a.diameter/2,thickness:a.thickness,position:a.position,messagePath:["circles",r]})}const s=i.points??[];for(let r=0;r<s.length;r++){const a=s[r],o=md(a.type);if(!o)continue;const l=Sn(a.timestamp);e.push({type:"points",stamp:l,style:o,points:a.points,outlineColors:a.outline_colors,outlineColor:(0,ba.N)(a).outline_color??{r:1,g:1,b:1,a:1},thickness:(0,ba.N)(a).thickness??1,fillColor:a.fill_color,messagePath:["points",r]})}const n=i.texts??[];for(let r=0;r<n.length;r++){const a=n[r],o=Sn(a.timestamp);e.push({type:"text",stamp:o,position:a.position,text:a.text,textColor:a.text_color,backgroundColor:a.background_color,fontSize:a.font_size,padding:a.font_size/ya*va,messagePath:["texts",r]})}return e}function Sn(i){return typeof i=="bigint"?(0,M.fromNanoSec)(i):i}function bd(i){return(0,z.Z)(i.markers,(e,t)=>Ta(e,["markers",t]))}function yd(i){switch(i){case Ne.LINE_LIST:return"line_list";case Ne.LINE_STRIP:return"line_strip";case Ne.POINTS:return"points";case Ne.POLYGON:return"polygon"}}function Ta(i,e){switch(i.type){case Ne.CIRCLE:return{type:"circle",stamp:i.header.stamp,fillColor:i.filled?i.fill_color:void 0,outlineColor:i.outline_color,radius:i.scale,thickness:1,position:i.position,messagePath:e};case Ne.TEXT:return{type:"text",stamp:i.header.stamp,position:i.position,text:i.text?.data??"",textColor:i.outline_color,backgroundColor:i.filled?i.fill_color:void 0,fontSize:i.scale*ya,padding:va*i.scale,messagePath:e};case Ne.POINTS:return{type:"points",stamp:i.header.stamp,style:"points",points:i.points,outlineColors:i.outline_colors,outlineColor:i.outline_color,thickness:i.scale,fillColor:i.fill_color,messagePath:e};case Ne.LINE_LIST:case Ne.LINE_STRIP:case Ne.POLYGON:{const t=yd(i.type);return{type:"points",stamp:i.header.stamp,style:t,points:i.points,outlineColors:i.outline_colors,outlineColor:i.outline_color,thickness:i.scale,fillColor:i.filled?i.fill_color:void 0,messagePath:e}}}}function vd(i){return"toJSON"in i?i.toJSON():i}function Td(i,e){const t=vd(i);switch(e){case"visualization_msgs/ImageMarker":case"visualization_msgs/msg/ImageMarker":case"ros.visualization_msgs.ImageMarker":{const s=Ta(t,[]);return s?[s]:[]}case"foxglove_msgs/ImageMarkerArray":case"foxglove_msgs/msg/ImageMarkerArray":case"studio_msgs/ImageMarkerArray":case"studio_msgs/msg/ImageMarkerArray":case"visualization_msgs/ImageMarkerArray":case"visualization_msgs/msg/ImageMarkerArray":case"ros.visualization_msgs.ImageMarkerArray":return bd(t);case"webviz_msgs/ImageMarkerArray":break;case"foxglove_msgs/ImageAnnotations":case"foxglove_msgs/msg/ImageAnnotations":case"foxglove::ImageAnnotations":case"foxglove.ImageAnnotations":return gd(t)}return[]}function xn(i,e){let t=i;for(const s of e)s in t&&(t=t[s]);return t}class Sd{#e;#t;#s;#i;#n=[];constructor(e){this.#e=e,this.#s={annotationsByTopic:new Map},this.#i=new pd.AVLTree(M.compare)}addListener(e){this.#n.push(e)}removeListener(e){this.#n=this.#n.filter(t=>t!==e)}handleRosRawImage=e=>{this.#r(e,ua(e.message))};handleRosCompressedImage=e=>{this.#r(e,fa(e.message))};handleRawImage=e=>{this.#r(e,pa(e.message))};handleCompressedImage=e=>{this.#r(e,ma(e.message))};#r(e,t){const s={...e,message:t};if(this.#e.synchronize!==!0){this.#s.image=s,this.#a();return}const n=this.#i.get(da(t));n?n.image=s:this.#i.set(da(t),{image:s,annotationsByTopic:new Map}),this.#a()}handleCameraInfo=e=>{const t=Xs(e.message);this.#s.cameraInfo=t,this.#a()};handleAnnotations=e=>{const t=Td(e.message,e.schemaName),{topic:s}=e;if(this.#e.synchronize!==!0){this.#s.annotationsByTopic.set(s,{originalMessage:e,annotations:t}),this.#a();return}const n=new Map;for(const r of t){const a=(0,M.toNanoSec)(r.stamp),o=n.get(a);if(o){o.push(r);continue}n.set(a,[r])}for(const[r,a]of n){const o=(0,M.fromNanoSec)(r);let l=this.#i.get(o);l||(l={image:void 0,annotationsByTopic:new Map},this.#i.set(o,l)),l.annotationsByTopic.set(s,{originalMessage:e,annotations:a})}this.#a()};setConfig(e){let t=!1;if(e.synchronize!=null&&e.synchronize!==this.#e.synchronize&&(this.#i.clear(),t=!0),"imageTopic"in e&&this.#e.imageTopic!==e.imageTopic){for(const s of this.#i.values())s.image=void 0;this.#s.image=void 0,t=!0}if("calibrationTopic"in e&&this.#e.calibrationTopic!==e.calibrationTopic&&(this.#s.cameraInfo=void 0,t=!0),e.annotations!=null&&this.#e.annotations&&this.#e.annotations!==e.annotations){const s=new Set;for(const[n,r]of Object.entries(e.annotations))r?.visible===!0&&s.add(n);for(const n of this.#s.annotationsByTopic.keys())s.has(n)||(this.#s.annotationsByTopic.delete(n),t=!0);for(const n of this.#i.values())for(const r of n.annotationsByTopic.keys())s.has(r)||(n.annotationsByTopic.delete(r),t=!0)}this.#e={...this.#e,...e},t&&this.#a()}clear(){this.#s={annotationsByTopic:new Map},this.#i.clear(),this.#t=void 0,this.#a()}#a(){const e=this.getRenderState();this.#n.forEach(t=>{t(e,this.#t)}),this.#t=e}getRenderState(){if(this.#e.synchronize===!0){const e=xd(this.#i,this.#o());return e.found?{cameraInfo:this.#s.cameraInfo,image:e.messages.image,annotationsByTopic:e.messages.annotationsByTopic}:{cameraInfo:this.#s.cameraInfo,presentAnnotationTopics:e.presentAnnotationTopics,missingAnnotationTopics:e.missingAnnotationTopics}}return{...this.#s}}#o(){const e=new Set;for(const[t,s]of Object.entries(this.#e.annotations??{}))s?.visible===!0&&e.add(t);return e}}function xd(i,e){let t,s,n;for(const r of i.entries()){const a=r[1];a.image&&([s,n]=fd.Z(Array.from(e),o=>a.annotationsByTopic.has(o)),n.length===0&&(t=r))}if(t){let r=i.minKey();for(;r&&(0,M.isLessThan)(r,t[0]);)i.shift(),r=i.minKey();return{found:!0,messages:t[1]}}return{found:!1,missingAnnotationTopics:n,presentAnnotationTopics:s}}var D=b(24991),jt=b(11932),fs=b(8052),ps=b(16896);const ms=1e5,gs={FILL:1+ms,LINE_PREPASS:2+ms,LINE:3+ms,POINTS:4+ms,TEXT:5+ms},bs={transparent:!0,depthWrite:!1,depthTest:!1};c.rBU.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new c.FM8(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},c.Vj0["foxglove.line"]={uniforms:c.rDY.merge([c.rBU.common,c.rBU.fog,c.rBU.line]),vertexShader:`
    #include <common>
    #include <color_pars_vertex>
    #include <fog_pars_vertex>
    #include <logdepthbuf_pars_vertex>
    #include <clipping_planes_pars_vertex>

    uniform float linewidth;
    uniform vec2 resolution;

    attribute vec3 instanceStart;
    attribute vec3 instanceEnd;

    attribute vec4 instanceColorStart;
    attribute vec4 instanceColorEnd;

    #ifdef WORLD_UNITS

      varying vec4 worldPos;
      varying vec3 worldStart;
      varying vec3 worldEnd;

      #ifdef USE_DASH

        varying vec2 vUv;

      #endif

    #else

      varying vec2 vUv;

    #endif

    #ifdef USE_DASH

      uniform float dashScale;
      attribute float instanceDistanceStart;
      attribute float instanceDistanceEnd;
      varying float vLineDistance;

    #endif

    #ifdef USE_COLOR

      varying float vAlpha;

    #endif

    void trimSegment( const in vec4 start, inout vec4 end ) {

      // trim end segment so it terminates between the camera plane and the near plane

      // conservative estimate of the near plane
      float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
      float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
      float nearEstimate = - 0.5 * b / a;

      float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

      end.xyz = mix( start.xyz, end.xyz, alpha );

    }

    void main() {

      #ifdef USE_COLOR

        vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart.xyz : instanceColorEnd.xyz;
        vAlpha = ( position.y < 0.5 ) ? instanceColorStart.w : instanceColorEnd.w;

      #endif

      #ifdef USE_DASH

        vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
        vUv = uv;

      #endif

      float aspect = resolution.x / resolution.y;

      // camera space
      vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
      vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

      #ifdef WORLD_UNITS

        worldStart = start.xyz;
        worldEnd = end.xyz;

      #else

        vUv = uv;

      #endif

      // special case for perspective projection, and segments that terminate either in, or behind, the camera plane
      // clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
      // but we need to perform ndc-space calculations in the shader, so we must address this issue directly
      // perhaps there is a more elegant solution -- WestLangley

      bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

      if ( perspective ) {

        if ( start.z < 0.0 && end.z >= 0.0 ) {

          trimSegment( start, end );

        } else if ( end.z < 0.0 && start.z >= 0.0 ) {

          trimSegment( end, start );

        }

      }

      // clip space
      vec4 clipStart = projectionMatrix * start;
      vec4 clipEnd = projectionMatrix * end;

      // ndc space
      vec3 ndcStart = clipStart.xyz / clipStart.w;
      vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

      // direction
      vec2 dir = ndcEnd.xy - ndcStart.xy;

      // account for clip-space aspect ratio
      dir.x *= aspect;
      dir = normalize( dir );

      #ifdef WORLD_UNITS

        // get the offset direction as perpendicular to the view vector
        vec3 worldDir = normalize( end.xyz - start.xyz );
        vec3 offset;
        if ( position.y < 0.5 ) {

          offset = normalize( cross( start.xyz, worldDir ) );

        } else {

          offset = normalize( cross( end.xyz, worldDir ) );

        }

        // sign flip
        if ( position.x < 0.0 ) offset *= - 1.0;

        float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

        // don't extend the line if we're rendering dashes because we
        // won't be rendering the endcaps
        #ifndef USE_DASH

          // extend the line bounds to encompass  endcaps
          start.xyz += - worldDir * linewidth * 0.5;
          end.xyz += worldDir * linewidth * 0.5;

          // shift the position of the quad so it hugs the forward edge of the line
          offset.xy -= dir * forwardOffset;
          offset.z += 0.5;

        #endif

        // endcaps
        if ( position.y > 1.0 || position.y < 0.0 ) {

          offset.xy += dir * 2.0 * forwardOffset;

        }

        // adjust for linewidth
        offset *= linewidth * 0.5;

        // set the world position
        worldPos = ( position.y < 0.5 ) ? start : end;
        worldPos.xyz += offset;

        // project the worldpos
        vec4 clip = projectionMatrix * worldPos;

        // shift the depth of the projected points so the line
        // segements overlap neatly
        vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
        clip.z = clipPose.z * clip.w;

      #else

        vec2 offset = vec2( dir.y, - dir.x );
        // undo aspect ratio adjustment
        dir.x /= aspect;
        offset.x /= aspect;

        // sign flip
        if ( position.x < 0.0 ) offset *= - 1.0;

        // endcaps
        if ( position.y < 0.0 ) {

          offset += - dir;

        } else if ( position.y > 1.0 ) {

          offset += dir;

        }

        // adjust for linewidth
        offset *= linewidth;

        // adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
        offset /= resolution.y;

        // select end
        vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

        // back to clip space
        offset *= clip.w;

        clip.xy += offset;

      #endif

      gl_Position = clip;

      vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

      #include <logdepthbuf_vertex>
      #include <clipping_planes_vertex>
      #include <fog_vertex>

    }
    `,fragmentShader:`
    uniform vec3 diffuse;
    uniform float opacity;
    uniform float linewidth;

    #ifdef USE_DASH

      uniform float dashOffset;
      uniform float dashSize;
      uniform float gapSize;

    #endif

    varying float vLineDistance;

    #ifdef WORLD_UNITS

      varying vec4 worldPos;
      varying vec3 worldStart;
      varying vec3 worldEnd;

      #ifdef USE_DASH

        varying vec2 vUv;

      #endif

    #else

      varying vec2 vUv;

    #endif

    #ifdef USE_COLOR

      varying float vAlpha;

    #endif

    #include <common>
    #include <color_pars_fragment>
    #include <fog_pars_fragment>
    #include <logdepthbuf_pars_fragment>
    #include <clipping_planes_pars_fragment>

    vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

      float mua;
      float mub;

      vec3 p13 = p1 - p3;
      vec3 p43 = p4 - p3;

      vec3 p21 = p2 - p1;

      float d1343 = dot( p13, p43 );
      float d4321 = dot( p43, p21 );
      float d1321 = dot( p13, p21 );
      float d4343 = dot( p43, p43 );
      float d2121 = dot( p21, p21 );

      float denom = d2121 * d4343 - d4321 * d4321;

      float numer = d1343 * d4321 - d1321 * d4343;

      mua = numer / denom;
      mua = clamp( mua, 0.0, 1.0 );
      mub = ( d1343 + d4321 * ( mua ) ) / d4343;
      mub = clamp( mub, 0.0, 1.0 );

      return vec2( mua, mub );

    }

    void main() {

      #include <clipping_planes_fragment>

      #ifdef USE_DASH

        if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

        if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

      #endif

      #ifdef USE_COLOR

      float alpha = vAlpha;

      #else

      float alpha = opacity;

      #endif

      #ifdef WORLD_UNITS

        // Find the closest points on the view ray and the line segment
        vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
        vec3 lineDir = worldEnd - worldStart;
        vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

        vec3 p1 = worldStart + lineDir * params.x;
        vec3 p2 = rayEnd * params.y;
        vec3 delta = p1 - p2;
        float len = length( delta );
        float norm = len / linewidth;

        #ifndef USE_DASH

          #ifdef USE_ALPHA_TO_COVERAGE

            float dnorm = fwidth( norm );
            alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

          #else

            if ( norm > 0.5 ) {

              discard;

            }

          #endif

        #endif

      #else

        #ifdef USE_ALPHA_TO_COVERAGE

          // artifacts appear on some hardware if a derivative is taken within a conditional
          float a = vUv.x;
          float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
          float len2 = a * a + b * b;
          float dlen = fwidth( len2 );

          if ( abs( vUv.y ) > 1.0 ) {

            alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

          }

        #else

          if ( abs( vUv.y ) > 1.0 ) {

            float a = vUv.x;
            float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
            float len2 = a * a + b * b;

            if ( len2 > 1.0 ) discard;

          }

        #endif

      #endif

      vec4 diffuseColor = vec4( diffuse, alpha );

      #include <logdepthbuf_fragment>
      #include <color_fragment>

      gl_FragColor = vec4( diffuseColor.rgb, alpha );

      #include <tonemapping_fragment>
      #include <encodings_fragment>
      #include <fog_fragment>
      #include <premultiplied_alpha_fragment>

    }
    `};class Dt extends c.jyz{isLineMaterial=!0;constructor(e){super({type:"LineMaterial",uniforms:c.rDY.clone(c.Vj0["foxglove.line"].uniforms),vertexShader:c.Vj0["foxglove.line"].vertexShader,fragmentShader:c.Vj0["foxglove.line"].fragmentShader,clipping:!0}),this.setValues(e)}get color(){return this.uniforms.diffuse.value}set color(e){this.uniforms.diffuse.value=e}get worldUnits(){return"WORLD_UNITS"in this.defines}set worldUnits(e){e?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}get lineWidth(){return this.uniforms.linewidth.value}set lineWidth(e){this.linewidth=e,this.uniforms.linewidth.value=e}get dashed(){return Boolean("USE_DASH"in this.defines)}set dashed(e){Boolean(e)!==Boolean("USE_DASH"in this.defines)&&(this.needsUpdate=!0),e?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashScale(){return this.uniforms.dashScale.value}set dashScale(e){this.uniforms.dashScale.value=e}get dashSize(){return this.uniforms.dashSize.value}set dashSize(e){this.uniforms.dashSize.value=e}get dashOffset(){return this.uniforms.dashOffset.value}set dashOffset(e){this.uniforms.dashOffset.value=e}get gapSize(){return this.uniforms.gapSize.value}set gapSize(e){this.uniforms.gapSize.value=e}setOpacity(e){this.uniforms.opacity.value=e}get resolution(){return this.uniforms.resolution.value}set resolution(e){this.uniforms.resolution.value.copy(e)}}const ut=new c.Pa4;class wd extends Dt{constructor(){super({worldUnits:!1,vertexColors:!1,linewidth:0,...bs}),this.uniforms.objectId={value:[NaN,NaN,NaN,NaN]}}onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.fragmentShader=`
      uniform vec4 objectId;
      void main() {
        gl_FragColor = objectId;
      }
    `}}const Sa={r:0,g:0,b:0,a:0};class xa extends K{#e;#t;#s;#i;#n;#r;#a;#o;#l=new Float32Array;#d=new Uint8Array;#c;#h;#u;#m=0;#f=0;#b=0;#p=!1;#v;#T;#y=!1;#S;#g=!1;constructor(e){super(e,void 0,{receiveTime:0n,messageTime:0n,frameId:"",pose:{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:0}},settingsPath:[],settings:{visible:!0},topic:e}),this.#e=new ps.z,this.#s=new Dt({worldUnits:!1,colorWrite:!1,vertexColors:!0,linewidth:0,stencilWrite:!0,stencilRef:1,stencilZPass:c.ce8,...bs}),this.#n=new Dt({worldUnits:!1,vertexColors:!0,linewidth:0,stencilWrite:!0,stencilRef:0,stencilFunc:c.RvT,stencilFail:c.ce8,stencilZPass:c.ce8,...bs}),this.#t=new fs.w(this.#e,this.#s),this.#t.renderOrder=gs.LINE_PREPASS,this.#t.userData.picking=!1,this.add(this.#t),this.#i=new fs.w(this.#e,this.#n),this.#i.renderOrder=gs.LINE,this.#i.userData.pickingMaterial=this.#r=new wd,this.add(this.#i)}dispose(){this.#e?.dispose(),this.#s.dispose(),this.#n.dispose(),this.#r.dispose(),this.#h?.dispose(),this.#u?.dispose(),super.dispose()}details(){return this.#v&&this.#T?{annotation:xn(this.#v,this.#T.messagePath),originalMessage:this.#v}:{}}setScale(e,t,s,n){this.#p||=e!==this.#m||t!==this.#f||s!==this.#b,this.#m=e,this.#f=t,this.#b=s}setCameraModel(e){this.#g||=this.#S!==e,this.#S=e}setAnnotation(e,t){this.#y||=this.#T!==e,this.#v=t,this.#T=e}setAnnotationFromCircle(e,t){this.setAnnotation(Id(e),t)}update(){if(!this.#T||!this.#S){this.visible=!1;return}const{points:e,outlineColor:t,outlineColors:s,thickness:n,style:r,fillColor:a}=this.#T,o=e.length;if(o<2){this.visible=!1;return}this.visible=!0;const l=r==="polygon",d=r==="line_strip",h=r==="line_list";if((this.#y||this.#p)&&(this.#n.resolution.set(this.#f,this.#b),this.#n.lineWidth=n*this.#m,this.#n.needsUpdate=!0,this.#s.resolution.set(this.#f,this.#b),this.#s.lineWidth=n*this.#m,this.#s.needsUpdate=!0,this.#r.resolution.set(this.#f,this.#b),this.#r.lineWidth=n*this.#m,this.#r.needsUpdate=!0,this.#p=!1),this.#y||this.#g){if(this.#y=!1,this.#g=!1,this.#o==null||!this.#e||o>this.#o||this.#a!==r){switch(this.#e?.dispose(),this.#o=o,this.#a=r,r){case"polygon":this.#l=new Float32Array((o+1)*3),this.#e=new jt.L;break;case"line_strip":this.#l=new Float32Array(o*3),this.#e=new jt.L;break;case"line_list":{this.#l=new Float32Array(o*3),this.#d=new Uint8Array(o*8),this.#e=new ps.z;const y=new c.$TI(this.#d,8,1);this.#e.setAttribute("instanceColorStart",new c.kB5(y,4,0,!0)),this.#e.setAttribute("instanceColorEnd",new c.kB5(y,4,4,!0));break}}this.#t.geometry=this.#e,this.#i.geometry=this.#e}const f=h,m=s.length===o/2,p=(l||d)&&a!=null&&a.a>0?a:void 0,g=p?new c.bnF:void 0,u=this.#l,x=this.#d;for(let y=0;y<o;y++){const C=e[y];if(this.#S.projectPixelTo3dPlane(ut,C),u[y*3+0]=ut.x,u[y*3+1]=ut.y,u[y*3+2]=ut.z,f){const T=m?s[y>>>1]:s[y]??t??Sa;x[y*4+0]=F(T.r)*255,x[y*4+1]=F(T.g)*255,x[y*4+2]=F(T.b)*255,x[y*4+3]=T.a*255}y===0?g?.moveTo(ut.x,ut.y):g?.lineTo(ut.x,ut.y)}if(l&&(u[o*3+0]=u[0],u[o*3+1]=u[1],u[o*3+2]=u[2],f&&(x[o*4+0]=x[0],x[o*4+1]=x[1],x[o*4+2]=x[2],x[o*4+3]=x[3]),g?.closePath()),p?(this.#h&&(this.#h.dispose(),this.#h=void 0),this.#h=new c.oa8(g),this.#u??=new c.vBJ({side:c.ehD,...bs}),this.#c?this.#c.geometry=this.#h:(this.#c=new c.Kj0(this.#h,this.#u),this.#c.renderOrder=gs.FILL,this.add(this.#c)),this.#c.position.set(0,0,1),this.#u.color.setRGB(p.r,p.g,p.b).convertSRGBToLinear(),this.#u.opacity=p.a,this.#u.needsUpdate=!0):(this.#h?.dispose(),this.#u?.dispose(),this.#c?.removeFromParent(),this.#h=void 0,this.#u=void 0,this.#c=void 0),f)this.#s.vertexColors=!0,this.#n.vertexColors=!0,this.#n.color.setRGB(1,1,1),this.#n.setOpacity(1),this.#e.getAttribute("instanceColorStart").needsUpdate=!0,this.#e.getAttribute("instanceColorEnd").needsUpdate=!0;else{const y=t??Sa;this.#s.vertexColors=!1,this.#n.vertexColors=!1,this.#n.color.setRGB(y.r,y.g,y.b).convertSRGBToLinear(),this.#n.setOpacity(y.a)}switch(this.#n.needsUpdate=!0,this.#e.setPositions(u),r){case"polygon":this.#e.instanceCount=o;break;case"line_strip":this.#e.instanceCount=o-1;break;case"line_list":this.#e.instanceCount=o>>>1;break}}}}function Id(i){const{position:{x:t,y:s},radius:n}=i;return{type:"points",stamp:i.stamp,style:"polygon",points:new Array(32).fill(void 0).map((r,a)=>{const o=2*Math.PI*a/32;return{x:t+n*Math.cos(o),y:s+n*Math.sin(o)}}),outlineColors:[],outlineColor:i.outlineColor,thickness:i.thickness,fillColor:i.fillColor,messagePath:i.messagePath}}class At extends c.u9r{attributes={};#e=new Map;#t;#s=0;constructor(e=c.dj0){super(),this.#t=e}setUsage(e){this.#t=e;for(const t of Object.values(this.attributes))t.setUsage(e)}createAttribute(e,t,s,n){const r=new t(this.#s*s),a=new c.TlE(r,s,n);return a.setUsage(this.#t),this.#e.set(e,t),this.setAttribute(e,a)}resize(e){if(this.setDrawRange(0,e),e<=this.#s){for(const t of Object.values(this.attributes))t.count=e;return}for(const[t,s]of Object.entries(this.attributes)){const n=this.#e.get(t);if(!n)throw new Error(`DynamicBufferGeometry resize(${e}) failed, missing data constructor for attribute "${t}". Attributes must be created using createAttribute().`);const r=new n(e*s.itemSize),a=new c.TlE(r,s.itemSize,s.normalized);a.setUsage(this.#t),this.setAttribute(t,a)}this.#s=e}}const si=new c.Pa4;class Cd extends c.jyz{constructor(){super({vertexShader:c.WdD.points_vert,fragmentShader:`
        uniform vec4 objectId;
        void main() {
          gl_FragColor = objectId;
        }
      `,uniforms:{...c.rBU.points,...c.rBU.fog,objectId:{value:[NaN,NaN,NaN,NaN]}}})}}class Md extends K{#e;#t;#s;#i;#n=0;#r=0;#a=!1;#o;#l;#d=!1;#c;#h=!1;constructor(e){super(e,void 0,{receiveTime:0n,messageTime:0n,frameId:"",pose:{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:0}},settingsPath:[],settings:{visible:!0},topic:e}),this.#e=new At,this.#e.createAttribute("position",Float32Array,3),this.#e.createAttribute("color",Uint8Array,4,!0),this.#s=new c.UY4({size:0,sizeAttenuation:!1,vertexColors:!0,...bs}),this.#i=new Cd,this.#t=new c.woe(this.#e,this.#s),this.#t.renderOrder=gs.POINTS,this.#t.userData.pickingMaterial=this.#i,this.add(this.#t)}dispose(){this.#e.dispose(),this.#s.dispose(),this.#i.dispose(),super.dispose()}details(){return this.#o&&this.#l?{annotation:xn(this.#o,this.#l.messagePath),originalMessage:this.#o}:{}}setScale(e,t,s,n){this.#a||=e!==this.#n||n!==this.#r,this.#n=e,this.#r=n}setCameraModel(e){this.#h||=this.#c!==e,this.#c=e}setAnnotation(e,t){this.#d||=this.#l!==e,this.#o=t,this.#l=e}update(){if(!this.#l||!this.#c){this.visible=!1;return}if(this.visible=!0,this.#d||this.#a){this.#a=!1;const{thickness:e}=this.#l;this.#s.size=e*2*this.#n,this.#s.needsUpdate=!0,this.#i.uniforms.size.value=e*2*this.#n*this.#r,this.#i.needsUpdate=!0}if(this.#d||this.#h){this.#d=!1,this.#h=!1;const{points:e,outlineColors:t,outlineColor:s,fillColor:n}=this.#l;this.#e.resize(e.length);const r=this.#e.getAttribute("position"),a=this.#e.getAttribute("color"),o=r.array,l=a.array,d=s&&s.a>0?s:n;for(let h=0;h<e.length;h++){const f=t[h]??d,m=e[h];this.#c.projectPixelTo3dPlane(si,m),o[h*3+0]=si.x,o[h*3+1]=si.y,o[h*3+2]=si.z,l[h*4+0]=F(f?.r??0)*255,l[h*4+1]=F(f?.g??0)*255,l[h*4+2]=F(f?.b??0)*255,l[h*4+3]=(f?.a??0)*255}r.needsUpdate=!0,a.needsUpdate=!0}}}class Dd extends K{#e;#t;#s=0;#i=!1;#n;#r;#a=!1;#o;#l=!1;constructor(e,t){super(e,void 0,{receiveTime:0n,messageTime:0n,frameId:"",pose:{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:0}},settingsPath:[],settings:{visible:!0},topic:e}),this.#e=t,this.#t=t.acquire(),this.#t.mesh.renderOrder=gs.TEXT,this.#t.setAnchorPoint(0,0),this.#t.setBillboard(!0),this.#t.setSizeAttenuation(!1),this.add(this.#t)}dispose(){this.#t.mesh.renderOrder=0,this.#e.release(this.#t),super.dispose()}details(){return this.#n&&this.#r?{annotation:xn(this.#n,this.#r.messagePath),originalMessage:this.#n}:{}}setScale(e,t,s,n){this.#i||=e!==this.#s,this.#s=e}setCameraModel(e){this.#l||=this.#o!==e,this.#o=e}setAnnotation(e,t){this.#a||=this.#r!==e,this.#n=t,this.#r=e}update(){if(!this.#r||!this.#o){this.visible=!1;return}this.visible=!0;const{position:e,text:t,textColor:s,backgroundColor:n,fontSize:r}=this.#r;(this.#a||this.#i)&&(this.#t.setLineHeight(r*this.#s),this.#i=!1),this.#a&&(this.#t.setText(t),this.#t.setColor(F(s.r),F(s.g),F(s.b)),this.#t.setOpacity(Math.min(s.a,.999)),n?this.#t.setBackgroundColor(F(n.r),F(n.g),F(n.b)):Hs(s.r,s.g,s.b)<.5?this.#t.setBackgroundColor(1,1,1):this.#t.setBackgroundColor(0,0,0)),(this.#a||this.#l)&&this.#o.projectPixelTo3dPlane(this.#t.position,e),this.#a=!1,this.#l=!1}}class Ad extends c.Tme{#e;#t=[];#s=[];#i=[];#n=0;#r=0;#a=0;#o=0;#l=!1;#d=[];#c=!1;#h;#u=!1;#m;#f;constructor(e,t){super(),this.#e=t,this.#f=e}dispose(){for(const e of this.#t)e.dispose();for(const e of this.#s)e.dispose()}setScale(e,t,s,n){this.#l||=this.#n!==e,this.#n=e,this.#r=t,this.#a=s,this.#o=n}setOriginalMessage(e){this.#m=e}setCameraModel(e){this.#u||=this.#h!==e,this.#h=e}setAnnotations(e){this.#c||=this.#d!==e,this.#d=e}update(){if(this.#l){this.#l=!1;for(const r of this.#t)r.setScale(this.#n,this.#r,this.#a,this.#o);for(const r of this.#s)r.setScale(this.#n,this.#r,this.#a,this.#o);for(const r of this.#i)r.setScale(this.#n,this.#r,this.#a,this.#o)}if(this.#u){this.#u=!1;for(const r of this.#t)r.setCameraModel(this.#h);for(const r of this.#s)r.setCameraModel(this.#h);for(const r of this.#i)r.setCameraModel(this.#h)}const e=()=>{for(const r of this.#t)r.update();for(const r of this.#s)r.update();for(const r of this.#i)r.update()};if(!this.#c){e();return}this.#c=!1;const t=this.#t.reverse();this.#t=[];const s=this.#s.reverse();this.#s=[];const n=this.#i.reverse();this.#i=[];for(const r of this.#d)switch(r.type){case"circle":{let a=s.pop();a||(a=new xa(this.#f),a.setScale(this.#n,this.#r,this.#a,this.#o),a.setCameraModel(this.#h),this.add(a)),this.#s.push(a),a.setAnnotationFromCircle(r,this.#m);break}case"points":switch(r.style){case"points":{let a=t.pop();a||(a=new Md(this.#f),a.setScale(this.#n,this.#r,this.#a,this.#o),a.setCameraModel(this.#h),this.add(a)),this.#t.push(a),a.setAnnotation(r,this.#m);break}case"polygon":case"line_strip":case"line_list":{let a=s.pop();a||(a=new xa(this.#f),a.setScale(this.#n,this.#r,this.#a,this.#o),a.setCameraModel(this.#h),this.add(a)),this.#s.push(a),a.setAnnotation(r,this.#m);break}}break;case"text":{let a=n.pop();a||(a=new Dd(this.#f,this.#e),a.setScale(this.#n,this.#r,this.#a,this.#o),a.setCameraModel(this.#h),this.add(a)),this.#i.push(a),a.setAnnotation(r,this.#m);break}}e();for(const r of t)r.removeFromParent(),r.dispose();for(const r of s)r.removeFromParent(),r.dispose();for(const r of n)r.removeFromParent(),r.dispose()}}function j(i,e){return e.has(i.schemaName)||(i.convertibleTo?.some(t=>e.has(t))??!1)}const Ed=/^.+\/(?=.)/;function wn(i){return Ed.exec(i)?.[0]}function In(i,e,t){const s=wn(e);s!=null&&i.sort((n,r)=>{const a=t(n).startsWith(s),o=t(r).startsWith(s);return a===o?0:a?-1:1})}const Cn="MISSING_SYNCHRONIZED_ANNOTATION",Pd=new Set(["foxglove_msgs/ImageMarkerArray","foxglove_msgs/msg/ImageMarkerArray","studio_msgs/ImageMarkerArray","studio_msgs/msg/ImageMarkerArray","webviz_msgs/ImageMarkerArray"]),Mn=new Set([...la,...$r,...Vr,...Pd]);class _d extends c.Tme{#e;#t=new Map;#s;#i;#n;#r;#a;constructor(e){super(),this.#e=e,this.#i=e.initialScale,this.#n=e.initialCanvasWidth,this.#r=e.initialCanvasHeight,this.#a=e.initialPixelRatio,e.messageHandler.addListener(this.#o)}getSubscriptions(){return[{type:"schema",schemaNames:Mn,subscription:{handler:this.#e.messageHandler.handleAnnotations}}]}dispose(){for(const e of this.#t.values())e.dispose();this.children.length=0,this.#t.clear()}removeAllRenderables(){for(const e of this.#t.values())e.dispose(),this.remove(e);this.#t.clear()}updateScale(e,t,s,n){this.#i=e,this.#n=t,this.#r=s,this.#a=n;for(const r of this.#t.values())r.setScale(e,t,s,n),r.update()}updateCameraModel(e){this.#s=e;for(const t of this.#t.values())t.setCameraModel(e),t.update()}#o=e=>{if(e.annotationsByTopic!=null)for(const{originalMessage:t,annotations:s}of e.annotationsByTopic.values())this.#l(t,s),this.#e.removeSettingsError(["imageAnnotations",t.topic],Cn);for(const t of e.presentAnnotationTopics??[])this.#e.removeSettingsError(["imageAnnotations",t],Cn);for(const t of e.missingAnnotationTopics??[])this.#e.addSettingsError(["imageAnnotations",t],Cn,"Waiting for annotation message with timestamp matching image. Turn off \u201CSync annotations\u201D to display annotations regardless of timestamp.")};#l(e,t){let s=this.#t.get(e.topic);s||(s=new Ad(e.topic,this.#e.labelPool),s.setScale(this.#i,this.#n,this.#r,this.#a),s.setCameraModel(this.#s),this.#t.set(e.topic,s),this.add(s)),s.setOriginalMessage(e.message),s.setAnnotations(t),s.update()}#d(e){if(e.action!=="update"||e.payload.path.length<2)return;const{value:t,path:s}=e.payload,n=s[1];s[0]==="imageAnnotations"&&s[2]==="visible"&&typeof t=="boolean"&&this.#c(n,t),this.#e.updateSettingsTree()}#c(e,t){this.#e.updateConfig(n=>{n.annotations??={};const r=n.annotations[e]??={};r.visible=t}),this.#e.messageHandler.setConfig({annotations:this.#e.config().annotations});const s=this.#t.get(e);s&&(s.visible=t)}settingsNodes(){const e=[];e.push({path:["imageAnnotations"],node:{label:(0,D.t)("threeDee:imageAnnotations"),enableVisibilityFilter:!0,defaultExpansionState:"expanded"}});const t=this.#e.config(),s=this.#e.topics().filter(n=>j(n,Mn));t.imageTopic&&In(s,t.imageTopic,n=>n.name);for(const n of s){const r=t.annotations?.[n.name];e.push({path:["imageAnnotations",n.name],node:{label:n.name,visible:r?.visible??!1,handler:this.#d.bind(this)}})}return e}}var J=b(41531);const $t=["imageMode","imageTopic"],Et=["imageMode","calibrationTopic"],wa="IMAGE_TOPIC_UNAVAILABLE",Ia="CALIBRATION_TOPIC_UNAVAILABLE",Ca="MISSING_CAMERA_INFO",Ma="IMAGE_TOPIC_DIFFERENT_FRAME",Da="CameraModel",Ld=500,Rd=50,ii=new Set([...ls,...cs,...hs,...us]),Dn=new Set([...zt,...Bt]),ni={synchronize:!1,flipHorizontal:!1,flipVertical:!1,rotation:0,...ia};class Nd extends J.d{#e;#t;#s;#i;#n;#r;#a=new c.FM8;#o=new c.FM8;#l=!1;#d;#c;constructor(e,{canvasSize:t,setHasCalibrationTopic:s}){super("foxglove.ImageMode",e),this.#c=s,this.#e=new ud;const n=this.#x();this.#e.setCanvasSize(t.width,t.height),this.#e.setRotation(n.rotation),this.#e.setFlipHorizontal(n.flipHorizontal),this.#e.setFlipVertical(n.flipVertical),this.#r=new Sd(n),this.#r.addListener(this.#b),e.settings.errors.on("update",this.#w),e.settings.errors.on("clear",this.#w),e.settings.errors.on("remove",this.#w),this.#s=new _d({initialScale:this.#e.getEffectiveScale(),initialCanvasWidth:t.width,initialCanvasHeight:t.height,initialPixelRatio:e.getPixelRatio(),topics:()=>e.topics??[],config:()=>this.#x(),updateConfig:r=>{e.updateConfig(a=>{r(a.imageMode)})},updateSettingsTree:()=>{this.updateSettingsTree()},labelPool:e.labelPool,messageHandler:this.#r,addSettingsError(r,a,o){e.settings.errors.add(r,a,o)},removeSettingsError(r,a){e.settings.errors.remove(r,a)}}),this.add(this.#s),e.input.on("mousedown",r=>{this.#e.getPanOffset(this.#a),this.#o.copy(r),e.input.trackDrag(a=>{this.#e.setPanOffset(a.clone().sub(this.#o).add(this.#a)),this.#l=!0,this.dispatchEvent({type:"hasModifiedViewChanged"}),this.renderer.queueAnimationFrame()})}),e.input.on("wheel",(r,a,o)=>{this.#e.updateZoomFromWheel(1-.01*c.M8C.clamp(o.deltaY,-30,30),r),this.#M(),this.#l=!0,this.dispatchEvent({type:"hasModifiedViewChanged"}),this.renderer.queueAnimationFrame()}),this.renderer.on("topicsChanged",this.#h),this.#h()}hasModifiedView(){return this.#l}resetViewModifications(){this.#l=!1,this.#e.resetModifications(),this.#M(),this.dispatchEvent({type:"hasModifiedViewChanged"})}getSubscriptions(){return[{type:"schema",schemaNames:Dn,subscription:{handler:this.#r.handleCameraInfo,shouldSubscribe:this.#m}},{type:"schema",schemaNames:ls,subscription:{handler:this.#r.handleRosRawImage,shouldSubscribe:this.#f}},{type:"schema",schemaNames:cs,subscription:{handler:this.#r.handleRosCompressedImage,shouldSubscribe:this.#f}},{type:"schema",schemaNames:hs,subscription:{handler:this.#r.handleRawImage,shouldSubscribe:this.#f}},{type:"schema",schemaNames:us,subscription:{handler:this.#r.handleCompressedImage,shouldSubscribe:this.#f}}].concat(this.#s.getSubscriptions())}dispose(){this.renderer.settings.errors.off("update",this.#w),this.renderer.settings.errors.off("clear",this.#w),this.renderer.settings.errors.off("remove",this.#w),this.renderer.off("topicsChanged",this.#h),this.#s.dispose(),this.#i?.dispose(),super.dispose()}removeAllRenderables(){this.#n==null&&(this.#n=setTimeout(()=>{this.#n=void 0,this.#i?.dispose(),this.#i?.removeFromParent(),this.#i=void 0,this.#S()},Rd)),this.#s.removeAllRenderables(),this.#r.clear(),this.#d=void 0,super.removeAllRenderables()}#h=()=>{if(this.#x().imageTopic!=null)return;const e=this.renderer.topics?.find(s=>j(s,ii));if(e==null)return;const t=this.#u(e.name);this.renderer.updateConfig(s=>{s.imageMode.imageTopic=e.name,t!=null&&(s.imageMode.calibrationTopic=t.name)}),t&&this.#c(!0)};#u(e){const t=wn(e);if(t!=null)return this.renderer.topics?.find(s=>j(s,Dn)&&s.name.startsWith(t))}settingsNodes(){const e=this.handleSettingsAction,t=this.#x(),{imageTopic:s,calibrationTopic:n,synchronize:r,flipHorizontal:a,flipVertical:o,rotation:l}=t,d=(0,z.Z)(this.renderer.topics??[],u=>{if(j(u,ii))return{label:u.name,value:u.name}}),h=(0,z.Z)(this.renderer.topics??[],u=>{if(j(u,Dn))return{label:u.name,value:u.name}});s&&In(h,s,u=>u.label),h.unshift({label:"None",value:void 0}),s&&!d.some(u=>u.value===s)?this.renderer.settings.errors.add($t,wa,`${s} is not available`):this.renderer.settings.errors.remove($t,wa),n&&!h.some(u=>u.value===n)?this.renderer.settings.errors.add(Et,Ia,`${n} is not available`):this.renderer.settings.errors.remove(Et,Ia);const f=this.renderer.settings.errors.errors.errorAtPath($t),m=this.renderer.settings.errors.errors.errorAtPath(Et),p={};p.imageTopic={label:"Topic",input:"select",value:s,options:d,error:f},p.calibrationTopic={label:"Calibration",input:"select",value:n,options:h,error:m},p.synchronize={input:"boolean",label:"Sync annotations",value:r},p.flipHorizontal={input:"boolean",label:"Flip horizontal",value:a},p.flipVertical={input:"boolean",label:"Flip vertical",value:o},p.rotation={input:"toggle",label:"Rotation",value:l,options:[{label:"0\xB0",value:0},{label:"90\xB0",value:90},{label:"180\xB0",value:180},{label:"270\xB0",value:270}]};const g=pn({config:t,defaults:{gradient:ni.gradient},modifiers:{supportsPackedRgbModes:!1,supportsRgbaFieldsMode:!1,hideFlatColor:!0,hideExplicitAlpha:!0}});return Object.assign(p,g),[{path:["imageMode"],node:{label:"General",defaultExpansionState:"expanded",handler:e,fields:p}},...this.#s.settingsNodes()]}handleSettingsAction=e=>{if(e.action!=="update"||e.payload.path.length===0)return;const t=e.payload.path,s=t[0],n=e.payload.value;if(s==="imageMode"){const r=this.#x();this.saveSetting(t,n);const a=this.#x();if(a.calibrationTopic!==r.calibrationTopic&&(a.calibrationTopic==null&&this.#c(!1),r.calibrationTopic==null&&this.#c(!0)),a.imageTopic!==r.imageTopic&&a.imageTopic!=null){const d=this.#u(a.imageTopic);d&&(this.renderer.updateConfig(h=>{h.imageMode.calibrationTopic=d.name}),this.#c(!0))}a.rotation!==r.rotation&&this.#e.setRotation(a.rotation),a.flipHorizontal!==r.flipHorizontal&&this.#e.setFlipHorizontal(a.flipHorizontal),a.flipVertical!==r.flipVertical&&this.#e.setFlipVertical(a.flipVertical),this.#i?.setSettings({...this.#i.userData.settings,colorMode:a.colorMode,flatColor:a.flatColor,gradient:a.gradient,colorMap:a.colorMap,explicitAlpha:a.explicitAlpha,minValue:a.minValue,maxValue:a.maxValue}),a.synchronize!==r.synchronize&&this.removeAllRenderables(),this.#r.setConfig(a),this.#I()}else return;this.updateSettingsTree()};#m=e=>this.#x().calibrationTopic===e;#f=e=>this.#x().imageTopic===e;#b=(e,t)=>{e.image!=null&&e.image!==t?.image&&this.#v(e.image,e.image.message),e.cameraInfo!=null&&e.cameraInfo!==t?.cameraInfo&&this.#p(e.cameraInfo)};#p=e=>{this.#D(e),this.#I()};#v=(e,t)=>{const s=e.topic,n=(0,M.toNanoSec)(e.receiveTime),r="header"in t?t.header.frame_id:t.frame_id;this.#n!=null&&(clearTimeout(this.#n),this.#n=void 0);const a=this.#g(s,n,t,r);this.#d={topic:e.topic,image:t},this.#t&&(a.userData.cameraInfo=this.#t.info,a.setCameraModel(this.#t.model)),a.name=s,a.userData.receiveTime=n,a.setImage(t,void 0,o=>{this.#y()&&this.#T(o,ca(t))})};#T=(e,t)=>{const s=Od({frameId:t,height:e.height,width:e.width,focalLength:Ld});this.#D(s),this.#I()};#y=()=>this.renderer.config.imageMode.calibrationTopic==null;#S=()=>{this.#t=void 0,this.#e.updateCamera(void 0),this.#e.updateProjectionMatrix()};#g(e,t,s,n){let r=this.#i;if(r)return r;const a=this.#x(),o={...Gt,colorMode:a.colorMode,gradient:a.gradient,colorMap:a.colorMap,minValue:a.minValue,maxValue:a.maxValue,planarProjectionFactor:1};return r=new ra(e,this.renderer,{receiveTime:t,messageTime:s?(0,M.toNanoSec)("header"in s?s.header.stamp:s.timestamp):0n,frameId:this.renderer.normalizeFrameId(n),pose:(0,N.N2)(),settingsPath:$t,topic:e,settings:o,cameraInfo:void 0,cameraModel:void 0,image:s,texture:void 0,material:void 0,geometry:void 0,mesh:void 0}),this.add(r),this.#i=r,r.setRenderBehindScene(),r.visible=!0,r}#A(){const{imageMode:e}=this.renderer.config,{calibrationTopic:t,imageTopic:s}=e;if(t==null&&s==null)return;const n=this.#t?.info,r=this.#i?.userData.image,a=n?.header.frame_id,o=r&&ca(r);return o!=null&&(o!==a?this.renderer.settings.errors.add($t,Ma,`Image topic's frame id (${o}) does not match camera info's frame id (${a})`):this.renderer.settings.errors.remove($t,Ma)),a??o}#x(){const e={...this.renderer.config.imageMode},t=e.colorMode==="rgba-fields"?ni.colorMode:e.colorMode??ni.colorMode;return Ce.Z({},ni,{colorMode:t},e)}#I(){if(this.#t?.info)this.renderer.settings.errors.remove(Et,Ca);else{this.renderer.settings.errors.add(Et,Ca,"Missing camera info for topic");return}if(this.renderer.setFollowFrameId(this.#A()),this.#t?.model){this.#e.updateCamera(this.#t.model),this.#M();const t=this.#i;t&&(t.userData.cameraInfo=this.#t.info,t.setCameraModel(this.#t.model),t.update())}}#D(e){const t=this.#t?.info;if(un(t,e)&&t!=null)return;const n=this.#C(e);n&&(this.#t={model:n,info:e},this.#s.updateCameraModel(n))}#C(e){let t;try{t=new Vi(e),this.renderer.settings.errors.remove(Et,Da)}catch(s){this.#t=void 0;const n=s;this.renderer.settings.errors.add(Et,Da,n.message)}return t}getActiveCamera(){return this.#e}handleResize(e,t,s){this.#e.setCanvasSize(e,t),this.#M()}#M(){this.#s.updateScale(this.#e.getEffectiveScale(),this.renderer.input.canvasSize.width,this.renderer.input.canvasSize.height,this.renderer.getPixelRatio())}setCameraState(){this.#I()}getCameraState(){}#w=()=>{this.updateSettingsTree()};getLatestImage(){if(!this.#d)return;const e=this.#x();return{...this.#d,rotation:e.rotation,flipHorizontal:e.flipHorizontal,flipVertical:e.flipVertical,minValue:e.minValue,maxValue:e.maxValue,colorMode:e.colorMode,colorMap:e.colorMap,gradient:e.gradient,explicitAlpha:e.explicitAlpha,flatColor:e.flatColor}}}const Od=i=>{const{width:e,height:t,focalLength:s,frameId:n}=i,r=e/2,a=t/2,o=s,l=s;return Xs({header:{seq:0,stamp:{sec:0,nsec:0},frame_id:n},height:t,width:e,distortion_model:"",R:[1,0,0,0,1,0,0,0,1],D:[],K:[o,0,r,0,l,a,0,0,1],P:[o,0,r,0,0,l,a,0,0,0,1,0]})};var Fd=b(88724),ri=b(30686),Aa=b(91004);function Ea(i,e){return(t,s)=>{const n=t.getInt8(s+i);return e?Math.max(n/127,-1):n}}function Pa(i,e){return(t,s)=>{const n=t.getUint8(s+i);return e?n/255:n}}function _a(i,e){return(t,s)=>{const n=t.getInt16(s+i,!0);return e?Math.max(n/32767,-1):n}}function La(i,e){return(t,s)=>{const n=t.getUint16(s+i,!0);return e?n/65535:n}}function Ra(i,e){return(t,s)=>{const n=t.getInt32(s+i,!0);return e?Math.max(n/2147483647,-1):n}}function Na(i,e){return(t,s)=>{const n=t.getUint32(s+i,!0);return e?n/4294967295:n}}function Oa(i){return(e,t)=>e.getFloat32(t+i,!0)}function Fa(i){return(e,t)=>e.getFloat64(t+i,!0)}function Pt(i){return!("count"in i&&i.count!==1)}function we(i,e,t=!1,s){if(!Pt(i))return;const n=i.type;if(n==null)switch(s??i.datatype){case B.INT8:return i.offset+1<=e?Ea(i.offset,t):void 0;case B.UINT8:return i.offset+1<=e?Pa(i.offset,t):void 0;case B.INT16:return i.offset+2<=e?_a(i.offset,t):void 0;case B.UINT16:return i.offset+2<=e?La(i.offset,t):void 0;case B.INT32:return i.offset+4<=e?Ra(i.offset,t):void 0;case B.UINT32:return i.offset+4<=e?Na(i.offset,t):void 0;case B.FLOAT32:return i.offset+4<=e?Oa(i.offset):void 0;case B.FLOAT64:return i.offset+8<=e?Fa(i.offset):void 0;default:return}else switch(s??n){case A.NumericType.INT8:return i.offset+1<=e?Ea(i.offset,t):void 0;case A.NumericType.UINT8:return i.offset+1<=e?Pa(i.offset,t):void 0;case A.NumericType.INT16:return i.offset+2<=e?_a(i.offset,t):void 0;case A.NumericType.UINT16:return i.offset+2<=e?La(i.offset,t):void 0;case A.NumericType.INT32:return i.offset+4<=e?Ra(i.offset,t):void 0;case A.NumericType.UINT32:return i.offset+4<=e?Na(i.offset,t):void 0;case A.NumericType.FLOAT32:return i.offset+4<=e?Oa(i.offset):void 0;case A.NumericType.FLOAT64:return i.offset+8<=e?Fa(i.offset):void 0;default:return}}function rt(){return 0}const Ua=["gradient","colormap"],Ud="INVALID_FOXGLOVE_GRID",zd="turbo",kd={r:1,g:1,b:1,a:1},Gd={r:100/255,g:47/255,b:105/255,a:1},Bd={r:227/255,g:177/255,b:135/255,a:1},ai={COLOR_MODE_FLAT:0,COLOR_MODE_RGBA:1,COLOR_MODE_GRADIENT:2,COLOR_MODE_COLORMAP:3},An={COLOR_MAP_TURBO:0,COLOR_MAP_RAINBOW:1},ys={visible:!1,frameLocked:!1,colorMode:"flat",minValue:void 0,maxValue:void 0,flatColor:oe(kd),colorField:void 0,gradient:[oe(Gd),oe(Bd)],colorMap:zd,explicitAlpha:1},za={redReader:rt,greenReader:rt,blueReader:rt,alphaReader:rt};function jd(i){return A.NumericType[i]??`${i}`}function ka(i){switch(i.colorMode){case"flat":return c.rnI;case"gradient":case"colormap":return c.rnI;case"rgba-fields":return c.knz}}const ye={r:0,g:0,b:0,a:1},Ga=[0,0];class $d extends K{dispose(){this.userData.texture.dispose(),this.userData.material.dispose(),this.userData.pickingMaterial.dispose()}details(){return this.userData.foxgloveGrid}syncPickingMaterial(){const{pickingMaterial:e,material:t}=this.userData;e.uniforms=t.uniforms,e.needsUpdate=!0}#e(e,t){const{cell_stride:s}=t;for(const n of t.fields){const{name:r}=n;r==="red"?e.redReader=we(n,s,!0)??rt:r==="green"?e.greenReader=we(n,s,!0)??rt:r==="blue"?e.blueReader=we(n,s,!0)??rt:r==="alpha"&&(e.alphaReader=we(n,s,!0)??rt)}}#t(e,t){const{cell_stride:s}=e;for(const n of e.fields){const{type:r,offset:a,name:o}=n;if(o===t.colorField){const l=we(n,s);if(!l){const d=A.NumericType[r],h=`Grid field "${o}" is invalid. type=${d}, offset=${a}, stride=${s}`;vs(this.renderer,this.userData.topic,h);return}return l}}return rt}updateMaterial(e){const{colorMode:t}=e,{material:s}=this.userData;let n=!1,r=!1;t==="flat"?(R(ye,e.flatColor),r=ye.a<1):t==="gradient"?(R(ye,e.gradient[0]),r=ye.a<1,R(ye,e.gradient[1]),r=r||ye.a<1):t==="colormap"&&(r=e.explicitAlpha<1),r!==s.transparent&&(s.depthWrite=!r,s.transparent=r,n=!0),n&&(s.needsUpdate=!0)}updateUniforms(e,t){const{material:s}=this.userData,{uniforms:{colorMode:n,colorMap:r,colorMapOpacity:a,minValue:o,maxValue:l,minGradientColorLinear:d,maxGradientColorLinear:h}}=s;t.colorMode==="rgba-fields"?n.value=ai.COLOR_MODE_RGBA:n.value=ai[`COLOR_MODE_${t.colorMode.toUpperCase()}`],r.value=An[`COLOR_MAP_${t.colorMap.toUpperCase()}`],a.value=t.explicitAlpha,Qd(Ga,t,e.fields.find(u=>t.colorField===u.name)?.type??A.NumericType.UNKNOWN);const[f,m]=Ga;o.value=f,l.value=m;const p=R(ye,t.gradient[0]);Ut(p,p),d.value.set(p.r,p.g,p.b,p.a);const g=R(ye,t.gradient[1]);Ut(g,g),h.value.set(g.r,g.g,g.b,g.a)}updateTexture(e,t){let s=this.userData.texture;const n=this.#t(e,t);if(!n)return;const r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),{column_count:a,row_stride:o,cell_stride:l}=e,d=e.data.length/o,h=a!==s.image.width||d!==s.image.height,f=Ua.includes(t.colorMode);((f?s.format!==c.hEm:s.format!==c.wk1)||h)&&(s.dispose(),s=Ba(e,t),s.generateMipmaps=!1,this.userData.texture=s,this.userData.material.uniforms.map.value=s);const p=ka(t);if(p!==s.encoding&&(s.encoding=p,s.needsUpdate=!0),f){const g=s.image.data;for(let u=0;u<d;u++)for(let x=0;x<a;x++){const y=u*o+x*l,C=n(r,y),T=u*a+x;g[T]=C}}else{const g=s.image.data;let u=!1;if(t.colorMode==="rgba-fields"){this.#e(za,e);const{redReader:x,greenReader:y,blueReader:C,alphaReader:T}=za;for(let I=0;I<d;I++)for(let _=0;_<a;_++){const P=I*o+_*l,G=(I*a+_)*4,Z=T(r,P);g[G+0]=x(r,P)*255|0,g[G+1]=y(r,P)*255|0,g[G+2]=C(r,P)*255|0,g[G+3]=Z*255|0,Z!==0&&Z!==1&&(u=!0)}}else if(t.colorMode==="flat"){const x=Js(t,0,1);for(let y=0;y<d;y++)for(let C=0;C<a;C++){const T=y*o+C*l,I=n(r,T);x(ye,I);const P=(y*a+C)*4;g[P+0]=Math.floor(ye.r*255),g[P+1]=Math.floor(ye.g*255),g[P+2]=Math.floor(ye.b*255),g[P+3]=Math.floor(ye.a*255),ye.a!==0&&ye.a!==1&&(u=!0)}}this.userData.material.transparent!==u&&(this.userData.material.transparent=u,this.userData.material.depthWrite=!u,this.userData.material.needsUpdate=!0)}this.userData.material.uniforms.map.value.needsUpdate=!0}}class Vd extends J.d{#e=new Map;constructor(e){super("foxglove.Grid",e)}getSubscriptions(){return[{type:"schema",schemaNames:Tn,subscription:{handler:this.#t}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,s=[];for(const n of this.renderer.topics??[]){if(!j(n,Tn))continue;const r=e[n.name]??{},a=pn({msgFields:this.#e.get(n.name),config:r,defaults:ys,modifiers:{supportsPackedRgbModes:!1,supportsRgbaFieldsMode:!0}}),o={order:n.name.toLocaleLowerCase(),icon:"Cells",visible:r.visible??ys.visible,fields:{...a,frameLocked:{label:"Frame lock",input:"boolean",value:r.frameLocked??ys.frameLocked}},handler:t};s.push({path:["topics",n.name],node:o})}return s}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const s=t[1],n=this.renderables.get(s);if(n){const r=this.renderer.config.topics[s];n.userData.settings={...ys,...r},n.updateMaterial(n.userData.settings),n.updateUniforms(n.userData.foxgloveGrid,n.userData.settings),(e.payload.path[2]==="colorMode"||e.payload.path[2]==="colorField"||e.payload.path[2]==="flatColor")&&n.updateTexture(n.userData.foxgloveGrid,n.userData.settings),n.syncPickingMaterial()}};#t=e=>{const t=e.topic,s=Jd(e.message),n=(0,M.toNanoSec)(e.receiveTime);let r=this.renderables.get(t);if(!this.#s(s,e.topic)){r&&(r.visible=!1);return}if(r)r.visible=!0;else{const o=this.renderer.config.topics[t],l={...ys,...o};l.colorField==null&&this.#e.get(t)==null&&(eh(l,s.fields,{supportsPackedRgbModes:!1}),this.renderer.updateConfig(g=>{const u={...o};u.colorField=l.colorField,u.colorMode=l.colorMode,u.colorMap=l.colorMap,g.topics[t]=u}));const d=Ba(s,l),h=this.renderer.sharedGeometry.getGeometry(this.constructor.name,Wd),f=Hd(t,d,h),m=f.material,p=f.userData.pickingMaterial;r=new $d(t,this.renderer,{receiveTime:n,messageTime:(0,M.toNanoSec)(s.timestamp),frameId:this.renderer.normalizeFrameId(s.frame_id),pose:s.pose,settingsPath:["topics",t],settings:l,topic:t,foxgloveGrid:s,mesh:f,texture:d,material:m,pickingMaterial:p}),r.add(f),this.add(r),this.renderables.set(t,r)}let a=this.#e.get(t);(!a||a.length!==s.fields.length)&&(a=s.fields.map(o=>o.name),this.#e.set(t,a),this.updateSettingsTree()),this.#i(r,s,n,r.userData.settings)};#s(e,t){const{cell_stride:s,row_stride:n,column_count:r}=e,a=e.data.byteLength/n;if(e.fields.length===0)return vs(this.renderer,t,"Grid has no fields. At least one field is required for the Grid to be displayed."),!1;if(Math.floor(r)!==r||Math.floor(a)!==a){const d=`Grid column count (${e.column_count}) or row count (${a} = data.byteLength ${e.data.byteLength} / row_stride ${n}) is not an integer.`;return vs(this.renderer,t,d),!1}if(s*r>n){const d=`Grid row_stride (${n}) does not allow for requisite column_count (${r}) with cell stride (${s}). Minimum requisite bytes in row_stride needed: (${r*s}) `;return vs(this.renderer,t,d),!1}let o=0,l;for(const d of e.fields){const h=Zd(d.type);d.offset+h>o&&(o=d.offset+h,l=d)}if(o>s){let d=`Grid cell_stride (${s}) is less than minimum bytes per cell (${o})`;return l&&(d+=` required by \u201C${l.name}\u201D field, type=${jd(l.type)}, offset=${l.offset}`),vs(this.renderer,t,d),!1}return!0}#i(e,t,s,n){e.userData.foxgloveGrid=t,e.userData.pose=t.pose,e.userData.receiveTime=s,e.userData.messageTime=(0,M.toNanoSec)(t.timestamp),e.userData.frameId=this.renderer.normalizeFrameId(t.frame_id);const{row_stride:r,column_count:a}=t,o=t.data.byteLength/r;e.updateMaterial(n),e.updateUniforms(t,n),e.updateTexture(t,n),e.scale.set(t.cell_size.x*a,t.cell_size.y*o,1),e.syncPickingMaterial()}}function Wd(){const i=new c._12(1,1,1,1);return i.translate(.5,.5,0),i.computeBoundingSphere(),i}function vs(i,e,t){i.settings.errors.addToTopic(e,Ud,t)}function Ba(i,e){const{column_count:t,row_stride:s}=i,n=i.data.byteLength/s,r=isFinite(t*n)?t*n:0,a=Ua.includes(e.colorMode),o=a?new Float32Array(r):new Uint8ClampedArray(r*4),l=a?c.hEm:c.wk1,d=a?c.VzW:c.ywz,h=new c.IEO(o,t,n,l,d,c.xfE,c.uWy,c.uWy,c.TyD,c.wem,1,ka(e));return h.generateMipmaps=!1,h}function Hd(i,e,t){const s=Yd(e,i),n=Kd(s),r=new c.Kj0(t,s);return r.castShadow=!0,r.receiveShadow=!0,r.userData.pickingMaterial=n,r}function Zd(i){switch(i){case A.NumericType.INT8:case A.NumericType.UINT8:return 1;case A.NumericType.INT16:case A.NumericType.UINT16:return 2;case A.NumericType.INT32:case A.NumericType.UINT32:case A.NumericType.FLOAT32:return 4;case A.NumericType.FLOAT64:return 8;default:return 0}}function Yd(i,e){return new c.jyz({name:`${e}:Material`,alphaTest:1e-4,side:c.ehD,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]},colorMode:{value:ai.COLOR_MODE_RGBA},colorMap:{value:An.COLOR_MAP_TURBO},colorMapOpacity:{value:1},minValue:{value:0},maxValue:{value:1},minGradientColorLinear:{value:new c.Ltg},maxGradientColorLinear:{value:new c.Ltg},map:{value:i}},vertexShader:`
      varying vec2 vUv;
      void main() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,defines:{...ai,...An,PICKING:0},fragmentShader:`
      uniform vec4 objectId;

      uniform sampler2D map;

      uniform int colorMode;
      uniform float minValue;
      uniform float maxValue;

      uniform int colorMap;
      uniform float colorMapOpacity;

      uniform vec4 minGradientColorLinear;
      uniform vec4 maxGradientColorLinear;

      varying vec2 vUv;

      ${ta}

      // adapted from https://gist.github.com/mikhailov-work/0d177465a8151eb6ede1768d51d476c7
      vec3 turboLinear(float x) {
        const vec4 kRedVec4 = vec4(0.13572138, 4.61539260, -42.66032258, 132.13108234);
        const vec4 kGreenVec4 = vec4(0.09140261, 2.19418839, 4.84296658, -14.18503333);
        const vec4 kBlueVec4 = vec4(0.10667330, 12.64194608, -60.58204836, 110.36276771);
        const vec2 kRedVec2 = vec2(-152.94239396, 59.28637943);
        const vec2 kGreenVec2 = vec2(4.27729857, 2.82956604);
        const vec2 kBlueVec2 = vec2(-89.90310912, 27.34824973);

        vec4 v4 = vec4(1.0, x, x * x, x * x * x);
        vec2 v2 = v4.zw * v4.z;
        return sRGBToLinear(vec3(
          (dot(v4, kRedVec4)   + dot(v2, kRedVec2)),
          (dot(v4, kGreenVec4) + dot(v2, kGreenVec2)),
          (dot(v4, kBlueVec4)  + dot(v2, kBlueVec2))
        ));
      }


      // taken from http://docs.ros.org/jade/api/rviz/html/c++/point__cloud__transformers_8cpp_source.html
      // line 47
      vec3 rainbowLinear(float pct) {
        vec3 colorOut = vec3(0.0);
        float h = (1.0 - clamp(pct, 0.0, 1.0)) * 5.0 + 1.0;
        float i = floor(h);
        float f = mod(h, 1.0);
        // if i is even
        if (mod(i, 2.0) < 1.0) {
          f = 1.0 - f;
        }
        float n = (1.0 - f);

        if (i <= 1.0) {
          colorOut.r = n;
          colorOut.g = 0.0;
          colorOut.b = 1.0;
        } else if (i == 2.0) {
          colorOut.r = 0.0;
          colorOut.g = n;
          colorOut.b = 1.0;
        } else if (i == 3.0) {
          colorOut.r = 0.0;
          colorOut.g = 1.0;
          colorOut.b = n;
        } else if (i == 4.0) {
          colorOut.r = n;
          colorOut.g = 1.0;
          colorOut.b = 0.0;
        } else {
          colorOut.r = 1.0;
          colorOut.g = n;
          colorOut.b = 0.0;
        }
        return sRGBToLinear(colorOut);
      }

      void main() {
        vec4 color = texture2D(map, vUv);
        if(colorMode == COLOR_MODE_RGBA) {
          // input color is in sRGB, texture.encoding is sRGB, so no conversion is needed
          gl_FragColor = color;
        } else if (colorMode == COLOR_MODE_FLAT) {
          // input color was already converted to linear by getColorConverter
          gl_FragColor = color;
        } else {
          // input color was already converted to linear by getColorConverter
          float delta = max(maxValue - minValue, 0.00001);
          float colorValue = color.r;
          float normalizedColorValue = clamp((colorValue - minValue) / delta, 0.0, 1.0);
          if(colorMode == COLOR_MODE_GRADIENT) {
            /**
            * Computes a gradient step from colors a to b using pre-multiplied alpha to
            * match CSS linear gradients. The inputs are assumed to not have pre-multiplied
            * alpha, and the output will have pre-multiplied alpha.
            */
            vec4 weightedMinColor = vec4(minGradientColorLinear.rgb * minGradientColorLinear.a, minGradientColorLinear.a);
            vec4 weightedMaxColor = vec4(maxGradientColorLinear.rgb * maxGradientColorLinear.a, maxGradientColorLinear.a);
            vec4 finalColor = mix(weightedMinColor, weightedMaxColor, normalizedColorValue);
            // gradient computation takes place in linear colorspace
            gl_FragColor = finalColor;
          } else if(colorMode == COLOR_MODE_COLORMAP) {
            // colormap
            if(colorMap == COLOR_MAP_TURBO) {
              gl_FragColor = vec4(turboLinear(normalizedColorValue), colorMapOpacity);
            } else if(colorMap == COLOR_MAP_RAINBOW) {
              gl_FragColor = vec4(rainbowLinear(normalizedColorValue), colorMapOpacity);
            }
          }
        }
        if(gl_FragColor.a < 0.00001) {
          discard;
        }
        if(PICKING == 1) {
          gl_FragColor = objectId;
        } else {
          #include <encodings_fragment>
        }
      }
    `})}function Kd(i){const e=new c.jyz;return e.copy(i),e.name="",e.defines.PICKING=1,e.uniformsNeedUpdate=!0,e.needsUpdate=!0,e}function Xd(i){return{name:i?.name??"",offset:i?.offset??0,type:i?.type??0}}function Jd(i){return{timestamp:ce(i.timestamp),pose:te(i.pose),frame_id:i.frame_id??"",row_stride:i.row_stride??0,cell_stride:i.cell_stride??0,column_count:i.column_count??0,cell_size:{x:i.cell_size?.x??1,y:i.cell_size?.y??1},fields:i.fields?.map(Xd)??[],data:kt(i.data)}}function Qd(i,e,t){if(!Jr.includes(e.colorMode))return;const[s,n]=qd[t],r=e.minValue??s,a=e.maxValue??n;i[0]=r,i[1]=a}const qd={[A.NumericType.UNKNOWN]:[0,1],[A.NumericType.UINT8]:[0,255],[A.NumericType.UINT16]:[0,65535],[A.NumericType.UINT32]:[0,Math.pow(2,32)-1],[A.NumericType.INT8]:[-128,127],[A.NumericType.INT16]:[-Math.pow(2,16-1),-Math.pow(2,16-1)-1],[A.NumericType.INT32]:[-Math.pow(2,32-1),-Math.pow(2,32-1)-1],[A.NumericType.FLOAT32]:[0,1],[A.NumericType.FLOAT64]:[0,1]};function eh(i,e,{supportsPackedRgbModes:t}){if(t)for(const s of e){const n=s.name.toLowerCase();if(fn.has(n)){switch(i.colorField=s.name,n){case"rgb":i.colorMode="rgb";break;default:case"rgba":i.colorMode="rgba";break}return}}if(ea(e.map(s=>s.name))){i.colorMode="rgba-fields";return}if(e.length>0){const s=e[0];i.colorField=s.name,i.colorMode="colormap",i.colorMap="turbo";return}}var ja=b(57718),$a=b(77075),En=b(21385);class th extends c.nls{constructor(...e){super(...e),this.defines??={},this.defines.USE_INSTANCING=!0}}var Va=b(13474);const sh=1,Wa=new c.FM8,ih=new c.JOQ(new c.Pa4(0,0,1),0);class nh extends ri.Z{getCamera;#e;canvasSize;#t;#s;#i=new c.FM8;#n;#r=new c.iMs;constructor(e,t){super(),this.getCamera=t;const s=e.parentElement;if(!s)throw new Error("<canvas> must be parented to a DOM element");this.#e=e,this.canvasSize=new c.FM8,this.#a([]);const n=Va.Z(this.#a);this.#t=new ResizeObserver(n),this.#t.observe(s),e.addEventListener("mousedown",this.#o),e.addEventListener("mousemove",this.#l),e.addEventListener("mouseup",this.#d),e.addEventListener("click",this.#c),e.addEventListener("wheel",this.#h),e.addEventListener("touchstart",this.#u,{passive:!1}),e.addEventListener("touchend",this.#m,{passive:!1}),e.addEventListener("touchmove",this.#f,{passive:!1}),e.addEventListener("touchcancel",this.#b,{passive:!1})}dispose(){const e=this.#e;this.removeAllListeners(),this.#t.disconnect(),e.removeEventListener("mousedown",this.#o),e.removeEventListener("mousemove",this.#l),e.removeEventListener("mouseup",this.#d),e.removeEventListener("click",this.#c),e.removeEventListener("wheel",this.#h),e.removeEventListener("touchstart",this.#u),e.removeEventListener("touchend",this.#m),e.removeEventListener("touchmove",this.#f),e.removeEventListener("touchcancel",this.#b)}trackDrag(e){const t=s=>{s.preventDefault(),this.#p(s),e(this.#i)};window.addEventListener("mousemove",t),window.addEventListener("mouseup",()=>{window.removeEventListener("mousemove",t)},{once:!0})}#a=e=>{if(this.#e.parentElement){const t=rh(this.#e.parentElement);if(isNaN(t.width)||isNaN(t.height))return;(t.width!==this.canvasSize.width||t.height!==this.canvasSize.height)&&(this.canvasSize.width=t.width,this.canvasSize.height=t.height,this.emit("resize",this.canvasSize))}};#o=e=>{this.#s=new c.FM8(e.offsetX,e.offsetY),this.#p(e),this.emit("mousedown",this.#i,this.#n,e)};#l=e=>{this.#p(e),this.emit("mousemove",this.#i,this.#n,e)};#d=e=>{this.#p(e),this.emit("mouseup",this.#i,this.#n,e)};#c=e=>{if(!this.#s)return;const t=this.#s.distanceTo(Wa.set(e.offsetX,e.offsetY));this.#s=void 0,!(t>sh)&&(this.#p(e),this.emit("click",this.#i,this.#n,e))};#h=e=>{this.#p(e),this.emit("wheel",this.#i,this.#n,e)};#u=e=>{const t=e.touches[0];t&&(this.#s=new c.FM8(t.clientX,t.clientY)),e.preventDefault()};#m=e=>{e.preventDefault()};#f=e=>{e.preventDefault()};#b=e=>{e.preventDefault()};#p(e){const t=this.#e.getBoundingClientRect(),s=e.clientX-t.left,n=e.clientY-t.top;this.#i.x=s,this.#i.y=n,this.#r.setFromCamera(Wa.set(s/this.canvasSize.width*2-1,-(n/this.canvasSize.height*2-1)),this.getCamera()),this.#n=this.#r.ray.intersectPlane(ih,this.#n??new c.Pa4)??void 0}}function rh(i){const e=getComputedStyle(i),t=parseFloat(e.paddingLeft)+parseFloat(e.paddingRight),s=parseFloat(e.paddingTop)+parseFloat(e.paddingBottom),n=parseFloat(e.borderLeftWidth)+parseFloat(e.borderRightWidth),r=parseFloat(e.borderTopWidth)+parseFloat(e.borderBottomWidth),a=i.clientWidth-t-n,o=i.clientHeight-s-r;return{width:a,height:o}}var ah=b(83829),oh=b(20111),lh=b(14666),ch=b(31031),dh=b(556),hh=b(81497),uh=b(28575),fh=b(30224),ph="../../packages/studio-base/src/panels/ThreeDeeRender/ModelCache.ts";const oi=Y.ZP.getLogger(ph),Pn="y_up",mh=new c.Ilk(2395903).convertSRGBToLinear(),gh=["model/gltf","model/gltf-binary","model/gltf+json"],bh=["model/stl","model/x.stl-ascii","model/x.stl-binary","application/sla"],yh=["model/vnd.collada+xml"],vh=["model/obj","text/prs.wavefront-obj"];class Th{options;#e=new TextDecoder;#t=new Map;#s;#i;#n;constructor(e){this.options=e,this.#s=e.edgeMaterial,this.#i=e.fetchAsset}async load(e,t,s){let n=this.#t.get(e);return n?await n:(n=this.#r(e,t,s).then(r=>Sh(r,this.#s)).catch(async r=>{s(r)}),this.#t.set(e,n),await n)}async#r(e,t,s){const r=await this.#i(e),a=r.data;if(a.byteLength<4)throw new Error(`${a.byteLength} bytes received`);const o=new DataView(a.buffer,a.byteOffset,a.byteLength),l=t.overrideMediaType??r.mediaType??"";if(o.getUint32(0,!1)===1735152710||gh.includes(l)||/\.glb$/i.test(e)||/\.gltf$/i.test(e))return await this.#a(e,s);if(bh.includes(l)||/\.stl$/i.test(e))return this.#o(e,a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength),this.options.meshUpAxis);if(yh.includes(l)||/\.dae$/i.test(e)){const d=this.#e.decode(a);return await this.#l(e,d,this.options.ignoreColladaUpAxis,s)}if(vh.includes(l)||/\.obj$/i.test(e)){const d=this.#e.decode(a);return await this.#d(e,d,this.options.meshUpAxis,s)}throw new Error(`Unknown ${a.byteLength} byte mesh (content-type: "${l}")`)}async#a(e,t){const s=o=>{const l=Rn(o);oi.error(`Failed to load GLTF asset "${l}" for "${e}"`),t(new Error(`Failed to load GLTF asset "${l}"`))},n=new c.lLk(void 0,void 0,s);n.setURLModifier(Ln);const r=new hh.E(n);r.setMeshoptDecoder(ah.z$),r.setDRACOLoader(this.#c(n)),n.itemStart(e);const a=await r.loadAsync(e);return n.itemEnd(e),a.scene.rotateX(Math.PI/2),a.scene}#o(e,t,s){const r=new fh.j().parse(t);oi.debug(`Finished loading STL from ${e}`);const a=new c.Wid({name:e.slice(-32),color:mh,metalness:0,roughness:1,dithering:!0}),o=new c.Kj0(r,a),l=new c.ZAu;return l.add(o),s==="y_up"&&l.rotateX(Math.PI/2),l}async#l(e,t,s,n){const r=m=>{const p=Rn(m);oi.error(`Failed to load COLLADA asset "${p}" for "${e}"`),n(new Error(`Failed to load COLLADA asset "${p}"`))},a=new DOMParser().parseFromString(t,"application/xml"),o=s?"Z_UP":(a.querySelector("up_axis")?.textContent??"Y_UP").trim().toUpperCase();a.querySelectorAll("up_axis").forEach(m=>{m.remove()});const l=a.documentElement.outerHTML,d=new c.lLk(void 0,void 0,r);d.setURLModifier(Ln);const h=new ch.G(d);d.itemStart(e);const f=h.parse(l,Ih(e));return d.itemEnd(e),o==="Y_UP"&&f.scene.rotateX(Math.PI/2),xh(f.scene)}async#d(e,t,s,n){const r=d=>{const h=Rn(d);oi.error(`Failed to load OBJ asset "${h}" for "${e}"`),n(new Error(`Failed to load OBJ asset "${h}"`))},a=new c.lLk(void 0,void 0,r);a.setURLModifier(Ln);const o=new uh.L(a);a.itemStart(e);const l=o.parse(t);return a.itemEnd(e),s==="y_up"&&l.rotateX(Math.PI/2),wh(l)}#c(e){let t=this.#n;return t||(t=new dh._(e),t._loadLibrary=async function(s,n){if(s==="draco_wasm_wrapper.js"&&n==="text")return lh;if(s==="draco_decoder.wasm"&&n==="arraybuffer")return await(await fetch(oh)).arrayBuffer();throw new Error(`DRACOLoader attempt to load non-bundled asset: ${s} as ${n}`)},this.#n=t),t.manager=e,t}dispose(){this.#n?.dispose(),this.#n=void 0}}const _n="edges";function Sh(i,e){const t=[];i.traverse(s=>{if(!(s instanceof c.Kj0))return;s.castShadow=!0,s.receiveShadow=!0;const n=new c.TOt(s.geometry,40),r=new c.ejS(n,e);r.name=_n,t.push([r,s])});for(const[s,n]of t)n.add(s);return i}function xh(i){return i.traverse(e=>{if(e instanceof c.Kj0)if(e.material instanceof c.YBo){const t=Ha(e.material);e.material.dispose(),e.material=t}else e.material instanceof c.Wid&&(e.material.dithering=!0)}),i}function wh(i){return i.traverse(e=>{if(e instanceof c.Kj0)if(e.material instanceof c.xoR){const t=Ha(e.material);e.material.dispose(),e.material=t}else e.material instanceof c.Wid&&(e.material.metalness=0,e.material.roughness=1,e.material.dithering=!0)}),i}function Ha(i){const e=new c.Wid({name:i.name}),t=i.shininess??0,s=i;return s.normalScale??=new c.FM8(1,1),e.copy(i),e.metalness=0,e.roughness=1-t/100,e.dithering=!0,e}function Ln(i){return i.startsWith("package://")&&/\.tiff?$/i.test(i)?i.replace("package://","x-foxglove-converted-tiff://"):i}function Rn(i){return i.startsWith("x-foxglove-converted-tiff://")?i.replace("x-foxglove-converted-tiff://","package://"):i}function Ih(i){return i.slice(0,i.lastIndexOf("/")+1)}const Ts=31,Ch=new c.FM8(0,0),Nn=new c.Ilk(16777215),Za=null;class Mh{#e;#t;#s;#i=new Map;#n;#r;#a=new c.Ilk;#o;#l=!1;constructor(e,t){this.#e=e,this.#t=t,this.#o=new c.dd2(Ts,Ts,{minFilter:c.TyD,magFilter:c.TyD,format:c.wk1,encoding:c.rnI,generateMipmaps:!1}),this.#r=new Uint8Array(4),this.#n=new c.xsS}dispose(){for(const e of this.#i.values())e.dispose();this.#i.clear(),this.#o.dispose()}pick(e,t,s,n={}){this.#n.onAfterRender=this.#b,this.#s=s;const{xInView:r,yInView:a}=this.#d(e,t,n),o=this.#h();this.#e.render(this.#n,s),this.#e.readRenderTargetPixels(this.#o,r,a,1,1,this.#r),this.#u(o),this.#c(n);const l=(this.#r[0]<<24)+(this.#r[1]<<16)+(this.#r[2]<<8)+this.#r[3];return n.debug===!0&&this.#m(s),l}pickInstance(e,t,s,n,r={}){this.#n.onAfterRender=this.#p.bind(this,n),this.#s=s;const{xInView:a,yInView:o}=this.#d(e,t,r),l=this.#h();return this.#e.render(this.#n,this.#s),this.#e.readRenderTargetPixels(this.#o,a,o,1,1,this.#r),this.#u(l),this.#c(r),r.debug===!0&&this.#f(s,n),(this.#r[0]<<24)+(this.#r[1]<<16)+(this.#r[2]<<8)+this.#r[3]}#d(e,t,s){(0,q.assert)(this.#s,"camera must be set before updating for pick");const n=this.#e.domElement.width,r=this.#e.domElement.height,a=this.#e.getPixelRatio();if(s.disableSetViewOffset!==!0){const o=Ts/2|0,l=Math.max(0,e*a-o),d=Math.max(0,t*a-o);return this.#s.setViewOffset(n,r,l,d,Ts,Ts),{xInView:o,yInView:o}}else{(this.#o.width!==n||this.#o.height!==r)&&this.#o.setSize(n,r);const o=Math.max(0,e*a),l=Math.max(0,r-t*a);return{xInView:o,yInView:l}}}#c(e){(0,q.assert)(this.#s,"camera must be set before resetting from pick"),e.disableSetViewOffset!==!0&&this.#s.clearViewOffset()}#h(){const e=this.#e.getRenderTarget(),t=this.#e.getClearAlpha();return this.#e.getClearColor(this.#a),this.#e.setRenderTarget(this.#o),this.#e.setClearColor(Nn,1),this.#e.clear(),{originalRenderTarget:e,originalAlpha:t}}#u({originalRenderTarget:e,originalAlpha:t}){this.#e.setRenderTarget(e),this.#e.setClearColor(this.#a,t)}#m(e){this.#l=!0,this.#n.onAfterRender=this.#b;const t=this.#e.getClearAlpha();this.#e.getClearColor(this.#a),this.#e.setClearColor(Nn,1),this.#e.clear(),this.#e.render(this.#n,e),this.#e.setClearColor(this.#a,t),this.#l=!1}#f(e,t){this.#l=!0,this.#n.onAfterRender=this.#p.bind(this,t);const s=this.#e.getClearAlpha();this.#e.getClearColor(this.#a),this.#e.setClearColor(Nn,1),this.#e.clear(),this.#e.render(this.#n,e),this.#e.setClearColor(this.#a,s),this.#l=!1}#b=()=>{const e=this.#e.renderLists.get(this.#t,0);e.opaque.forEach(this.#v),e.transmissive.forEach(this.#v),e.transparent.forEach(this.#v)};#p(e){e.traverseVisible(t=>{const s=t;if(s.id!=null&&s.geometry&&s.material){const n={id:s.id,object:t,geometry:s.geometry,material:s.material,program:void 0,groupOrder:0,renderOrder:0,z:0,group:null};this.#T(n)}})}#v=e=>{if(!this.#s)return;const t=e.object,s=this.#l?Ah(t.id):t.id,n=e.material,r=e.geometry;if(!r||e.object.userData.picking===!1)return;const a=n.type==="SpriteMaterial",o=Ch.set(this.#o.width,this.#o.height),l=n.sizeAttenuation===!0,d=e.object.userData.pickingMaterial;d?.uniforms.resolution!=null&&d.uniforms.resolution.value.copy(o);const h=d??this.#y({isSprite:a,sizeAttenuation:l,depthTest:n.depthTest,depthWrite:n.depthWrite});a&&(h.uniforms.rotation={value:n.rotation},h.uniforms.center={value:t.center}),Dh(h,s),h.uniformsNeedUpdate=!0,this.#e.renderBufferDirect(this.#s,Za,r,h,t,null)};#T=e=>{if(!this.#s)return;const t=e.object,s=e.geometry;if(!s||e.object.userData.picking===!1)return;const r=e.object.userData.instancePickingMaterial??this.#S();this.#e.renderBufferDirect(this.#s,Za,s,r,t,null)};#y({isSprite:e,sizeAttenuation:t,depthTest:s,depthWrite:n}){const r=(e?1:0)<<0|(t?1:0)<<1|(s?1:0)<<2|(n?1:0)<<3;let a=this.#i.get(r);if(a)return a;let o=c.WdD.meshbasic_vert;return e&&(o=c.WdD.sprite_vert),t&&(o=`#define USE_SIZEATTENUATION

`+o),a=new c.jyz({vertexShader:o,fragmentShader:`
          uniform vec4 objectId;
          void main() {
            gl_FragColor = objectId;
          }
        `,side:c.ehD,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]}},depthTest:s,depthWrite:n}),this.#i.set(r,a),a}#S(){let t=this.#i.get(-1);if(t)return t;let s=c.WdD.meshbasic_vert;return s=s.replace("void main() {",`
      varying vec4 objectId;

      void main() {
        objectId = vec4(
          float((gl_InstanceID >> 24) & 255) / 255.0,
          float((gl_InstanceID >> 16) & 255) / 255.0,
          float((gl_InstanceID >> 8) & 255) / 255.0,
          float(gl_InstanceID & 255) / 255.0);
      `),t=new c.jyz({vertexShader:s,fragmentShader:`
          varying vec4 objectId;
          void main() {
            gl_FragColor = objectId;
          }
        `,side:c.ehD,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]}}}),this.#i.set(-1,t),t}}function Dh(i,e){const t=i.uniforms.objectId;if(!t)throw new Error("objectId uniform not found in picking material");t.value=[(e>>24&255)/255,(e>>16&255)/255,(e>>8&255)/255,(e&255)/255]}const de=new Uint32Array(1);function Ah(i){return de[0]=i|0,de[0]-=de[0]<<6,de[0]^=de[0]>>>17,de[0]-=de[0]<<9,de[0]^=de[0]<<4,de[0]-=de[0]<<3,de[0]^=de[0]<<10,de[0]^=de[0]>>>15,de[0]}class Eh extends c.Tme{#e;constructor(e){super(),this.#e=new c.jyz({transparent:!0,depthTest:!1,depthWrite:!1,uniforms:{color:{value:[1,0,1,1]}},vertexShader:`
        void main() {
          gl_Position = vec4(position.xy, 0.0, 1.0);
        }`,fragmentShader:`
        uniform vec4 color;
        void main() {
          gl_FragColor = color;
        }
      `});const t=e.sharedGeometry.getGeometry(this.constructor.name,Ph),s=new c.Kj0(t,this.#e);s.frustumCulled=!1,this.add(s)}setColor(e,t){const s=this.#e.uniforms.color.value;s[0]=e.r,s[1]=e.g,s[2]=e.b,s[3]=t}}function Ph(){return new c._12(2,2,1,1)}var _h="../../packages/studio-base/src/panels/ThreeDeeRender/LayerErrors.ts";const Vt=["topics",""];class li{path;errorsById;children;constructor(e){this.path=e}errorMessage(){if(this.errorsById&&this.errorsById.size>0)return Array.from(this.errorsById.values()).join(", ")}errorAtPath(e){let t=this;for(const s of e)if(t=t.children?.get(s),!t)return;return t.errorMessage()}clone(){const e=new li(this.path);return e.errorsById=this.errorsById,e.children=this.children,e}}const Lh=Y.ZP.getLogger(_h);class Rh extends ri.Z{errors=new li([]);add(e,t,s){let n=this.errors;for(const a of e)n.children||(n.children=new Map),n.children.has(a)||n.children.set(a,new li([...n.path,a])),n=n.children.get(a);n.errorsById??=new Map;const r=n.errorsById.get(t);r==null&&Lh.warn(`[${e.join(" > ")}] ${s}`),s!==r&&(n.errorsById.set(t,s),this.emit("update",e,t,s))}addToTopic(e,t,s){Vt[1]=e,this.add(Vt,t,s)}hasError(e,t){return this.#e(e)?.errorsById?.has(t)===!0}remove(e,t){const s=this.#e(e);s?.errorsById?.has(t)===!0&&(s.errorsById.delete(t),this.emit("remove",e,t))}removeFromTopic(e,t){Vt[1]=e,this.remove(Vt,t)}clearPath(e){const t=this.#e(e);if(!t)return;let s=!1;t.children&&t.children.size>0&&(t.children.clear(),s=!0),t.errorsById&&t.errorsById.size>0&&(t.errorsById.clear(),s=!0),s&&this.emit("clear",e)}clearTopic(e){Vt[1]=e,this.clearPath(Vt)}clear(){this.clearPath([])}#e(e){let t=this.errors;for(const s of e)if(t=t.children?.get(s),!t)return;return t}}class Nh extends ri.Z{errors=new Rh;#e=new Map;#t={children:{}};#s=[];constructor(e){super(),this.#t={children:e},this.errors.on("update",this.handleErrorUpdate),this.errors.on("remove",this.handleErrorUpdate),this.errors.on("clear",this.handleErrorUpdate)}setNodesForKey(e,t){t.forEach(s=>{this.#s.forEach(n=>{n(s,this.errors)})}),this.#t=(0,re.Uy)(this.#t,s=>{const n=this.#e.get(e);if(n)for(const{path:r}of n)Ya(s,r);for(const{path:r,node:a}of t)a.error??=this.errors.errors.errorAtPath(r),a.label??=r[r.length-1],a.defaultExpansionState??="collapsed",Oh(s,r,a)}),this.#e.set(e,t),this.emit("update")}setLabel(e,t){this.#t=(0,re.Uy)(this.#t,s=>{Fh(s,e,t)}),this.emit("update")}clearChildren(e){this.#t=(0,re.Uy)(this.#t,t=>{Ka(t,e)}),this.emit("update")}tree(){return this.#t.children}handleAction=e=>{const t=e.payload.path;let s=this.#t;s.handler?.(e);for(const n of t){const r=s.children?.[n];if(!r)return;r.handler?.(e),s=r}};addNodeValidator=e=>{this.#s.push(e)};removeNodeValidator=e=>{this.#s=this.#s.filter(t=>t!==e)};handleErrorUpdate=e=>{this.#t=(0,re.Uy)(this.#t,t=>{if(e.length===0)return{...t};let s=t;for(const n of e){const r=s.children?.[n];if(!r)return s.children={...s.children},t;s=r}return s.error=this.errors.errors.errorAtPath(e),t}),this.emit("update")}}function Ya(i,e){if(e.length===0)return!1;const t=e[0],s=i.children?.[t];if(!s)return!1;if(e.length===1){const n=i.children?.[t]!=null;return n&&(i.children[t]=void 0),n}return Ya(s,e.slice(1))}function Ka(i,e){if(e.length===0)return;const t=e[0],s=i.children?.[t];if(s){if(e.length===1){s.children=void 0;return}Ka(s,e.slice(1))}}function Oh(i,e,t){if(e.length===0)throw new Error(`Empty path for settings node "${t.label}"`);let s=i;for(let r=0;r<e.length-1;r++){const a=e[r];s.children||(s.children={}),s.children[a]||(s.children[a]={}),s=s.children[a]}const n=e[e.length-1];s.children||(s.children={}),s.children[n]=t}function Fh(i,e,t){if(e.length===0)throw new Error(`Empty path for settings label "${t}"`);let s=i;for(const n of e)s.children||(s.children={}),s.children[n]||(s.children[n]={}),s=s.children[n];s.label=t}class Uh{#e=new Map;getGeometry(e,t){let s=this.#e.get(e);return s||(s=t(),this.#e.set(e,s)),s}dispose(){for(const e of this.#e.values())e.dispose();this.#e.clear()}}var ve;(function(i){i[i.Low=0]="Low",i[i.Medium=1]="Medium",i[i.High=2]="High"})(ve||(ve={}));function zh(i){return i.maxSamples??0}function Xa(i){switch(i){case ve.Low:return 12;case ve.Medium:return 20;case ve.High:return 32}}function Ja(i){switch(i){case ve.Low:return 12;case ve.Medium:return 20;case ve.High:return 32}}function kh(i){switch(i){case ve.Low:return 12;case ve.Medium:return 20;case ve.High:return 32}}function Gh(i){switch(i){case ve.Low:return 10;case ve.Medium:return 24;case ve.High:return 32}}var On=b(25513),Bh=b(22041),Wt=b(74354);const V=3,tt=1;function Qa(i,e,t){return{label:i,input:"number",min:0,step:.5,precision:V,value:e,placeholder:String(t)}}function jh(i,e){return{label:i,input:"vec3",labels:["X","Y","Z"],step:.5,precision:V,value:e}}function qa(i,e,t){return{label:i,input:"number",min:0,step:.005,precision:4,value:e,placeholder:String(t)}}function $h(i,e){return{label:i,input:"gradient",value:e}}const eo="DISPLAY_FRAME_NOT_FOUND",Vh=new c.Pa4(1,0,0),Wh=new c.Pa4(0,0,1),Hh=Math.PI/2,ft=(0,N.N2)(),Zh=new c.Pa4,to=new c.$V,Yh=new c.USm,Fn=["general","followTf"];class Kh extends J.d{#e;unfollowPoseSnapshot;#t;#s=!1;#i;#n;#r;#a;#o;constructor(e,t,s){super("foxglove.CameraStateSettings",e),e.on("transformTreeUpdated",this.#h),e.on("cameraMove",this.#c),e.settings.errors.on("update",this.#f),e.settings.errors.on("clear",this.#f),e.settings.errors.on("remove",this.#f),this.#i=t,this.#r=new c.cPb,this.#a=new c.iKG,this.#n=new c.ZAu,this.#n.add(this.#r),this.#n.add(this.#a),this.add(this.#n),this.#t=new Bh.z(this.#r,this.#i),this.#t.screenSpacePanning=!1,this.#t.mouseButtons.LEFT=c.RsA.PAN,this.#t.mouseButtons.RIGHT=c.RsA.ROTATE,this.#t.touches.ONE=c.QmN.PAN,this.#t.touches.TWO=c.QmN.DOLLY_ROTATE,this.#t.addEventListener("change",()=>{this.#s||e.emit("cameraMove",e)}),t.tabIndex=1e3,this.#o=s,this.#t.keys={LEFT:"KeyA",RIGHT:"KeyD",UP:"KeyW",BOTTOM:"KeyS"},this.#t.listenToKeyEvents(t)}dispose(){this.renderer.off("cameraMove",this.#c),this.renderer.off("transformTreeUpdated",this.#h),this.renderer.settings.errors.off("update",this.#f),this.renderer.settings.errors.off("clear",this.#f),this.renderer.settings.errors.off("remove",this.#f),super.dispose()}settingsNodes(){return[this.#l(),this.#d()]}#l(){const e=this.renderer.config,{cameraState:t}=e,s=this.handleSettingsAction;return{path:["cameraState"],node:{label:(0,D.t)("threeDee:view"),actions:[{type:"action",id:"reset-camera",label:(0,D.t)("threeDee:reset")}],handler:s,fields:{syncCamera:{label:(0,D.t)("threeDee:syncCamera"),input:"boolean",error:this.renderer.cameraSyncError(),value:e.scene.syncCamera??!1,help:(0,D.t)("threeDee:syncCameraHelp")},distance:{label:(0,D.t)("threeDee:distance"),input:"number",step:1,precision:V,value:t.distance},perspective:{label:(0,D.t)("threeDee:perspective"),input:"boolean",value:t.perspective},targetOffset:{label:(0,D.t)("threeDee:target"),input:"vec3",labels:["X","Y","Z"],precision:V,value:[...t.targetOffset]},thetaOffset:{label:(0,D.t)("threeDee:theta"),input:"number",step:1,precision:tt,value:t.thetaOffset},...t.perspective&&{phi:{label:(0,D.t)("threeDee:phi"),input:"number",step:1,precision:tt,value:t.phi},fovy:{label:(0,D.t)("threeDee:fovy"),input:"number",step:1,precision:tt,value:t.fovy}},near:{label:(0,D.t)("threeDee:near"),input:"number",step:Wt.d.near,precision:V,value:t.near},far:{label:(0,D.t)("threeDee:far"),input:"number",step:1,precision:V,value:t.far}}}}}#d(){const e=this.renderer.config,t=this.handleSettingsAction;let s=this.renderer.coordinateFrameList;const n=this.renderer.followFrameId;this.#m();const r=e.followTf??n;r!=null&&!this.renderer.transformTree.hasFrame(r)&&(s=[{label:N.W$.DisplayName(r),value:r},...s]);const a=this.renderer.settings.errors.errors.errorAtPath(Fn),o=[{label:(0,D.t)("threeDee:pose"),value:"follow-pose"},{label:(0,D.t)("threeDee:position"),value:"follow-position"},{label:(0,D.t)("threeDee:fixed"),value:"follow-none"}],l=this.renderer.config.followMode;return{path:["general"],node:{label:(0,D.t)("threeDee:frame"),fields:{followTf:{label:(0,D.t)("threeDee:displayFrame"),help:(0,D.t)("threeDee:displayFrameHelp"),input:"select",options:s,value:r,error:a},followMode:{label:(0,D.t)("threeDee:followMode"),help:(0,D.t)("threeDee:followModeHelp"),input:"select",options:o,value:l}},defaultExpansionState:"expanded",handler:t}}}handleSettingsAction=e=>{if(e.action==="perform-node-action"&&e.payload.id==="reset-camera"){this.renderer.updateConfig(r=>{r.cameraState=ae.Z(Wt.d)}),this.updateSettingsTree();return}if(e.action!=="update"||e.payload.path.length===0)return;const{path:[t],path:s,value:n}=e.payload;if(t==="cameraState"&&(s[1]==="syncCamera"?this.renderer.updateConfig(r=>{r.scene.syncCamera=n}):this.renderer.updateConfig(r=>On.Z(r,s,n)),this.updateSettingsTree()),t==="general"){if(s[1]==="followTf"){const r=n;this.renderer.updateConfig(a=>{a.followTf=r}),this.#u(),this.renderer.settings.errors.clearPath(["general","followTf"])}else if(s[1]==="followMode"){const r=n;this.renderer.updateConfig(a=>{a.followMode==="follow-none"?(a.cameraState.targetOffset=[...Wt.d.targetOffset],a.cameraState.thetaOffset=Wt.d.thetaOffset):r==="follow-pose"&&(a.cameraState.thetaOffset=Wt.d.thetaOffset),a.followMode=r})}this.updateSettingsTree()}};startFrame(e,t,s){const n=this.renderer.config.followMode;if(n==="follow-pose"||s===N.W$.FALLBACK_FRAME_ID||t===N.W$.FALLBACK_FRAME_ID){this.#e=void 0,this.unfollowPoseSnapshot=void 0,this.#n.position.set(0,0,0),this.#n.quaternion.set(0,0,0,1);return}const r=this.#b(s,t,e),a=this.renderer.transformTree;if(r){if(!Boolean(a.apply(ft,r,t,s,s,e,e)))return;n==="follow-position"?this.#n.position.set(0,0,0):this.#n.position.set(ft.position.x,ft.position.y,ft.position.z),this.#n.quaternion.set(ft.orientation.x,ft.orientation.y,ft.orientation.z,ft.orientation.w)}}#c=()=>{this.updateSettingsTree()};#h=()=>{this.#u(),this.updateSettingsTree()};#u(){const{followTf:e}=this.renderer.config,{transformTree:t}=this.renderer;if(this.#m(),e!=null&&t.hasFrame(e)){this.renderer.setFollowFrameId(e);return}const n=t.getDefaultFollowFrameId();this.renderer.setFollowFrameId(n)}#m=()=>{const{followTf:e}=this.renderer.config,{transformTree:t}=this.renderer;e!=null&&(t.hasFrame(e)?this.renderer.settings.errors.remove(Fn,eo):this.renderer.settings.errors.add(Fn,eo,(0,D.t)("threeDee:frameNotFound",{frameId:e})))};#f=()=>{this.updateSettingsTree()};#b(e,t,s){const n=this.renderer.transformTree;return(this.#e?.fixed!==e||this.#e.render!==t)&&(this.unfollowPoseSnapshot=(0,N.N2)(),n.apply(this.unfollowPoseSnapshot,this.unfollowPoseSnapshot,e,e,t,s,s),this.#e={fixed:e,render:t}),this.unfollowPoseSnapshot}getActiveCamera(){return this.renderer.config.cameraState.perspective?this.#r:this.#a}handleResize(e,t,s){this.#o=e/t,this.setCameraState(this.renderer.config.cameraState)}getCameraState(){const e=this.renderer.config;return{perspective:e.cameraState.perspective,distance:this.#t.getDistance(),phi:c.M8C.radToDeg(this.#t.getPolarAngle()),thetaOffset:c.M8C.radToDeg(-this.#t.getAzimuthalAngle()),targetOffset:[this.#t.target.x,this.#t.target.y,this.#t.target.z],target:e.cameraState.target,targetOrientation:e.cameraState.targetOrientation,fovy:e.cameraState.fovy,near:e.cameraState.near,far:e.cameraState.far}}setCameraState(e){this.#s=!0,this.#p(e),this.renderer.config.followMode==="follow-pose"&&this.#t.update(),this.#s=!1}#p(e){const t=Zh,s=this.renderer.config;t.fromArray(e.targetOffset);const n=c.M8C.degToRad(e.phi),r=-c.M8C.degToRad(e.thetaOffset);if(to.set(e.distance,n,r),this.#r.position.setFromSpherical(to).applyAxisAngle(Vh,Hh),this.#r.position.add(t),this.#r.quaternion.setFromEuler(Yh.set(n,0,r,"ZYX")),this.#r.fov=e.fovy,this.#r.near=e.near,this.#r.far=e.far,this.#r.aspect=this.#o,this.#r.updateProjectionMatrix(),this.#t.target.copy(t),e.perspective)this.#t.minPolarAngle=0,this.#t.maxPolarAngle=Math.PI;else{const a=c.M8C.degToRad(s.cameraState.phi);this.#t.minPolarAngle=this.#t.maxPolarAngle=a,this.#a.position.set(t.x,t.y,e.far/2),this.#a.quaternion.setFromAxisAngle(Wh,r),this.#a.left=-e.distance/2*this.#o,this.#a.right=e.distance/2*this.#o,this.#a.top=e.distance/2,this.#a.bottom=-e.distance/2,this.#a.near=e.near,this.#a.far=e.far,this.#a.updateProjectionMatrix()}}}const ci=new c.Ilk,di=new c.Ilk,at=[0,0,0,0];function We(i,e,t){return`${i}:${e?e+":":""}${t}`.replace(/\s/g,"_")}class Oe extends K{constructor(e,t,s,n){const r=We(e,t.ns,t.id),a=t.lifetime.sec!==0||t.lifetime.nsec!==0;super(r,n,{receiveTime:s??0n,messageTime:(0,M.toNanoSec)(t.header.stamp),frameId:n.normalizeFrameId(t.header.frame_id),pose:t.pose,settingsPath:["topics",e],settings:{visible:!0,frameLocked:t.frame_locked},topic:e,marker:t,originalMarker:t,expiresIn:a?(0,M.toNanoSec)(t.lifetime):void 0})}idFromMessage(){return this.userData.marker.id}selectedIdVariable(){return this.getSettings()?.selectedIdVariable}getSettings(){return this.renderer.config.topics[this.userData.topic]}details(){return this.userData.originalMarker}update(e,t){const s=e.lifetime.sec!==0||e.lifetime.nsec!==0;t!=null&&(this.userData.receiveTime=t),this.userData.messageTime=(0,M.toNanoSec)(e.header.stamp),this.userData.frameId=this.renderer.normalizeFrameId(e.header.frame_id),this.userData.pose=e.pose,this.userData.marker=this.#e(e),this.userData.originalMarker=e,this.userData.expiresIn=s?(0,M.toNanoSec)(e.lifetime):void 0}_markerColorsToLinear(e,t,s){be(ci,e.color);for(let n=0;n<t;n++){const r=e.colors[n];r?(be(di,r),at[0]=di.r,at[1]=di.g,at[2]=di.b,at[3]=r.a):(at[0]=ci.r,at[1]=ci.g,at[2]=ci.b,at[3]=e.color.a),s(at,n)}}#e(e){const t=this.userData.topic,n=this.renderer.config.topics[t]?.color;if(n==null)return e;const r=R(ee(),n);return{...e,color:r,colors:[]}}}function ne(i){switch(i.type){case E.ARROW:case E.CUBE:case E.SPHERE:case E.CYLINDER:case E.TEXT_VIEW_FACING:case E.MESH_RESOURCE:return i.color.a<1;case E.LINE_STRIP:case E.LINE_LIST:case E.CUBE_LIST:case E.SPHERE_LIST:case E.POINTS:case E.TRIANGLE_LIST:default:for(const e of i.colors)if(e.a<1)return!0;return i.colors.length>=i.points.length?!1:i.color.a<1}}function Ht(i){return new c.Wid({color:new c.Ilk(i.r,i.g,i.b).convertSRGBToLinear(),metalness:0,roughness:1,dithering:!0,opacity:i.a,transparent:i.a<1,depthWrite:i.a===1})}function Xh(i){const e=ne(i);return new c.Wid({metalness:0,roughness:1,dithering:!0,vertexColors:!0,side:c.ehD,opacity:1,transparent:e,depthWrite:!e})}function so(i){const e=ne(i);return new c.Wid({metalness:0,roughness:1,dithering:!0,opacity:1,transparent:e,depthWrite:!e})}function io(i,e){const t=i.scale.x,s=ne(i),n=new Dt({worldUnits:e.worldUnits??!0,colorWrite:!1,transparent:s,depthWrite:!s,linewidth:t,resolution:e.resolution.clone(),stencilWrite:!0,stencilRef:1,stencilZPass:c.ce8});return n.lineWidth=t,n}function no(i,e){const t=i.scale.x,s=ne(i),n=new Dt({worldUnits:e.worldUnits??!0,vertexColors:!0,linewidth:t,transparent:s,depthWrite:!s,resolution:e.resolution.clone(),stencilWrite:!0,stencilRef:0,stencilFunc:c.RvT,stencilFail:c.ce8,stencilZPass:c.ce8});return n.lineWidth=t,n}function Un(i,e){return new c.jyz({vertexShader:c.Vj0["foxglove.line"].vertexShader,fragmentShader:`
      uniform vec4 objectId;
      void main() {
        gl_FragColor = objectId;
      }
    `,clipping:!0,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]},linewidth:{value:i},resolution:{value:e.resolution.clone()},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},defines:e.worldUnits??!0?{WORLD_UNITS:""}:{}})}function Jh(i){const e=ne(i);return new c.UY4({vertexColors:!0,size:i.scale.x,sizeAttenuation:!0,transparent:e,depthWrite:!e})}class zn extends Oe{#e;#t;#s;#i=new Float32Array;#n=new Uint8Array;constructor(e,t,s,n,r={}){super(e,t,s,n),this.#e=new ps.z;const{worldUnits:a=!0}=r,o={resolution:this.renderer.input.canvasSize,worldUnits:a},l=io(t,o);this.#t=new fs.w(this.#e,l),this.#t.renderOrder=1,this.#t.userData.picking=!1,this.add(this.#t);const d=no(t,o);this.#s=new fs.w(this.#e,d),this.#s.renderOrder=2;const h=t.scale.x*1.2;this.#s.userData.pickingMaterial=Un(h,o),this.add(this.#s),this.update(t,s)}dispose(){this.#t.material.dispose(),this.#s.material.dispose(),this.#s.userData.pickingMaterial.dispose(),this.#e.dispose()}update(e,t){const s=this.userData.marker;super.update(e,t);const n=this.userData.marker;let r=n.points.length;r%2!==0&&r--;const a=n.scale.x,o=ne(n);o!==ne(s)&&(this.#t.material.transparent=o,this.#t.material.depthWrite=!o,this.#t.material.needsUpdate=!0,this.#s.material.transparent=o,this.#s.material.depthWrite=!o,this.#s.material.needsUpdate=!0);const l=this.#t.material;l.lineWidth=a;const d=this.#s.material;d.lineWidth=a;const h=this.#i.length/3;r>h&&(this.#e.dispose(),this.#e=new ps.z,this.#t.geometry=this.#e,this.#s.geometry=this.#e),this.#r(n,r),this.#a(n,r),this.#s.computeLineDistances()}#r(e,t){3*t>this.#i.length&&(this.#i=new Float32Array(3*t));const s=this.#i;for(let n=0;n<t;n++){const r=e.points[n],a=n*3;s[a+0]=r.x,s[a+1]=r.y,s[a+2]=r.z}this.#e.setPositions(s),this.#e.instanceCount=t>>>1}#a(e,t){if(4*t>this.#n.length){this.#n=new Uint8Array(4*t);const n=new c.$TI(this.#n,8,1);this.#e.setAttribute("instanceColorStart",new c.kB5(n,4,0,!0)),this.#e.setAttribute("instanceColorEnd",new c.kB5(n,4,4,!0))}else this.#e.getAttribute("instanceColorStart").needsUpdate=!0,this.#e.getAttribute("instanceColorEnd").needsUpdate=!0;const s=this.#n;this._markerColorsToLinear(e,t,(n,r)=>{const a=r*4;s[a+0]=Math.floor(255*n[0]),s[a+1]=Math.floor(255*n[1]),s[a+2]=Math.floor(255*n[2]),s[a+3]=Math.floor(255*n[3])})}}var Qh="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/Cameras.ts";const qh=Y.ZP.getLogger(Qh),ro=1,ao=0,oo=.01,eu={r:124/255,g:107/255,b:1,a:1},lo=oe(eu),kn="CameraModel",Gn={visible:!1,frameLocked:!0,distance:ro,planarProjectionFactor:ao,width:oo,color:lo};class tu extends K{dispose(){this.userData.lines?.dispose(),super.dispose()}details(){return this.userData.originalMessage??{}}}class su extends J.d{constructor(e){super("foxglove.Cameras",e)}getSubscriptions(){return[{type:"schema",schemaNames:zt,subscription:{handler:this.#e}},{type:"schema",schemaNames:Bt,subscription:{handler:this.#e}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,s=[];for(const n of this.renderer.topics??[]){if(!(j(n,zt)||j(n,Bt)))continue;const r=e[n.name]??{},a={distance:{label:"Distance",input:"number",placeholder:String(ro),step:.1,precision:V,value:r.distance},planarProjectionFactor:{label:"Planar Projection Factor",input:"number",placeholder:String(ao),min:0,max:1,step:.1,precision:2,value:r.planarProjectionFactor},width:qa("Line Width",r.width,oo),color:{label:"Color",input:"rgba",value:r.color??lo}};s.push({path:["topics",n.name],node:{icon:"Camera",fields:a,visible:r.visible??Gn.visible,handler:t,order:n.name.toLocaleLowerCase()}})}return s}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const s=t[1],n=this.renderables.get(s);if(n){const{cameraInfo:r,receiveTime:a,originalMessage:o}=n.userData;if(r){const l=this.renderer.config.topics[s];this.#t(n,r,o,a,l)}}};#e=e=>{const t=e.topic,s=Xs(e.message),n=(0,M.toNanoSec)(e.receiveTime);let r=this.renderables.get(t);if(!r){const a=(0,M.toNanoSec)(s.header.stamp),o=this.renderer.normalizeFrameId(s.header.frame_id),l=this.renderer.config.topics[t],d={...Gn,...l};r=new tu(t,this.renderer,{receiveTime:n,messageTime:a,frameId:o,pose:(0,N.N2)(),settingsPath:["topics",t],settings:d,topic:t,cameraInfo:void 0,originalMessage:void 0,cameraModel:void 0,lines:void 0}),this.add(r),this.renderables.set(t,r)}this.#t(r,s,e.message,n,r.userData.settings)};#t(e,t,s,n,r){const a=e.userData.settings,o={...Gn,...r},l=o.color===a.color&&o.distance===a.distance&&o.planarProjectionFactor===a.planarProjectionFactor&&o.width===a.width,d=e.userData.topic;e.userData.receiveTime=n,e.userData.messageTime=(0,M.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id),e.userData.settings=o;const h=un(e.userData.cameraInfo,t);if(!h)if(e.userData.cameraInfo=t,e.userData.originalMessage=s,t.P.length===12)try{e.userData.cameraModel=new Vi(t)}catch(f){const m=f;this.renderer.settings.errors.addToTopic(d,kn,m.message),e.userData.cameraModel=void 0,e.userData.lines&&(e.remove(e.userData.lines),e.userData.lines.dispose(),e.userData.lines=void 0)}else this.renderer.settings.errors.addToTopic(d,kn,`P has length ${t.P.length}, not a 3x4 matrix`);if(e.userData.cameraModel!=null&&(!h||!l||!e.userData.lines)){this.renderer.settings.errors.removeFromTopic(d,kn);const f=iu(t,e.userData.cameraModel,e.userData.settings);e.userData.lines?e.userData.lines.update(f,void 0):(e.userData.lines=new zn(d,f,void 0,this.renderer),e.add(e.userData.lines))}}}function Zt(){return{x:0,y:0,z:0}}function iu(i,e,t,s=10){const n={x:0,y:0},r=Ct(Zt(),n,e,t);n.x=i.width,n.y=0;const a=Ct(Zt(),n,e,t);n.x=0,n.y=i.height;const o=Ct(Zt(),n,e,t);n.x=i.width,n.y=i.height;const l=Ct(Zt(),n,e,t),d={x:0,y:0,z:0},h=[d,r,d,a,d,l,d,o];return h.push(r),co(h,0,i,e,s,t),h.push(a),h.push(o),co(h,i.height,i,e,s,t),h.push(l),h.push(r),ho(h,0,i,e,s,t),h.push(o),h.push(a),ho(h,i.width,i,e,s,t),h.push(l),{header:i.header,ns:"",id:0,type:E.LINE_LIST,action:le.ADD,pose:(0,N.N2)(),scale:{x:t.width,y:t.width,z:t.width},color:R(ee(),t.color),lifetime:dt,frame_locked:!0,points:h,colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function co(i,e,t,s,n,r){const a={x:0,y:0};for(let o=1;o<n;o++){a.x=o/n*t.width,a.y=e;const l=Ct(Zt(),a,s,r);i.push(l,l)}}function ho(i,e,t,s,n,r){const a={x:0,y:0};for(let o=1;o<n;o++){a.x=e,a.y=o/n*t.height;const l=Ct(Zt(),a,s,r);i.push(l,l)}}var hi=b(59677),nu=b(40740);const Ss=.154,uo=.02,fo=.046,po=.05,xs=Ss+fo,mo=new c.Ilk(10238280).convertSRGBToLinear(),go=new c.Ilk(8969476).convertSRGBToLinear(),bo=new c.Ilk(2855163).convertSRGBToLinear(),yo={r:1,g:1,b:1,a:1},Yt=Math.PI/2,ot=new c.yGw,pt=new c.Pa4;class ws extends c.Tme{#e;#t;#s;constructor(e,t){super(),this.name=e,this.#e=t;const s=this.#e.sharedGeometry.getGeometry(`${this.constructor.name}-shaft-${this.#e.maxLod}`,()=>ru(this.#e.maxLod));this.#t=new c.SPe(s,vo(yo),3),this.#t.castShadow=!0,this.#t.receiveShadow=!0;const n=this.#e.sharedGeometry.getGeometry(`${this.constructor.name}-head-${this.#e.maxLod}`,()=>au(this.#e.maxLod));this.#s=new c.SPe(n,vo(yo),3),this.#s.castShadow=!0,this.#s.receiveShadow=!0,ws.#i(this.#t,this.#s,0),this.add(this.#t),this.add(this.#s)}dispose(){this.#t.material.dispose(),this.#t.dispose(),this.#s.material.dispose(),this.#s.dispose()}static#i(e,t,s){const n=s*3+0,r=s*3+1,a=s*3+2;pt.set(Ss,uo,uo),e.setMatrixAt(n,ot.identity().scale(pt)),e.setMatrixAt(r,ot.makeRotationZ(Yt).scale(pt)),e.setMatrixAt(a,ot.makeRotationY(-Yt).scale(pt)),pt.set(fo,po,po),ot.identity().scale(pt).setPosition(Ss,0,0),t.setMatrixAt(n,ot),ot.makeRotationZ(Yt).scale(pt).setPosition(0,Ss,0),t.setMatrixAt(r,ot),ot.makeRotationY(-Yt).scale(pt).setPosition(0,0,Ss),t.setMatrixAt(a,ot),e.setColorAt(n,mo),e.setColorAt(r,go),e.setColorAt(a,bo),t.setColorAt(n,mo),t.setColorAt(r,go),t.setColorAt(a,bo)}}function ru(i){const e=Xa(i),t=new c.fHI(.5,.5,1,e,1,!1);return t.rotateZ(-Yt),t.translate(.5,0,0),t.computeBoundingSphere(),t}function au(i){const e=Ja(i),t=new c.b_z(.5,1,e,1,!1);return t.rotateZ(-Yt),t.translate(.5,0,0),t.computeBoundingSphere(),t}function vo(i){return new c.Wid({color:new c.Ilk(i.r,i.g,i.b).convertSRGBToLinear(),metalness:0,roughness:1,dithering:!0,opacity:i.a,transparent:i.a<1,depthWrite:i.a===1})}const ui=1;class ou extends J.d{constructor(e){super("foxglove.SceneSettings",e),e.labelPool.scaleFactor=e.config.scene.labelScaleFactor??ui}dispose(){super.dispose()}settingsNodes(){const e=this.renderer.config,t=this.handleSettingsAction,s={enableStats:{label:(0,D.t)("threeDee:renderStats"),input:"boolean",value:e.scene.enableStats},debugPicking:{label:(0,D.t)("threeDee:debugPicking"),input:"boolean",value:this.renderer.debugPicking},backgroundColor:{label:(0,D.t)("threeDee:background"),input:"rgb",value:e.scene.backgroundColor},labelScaleFactor:{label:(0,D.t)("threeDee:labelScale"),help:(0,D.t)("threeDee:labelScaleHelp"),input:"number",min:0,step:.1,precision:2,value:e.scene.labelScaleFactor,placeholder:String(ui)},ignoreColladaUpAxis:{label:(0,D.t)("threeDee:ignoreColladaUpAxis"),help:(0,D.t)("threeDee:ignoreColladaUpAxisHelp"),input:"boolean",value:e.scene.ignoreColladaUpAxis,error:(e.scene.ignoreColladaUpAxis??!1)!==this.renderer.modelCache.options.ignoreColladaUpAxis?(0,D.t)("threeDee:takeEffectAfterReboot"):void 0},meshUpAxis:{label:(0,D.t)("threeDee:meshUpAxis"),help:(0,D.t)("threeDee:meshUpAxisHelp"),input:"select",value:e.scene.meshUpAxis??Pn,options:[{label:(0,D.t)("threeDee:YUp"),value:"y_up"},{label:(0,D.t)("threeDee:ZUp"),value:"z_up"}],error:(e.scene.meshUpAxis??Pn)!==this.renderer.modelCache.options.meshUpAxis?(0,D.t)("threeDee:takeEffectAfterReboot"):void 0}};return delete s.debugPicking,[{path:["scene"],node:{label:(0,D.t)("threeDee:scene"),actions:[{type:"action",id:"reset-scene",label:(0,D.t)("threeDee:reset")}],fields:s,defaultExpansionState:"collapsed",handler:t}}]}handleSettingsAction=e=>{if(e.action==="perform-node-action"&&e.payload.id==="reset-scene"){this.renderer.updateConfig(r=>{r.scene={}}),this.updateSettingsTree();return}if(e.action!=="update"||e.payload.path.length===0)return;const t=e.payload.path,s=t[0],n=e.payload.value;if(s==="scene"){if(t[1]==="debugPicking"){this.renderer.debugPicking=n??!1,this.updateSettingsTree();return}if(this.renderer.updateConfig(r=>On.Z(r,t,n)),t[1]==="backgroundColor"){const r=n;this.renderer.setColorScheme(this.renderer.colorScheme,r)}else if(t[1]==="labelScaleFactor"){const r=n;this.renderer.labelPool.setScaleFactor(r??ui)}}else return;this.updateSettingsTree()}}const lu=6,cu=Math.PI/2,Bn=!1,fi=1,jn=2,$n="#ffff00",pi=.2,du={visible:!0,frameLocked:!0,xyzOffset:[0,0,0],rpyCoefficient:[0,0,0]};class hu extends K{dispose(){this.renderer.labelPool.release(this.userData.label),super.dispose()}details(){const e=this.renderer.transformTree.frame(this.userData.frameId),t=e?.parent(),s=e?.root();return{child_frame_id:e?.displayName()??"<unknown>",parent_frame_id:t?.displayName()??"<unknown>",fixed_frame_id:s?.displayName()??"<unknown>"}}}const uu=new c.Pa4,fu=new c.Pa4,pu=[0n,N.wx.Identity()],To=[0n,N.wx.Identity()],So=new c._fP,mi=new c.USm,xo=["transforms",""];class mu extends J.d{#e;#t;#s=1;#i=new c.Ilk;#n;#r;constructor(e,t){super("foxglove.FrameAxes",e);const s=this.renderer.config.scene.transforms?.lineWidth??jn,n=Qi(new c.Ilk,this.renderer.config.scene.transforms?.lineColor??$n);this.#e=new nu.Y({linewidth:s}),this.#e.color=n;const r={resolution:e.input.canvasSize,worldUnits:!1};this.#n=this.renderer.sharedGeometry.getGeometry(this.constructor.name,gu),this.#t=Un(lu,r),e.on("transformTreeUpdated",this.#h),this.#r={...du,...t}}dispose(){this.renderer.off("transformTreeUpdated",this.#h),this.#e.dispose(),this.#t.dispose(),super.dispose()}removeAllRenderables(){}settingsNodes(){const e=this.renderer.config,t=e.transforms,s=this.handleSettingsAction,n=this.renderer.coordinateFrameList.length,r={settings:{label:(0,D.t)("threeDee:settings"),defaultExpansionState:"collapsed",order:0,fields:{editable:{label:(0,D.t)("threeDee:editable"),input:"boolean",value:e.scene.transforms?.editable??Bn},showLabel:{label:(0,D.t)("threeDee:labels"),input:"boolean",value:e.scene.transforms?.showLabel??!0},...(e.scene.transforms?.showLabel??!0)&&{labelSize:{label:(0,D.t)("threeDee:labelSize"),input:"number",min:0,step:.01,precision:2,placeholder:String(pi),value:e.scene.transforms?.labelSize}},axisScale:Qa((0,D.t)("threeDee:axisScale"),e.scene.transforms?.axisScale,fi),lineWidth:{label:(0,D.t)("threeDee:lineWidth"),input:"number",min:0,step:.5,precision:1,value:e.scene.transforms?.lineWidth,placeholder:String(jn)},lineColor:{label:(0,D.t)("threeDee:lineColor"),input:"rgb",value:e.scene.transforms?.lineColor??$n},enablePreloading:{label:(0,D.t)("threeDee:enablePreloading"),input:"boolean",value:e.scene.transforms?.enablePreloading??!0}}}};let a=1;for(const{label:o,value:l}of this.renderer.coordinateFrameList){const d=`frame:${l}`,h=this.#c(t[d]??{}),f=this.renderer.transformTree.frame(l),m=bu(f,this.renderer.currentTime,e);xo[1]=d,r[d]={label:o,fields:m,visible:h.visible,order:a++,defaultExpansionState:"collapsed",error:this.renderer.settings.errors.errors.errorAtPath(xo)}}return[{path:["transforms"],node:{label:`${(0,D.t)("threeDee:transforms")}${n>0?` (${n})`:""}`,actions:[{id:"show-all",type:"action",label:(0,D.t)("threeDee:showAll")},{id:"hide-all",type:"action",label:(0,D.t)("threeDee:hideAll")}],handler:s,children:r}}]}startFrame(e,t,s){this.#e.resolution=this.renderer.input.canvasSize,this.updateSettingsTree(),super.startFrame(e,t,s);const n=this.renderer.config.scene.transforms?.axisScale??fi,r=xs*n,a=this.renderer.config.scene.transforms?.labelSize??pi,o=this.renderer.config.scene.labelScaleFactor??ui,l=r+a*o*1.5;for(const d of this.renderables.values()){if(!d.visible)continue;const h=d.userData.parentLine,m=this.renderer.transformTree.frame(d.userData.frameId)?.parent(),p=fu;if(d.getWorldPosition(p),h.visible=!1,m){const u=this.renderables.get(m.id);if(u?.visible===!0){const x=uu;u.getWorldPosition(x);const y=x.distanceTo(p);h.lookAt(x),h.rotateY(-cu),h.scale.set(y,1,1),h.visible=!0}}const g=d.userData.label;g.visible=this.renderer.config.scene.transforms?.showLabel??!0,p.z+=l,d.worldToLocal(p),g.position.set(p.x,p.y,p.z)}}setColorScheme(e,t){const s=e==="dark"?1:0;this.#s=s,this.#i.setRGB(1-s,1-s,1-s),t&&(this.#s=Hs(t.r,t.g,t.b)>.5?0:1,this.#i.copy(t));for(const n of this.renderables.values())n.userData.label.setColor(this.#s,this.#s,this.#s),n.userData.label.setBackgroundColor(this.#i.r,this.#i.g,this.#i.b)}#a(e){for(const t of this.renderables.values())t.userData.label.setLineHeight(e)}#o(e){for(const t of this.renderables.values())t.userData.axis.scale.set(e,e,e)}#l(e){this.#e.linewidth=e}#d(e){Qi(this.#e.color,e)}handleSettingsAction=e=>{const t=e.payload.path,s=n=>{for(const r of this.renderables.values())r.userData.settings.visible=n;this.renderer.updateConfig(r=>{for(const a of this.renderables.keys()){const o=a==="settings"?"$settings":`frame:${a}`;r.transforms[o]??={},r.transforms[o].visible=n}}),this.updateSettingsTree()};if(e.action==="perform-node-action"){e.payload.id==="show-all"?s(!0):e.payload.id==="hide-all"&&s(!1);return}if(t.length===3)if(t[1]==="settings"){const n=t[2],r=e.payload.value;if(this.saveSetting(["scene","transforms",n],r),n==="editable")this.#m();else if(n==="labelSize"){const a=r;this.#a(a??pi)}else if(n==="axisScale"){const a=r;this.#o(a??fi)}else if(n==="lineWidth"){const a=r;this.#l(a??jn)}else if(n==="lineColor"){const a=r;this.#d(a??$n)}}else{this.saveSetting(t,e.payload.value);const n=t[1],r=n.replace(/^frame:/,""),a=this.renderables.get(r);if(a){const o=this.renderer.config.transforms[n];a.userData.settings=this.#c(o??{}),this.#f(a)}}};#c(e){return{...this.#r,...e}}#h=()=>{for(const t of this.renderer.transformTree.frames().keys())this.#u(t);this.renderer.config.scene.transforms?.editable===!0&&this.#m(),this.updateSettingsTree()};#u(e){if(this.renderables.has(e))return;const t=this.renderer.config,s=this.renderer.transformTree.frame(e);if(!s)throw new Error(`CoordinateFrame "${e}" was not created`);const n=s.displayName(),r=this.renderer.labelPool.acquire();r.setBillboard(!0),r.setText(n),r.setLineHeight(t.scene.transforms?.labelSize??pi),r.setColor(this.#s,this.#s,this.#s),r.setBackgroundColor(this.#i.r,this.#i.g,this.#i.b);const a=`frame:${e}`,o=t.transforms[a],l=this.#c(o??{}),d=new hi.w(this.#n,this.#e);d.castShadow=!0,d.receiveShadow=!1,d.userData.pickingMaterial=this.#t;const h=new ws(e,this.renderer),f=t.scene.transforms?.axisScale??fi;h.scale.set(f,f,f);const m=new hu(e,this.renderer,{receiveTime:0n,messageTime:0n,frameId:e,pose:(0,N.N2)(),settingsPath:["transforms",a],settings:l,axis:h,label:r,parentLine:d});m.add(h),m.add(r),m.add(d),this.add(m),this.renderables.set(e,m),this.#f(m)}#m(){for(const e of this.renderables.values())this.#f(e)}#f(e){const t=this.renderer.transformTree.getOrCreateFrame(e.userData.frameId);if(!(this.renderer.config.scene.transforms?.editable??Bn)){t.offsetPosition=void 0,t.offsetEulerDegrees=void 0;return}const n=`frame:${e.userData.frameId}`;t.offsetPosition=Do(this.renderer.config.transforms[n]?.xyzOffset),t.offsetEulerDegrees=Do(this.renderer.config.transforms[n]?.rpyCoefficient)}}function gu(){const i=new jt.L;return i.setPositions([0,0,0,1,0,0]),i}function bu(i,e,t){const s=i?`frame:${i.id}`:"",n=i?.parent()?.id;if(n==null)return{parent:{label:"Parent",input:"string",readonly:!0,value:"<root>"}};const r=String(i?.transformsSize()??0);let a,o,l;if(e!=null&&i&&i.findClosestTransforms(pu,To,e,N.Zf)){const[h,f]=To;a=h<e?Tu(e-h):"0 ns";const m=f.position(),p=f.rotation();o=[Kt(m[0],3),Kt(m[1],3),Kt(m[2],3)],So.set(p[0],p[1],p[2],p[3]),mi.setFromQuaternion(So,"XYZ"),l=[Kt(c.M8C.radToDeg(mi.x),3),Kt(c.M8C.radToDeg(mi.y),3),Kt(c.M8C.radToDeg(mi.z),3)]}const d={parent:{label:"Parent",input:"string",readonly:!0,value:n},age:{label:"Age",input:"string",readonly:!0,value:a},historySize:{label:"History Size",input:"string",readonly:!0,value:r},xyz:{label:"Translation",input:"vec3",precision:V,labels:["X","Y","Z"],readonly:!0,value:o},rpy:{label:"Rotation",input:"vec3",precision:tt,labels:["R","P","Y"],readonly:!0,value:l}};if(t.scene.transforms?.editable??Bn){let h=t.transforms[s]?.xyzOffset,f=t.transforms[s]?.rpyCoefficient;h&&Mo(h)&&(h=void 0),f&&Mo(f)&&(f=void 0),d.xyzOffset={label:"Translation Offset",input:"vec3",precision:V,step:.1,labels:["X","Y","Z"],value:h},d.rpyCoefficient={label:"Rotation Offset",input:"vec3",precision:tt,step:1,min:-180,max:180,labels:["R","P","Y"],value:f}}return d}const yu=BigInt(1e5),vu=BigInt(1e6),wo=BigInt(1e9),Io=BigInt(6e10),Co=BigInt(36e11);function Tu(i){const e=Su(i);return e<yu?`${i} ns`:e<wo?`${Number(i/vu).toFixed(1)} ms`:e<Io?`${Number(i/wo).toFixed(1)} s`:e<Co?`${Number(i/Io).toFixed(1)} min`:`${Number(i/Co).toFixed(1)} hr`}function Su(i){return i<0n?-i:i}function Kt(i,e){return Number(i.toFixed(e))}function Mo(i,e=1e-6){return Math.abs(i[0])<e&&Math.abs(i[1])<e&&Math.abs(i[2])<e}function Do(i){if(!i)return;const[e=0,t=0,s=0]=i;if(!(e===0&&t===0&&s===0))return[e,t,s]}var Ao=b(33895),xu="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/Grids.ts";const wu=Y.ZP.getLogger(xu),Is="foxglove.Grid",Eo=10,Po=10,_o=1,Lo="#248eff",Iu=4096,Cu={worldUnits:!1},Vn={visible:!0,frameLocked:!0,label:"Grid",instanceId:"invalid",layerId:Is,frameId:void 0,size:Eo,divisions:Po,lineWidth:_o,color:Lo,position:[0,0,0],rotation:[0,0,0]};class Mu extends K{dispose(){this.userData.lineList.dispose(),super.dispose()}}class Du extends J.d{constructor(e){super("foxglove.Grids",e),e.addCustomLayerAction({layerId:Is,label:(0,D.t)("threeDee:addGrid"),icon:"Grid",handler:this.#e}),e.on("transformTreeUpdated",this.#t);for(const[t,s]of Object.entries(e.config.layers))s?.layerId===Is&&this.#s(t,s)}dispose(){this.renderer.off("transformTreeUpdated",this.#t),super.dispose()}removeAllRenderables(){}settingsNodes(){const e=this.handleSettingsAction,t=[];for(const[s,n]of Object.entries(this.renderer.config.layers)){if(n?.layerId!==Is)continue;const r=n,a=[{label:"<Display frame>",value:void 0},...this.renderer.coordinateFrameList],o={frameId:{label:(0,D.t)("threeDee:frame"),input:"select",options:a,value:r.frameId},size:{label:(0,D.t)("threeDee:size"),input:"number",min:0,step:.5,precision:V,value:r.size,placeholder:String(Eo)},divisions:{label:(0,D.t)("threeDee:divisions"),input:"number",min:1,max:Iu,step:1,precision:0,value:r.divisions,placeholder:String(Po)},lineWidth:{label:(0,D.t)("threeDee:lineWidth"),input:"number",min:0,step:.5,precision:1,value:r.lineWidth,placeholder:String(_o)},color:{label:(0,D.t)("threeDee:color"),input:"rgba",value:r.color??Lo},position:{label:(0,D.t)("threeDee:position"),input:"vec3",labels:["X","Y","Z"],precision:V,value:r.position??[0,0,0]},rotation:{label:(0,D.t)("threeDee:rotation"),input:"vec3",labels:["R","P","Y"],precision:tt,value:r.rotation??[0,0,0]}};t.push({path:["layers",s],node:{label:r.label??(0,D.t)("threeDee:grid"),icon:"Grid",fields:o,visible:r.visible??Vn.visible,actions:[{type:"action",id:"delete",label:(0,D.t)("threeDee:delete")}],order:n.order,handler:e}}),this.renderables.has(s)||this.#s(s,r)}return t}startFrame(e,t,s){for(const n of this.renderables.values())n.userData.frameId=n.userData.settings.frameId??t;super.startFrame(e,t,s)}handleSettingsAction=e=>{const t=e.payload.path;if(e.action==="perform-node-action"){if(t.length===2&&e.payload.id==="delete"){const r=t[1];this.renderer.updateConfig(a=>{delete a.layers[r]}),this.#s(r,void 0),this.updateSettingsTree(),this.renderer.updateCustomLayersCount()}return}if(t.length!==3)return;this.saveSetting(t,e.payload.value);const s=t[1],n=this.renderer.config.layers[s];this.#s(s,n)};#e=e=>{wu.info(`Creating ${Is} layer ${e}`);const t={...Vn,instanceId:e};this.renderer.updateConfig(s=>{const r=1+(Ao.Z(Object.values(s.layers),a=>a?.order)?.order??0);s.layers[e]={...t,order:r}}),this.#s(e,t),this.updateSettingsTree()};#t=()=>{this.updateSettingsTree()};#s(e,t){let s=this.renderables.get(e);if(t==null){s!=null&&(s.userData.lineList.dispose(),this.remove(s),this.renderables.delete(e));return}const n={...Vn,...t};s||(s=this.#i(e,n),s.userData.pose=(0,N.EI)(n.position,n.rotation));const r=s.userData.settings,a=n.size===r.size&&n.divisions===r.divisions&&n.frameId===r.frameId&&n.lineWidth===r.lineWidth&&n.color===r.color;if(s.userData.settings=n,!a){const o=Ro(n);s.userData.lineList.update(o,void 0)}(!Gr(n.position,r.position)||!Gr(n.rotation,r.rotation))&&(s.userData.pose=(0,N.EI)(n.position,n.rotation))}#i(e,t){const s=Ro(t),n=`${e}:LINE_LIST`,r=new zn(n,s,void 0,this.renderer,Cu),a=new Mu(e,this.renderer,{receiveTime:0n,messageTime:0n,frameId:"",pose:(0,N.N2)(),settingsPath:["layers",e],settings:t,lineList:r});return a.add(r),this.add(a),this.renderables.set(e,a),a}}function Ro(i){const{size:e,divisions:t,color:s}=i,n=e/t,r=e/2,a=[];for(let l=0;l<=t;l++){const d=-r+l*n;a.push({x:d,y:-r,z:0}),a.push({x:d,y:r,z:0}),a.push({x:-r,y:d,z:0}),a.push({x:r,y:d,z:0})}const o={r:1,g:1,b:1,a:1};return R(o,s),{header:{frame_id:"",stamp:dt},ns:"",id:0,type:E.LINE_LIST,action:le.ADD,pose:(0,N.N2)(),scale:{x:i.lineWidth,y:1,z:1},color:o,lifetime:dt,frame_locked:!0,points:a,colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}class Au{#e=new Map;get(e){return this.#e.get(e)}set(e,t){const s=this.#e.get(e);s==null?this.#e.set(e,[t]):s.includes(t)||s.push(t)}delete(e,t){const s=this.#e.get(e);if(s!=null){const n=s.indexOf(t);n>=0&&(s.splice(n,1),s.length===0&&this.#e.delete(e))}}deleteAll(e){this.#e.delete(e)}clear(){this.#e.clear()}}var Eu="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/Images.ts";const Pu=Y.ZP.getLogger(Eu),_u=512,gi="NoCameraInfo",No="CameraModel";class Lu extends J.d{#e=new Set;#t=new Au;#s=new Map;constructor(e){super("foxglove.Images",e),this.renderer.on("topicsChanged",this.#i),this.#i()}dispose(){this.renderer.off("topicsChanged",this.#i),super.dispose()}getSubscriptions(){return[{type:"schema",schemaNames:ld,subscription:{handler:this.#c,shouldSubscribe:this.#n}},{type:"schema",schemaNames:ls,subscription:{handler:this.#r}},{type:"schema",schemaNames:cs,subscription:{handler:this.#a}},{type:"schema",schemaNames:hs,subscription:{handler:this.#o}},{type:"schema",schemaNames:us,subscription:{handler:this.#l}}]}#i=()=>{this.#e=new Set;for(const e of this.renderer.topics??[])(j(e,zt)||j(e,Bt))&&this.#e.add(e.name)};settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,s=[];for(const n of this.renderer.topics??[]){if(!(j(n,ls)||j(n,cs)||j(n,hs)||j(n,us)))continue;const r=n.name,a=e[r]??{},o=Array.from(this.#e,d=>({label:d,value:d}));o.sort(),In(o,r,d=>d.value);const l={cameraInfoTopic:{label:"Camera Info",input:"select",options:o,value:a.cameraInfoTopic},distance:{label:"Distance",input:"number",placeholder:String(Gt.distance),step:.1,precision:V,value:a.distance},planarProjectionFactor:{label:"Planar Projection Factor",input:"number",placeholder:String(Gt.planarProjectionFactor),min:0,max:1,step:.1,precision:2,value:a.planarProjectionFactor},color:{label:"Color",input:"rgba",value:a.color}};s.push({path:["topics",r],node:{icon:"ImageProjection",fields:l,visible:a.visible??Gt.visible,order:r.toLocaleLowerCase(),handler:t}})}return s}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;const s=t[1],r=this.renderer.config.topics[s]?.cameraInfoTopic;this.saveSetting(t,e.payload.value);const a=this.renderer.config.topics[s],o=a?.cameraInfoTopic;o!==r&&o!=null&&this.#t.set(o,s);const l=this.renderables.get(s);if(!l||(l.setSettings({...Gt,...a}),r!=null&&this.#t.delete(r,s),!o))return;const d=this.#s.get(o);if(!d){this.renderer.settings.errors.addToTopic(s,gi,`No CameraInfo received on ${o}`);return}this.#h(l,d),l.update()};#n=e=>{for(const t of Object.values(this.renderer.config.topics)){const s=t;if(s.cameraInfoTopic===e&&s.visible===!0)return!0}return!1};#r=e=>{this.#d(e,ua(e.message))};#a=e=>{this.#d(e,fa(e.message))};#o=e=>{this.#d(e,pa(e.message))};#l=e=>{this.#d(e,ma(e.message))};#d=(e,t)=>{const s=e.topic,n=(0,M.toNanoSec)(e.receiveTime),r="header"in t?t.header.frame_id:t.frame_id,a=this.#u(s,n,t,r);a.setImage(t,_u),a.userData.receiveTime=n;const o=a.userData.settings;if(o.cameraInfoTopic==null){const d=wn(s),h=d!=null?(0,z.Z)(this.#e,f=>f.startsWith(d)?f:void 0).sort()[0]:void 0;if(o.cameraInfoTopic=h,a.setSettings(o),h==null){this.renderer.settings.errors.addToTopic(s,gi,"No CameraInfo topic found");return}this.renderer.updateConfig(f=>{const m={...o};m.cameraInfoTopic=h,f.topics[s]=m}),this.updateSettingsTree()}(0,q.assert)(o.cameraInfoTopic!=null),this.#t.set(o.cameraInfoTopic,s);const l=this.#s.get(o.cameraInfoTopic);l?this.#h(a,l):this.renderer.settings.errors.addToTopic(s,gi,`No CameraInfo received on ${o.cameraInfoTopic}`)};#c=e=>{const t=Xs(e.message);this.#s.set(e.topic,t);const s=this.#t.get(e.topic)??[];for(const n of s){const r=this.renderables.get(n);if(!r)continue;const a=r.userData.settings;!a.cameraInfoTopic||a.cameraInfoTopic!==e.topic||(this.renderer.settings.errors.removeFromTopic(n,gi),this.#h(r,t),r.update())}};#h(e,t){if(un(e.userData.cameraInfo,t)&&e.userData.cameraModel!=null)return;const n=e.userData.topic;try{e.setCameraModel(new Vi(t)),e.userData.cameraInfo=t,this.renderer.settings.errors.removeFromTopic(n,No)}catch(r){const a=r;this.renderer.settings.errors.addToTopic(n,No,a.message)}}#u(e,t,s,n){let r=this.renderables.get(e);if(r)return r;const a=this.renderer.config.topics[e];return r=new ra(e,this.renderer,{receiveTime:t,messageTime:s?(0,M.toNanoSec)("header"in s?s.header.stamp:s.timestamp):0n,frameId:this.renderer.normalizeFrameId(n),pose:(0,N.N2)(),settingsPath:["topics",e],topic:e,settings:{...Gt,...a},cameraInfo:void 0,cameraModel:void 0,image:s,texture:void 0,material:void 0,geometry:void 0,mesh:void 0}),this.add(r),this.renderables.set(e,r),r}}var Fe=b(93254),bi=b(10336);const Ru=1.5,Nu="circle",Ou="turbo",Fu={r:1,g:1,b:1,a:1},Uu={r:100/255,g:47/255,b:105/255,a:1},zu={r:227/255,g:177/255,b:135/255,a:1},yi={visible:!1,frameLocked:!1,pointSize:Ru,pointShape:Nu,decayTime:0,colorMode:"flat",flatColor:oe(Fu),colorField:void 0,gradient:[oe(Uu),oe(zu)],colorMap:Ou,explicitAlpha:1,minValue:void 0,maxValue:void 0},Oo=["x","y","z"],ku=[{label:"Circle",value:"circle"},{label:"Square",value:"square"}];function Wn(i,e,t,s=yi){const n=t.pointSize,r=t.pointShape??"circle",a=t.decayTime,o=pn({msgFields:e,config:t,defaults:s,modifiers:{supportsPackedRgbModes:Ys.has(i.schemaName),supportsRgbaFieldsMode:ti.has(i.schemaName)}});return{order:i.name.toLocaleLowerCase(),visible:t.visible??s.visible,fields:{pointSize:{label:"Point size",input:"number",step:1,placeholder:"2",precision:2,value:n,min:0},pointShape:{label:"Point shape",input:"select",options:ku,value:r},decayTime:{label:"Decay time",input:"number",step:.5,placeholder:"0 seconds",min:0,precision:3,value:a},...o}}}function Fo(i,e,{supportsPackedRgbModes:t}){if(t)for(const n of e.fields){if(!Pt(n))continue;const r=n.name.toLowerCase();if(fn.has(r)){switch(i.colorField=n.name,r){case"rgb":i.colorMode="rgb";break;default:case"rgba":i.colorMode="rgba";break}return}}for(const n of e.fields)if(Pt(n)&&qr.has(n.name)){i.colorField=n.name,i.colorMode="colormap",i.colorMap="turbo";return}const s=e.fields.find(n=>Pt(n));if(s!=null){i.colorField=s.name,i.colorMode="colormap",i.colorMap="turbo";return}}function Uo(i,e){const t=new At(e);return t.name=`${i}:PointScans:geometry`,t.createAttribute("position",Float32Array,3),t.createAttribute("color",Uint8Array,4,!0),t}function Hn(i){switch(i.colorMode){case"flat":case"colormap":case"gradient":return"linear";case"rgb":case"rgba":case"rgba-fields":return"srgb"}}class zo extends K{#e;geometry;pickableInstances=!0;constructor(e,t,s,n,r,a){super(e,void 0,t),this.geometry=s;const o=new c.woe(s,n);o.frustumCulled=!1,o.name=`${t.topic}:PointCloud:points`,o.userData={pickingMaterial:r,instancePickingMaterial:a,pose:t.pose},this.#e=o,this.add(o)}dispose(){this.#e.geometry.dispose()}updateMaterial(e){this.#e.material=e}}const Gu=`
outgoingLight = sRGBToLinear(outgoingLight);
`,Bu=`
vec2 cxy = 2.0 * gl_PointCoord - 1.0;
if (dot(cxy, cxy) > 1.0) { discard; }
`;function Zn(i){const e=qs(i),t=Hn(i),s=i.pointSize,n=i.pointShape,r=new c.UY4({vertexColors:!0,size:s,sizeAttenuation:!1,transparent:e,depthWrite:!0});return r.customProgramCacheKey=()=>`${n}-${t}`,r.onBeforeCompile=a=>{const o="#include <output_fragment>";n==="circle"&&(a.fragmentShader=a.fragmentShader.replace(o,Bu+o)),t==="srgb"&&(a.fragmentShader=ta+a.fragmentShader.replace(o,Gu+o))},r}function ko(i){const t=Math.max(i.pointSize,8);return new c.jyz({vertexShader:`
      uniform float pointSize;
      void main() {
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        gl_PointSize = pointSize;
      }
    `,fragmentShader:`
      uniform vec4 objectId;
      void main() {
        gl_FragColor = objectId;
      }
    `,side:c.ehD,uniforms:{pointSize:{value:t},objectId:{value:[NaN,NaN,NaN,NaN]}}})}function Go(i){const t=Math.max(i.pointSize,8);return new c.jyz({vertexShader:`
        uniform float pointSize;
        varying vec4 objectId;
        void main() {
          objectId = vec4(
            float((gl_VertexID >> 24) & 255) / 255.0,
            float((gl_VertexID >> 16) & 255) / 255.0,
            float((gl_VertexID >> 8) & 255) / 255.0,
            float(gl_VertexID & 255) / 255.0);
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          gl_PointSize = pointSize;
        }
      `,fragmentShader:`
        varying vec4 objectId;
        void main() {
          gl_FragColor = objectId;
        }
      `,side:c.ehD,uniforms:{pointSize:{value:t}}})}class Yn{#e;#t;#s;constructor({initial:e,renderer:t,parentRenderable:s}){this.#e=[e],this.#s=t,this.#t=s}addHistoryEntry(e){this.#e.push(e)}forEach(e){this.#e.forEach(e)}updateHistoryFromCurrentTime(e){const t=this.#e,s=this.#t.userData.settings.decayTime,n=s>0?e-BigInt(Math.round(s*1e9)):N.Zf;for(;t.length>1&&t[0].receiveTime<n;){const r=this.#e.shift();this.#t.remove(r.renderable),r.renderable.dispose()}}updatePoses(e,t,s){let n=!1;for(const r of this.#e){const a=r.messageTime,o=this.#t.userData.frameId;if(!(0,bi.S)(r.renderable,this.#s.transformTree,t,s,o,e,a)&&!n){const d=(0,Fe.v)(t,s,o);this.#s.settings.errors.add(this.#t.userData.settingsPath,Fe.o,d),n=!0}}}latest(){if(this.#e.length===0)throw new Error("RenderObjectHistory is empty");return this.#e[this.#e.length-1]}clearHistory(){for(const e of this.#e.splice(0,this.#e.length-1))e.renderable.dispose(),this.#t.remove(e.renderable)}dispose(){for(const e of this.#e)e.renderable.dispose();this.#e.length=0}}function Kn(){return{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:1}}}const Bo=yi,ju=["range","intensity"],$u=new Set([...gn,...nn]),Vu="INVALID_LASERSCAN",Wu=new c.Pa4,Cs={r:0,g:0,b:0,a:0};function jo(i,e){const t=new At(e);return t.name=`${i}:LaserScan:geometry`,t.createAttribute("position",Float32Array,1),t.createAttribute("color",Uint8Array,4,!0),t}class $o extends zo{#e;#t;#s;constructor(e,t,s){const n=new vi,r=new vi({picking:!0}),a=new Xn;super(e,t,s,n,r,a),this.#e=n,this.#t=r,this.#s=a}details(){return this.userData.originalMessage??{}}instanceDetails(e){const t=e>=0&&e<this.userData.laserScan.ranges.length?this.userData.laserScan.ranges[e]:void 0,s=e>=0&&e<this.userData.laserScan.intensities.length?this.userData.laserScan.intensities[e]:void 0;return{range:t,intensity:s}}updateUniforms(e,t){this.#e.updateUniforms(e,t),this.#t.updateUniforms(e,t),this.#s.updateUniforms(e,t)}setPixelRatio(e){this.#e.setPixelRatio(e),this.#t.setPixelRatio(e),this.#s.setPixelRatio(e)}dispose(){super.dispose(),this.#e.dispose(),this.#t.dispose(),this.#s.dispose()}}class Hu extends K{pickable=!1;#e;constructor(e,t,s){super(e,t,s);const n=s.settings.decayTime>0,r=jo(e,n?c.dj0:c.W2J),a=new $o(e,{receiveTime:-1n,messageTime:-1n,frameId:"",pose:s.latestLaserScan.pose,settingsPath:[],settings:{visible:!0},topic:e,laserScan:s.latestLaserScan,originalMessage:s.latestOriginalMessage},r);this.#e=new Yn({initial:{messageTime:s.receiveTime,receiveTime:s.receiveTime,renderable:a},parentRenderable:this,renderer:t}),this.add(a)}dispose(){this.userData.latestOriginalMessage=void 0,this.#e.dispose(),super.dispose()}updateLaserScan(e,t,s,n){const r=(0,M.toNanoSec)(e.timestamp);this.userData.receiveTime=n,this.userData.messageTime=r,this.userData.frameId=this.renderer.normalizeFrameId(e.frame_id),this.userData.latestLaserScan=e,this.userData.latestOriginalMessage=t,this.userData.settings=s;const{colorField:a}=s,{intensities:o,ranges:l}=e;if(o.length!==0&&o.length!==l.length){const T=`LaserScan intensities length (${o.length}) does not match ranges length (${l.length})`;Vo(this.renderer,this,T);return}if(a!=="intensity"&&a!=="range"){const T=`LaserScan color field must be either 'intensity' or 'range', found '${a}'`;Vo(this.renderer,this,T);return}const d=this.userData.topic,h=this.#e;if(s.decayTime>0){const T=jo(d,c.W2J),I=new $o(d,{receiveTime:-1n,messageTime:-1n,frameId:"",pose:e.pose,settingsPath:[],settings:{visible:!0},topic:d,laserScan:e,originalMessage:t},T);h.addHistoryEntry({receiveTime:n,messageTime:r,renderable:I}),this.add(I)}const m=h.latest();m.receiveTime=n,m.messageTime=r,m.renderable.userData.pose=e.pose,m.renderable.userData.laserScan=e,m.renderable.userData.originalMessage=t;const p=m.renderable.geometry;p.resize(l.length);const g=p.attributes.position,u=p.attributes.color;g.set(l),m.renderable.updateUniforms(s,e);let x=s.minValue??Number.POSITIVE_INFINITY,y=s.maxValue??Number.NEGATIVE_INFINITY;if(s.minValue==null||s.maxValue==null){let T=0;for(let I=0;I<l.length;I++){const _=l[I];Number.isFinite(_)&&(T=Math.max(T,_));const P=a==="range"?_:o[I];Number.isFinite(P)&&(x=Math.min(x,P),y=Math.max(y,P))}x=s.minValue??x,y=s.maxValue??y,m.renderable.geometry.boundingSphere??=new c.aLr,m.renderable.geometry.boundingSphere.set(Wu,T),m.renderable.frustumCulled=!0}else m.renderable.geometry.boundingSphere=null,m.renderable.frustumCulled=!1;const C=s.colorMode==="rgba-fields"?()=>NaN:Js(s,x,y);for(let T=0;T<l.length;T++){const I=a==="range"?l[T]:o[T]??0;C(Cs,I),u.setXYZW(T,Cs.r,Cs.g,Cs.b,Cs.a)}g.needsUpdate=!0,u.needsUpdate=!0}invalidateLastEntry(){this.#e.latest().renderable.geometry.resize(0)}startFrame(e,t,s){this.#e.updateHistoryFromCurrentTime(e),this.#e.updatePoses(e,t,s);const n=this.renderer.getPixelRatio();this.#e.forEach(r=>{r.renderable.setPixelRatio(n)})}}class Zu extends J.d{constructor(e){super("foxglove.LaserScans",e)}getSubscriptions(){return[{type:"schema",schemaNames:nn,subscription:{handler:this.#e}},{type:"schema",schemaNames:gn,subscription:{handler:this.#e}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,s=[];for(const n of this.renderer.topics??[]){if(!j(n,$u))continue;const a=e[n.name]??{},l=Wn(n,ju,a);l.handler=t,l.icon="Radar",s.push({path:["topics",n.name],node:l})}return s}startFrame(e,t,s){for(const[n,r]of this.renderables){if(!r.userData.settings.visible){r.removeFromParent(),r.dispose(),this.renderables.delete(n);continue}r.startFrame(e,t,s)}}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const s=t[1],n=this.renderables.get(s);if(n){const r=this.renderer.config.topics[s],a={...Bo,...r};n.updateLaserScan(n.userData.latestLaserScan,n.userData.latestOriginalMessage,a,n.userData.receiveTime)}};#e=e=>{const t=e.topic,s="header"in e.message?Ku(e.message):Yu(e.message),n=(0,M.toNanoSec)(e.receiveTime);let r=this.renderables.get(t);if(!r){const a=this.renderer.config.topics[t],o={...Bo,...a};o.colorField==null&&(o.colorField="intensity",o.colorMode="colormap",o.colorMap="turbo",this.renderer.updateConfig(d=>{const h={...a};h.colorField=o.colorField,h.colorMode=o.colorMode,h.colorMap=o.colorMap,d.topics[t]=h}));const l=(0,M.toNanoSec)(s.timestamp);r=new Hu(t,this.renderer,{receiveTime:n,messageTime:l,frameId:this.renderer.normalizeFrameId(s.frame_id),pose:s.pose,settingsPath:["topics",t],settings:o,topic:t,latestLaserScan:s,latestOriginalMessage:e.message}),this.add(r),this.renderables.set(t,r)}r.updateLaserScan(s,e.message,r.userData.settings,n)}}class vi extends c.FIo{static#e=8;constructor({picking:e=!1}={}){super({vertexShader:`        #version 300 es
        precision highp float;
        precision highp int;
        uniform mat4 projectionMatrix, modelViewMatrix;

        uniform float pointSize;
        uniform float pixelRatio;
        uniform float angleMin, angleIncrement;
        uniform float rangeMin, rangeMax;
        in float position; // range, but must be named position in order for three.js to render anything
        in mediump vec4 color;
        out mediump vec4 vColor;
        void main() {
          if (position < rangeMin || position > rangeMax) {
            gl_PointSize = 0.0;
            return;
          }
          vColor = color;
          float angle = angleMin + angleIncrement * float(gl_VertexID);
          vec4 pos = vec4(position * cos(angle), position * sin(angle), 0, 1.0);
          gl_Position = projectionMatrix * modelViewMatrix * pos;
          ${e?`gl_PointSize = pixelRatio * max(pointSize, ${vi.#e.toFixed(1)});`:"gl_PointSize = pixelRatio * pointSize;"}

        }
      `,fragmentShader:`        #version 300 es
        #ifdef GL_FRAGMENT_PRECISION_HIGH
          precision highp float;
        #else
          precision mediump float;
        #endif
        uniform bool isCircle;
        ${e?"uniform vec4 objectId;":"in mediump vec4 vColor;"}
        out vec4 outColor;

        ${c.WdD.encodings_pars_fragment}

        void main() {
          if (isCircle) {
            vec2 cxy = 2.0 * gl_PointCoord - 1.0;
            if (dot(cxy, cxy) > 1.0) { discard; }
          }
          ${e?"outColor = objectId;":"outColor = LinearTosRGB(vColor);"}
        }
      `}),this.uniforms={isCircle:{value:!1},pointSize:{value:1},pixelRatio:{value:1},angleMin:{value:NaN},angleIncrement:{value:NaN},rangeMin:{value:NaN},rangeMax:{value:NaN}},e&&(this.uniforms.objectId={value:[NaN,NaN,NaN,NaN]})}updateUniforms(e,t){this.uniforms.isCircle.value=e.pointShape==="circle",this.uniforms.pointSize.value=e.pointSize,this.uniforms.angleMin.value=t.start_angle,this.uniforms.angleIncrement.value=(t.end_angle-t.start_angle)/(t.ranges.length-1),this.uniforms.rangeMin.value=t.range_min,this.uniforms.rangeMax.value=t.range_max,this.uniformsNeedUpdate=!0;const s=qs(e);s!==this.transparent&&(this.transparent=s,this.depthWrite=!this.transparent,this.needsUpdate=!0)}setPixelRatio(e){this.uniforms.pixelRatio.value=e}}class Xn extends c.FIo{static#e=8;constructor(){const e=Xn.#e.toFixed(1);super({vertexShader:`        #version 300 es
        precision highp float;
        precision highp int;
        uniform mat4 projectionMatrix, modelViewMatrix;

        uniform float pointSize;
        uniform float pixelRatio;
        uniform float angleMin, angleIncrement;
        uniform float rangeMin, rangeMax;
        in float position; // range, but must be named position in order for three.js to render anything
        out vec4 objectId;
        void main() {
          if (position < rangeMin || position > rangeMax) {
            gl_PointSize = 0.0;
            return;
          }
          objectId = vec4(
            float((gl_VertexID >> 24) & 255) / 255.0,
            float((gl_VertexID >> 16) & 255) / 255.0,
            float((gl_VertexID >> 8) & 255) / 255.0,
            float(gl_VertexID & 255) / 255.0);
          float angle = angleMin + angleIncrement * float(gl_VertexID);
          vec4 pos = vec4(position * cos(angle), position * sin(angle), 0, 1.0);
          gl_Position = projectionMatrix * modelViewMatrix * pos;
          gl_PointSize = pixelRatio * max(pointSize, ${e});
        }
      `,fragmentShader:`        #version 300 es
        #ifdef GL_FRAGMENT_PRECISION_HIGH
          precision highp float;
        #else
          precision mediump float;
        #endif
        uniform bool isCircle;
        in vec4 objectId;
        out vec4 outColor;

        void main() {
          if (isCircle) {
            vec2 cxy = 2.0 * gl_PointCoord - 1.0;
            if (dot(cxy, cxy) > 1.0) { discard; }
          }
          outColor = objectId;
        }
      `}),this.uniforms={isCircle:{value:!1},pointSize:{value:1},pixelRatio:{value:1},angleMin:{value:NaN},angleIncrement:{value:NaN},rangeMin:{value:NaN},rangeMax:{value:NaN}}}updateUniforms(e,t){this.uniforms.isCircle.value=e.pointShape==="circle",this.uniforms.pointSize.value=e.pointSize,this.uniforms.angleMin.value=t.start_angle,this.uniforms.angleIncrement.value=(t.end_angle-t.start_angle)/(t.ranges.length-1),this.uniforms.rangeMin.value=t.range_min,this.uniforms.rangeMax.value=t.range_max,this.uniformsNeedUpdate=!0}setPixelRatio(e){this.uniforms.pixelRatio.value=e}}function Vo(i,e,t){i.settings.errors.addToTopic(e.userData.topic,Vu,t),e.invalidateLastEntry()}function Yu(i){return{timestamp:ce(i.timestamp),frame_id:i.frame_id??"",pose:te(i.pose),start_angle:i.start_angle??0,end_angle:i.end_angle??0,range_min:-1/0,range_max:1/0,ranges:Ks(i.ranges),intensities:Ks(i.intensities)}}function Ku(i){return{timestamp:ce(i.header?.stamp),frame_id:i.header?.frame_id??"",pose:Kn(),start_angle:i.angle_min??0,end_angle:i.angle_max??0,range_min:i.range_min??-1/0,range_max:i.range_max??1/0,ranges:Ks(i.ranges),intensities:Ks(i.intensities)}}const Xu="INVALID_CUBE_LIST",Jn="INVALID_LINE_LIST",Wo="INVALID_LINE_STRIP",Ju="INVALID_MARKER_ACTION",Qu="INVALID_MARKER_TYPE",qu="INVALID_POINTS_LIST",ef="INVALID_SPHERE_LIST",tf={visible:!0};class sf{namespace;markersById=new Map;settings;constructor(e,t,s){this.namespace=t;const r=s.config.topics[e]?.namespaces?.[t];this.settings={...tf,...r}}}class nf extends K{pickable=!1;namespaces=new Map;dispose(){for(const e of this.namespaces.values())for(const t of e.markersById.values())this.renderer.markerPool.release(t);this.children.length=0,this.namespaces.clear()}addMarkerMessage(e,t){switch(e.action){case le.ADD:case le.MODIFY:this.#e(e,t);break;case le.DELETE:this.#t(e.ns,e.id);break;case le.DELETEALL:{this.#s(e.ns);break}default:this.renderer.settings.errors.addToTopic(this.topic,Ju,`Invalid marker action ${e.action}`)}}update(){for(const e of this.namespaces.values())for(const t of e.markersById.values())t.update(t.userData.originalMarker,t.userData.receiveTime)}startFrame(e,t,s){if(this.visible=this.userData.settings.visible,!this.visible){this.renderer.settings.errors.clearTopic(this.topic);return}for(const n of this.namespaces.values())for(const r of n.markersById.values()){if(r.visible=n.settings.visible,!r.visible)continue;const a=r.userData.marker,o=r.userData.receiveTime,l=r.userData.expiresIn;if(l!=null&&e>o+l){this.#t(n.namespace,a.id);continue}const d=this.renderer.normalizeFrameId(a.header.frame_id),h=a.frame_locked?e:r.userData.messageTime,f=(0,bi.S)(r,this.renderer.transformTree,t,s,d,e,h);r.visible=f;const m=r.userData.topic;if(f)this.renderer.settings.errors.removeFromTopic(m,Fe.o);else{const p=(0,Fe.v)(t,s,d);this.renderer.settings.errors.addToTopic(m,Fe.o,p)}}}#e(e,t){let s=this.namespaces.get(e.ns);s||(s=new sf(this.topic,e.ns,this.renderer),this.namespaces.set(e.ns,s));let n=s.markersById.get(e.id);if(n&&n.userData.marker.type!==e.type&&(this.#t(e.ns,e.id),n=void 0),!n){if(n=this.#i(e,t),!n)return;this.add(n),s.markersById.set(e.id,n)}n.update(e,t)}#t(e,t){const s=this.namespaces.get(e);if(s){const n=s.markersById.get(t);if(n)return this.remove(n),this.renderer.markerPool.release(n),s.markersById.delete(t),!0}return!1}#s(e){const t=s=>{for(const n of s.markersById.values())this.remove(n),this.renderer.markerPool.release(n);s.markersById.clear()};if(e.length===0)for(const s of this.namespaces.values())t(s);else{const s=this.namespaces.get(e);s&&t(s)}}#i(e,t){const s=this.renderer.markerPool;switch(e.type){case E.ARROW:return s.acquire(E.ARROW,this.topic,e,t);case E.CUBE:return s.acquire(E.CUBE,this.topic,e,t);case E.SPHERE:return s.acquire(E.SPHERE,this.topic,e,t);case E.CYLINDER:return s.acquire(E.CYLINDER,this.topic,e,t);case E.LINE_STRIP:if(e.points.length===0){const n=We(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Wo,`LINE_STRIP marker ${n} has no points`);return}else if(e.points.length===1){const n=We(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Wo,`LINE_STRIP marker ${n} only has one point`);return}return s.acquire(E.LINE_STRIP,this.topic,e,t);case E.LINE_LIST:if(e.points.length===0){const n=We(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Jn,`LINE_LIST marker ${n} has no points`);return}else if(e.points.length===1){const n=We(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Jn,`LINE_LIST marker ${n} only has one point`);return}else if(e.points.length%2!==0){const n=We(this.topic,e.ns,e.id);if(this.renderer.settings.errors.addToTopic(this.topic,Jn,`LINE_LIST marker ${n} has an odd number of points (${e.points.length})`),e.points.length===1)return}return s.acquire(E.LINE_LIST,this.topic,e,t);case E.CUBE_LIST:if(e.points.length===0){const n=We(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Xu,`CUBE_LIST marker ${n} has no points`);return}return s.acquire(E.CUBE_LIST,this.topic,e,t);case E.SPHERE_LIST:if(e.points.length===0){const n=We(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,ef,`SPHERE_LIST marker ${n} has no points`);return}return s.acquire(E.SPHERE_LIST,this.topic,e,t);case E.POINTS:if(e.points.length===0){const n=We(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,qu,`POINTS marker ${n} has no points`);return}return s.acquire(E.POINTS,this.topic,e,t);case E.TEXT_VIEW_FACING:return s.acquire(E.TEXT_VIEW_FACING,this.topic,e,t);case E.MESH_RESOURCE:{const n=s.acquire(E.MESH_RESOURCE,this.topic,e,t);return n.update(e,t,!0),n}case E.TRIANGLE_LIST:return s.acquire(E.TRIANGLE_LIST,this.topic,e,t);default:{const n=We(this.topic,e.ns,e.id);this.renderer.settings.errors.addToTopic(this.topic,Qu,`Marker ${n} has invalid type ${e.type}`);return}}}}const Ti={visible:!1,showOutlines:!0,color:void 0,selectedIdVariable:void 0,namespaces:{}};class rf extends J.d{constructor(e){super("foxglove.Markers",e)}getSubscriptions(){return[{type:"schema",schemaNames:Zs,subscription:{handler:this.#t}},{type:"schema",schemaNames:tn,subscription:{handler:this.#s}}]}settingsNodes(){const e=this.renderer.config.topics,t=[];for(const s of this.renderer.topics??[]){if(!(j(s,Zs)||j(s,tn)))continue;const n=e[s.name]??{},r={label:s.name,icon:"Shapes",order:s.name.toLocaleLowerCase(),fields:{color:{label:"Color",input:"rgba",value:n.color},showOutlines:{label:"Show outline",input:"boolean",value:n.showOutlines??Ti.showOutlines},selectedIdVariable:{label:"Selection Variable",input:"string",help:"When selecting a marker, this global variable will be set to the marker ID",value:n.selectedIdVariable,placeholder:Wi}},visible:n.visible??Ti.visible,handler:this.handleSettingsAction},a=this.renderables.get(s.name),o=Array.from(a?.namespaces.values()??[]).sort((l,d)=>l.namespace.localeCompare(d.namespace));if(o.length>1||o.length===1&&o[0].namespace!==""){r.children={};for(const l of o){const d={label:l.namespace!==""?l.namespace:'""',icon:"Shapes",visible:l.settings.visible,defaultExpansionState:o.length>1?"collapsed":"expanded",handler:this.#e};r.children[`ns:${l.namespace}`]=d}}t.push({path:["topics",s.name],node:r})}return t}startFrame(e,t,s){for(const n of this.renderables.values())n.startFrame(e,t,s)}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const s=t[1],n=this.renderables.get(s);if(n){const r=this.renderer.config.topics[s];n.userData.settings={...Ti,...r},n.update()}};#e=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==4)return;const s=t[1],n=t[2],r=t[3],a=n.slice(3);this.renderer.updateConfig(l=>{const d=["topics",s,"namespaces",a,r];On.Z(l,d,e.payload.value)});const o=this.renderables.get(s);if(o){const l=this.renderer.config.topics[s],d=o.namespaces.get(a);if(d){const h=l?.namespaces?.[a];d.settings={...d.settings,...h}}}this.updateSettingsTree()};#t=e=>{const t=e.topic,s=e.message,n=(0,M.toNanoSec)(e.receiveTime);for(const r of s.markers??[])if(r){const a=Ho(r);this.#i(t,a,n)}};#s=e=>{const t=e.topic,s=Ho(e.message),n=(0,M.toNanoSec)(e.receiveTime);this.#i(t,s,n)};#i(e,t,s){const n=this.#n(e,t,s),r=n.namespaces.size;n.addMarkerMessage(t,s),r!==n.namespaces.size&&this.updateSettingsTree()}addMarkerArray(e,t,s){const n=t[0];if(!n)return;const r=this.#n(e,n,s),a=r.namespaces.size;for(const o of t)r.addMarkerMessage(o,s);a!==r.namespaces.size&&this.updateSettingsTree()}#n(e,t,s){let n=this.renderables.get(e);if(!n){const r=this.renderer.config.topics[e];n=new nf(e,this.renderer,{receiveTime:s,messageTime:(0,M.toNanoSec)(t.header.stamp),frameId:this.renderer.normalizeFrameId(t.header.frame_id),pose:(0,N.N2)(),settingsPath:["topics",e],topic:e,settings:{...Ti,...r}}),this.renderables.set(e,n),this.add(n)}return n}}function Ho(i){return{header:Le(i.header),ns:i.ns??"",id:i.id??0,type:i.type??0,action:i.action??0,pose:te(i.pose),scale:Ve(i.scale),color:et(i.color),lifetime:ce(i.lifetime),frame_locked:i.frame_locked??!1,points:Wr(i.points),colors:hn(i.colors),text:i.text??"",mesh_resource:i.mesh_resource??"",mesh_use_embedded_materials:i.mesh_use_embedded_materials??!1}}const Si=9999999;class af extends c.jyz{constructor({color:e,...t}){super({...t,vertexShader:`
        #include <common>
        uniform vec2 canvasSize;
        void main() {
          vec4 mvPosition = modelViewMatrix * vec4(0., 0., 0., 1.);

          // Adapted from THREE.ShaderLib.sprite
          vec2 scale;
          scale.x = length(vec3(modelMatrix[0].xyz));
          scale.y = length(vec3(modelMatrix[1].xyz));

          gl_Position = projectionMatrix * mvPosition;

          // Add position after projection to maintain constant pixel size
          gl_Position.xy += position.xy / canvasSize * scale * gl_Position.w;
        }
      `,fragmentShader:`
        uniform vec3 color;
        void main() {
          gl_FragColor = vec4(color, 1.0);
        }
      `,uniforms:{canvasSize:{value:[0,0]},color:{value:new c.Ilk(e).convertSRGBToLinear()}}})}}class of extends J.d{#e=new c.zf8(5,16);#t=new af({color:16711680,depthTest:!1,depthWrite:!1});#s=new c.Kj0(this.#e,this.#t);#i=new c.Kj0(this.#e,this.#t);#n=new c.a$l([0,0,0,0,0,0],3);#r=new c.x12(new c.u9r,new c.nls({color:16711680}));#a=new c.x12(new c.u9r,new c.FT0({color:16711680,dashSize:1,gapSize:1,depthWrite:!1,depthFunc:c.w$m}));#o;#l=!1;#d=!1;#c;#h;state="idle";constructor(e){super("foxglove.MeasurementTool",e),this.#r.userData.picking=!1,this.#a.userData.picking=!1,this.#s.userData.picking=!1,this.#i.userData.picking=!1,this.#o=e.labelPool.acquire(),this.#o.visible=!1,this.#o.setBillboard(!0),this.#o.setSizeAttenuation(!1),this.#o.setLineHeight(12),this.#o.setColor(1,0,0),this.#o.renderOrder=Si,this.#o.material.depthTest=!1,this.#o.material.depthWrite=!1,this.#o.material.transparent=!0,this.#a.renderOrder=Si,this.#s.renderOrder=Si,this.#i.renderOrder=Si,this.#r.frustumCulled=!1,this.#a.frustumCulled=!1,this.#r.geometry.setAttribute("position",this.#n),this.#a.geometry.setAttribute("position",this.#n),this.#s.visible=!1,this.#i.visible=!1,this.add(this.#s),this.add(this.#i),this.add(this.#r),this.add(this.#a),this.add(this.#o),this.#u("idle")}dispose(){super.dispose(),this.renderer.labelPool.release(this.#o),this.#e.dispose(),this.#t.dispose(),this.#r.geometry.dispose(),this.#r.material.dispose(),this.#a.geometry.dispose(),this.#a.material.dispose(),this.renderer.input.removeListener("click",this.#b),this.renderer.input.removeListener("mousemove",this.#m)}startMeasuring(){this.#u("place-first-point")}stopMeasuring(){this.#c=this.#h=void 0,this.#u("idle")}startFrame(e,t,s){super.startFrame(e,t,s),this.#t.uniforms.canvasSize.value[0]=this.renderer.input.canvasSize.x,this.#t.uniforms.canvasSize.value[1]=this.renderer.input.canvasSize.y}#u(e){switch(this.state=e,e){case"idle":this.renderer.input.removeListener("click",this.#b),this.renderer.input.removeListener("mousemove",this.#m),this.dispatchEvent({type:"foxglove.measure-end"});break;case"place-first-point":this.#c=this.#h=void 0,this.renderer.input.addListener("click",this.#b),this.renderer.input.addListener("mousemove",this.#m),this.dispatchEvent({type:"foxglove.measure-start"});break;case"place-second-point":break}this.#f(),this.#p()}#m=(e,t,s)=>{if(t){switch(this.state){case"idle":break;case"place-first-point":(this.#c??=new c.Pa4).copy(t),this.#l=!0;break;case"place-second-point":(this.#h??=new c.Pa4).copy(t),this.#d=!0,this.#f();break}this.#p()}};#f(){this.#c&&this.#h&&this.#o.setText(this.#c.distanceTo(this.#h).toFixed(2))}#b=(e,t,s)=>{if(t){switch(this.state){case"idle":break;case"place-first-point":this.#c=t.clone(),this.#l=!0,this.#u("place-second-point");break;case"place-second-point":this.#h=t.clone(),this.#d=!0,this.#u("idle");break}this.#p()}};#p(){this.#c?(this.#s.visible=!0,this.#s.position.copy(this.#c),this.#l&&(this.#n.setXYZ(0,this.#c.x,this.#c.y,this.#c.z),this.#n.needsUpdate=!0,this.#a.computeLineDistances(),this.#l=!1)):this.#s.visible=!1,this.#h?(this.#i.visible=!0,this.#i.position.copy(this.#h),this.#d&&(this.#n.setXYZ(1,this.#h.x,this.#h.y,this.#h.z),this.#n.needsUpdate=!0,this.#a.computeLineDistances(),this.#d=!1)):this.#i.visible=!1,this.#c&&this.#h?(this.#r.visible=!0,this.#a.visible=!0,this.#o.visible=!0,this.#o.position.copy(this.#c).lerp(this.#h,.5)):(this.#r.visible=!1,this.#a.visible=!1,this.#o.visible=!1),this.renderer.queueAnimationFrame()}}const lf="INVALID_OCCUPANCY_GRID",cf={r:1,g:1,b:1,a:1},df={r:0,g:0,b:0,a:1},hf={r:.5,g:.5,b:.5,a:1},uf={r:1,g:0,b:1,a:1},ff=1,pf=oe(cf),mf=oe(df),gf=oe(hf),bf=oe(uf),Qn={visible:!1,frameLocked:!1,colorMode:"custom",minColor:pf,maxColor:mf,unknownColor:gf,invalidColor:bf,alpha:ff};class yf extends K{dispose(){this.userData.texture.dispose(),this.userData.material.dispose(),this.userData.pickingMaterial.dispose()}details(){return this.userData.occupancyGrid}}class vf extends J.d{constructor(e){super("foxglove.OccupancyGrids",e)}getSubscriptions(){return[{type:"schema",schemaNames:sn,subscription:{handler:this.#e}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,s=[];for(const n of this.renderer.topics??[]){if(!j(n,sn))continue;const r={...Qn,...e[n.name]};let a={colorMode:{label:"Color mode",input:"select",value:r.colorMode,options:[{label:"Custom",value:"custom"},{label:"Map",value:"map"},{label:"Costmap",value:"costmap"},{label:"Raw",value:"raw"}]}};if(r.colorMode==="custom"){const o={minColor:{label:"Min color",input:"rgba",value:r.minColor},maxColor:{label:"Max color",input:"rgba",value:r.maxColor},unknownColor:{label:"Unknown color",input:"rgba",value:r.unknownColor},invalidColor:{label:"Invalid color",input:"rgba",value:r.invalidColor}};a={...a,...o}}else{const o={alpha:{label:"Alpha",input:"number",value:r.alpha,min:0,max:1,step:.1,placeholder:"auto"}};a={...a,...o}}a.frameLocked={label:"Frame lock",input:"boolean",value:r.frameLocked},s.push({path:["topics",n.name],node:{label:n.name,icon:"Cells",fields:a,visible:r.visible,order:n.name.toLocaleLowerCase(),handler:t}})}return s}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const s=t[1],n=this.renderables.get(s);if(n){const r=qn(n.userData.settings),a=this.renderer.config.topics[s];n.userData.settings={...Qn,...a};const o=qn(n.userData.settings);r!==o&&(n.userData.material.transparent=o,n.userData.material.depthWrite=!o,n.userData.material.needsUpdate=!0),this.#t(n,n.userData.occupancyGrid,n.userData.receiveTime)}};#e=e=>{const t=e.topic,s=Mf(e.message),n=(0,M.toNanoSec)(e.receiveTime);let r=this.renderables.get(t);if(!r){const a=this.renderer.config.topics[t],o={...Qn,...a},l=Zo(s),d=this.renderer.sharedGeometry.getGeometry(this.constructor.name,Tf),h=xf(t,d,l,o),f=h.material,m=h.userData.pickingMaterial;r=new yf(t,this.renderer,{receiveTime:n,messageTime:(0,M.toNanoSec)(s.header.stamp),frameId:this.renderer.normalizeFrameId(s.header.frame_id),pose:s.info.origin,settingsPath:["topics",t],settings:o,topic:t,occupancyGrid:s,mesh:h,texture:l,material:f,pickingMaterial:m}),r.add(h),this.add(r),this.renderables.set(t,r)}this.#t(r,s,n)};#t(e,t,s){e.userData.occupancyGrid=t,e.userData.pose=t.info.origin,e.userData.receiveTime=s,e.userData.messageTime=(0,M.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id);const n=t.info.width*t.info.height;if(t.data.length!==n){const d=`OccupancyGrid data length (${t.data.length}) is not equal to width ${t.info.width} * height ${t.info.height}`;Sf(this.renderer,e,d);return}let r=e.userData.texture;const a=t.info.width,o=t.info.height,l=t.info.resolution;(a!==r.image.width||o!==r.image.height)&&(r.dispose(),r=Zo(t),e.userData.texture=r,e.userData.material.map=r),wf(r,t,e.userData.settings),e.scale.set(l*a,l*o,1)}}function Tf(){const i=new c._12(1,1,1,1);return i.translate(.5,.5,0),i.computeBoundingSphere(),i}function Sf(i,e,t){i.settings.errors.addToTopic(e.userData.topic,lf,t)}function Zo(i){const e=i.info.width,t=i.info.height,s=e*t,n=new Uint8ClampedArray(s*4),r=new c.IEO(n,e,t,c.wk1,c.ywz,c.xfE,c.uWy,c.uWy,c.TyD,c.wem,1,c.rnI);return r.generateMipmaps=!1,r}function xf(i,e,t,s){const n=Cf(t),r=If(t,i,s),a=new c.Kj0(e,r);return a.castShadow=!0,a.receiveShadow=!0,a.userData.pickingMaterial=n,a}const Ms={r:0,g:0,b:0,a:0},mt={r:0,g:0,b:0,a:0},gt={r:0,g:0,b:0,a:0},Ue={r:0,g:0,b:0,a:0},bt={r:0,g:0,b:0,a:0};function wf(i,e,t){const s=e.info.width*e.info.height,n=i.image.data;R(Ue,t.minColor),R(bt,t.maxColor),R(mt,t.unknownColor),R(gt,t.invalidColor),xi(Ue),xi(bt),xi(mt),xi(gt);const r=e.data;for(let a=0;a<s;a++){const o=r[a]|0,l=a*4;if(t.colorMode==="custom")if(o===-1)n[l+0]=mt.r,n[l+1]=mt.g,n[l+2]=mt.b,n[l+3]=mt.a;else if(o>=0&&o<=100){const d=o/100;n[l+0]=Ue.r+(bt.r-Ue.r)*d,n[l+1]=Ue.g+(bt.g-Ue.g)*d,n[l+2]=Ue.b+(bt.b-Ue.b)*d,n[l+3]=Ue.a+(bt.a-Ue.a)*d}else n[l+0]=gt.r,n[l+1]=gt.g,n[l+2]=gt.b,n[l+3]=gt.a;else Df(Ms,o,t.colorMode),n[l+0]=Ms.r,n[l+1]=Ms.g,n[l+2]=Ms.b,n[l+3]=Ms.a*t.alpha}i.needsUpdate=!0}function If(i,e,t){const s=qn(t);return new c.vBJ({name:`${e}:Material`,alphaTest:1e-4,depthWrite:!s,map:i,side:c.ehD,transparent:s})}function Cf(i){return new c.jyz({vertexShader:`
      varying vec2 vUv;
      void main() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,fragmentShader:`
      uniform sampler2D map;
      uniform vec4 objectId;
      varying vec2 vUv;
      void main() {
        vec4 color = texture2D(map, vUv);
        if (color.a == 0.0) {
          discard;
        }
        gl_FragColor = objectId;
      }
    `,side:c.ehD,uniforms:{map:{value:i},objectId:{value:[NaN,NaN,NaN,NaN]}}})}function qn(i){return i.colorMode==="custom"?(R(Ue,i.minColor),R(bt,i.maxColor),R(mt,i.unknownColor),R(gt,i.invalidColor),Ue.a<1||bt.a<1||gt.a<1||mt.a<1):!0}function xi(i){i.r=Math.trunc(F(i.r)*255),i.g=Math.trunc(F(i.g)*255),i.b=Math.trunc(F(i.b)*255),i.a=Math.trunc(i.a*255)}function Mf(i){const e=i.info??{};return{header:Le(i.header),info:{map_load_time:ce(e.map_load_time),resolution:e.resolution??0,width:e.width??0,height:e.height??0,origin:te(e.origin)},data:Nc(i.data)}}let er,tr,Xt;function Df(i,e,t){const s=e>=0?e:e+256;(s<0||s>255)&&(i.r=0,i.g=0,i.b=0,i.a=0);let n;switch(t){case"costmap":er||(er=Ef()),n=er;break;case"map":tr||(tr=Af()),n=tr;break;case"raw":Xt||(Xt=Yo()),n=Xt;break;default:Xt||(Xt=Yo()),n=Xt}const r=n[Math.trunc(s)];i.r=r[0],i.g=r[1],i.b=r[2],i.a=r[3]}function Af(){let i=0;const e=new Array(256).fill([0,0,0,0]);for(let t=0;t<=100;t++){const s=Math.trunc(255-255*t/100);e[i++]=[s,s,s,255]}for(let t=101;t<=127;t++)e[i++]=[0,255,0,255];for(let t=128;t<=254;t++)e[i++]=[255,Math.trunc(255*(t-128)/(254-128)),0,255];return e[i++]=[112,137,134,255],e}function Ef(){let i=0;const e=new Array(256).fill([0,0,0,0]);e[i++]=[0,0,0,0];for(let t=1;t<=98;t++){const s=Math.trunc(255*t/100);e[i++]=[s,0,255-s,255]}e[i++]=[0,255,255,255],e[i++]=[255,0,255,255];for(let t=101;t<=127;t++)e[i++]=[0,255,0,255];for(let t=128;t<=254;t++)e[i++]=[255,Math.trunc(255*(t-128)/(254-128)),0,255];return e[i++]=[112,137,134,255],e}function Yo(){let i=0;const e=new Array(256).fill([0,0,0,0]);for(let t=0;t<256;t++)e[i++]=[t,t,t,255];return e}const sr={...yi,stixelsEnabled:!1},Pf=["gradient","colormap"],_f=new Set([...ti,...Ys]),ir="INVALID_POINTCLOUD",De={r:0,g:0,b:0,a:0},Ko=[0,0],Xo={xReader:he,yReader:he,zReader:he,packedColorReader:he,redReader:he,greenReader:he,blueReader:he,alphaReader:he};class Jo extends zo{details(){return this.userData.originalMessage??{}}instanceDetails(e){const t=this.userData.pointCloud,s=t.data,n=Ds(t),r=new DataView(s.buffer,s.byteOffset,s.byteLength),a=Ds(t),o={};for(const l of t.fields){const d=e*a,h=we(l,n);h&&(o[l.name]=h(r,d))}return o}}class Qo extends K{pickable=!1;#e;#t;constructor(e,t,s){super(e,t,s);const n=s.settings.decayTime>0,r=Uo(e,n?c.W2J:c.dj0),a=new Jo(e,{receiveTime:-1n,messageTime:-1n,frameId:"",pose:As(s.latestPointCloud),settingsPath:[],settings:{visible:!0},topic:e,pointCloud:s.latestPointCloud,originalMessage:s.latestOriginalMessage},r,s.material,s.pickingMaterial,s.instancePickingMaterial);this.#e=new Yn({initial:{messageTime:s.receiveTime,receiveTime:s.receiveTime,renderable:a},parentRenderable:this,renderer:t}),this.add(a);const o=el(e,n?c.W2J:c.dj0),l=new tl(e,{receiveTime:-1n,messageTime:-1n,frameId:"",pose:As(s.latestPointCloud),settingsPath:[],settings:{visible:!0},topic:e},o,s.stixelMaterial);this.#t=new Yn({initial:{messageTime:s.receiveTime,receiveTime:s.receiveTime,renderable:l},parentRenderable:this,renderer:t}),this.add(l)}dispose(){this.userData.latestOriginalMessage=void 0,this.userData.material.dispose(),this.userData.pickingMaterial.dispose(),this.userData.instancePickingMaterial.dispose(),this.userData.stixelMaterial.dispose(),this.#e.dispose(),this.#t.dispose(),super.dispose()}updatePointCloud(e,t,s,n){const r=(0,M.toNanoSec)(qo(e));this.userData.receiveTime=n,this.userData.messageTime=r,this.userData.frameId=this.renderer.normalizeFrameId(zf(e)),this.userData.latestPointCloud=e,this.userData.latestOriginalMessage=t;const a=this.userData.settings,o=a.decayTime>0;this.userData.settings=s;let l=this.userData.material,d=this.userData.stixelMaterial;const h=qs(s)!==l.transparent||Hn(s)!==Hn(a)||s.pointShape!==a.pointShape,f=this.#e,m=this.#t;h?(l.dispose(),l=Zn(s),this.userData.material=l,f.forEach(L=>{L.renderable.updateMaterial(l)}),d.dispose(),d=nr(s),this.userData.stixelMaterial=d,m.forEach(L=>{L.renderable.updateMaterial(d)})):l.size=s.pointSize;const p=a.stixelsEnabled!==s.stixelsEnabled;if(!s.stixelsEnabled&&p&&m.clearHistory(),!this.#i(e)||!this.#a(Xo,e,s))return;const g=f.latest();g.receiveTime=n,g.messageTime=r,g.renderable.userData.pose=As(e),g.renderable.userData.pointCloud=e,g.renderable.userData.originalMessage=t;const u=Math.trunc(e.data.length/Ds(e)),x=g.renderable;g.renderable.geometry.resize(u);const y=x.geometry.attributes.position,C=x.geometry.attributes.color,T=m.latest(),I=s.decayTime>0;!I&&o!==I&&(g.renderable.geometry.setUsage(c.dj0),T.renderable.geometry.setUsage(c.dj0)),T.receiveTime=n,T.messageTime=r,T.renderable.userData.pose=g.renderable.userData.pose,s.stixelsEnabled?T.renderable.geometry.resize(u*2):T.renderable.geometry.resize(0);const _=T.renderable.geometry.attributes.position,P=T.renderable.geometry.attributes.color;this.#l(e,Xo,u,s,y,C,_,P)}startFrame(e,t,s){this.#e.updateHistoryFromCurrentTime(e),this.#e.updatePoses(e,t,s),this.userData.settings.stixelsEnabled&&(this.#t.updateHistoryFromCurrentTime(e),this.#t.updatePoses(e,t,s))}pushHistory(e,t,s,n){const r=(0,M.toNanoSec)(qo(e)),a=this.#e,o=this.#t,l=this.userData.material,d=this.userData.stixelMaterial,h=this.userData.topic,f=Uo(h,c.W2J),m=new Jo(h,{receiveTime:-1n,messageTime:-1n,frameId:"",pose:As(e),settingsPath:[],settings:{visible:!0},topic:h,pointCloud:e,originalMessage:t},f,l,this.userData.pickingMaterial,this.userData.instancePickingMaterial);if(a.addHistoryEntry({receiveTime:n,messageTime:r,renderable:m}),this.add(m),s.stixelsEnabled){const p=el(h,c.W2J),g=new tl(h,{receiveTime:-1n,messageTime:-1n,frameId:"",pose:As(e),settingsPath:[],settings:{visible:!0},topic:h},p,d);o.addHistoryEntry({receiveTime:n,messageTime:r,renderable:g}),this.add(g)}}#s(e){this.renderer.settings.errors.addToTopic(this.userData.topic,ir,e),this.#e.latest().renderable.geometry.resize(0)}#i(e){return e.header?this.#r(e):this.#n(e)}#n(e){const t=e.data;if(t.length%e.point_stride!==0){const s=`PointCloud data length ${t.length} is not a multiple of point_stride ${e.point_stride}`;return this.#s(s),!1}if(e.fields.length===0){const s="PointCloud has no fields";return this.#s(s),!1}return!0}#r(e){const t=e.data;if(e.is_bigendian){const s="PointCloud2 is_bigendian=true is not supported";return this.#s(s),!1}if(t.length%e.point_step!==0){const s=`PointCloud2 data length ${t.length} is not a multiple of point_step ${e.point_step}`;return this.#s(s),!1}if(e.fields.length===0){const s="PointCloud2 has no fields";return this.#s(s),!1}if(t.length<e.height*e.row_step){const s=`PointCloud2 data length ${t.length} is less than height ${e.height} * row_step ${e.row_step}`;this.renderer.settings.errors.addToTopic(this.userData.topic,ir,s)}if(e.width*e.point_step>e.row_step){const s=`PointCloud2 width ${e.width} * point_step ${e.point_step} is greater than row_step ${e.row_step}`;this.renderer.settings.errors.addToTopic(this.userData.topic,ir,s)}return!0}#a(e,t,s){let n,r,a,o,l,d,h,f;const m=Ds(t);let p=0;for(const u of t.fields){if(!Pt(u))continue;const x=u.type,y=x!=null?kc(x):u.datatype;if(u.offset<0){const T=`PointCloud field "${u.name}" has invalid offset ${u.offset}. Must be >= 0`;return this.#s(T),!1}if(u.name==="x"){if(n=we(u,m),!n){const I=`PointCloud field "x" is invalid. type=${wi(y)}, offset=${u.offset}, stride=${m}`;return this.#s(I),!1}}else if(u.name==="y"){if(r=we(u,m),!r){const I=`PointCloud field "y" is invalid. type=${wi(y)}, offset=${u.offset}, stride=${m}`;return this.#s(I),!1}}else if(u.name==="z"){if(a=we(u,m),!a){const I=`PointCloud field "z" is invalid. type=${wi(y)}, offset=${u.offset}, stride=${m}`;return this.#s(I),!1}}else u.name==="red"?l=we(u,m,!0):u.name==="green"?d=we(u,m,!0):u.name==="blue"?h=we(u,m,!0):u.name==="alpha"&&(f=we(u,m,!0));const C=Rf(y);if(p=Math.max(p,u.offset+C),u.name===s.colorField){const T=(s.colorMode==="rgb"||s.colorMode==="rgba")&&C>=4?x!=null?A.NumericType.UINT32:B.UINT32:void 0;if(o=we(u,m,!1,T),!o){const I=wi(y),_=`PointCloud field "${u.name}" is invalid. type=${I}, offset=${u.offset}, stride=${m}`;return this.#s(_),!1}}}if(p>m){const u=`PointCloud stride ${m} is less than minimum bytes per point ${p}`;return this.#s(u),!1}if((n?1:0)+(r?1:0)+(a?1:0)<2){const u="PointCloud must contain at least two of x/y/z fields";return this.#s(u),!1}return e.xReader=n??he,e.yReader=r??he,e.zReader=a??he,e.packedColorReader=o??n??r??a??he,e.redReader=l??he,e.greenReader=d??he,e.blueReader=h??he,e.alphaReader=f??he,!0}#o(e,t,s,n,r,a){let o=a.minValue??Number.POSITIVE_INFINITY,l=a.maxValue??Number.NEGATIVE_INFINITY;if(Pf.includes(a.colorMode)&&(a.minValue==null||a.maxValue==null)){for(let d=0;d<n;d++){const h=d*r,f=t(s,h);o=Math.min(o,f),l=Math.max(l,f)}o=a.minValue??o,l=a.maxValue??l}e[0]=o,e[1]=l}#l(e,t,s,n,r,a,o,l){const d=e.data,h=new DataView(d.buffer,d.byteOffset,d.byteLength),f=Ds(e),{xReader:m,yReader:p,zReader:g,packedColorReader:u,redReader:x,greenReader:y,blueReader:C,alphaReader:T}=t;for(let I=0;I<s;I++){const _=I*f,P=m(h,_),L=p(h,_),G=g(h,_);r.setXYZ(I,P,L,G),n.stixelsEnabled&&(o.setXYZ(I*2,P,L,G),o.setXYZ(I*2+1,P,L,0))}if(n.colorMode==="rgba-fields")for(let I=0;I<s;I++){const _=I*f,P=x(h,_),L=y(h,_),G=C(h,_),Z=T(h,_);a.setXYZW(I,P,L,G,Z),n.stixelsEnabled&&(l.setXYZW(I*2,P,L,G,Z),l.setXYZW(I*2+1,P,L,G,Z))}else{this.#o(Ko,u,h,s,f,n);const[I,_]=Ko,P=Js(n,I,_);for(let L=0;L<s;L++){const G=L*f,Z=u(h,G);P(De,Z),a.setXYZW(L,De.r,De.g,De.b,De.a),n.stixelsEnabled&&(l.setXYZW(L*2,De.r,De.g,De.b,De.a),l.setXYZW(L*2+1,De.r,De.g,De.b,De.a))}}r.needsUpdate=!0,a.needsUpdate=!0,o.needsUpdate=!0,l.needsUpdate=!0}}class Lf extends J.d{#e=new Map;constructor(e){super("foxglove.PointClouds",e)}getSubscriptions(){return[{type:"schema",schemaNames:Ys,subscription:{handler:this.#s}},{type:"schema",schemaNames:ti,subscription:{handler:this.#t}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,s=[];for(const n of this.renderer.topics??[]){if(!j(n,_f))continue;const a=e[n.name]??{},o=this.#e.get(n.name)??Oo,l=Wn(n,o,a);l.fields.stixelsEnabled={label:"Stixel view",input:"boolean",value:a.stixelsEnabled??sr.stixelsEnabled},l.handler=t,l.icon="Points",s.push({path:["topics",n.name],node:l})}return s}startFrame(e,t,s){for(const[n,r]of this.renderables){if(!r.userData.settings.visible){r.removeFromParent(),r.dispose(),this.renderables.delete(n);continue}r.startFrame(e,t,s)}}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const s=t[1],n=this.renderables.get(s);if(n){const r=this.renderer.config.topics[s],a={...sr,...r};n.updatePointCloud(n.userData.latestPointCloud,n.userData.latestOriginalMessage,a,n.userData.receiveTime)}};#t=e=>{const t=e.topic,s=Ff(e.message),n=(0,M.toNanoSec)(e.receiveTime),r=(0,M.toNanoSec)(s.timestamp),a=s.frame_id;let o=this.#e.get(t);(!o||o.length!==s.fields.length)&&(o=s.fields.map(l=>l.name),this.#e.set(t,o),this.updateSettingsTree()),this.#i(t,s,n,r,e.message,a)};#s=e=>{const t=e.topic,s=Uf(e.message),n=(0,M.toNanoSec)(e.receiveTime),r=(0,M.toNanoSec)(s.header.stamp),a=s.header.frame_id;let o=this.#e.get(t);const l=s.fields.reduce((d,h)=>d+(Pt(h)?1:0),0);(!o||o.length!==l)&&(o=(0,z.Z)(s.fields,d=>Pt(d)?d.name:void 0),this.#e.set(t,o),this.updateSettingsTree()),this.#i(t,s,n,r,e.message,a)};#i(e,t,s,n,r,a){let o=this.renderables.get(e);if(!o){const d=this.renderer.config.topics[e],h={...sr,...d};h.colorField==null&&(Fo(h,t,{supportsPackedRgbModes:!0}),this.renderer.updateConfig(u=>{const x={...d};x.colorField=h.colorField,x.colorMode=h.colorMode,x.colorMap=h.colorMap,u.topics[e]=x}));const f=Zn(h),m=ko(h),p=Go(h),g=nr(h);o=new Qo(e,this.renderer,{receiveTime:s,messageTime:n,frameId:this.renderer.normalizeFrameId(a),pose:(0,N.N2)(),settingsPath:["topics",e],settings:h,topic:e,latestPointCloud:t,latestOriginalMessage:r,material:f,pickingMaterial:m,instancePickingMaterial:p,stixelMaterial:g}),this.add(o),this.renderables.set(e,o)}const{settings:l}=o.userData;l.decayTime>0&&o.pushHistory(t,r,l,s),o.updatePointCloud(t,r,l,s)}}function wi(i){return B[i]??`${i}`}function Rf(i){switch(i){case B.INT8:case B.UINT8:return 1;case B.INT16:case B.UINT16:return 2;case B.INT32:case B.UINT32:case B.FLOAT32:return 4;case B.FLOAT64:return 8;default:return 0}}function he(){return 0}function Nf(i){return i?{name:i.name??"",offset:i.offset??0,datatype:i.datatype??B.UNKNOWN,count:i.count??0}:{name:"",offset:0,datatype:B.UNKNOWN,count:0}}function Of(i){return{name:i?.name??"",offset:i?.offset??0,type:i?.type??0}}function Ff(i){return{timestamp:ce(i.timestamp),frame_id:i.frame_id??"",pose:te(i.pose),point_stride:i.point_stride??0,fields:i.fields?.map(Of)??[],data:kt(i.data)}}function Uf(i){return{header:Le(i.header),height:i.height??0,width:i.width??0,fields:i.fields?.map(Nf)??[],is_bigendian:i.is_bigendian??!1,point_step:i.point_step??0,row_step:i.row_step??0,data:kt(i.data),is_dense:i.is_dense??!1}}function qo(i){const e=i;return e.header?e.header.stamp:i.timestamp}function zf(i){const e=i;return e.header?e.header.frame_id:i.frame_id}function Ds(i){return i.point_step??i.point_stride}function As(i){return i.pose??(0,N.N2)()}function nr(i){const e=qs(i);return new c.nls({vertexColors:!0,transparent:e,depthWrite:!0})}function el(i,e){const t=new At(e);return t.name=`${i}:PointCloud:stixelGeometry`,t.createAttribute("position",Float32Array,3),t.createAttribute("color",Uint8Array,4,!0),t}class tl extends K{#e;geometry;constructor(e,t,s,n){super(e,void 0,t),this.geometry=s;const r=new c.ejS(s,n);r.frustumCulled=!1,r.name=`${t.topic}:PointCloud:stixels`,this.#e=r,this.add(r)}dispose(){this.#e.geometry.dispose()}updateMaterial(e){this.#e.material=e}}const kf=[0,0,0,0];class rr extends Oe{#e;#t;#s;#i=new Float32Array;#n=new Uint8Array;constructor(e,t,s,n){super(e,t,s,n),this.#e=new jt.L;const r={resolution:n.input.canvasSize,worldUnits:!0},a=io(t,r);this.#t=new hi.w(this.#e,a),this.#t.renderOrder=1,this.#t.userData.picking=!1,this.add(this.#t);const o=no(t,r);this.#s=new hi.w(this.#e,o),this.#s.renderOrder=2;const l=t.scale.x*1.2;this.#s.userData.pickingMaterial=Un(l,r),this.add(this.#s),this.update(t,s)}dispose(){this.#t.material.dispose(),this.#s.material.dispose(),this.#s.userData.pickingMaterial.dispose(),this.#s.userData.pickingMaterial=void 0,super.dispose()}update(e,t){const s=this.userData.marker;super.update(e,t);const n=this.userData.marker,r=n.points.length,a=n.scale.x,o=ne(n);if(r===0){this.#t.visible=!1,this.#s.visible=!1;return}else this.#t.visible=!0,this.#s.visible=!0;o!==ne(s)&&(this.#t.material.transparent=o,this.#t.material.depthWrite=!o,this.#t.material.needsUpdate=!0,this.#s.material.transparent=o,this.#s.material.depthWrite=!o,this.#s.material.needsUpdate=!0);const l=this.#t.material;l.lineWidth=a;const d=this.#s.material;d.lineWidth=a;const h=this.#i.length/3;r>h&&(this.#e.dispose(),this.#e=new jt.L,this.#t.geometry=this.#e,this.#s.geometry=this.#e),this.#r(n,r),this.#a(n,r),this.#t.computeLineDistances(),this.#s.computeLineDistances()}#r(e,t){3*t>this.#i.length&&(this.#i=new Float32Array(3*t));const s=this.#i;for(let n=0;n<t;n++){const r=e.points[n],a=n*3;s[a+0]=r.x,s[a+1]=r.y,s[a+2]=r.z}this.#e.setPositions(s),this.#e.instanceCount=t-1}#a(e,t){if(8*t>this.#n.length){this.#n=new Uint8Array(8*t);const r=new c.$TI(this.#n,8,1);this.#e.setAttribute("instanceColorStart",new c.kB5(r,4,0,!0)),this.#e.setAttribute("instanceColorEnd",new c.kB5(r,4,4,!0))}else this.#e.getAttribute("instanceColorStart").needsUpdate=!0,this.#e.getAttribute("instanceColorEnd").needsUpdate=!0;const s=this.#n,n=kf;n[0]=0,n[1]=0,n[2]=0,n[3]=0,this._markerColorsToLinear(e,t,(r,a)=>{if(a===0){sl(r,n);return}const l=(a-1)*8;s[l+0]=Math.floor(255*n[0]),s[l+1]=Math.floor(255*n[1]),s[l+2]=Math.floor(255*n[2]),s[l+3]=Math.floor(255*n[3]),s[l+4]=Math.floor(255*r[0]),s[l+5]=Math.floor(255*r[1]),s[l+6]=Math.floor(255*r[2]),s[l+7]=Math.floor(255*r[3]),sl(r,n)})}}function sl(i,e){e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3]}const Gf={r:124/255,g:107/255,b:1,a:1},il=.1,nl=oe(Gf),ar={visible:!1,lineWidth:il,color:nl};class Bf extends K{dispose(){this.userData.lines?.dispose(),super.dispose()}details(){return this.userData.polygonStamped}}class jf extends J.d{constructor(e){super("foxglove.Polygons",e)}getSubscriptions(){return[{type:"schema",schemaNames:cn,subscription:{handler:this.#e}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,s=[];for(const n of this.renderer.topics??[]){if(!j(n,cn))continue;const r=e[n.name]??{},a={lineWidth:{label:"Line Width",input:"number",min:0,placeholder:String(il),step:.005,precision:3,value:r.lineWidth},color:{label:"Color",input:"rgba",value:r.color??nl}};s.push({path:["topics",n.name],node:{label:n.name,icon:"Star",fields:a,visible:r.visible??ar.visible,handler:t}})}return s}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const s=t[1],n=this.renderables.get(s);if(n){const r=this.renderer.config.topics[s];n.userData.settings={...ar,...r},this.#t(n,n.userData.polygonStamped,n.userData.receiveTime)}};#e=e=>{const t=e.topic,s=Wf(e.message),n=(0,M.toNanoSec)(e.receiveTime);let r=this.renderables.get(t);if(!r){const a=this.renderer.config.topics[t],o={...ar,...a};r=new Bf(t,this.renderer,{receiveTime:n,messageTime:(0,M.toNanoSec)(s.header.stamp),frameId:this.renderer.normalizeFrameId(s.header.frame_id),pose:(0,N.N2)(),settingsPath:["topics",t],settings:o,topic:t,polygonStamped:s,lines:void 0}),this.add(r),this.renderables.set(t,r)}this.#t(r,s,n)};#t(e,t,s){const n=e.userData.settings;e.userData.receiveTime=s,e.userData.messageTime=(0,M.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id),e.userData.polygonStamped=t;const r=e.userData.topic,a=$f(t,n);e.userData.lines?e.userData.lines.update(a,s):(e.userData.lines=new rr(r,a,s,this.renderer),e.add(e.userData.lines))}}function $f(i,e){const t=[...i.polygon.points];return t.length>0&&t.push(t[0]),{header:i.header,ns:"",id:0,type:E.LINE_STRIP,action:le.ADD,pose:(0,N.N2)(),scale:{x:e.lineWidth,y:1,z:1},color:R(ee(),e.color),lifetime:dt,frame_locked:!0,points:t,colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function Vf(i){return{points:Wr(i?.points)}}function Wf(i){return{header:Le(i.header),polygon:Vf(i.polygon)}}var Hf=b(89380);const rl=.77,al=1,ol=.23,ll=2,Zf=.23,Yf=new c.Pa4(1,0,0),cl=new c.Pa4,dl=new c.Pa4,Es=new c.Pa4;class Ii extends Oe{shaftMesh;headMesh;#e;#t;constructor(e,t,s,n){super(e,t,s,n);const r=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-shaft-${n.maxLod}`,()=>Kf(n.maxLod)),a=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-head-${n.maxLod}`,()=>Xf(n.maxLod)),o=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-shaftedges-${n.maxLod}`,()=>Jf(r)),l=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-headedges-${n.maxLod}`,()=>Qf(a));this.shaftMesh=new c.Kj0(r,Ht(t.color)),this.shaftMesh.castShadow=!0,this.shaftMesh.receiveShadow=!0,this.add(this.shaftMesh),this.headMesh=new c.Kj0(a,Ht(t.color)),this.headMesh.castShadow=!0,this.headMesh.receiveShadow=!0,this.add(this.headMesh),this.#e=new c.ejS(o,n.outlineMaterial),this.#e.userData.picking=!1,this.shaftMesh.add(this.#e),this.#t=new c.ejS(l,n.outlineMaterial),this.#t.userData.picking=!1,this.headMesh.add(this.#t),this.update(t,s)}dispose(){this.shaftMesh.material.dispose(),this.headMesh.material.dispose(),super.dispose()}update(e,t){super.update(e,t);const s=this.userData.marker,n=s.color.a<1;n!==this.shaftMesh.material.transparent&&(this.shaftMesh.material.transparent=n,this.shaftMesh.material.depthWrite=!n,this.shaftMesh.material.needsUpdate=!0,this.headMesh.material.transparent=n,this.headMesh.material.depthWrite=!n,this.headMesh.material.needsUpdate=!0),be(this.shaftMesh.material.color,s.color),this.shaftMesh.material.opacity=s.color.a,this.headMesh.material.color.set(this.shaftMesh.material.color),this.headMesh.material.opacity=s.color.a;const r=this.getSettings();if(this.#e.visible=r?.showOutlines??!0,this.#t.visible=r?.showOutlines??!0,s.points.length===2){const a=s.points[0],o=s.points[1];cl.set(a.x,a.y,a.z),dl.set(o.x,o.y,o.z),Es.subVectors(dl,cl);const l=Es.length();let d=Zf*l;if(s.scale.z!==0){const g=s.scale.z;d=(0,Hf.uZ)(g,0,l)}const h=l-d,f=s.scale.x,m=s.scale.y;this.shaftMesh.scale.set(h,f,f),this.headMesh.scale.set(d,m,m),this.scale.set(1,1,1),this.shaftMesh.position.set(a.x,a.y,a.z),this.shaftMesh.position.addScaledVector(Es,.5*(h/l)),this.headMesh.position.set(o.x,o.y,o.z),this.headMesh.position.addScaledVector(Es,-.5*(d/l));const p=Pc(Yf,Es);this.shaftMesh.setRotationFromQuaternion(p),this.headMesh.rotation.copy(this.shaftMesh.rotation)}else{this.shaftMesh.scale.set(rl,al,al),this.headMesh.scale.set(ol,ll,ll),this.scale.set(s.scale.x,s.scale.y,s.scale.z);const a=rl/2,o=ol/2;this.shaftMesh.position.set(a,0,0),this.headMesh.position.set(a*2+o,0,0),this.shaftMesh.rotation.set(0,0,0),this.headMesh.rotation.set(0,0,0)}}}function Kf(i){const e=Xa(i),t=new c.fHI(.5,.5,1,e,1,!1);return t.rotateZ(-Math.PI/2),t.computeBoundingSphere(),t}function Xf(i){const e=Ja(i),t=new c.b_z(.5,1,e,1,!1);return t.rotateZ(-Math.PI/2),t.computeBoundingSphere(),t}function Jf(i){const e=new c.TOt(i,40),t=e.getAttribute("position"),s=Array.from(t.array),n=s.length/3/2*3,r=s.slice(n,s.length),a=new c.a$l(r,3);return e.setAttribute("position",a),e.computeBoundingSphere(),e}function Qf(i){const e=new c.TOt(i,40);return e.computeBoundingSphere(),e}class Ci extends Oe{mesh;constructor(e,t,s,n){super(e,t,s,n);const r=n.sharedGeometry.getGeometry(`${this.constructor.name}-${n.maxLod}`,()=>hl(n.maxLod));this.mesh=new c.Kj0(r,Ht(t.color)),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.add(this.mesh),this.update(t,s)}dispose(){this.mesh.material.dispose()}update(e,t){super.update(e,t);const s=this.userData.marker,n=s.color.a<1;n!==this.mesh.material.transparent&&(this.mesh.material.transparent=n,this.mesh.material.depthWrite=!n,this.mesh.material.needsUpdate=!0),be(this.mesh.material.color,s.color),this.mesh.material.opacity=s.color.a,this.scale.set(s.scale.x,s.scale.y,s.scale.z)}}function hl(i){const e=Gh(i),t=new c.xo$(.5,e,e);return t.computeBoundingSphere(),t}const ul="axis",fl=xs,pl=[1,.15,.15],qf={r:124/255,g:107/255,b:1,a:1},ml=!0,ep={r:198/255,g:107/255,b:1,a:.25},gl=oe(qf),bl=oe(ep),or={type:ul,visible:!1,axisScale:fl,arrowScale:pl,color:gl,showCovariance:ml,covarianceColor:bl},tp=[{label:"Axis",value:"axis"},{label:"Arrow",value:"arrow"}];class sp extends K{dispose(){this.userData.axis?.dispose(),this.userData.arrow?.dispose(),this.userData.sphere?.dispose(),super.dispose()}details(){return this.userData.originalMessage}}class ip extends J.d{constructor(e){super("foxglove.Poses",e)}getSubscriptions(){return[{type:"schema",schemaNames:an,subscription:{handler:this.#e}},{type:"schema",schemaNames:yn,subscription:{handler:this.#t}},{type:"schema",schemaNames:on,subscription:{handler:this.#s}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,s=[];for(const n of this.renderer.topics??[]){const r=j(n,an),a=j(n,yn),o=r?!1:j(n,on);if(!(r||o||a))continue;const l=e[n.name]??{},d=l.type??ul,h={type:{label:"Type",input:"select",options:tp,value:d}};if(d==="axis"?h.axisScale={label:"Scale",input:"number",step:.5,min:0,precision:V,value:l.axisScale??fl}:(h.arrowScale={label:"Scale",input:"vec3",labels:["X","Y","Z"],step:.5,precision:V,value:l.arrowScale??pl},h.color={label:"Color",input:"rgba",value:l.color??gl}),o){const f=l.showCovariance??ml,m=l.covarianceColor??bl;h.showCovariance={label:"Covariance",input:"boolean",value:f},f&&(h.covarianceColor={label:"Covariance Color",input:"rgba",value:m})}s.push({path:["topics",n.name],node:{label:n.name,icon:"Flag",fields:h,visible:l.visible??or.visible,order:n.name.toLocaleLowerCase(),handler:t}})}return s}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const s=t[1],n=this.renderables.get(s);if(n){const r=this.renderer.config.topics[s];this.#n(n,n.userData.poseMessage,n.userData.originalMessage,n.userData.receiveTime,{...or,...r})}};#e=e=>{const t=rp(e.message),s=(0,M.toNanoSec)(e.receiveTime);this.#i(e.topic,t,e.message,s)};#t=e=>{const t=ap(e.message),s=(0,M.toNanoSec)(e.receiveTime);this.#i(e.topic,t,e.message,s)};#s=e=>{const t=lp(e.message),s=(0,M.toNanoSec)(e.receiveTime);this.#i(e.topic,t,e.message,s)};#i(e,t,s,n){let r=this.renderables.get(e);if(!r){const a=this.renderer.config.topics[e],o={...or,...a};r=new sp(e,this.renderer,{receiveTime:n,messageTime:(0,M.toNanoSec)(t.header.stamp),frameId:this.renderer.normalizeFrameId(t.header.frame_id),pose:(0,N.N2)(),settingsPath:["topics",e],settings:o,topic:e,poseMessage:t,originalMessage:s,axis:void 0,arrow:void 0,sphere:void 0}),this.add(r),this.renderables.set(e,r)}this.#n(r,t,s,n,r.userData.settings)}#n(e,t,s,n,r){e.userData.receiveTime=n,e.userData.messageTime=(0,M.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id),e.userData.poseMessage=t,e.userData.originalMessage=s,e.userData.sphere&&(e.userData.sphere.visible=!1);const{topic:a,settings:o}=e.userData,l=r.type!==o.type||r.axisScale!==o.axisScale||!Ki(r.arrowScale,o.arrowScale)||r.color!==o.color||!e.userData.arrow&&!e.userData.axis;if(e.userData.settings=r,l)if(e.userData.settings.type==="axis"){if(e.userData.arrow&&(e.remove(e.userData.arrow),e.userData.arrow.dispose(),e.userData.arrow=void 0),!e.userData.axis){const h=new ws(a,this.renderer);e.userData.axis=h,e.add(h)}const d=e.userData.settings.axisScale*(1/xs);e.userData.axis.scale.set(d,d,d)}else{e.userData.axis&&(e.remove(e.userData.axis),e.userData.axis.dispose(),e.userData.axis=void 0);const d=R(ee(),r.color),h=yl(r.arrowScale,d);if(!e.userData.arrow){const f=new Ii(a,h,void 0,this.renderer);e.userData.arrow=f,e.add(f)}e.userData.arrow.update(h,void 0)}if("covariance"in t.pose){e.userData.pose=t.pose.pose;const h=np(t,e.userData.settings);h?(e.userData.sphere||(e.userData.sphere=new Ci(e.userData.topic,h,void 0,this.renderer),e.add(e.userData.sphere)),e.userData.sphere.visible=e.userData.settings.showCovariance,e.userData.sphere.update(h,void 0)):e.userData.sphere&&(e.userData.sphere.visible=!1)}else e.userData.pose=t.pose}}function yl(i,e){const[t,s,n]=i;return{header:{frame_id:"",stamp:{sec:0,nsec:0}},ns:"",id:0,type:E.ARROW,action:le.ADD,pose:(0,N.N2)(),scale:{x:t,y:s,z:n},color:e,lifetime:dt,frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function np(i,e){const t=i.pose.covariance,s={x:Math.sqrt(t[0]),y:Math.sqrt(t[7]),z:Math.sqrt(t[14])};return{header:i.header,ns:"",id:1,type:E.SPHERE,action:le.ADD,pose:(0,N.N2)(),scale:s,color:R(ee(),e.covarianceColor),lifetime:dt,frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function rp(i){return{header:Le(i.header),pose:te(i.pose)}}function ap(i){return{header:{stamp:ce(i.timestamp),frame_id:i.frame_id??""},pose:te(i.pose)}}function op(i){const e=Oc(i?.covariance);return{pose:te(i?.pose),covariance:e}}function lp(i){return{header:Le(i.header),pose:op(i.pose)}}const vl="axis",Tl=xs,Sl=[1,.15,.15],xl=.2,wl=[{r:124/255,g:107/255,b:1,a:1},{r:124/255,g:107/255,b:1,a:.5}],cp="MISMATCHED_FRAME_ID",dp={sec:0,nsec:0},hp={r:1,g:1,b:1,a:1},Il=[oe(wl[0]),oe(wl[1])],lr={visible:!1,type:vl,axisScale:Tl,arrowScale:Sl,lineWidth:xl,gradient:Il},up=[{label:"Axis",value:"axis"},{label:"Arrow",value:"arrow"},{label:"Line",value:"line"}],fp=ee(),pp=ee(),mp=ee();class gp extends K{dispose(){this.userData.axes.forEach(e=>{e.dispose()}),this.userData.arrows.forEach(e=>{e.dispose()}),this.userData.lineStrip?.dispose(),super.dispose()}details(){return this.userData.originalMessage}removeArrows(){for(const e of this.userData.arrows)this.remove(e),e.dispose();this.userData.arrows.length=0}removeAxes(){for(const e of this.userData.axes)this.remove(e),e.dispose();this.userData.axes.length=0}removeLineStrip(){this.userData.lineStrip&&(this.remove(this.userData.lineStrip),this.userData.lineStrip.dispose(),this.userData.lineStrip=void 0)}}class bp extends J.d{constructor(e){super("foxglove.PoseArrays",e)}getSubscriptions(){return[{type:"schema",schemaNames:ln,subscription:{handler:this.#e}},{type:"schema",schemaNames:vn,subscription:{handler:this.#s}},{type:"schema",schemaNames:os,subscription:{handler:this.#t}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,s=[];for(const n of this.renderer.topics??[]){if(!(j(n,ln)||j(n,os)||j(n,vn)))continue;const r=e[n.name]??{},a=r.type??cr(n),{axisScale:o,lineWidth:l}=r,d=r.arrowScale??Sl,h=r.gradient??Il,f={type:{label:"Type",input:"select",options:up,value:a}};switch(a){case"axis":f.axisScale=Qa("Scale",o,Tl);break;case"arrow":f.arrowScale=jh("Scale",d);break;case"line":f.lineWidth=qa("Line Width",l,xl);break}a!=="axis"&&(f.gradient=$h("Gradient",h)),s.push({path:["topics",n.name],node:{label:n.name,icon:j(n,os)?"Timeline":"Flag",fields:f,visible:r.visible??lr.visible,handler:t}})}return s}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const s=t[1],n=this.renderables.get(s);if(n){const r=this.renderer.config.topics[s],a={type:cr(this.renderer.topicsByName?.get(s))};this.#a(n,n.userData.poseArrayMessage,n.userData.originalMessage,n.userData.receiveTime,{...lr,...a,...r})}};#e=e=>{const t=yp(e.message),s=(0,M.toNanoSec)(e.receiveTime);this.#i(e.topic,t,e.message,s)};#t=e=>{if(!Sp(e,this.renderer))return;const t=vp(e.message),s=(0,M.toNanoSec)(e.receiveTime);this.#i(e.topic,t,e.message,s)};#s=e=>{const t=Tp(e.message),s=(0,M.toNanoSec)(e.receiveTime);this.#i(e.topic,t,e.message,s)};#i(e,t,s,n){let r=this.renderables.get(e);if(!r){const a=this.renderer.config.topics[e],o={type:cr(this.renderer.topicsByName?.get(e))},l={...lr,...o,...a};r=new gp(e,this.renderer,{receiveTime:n,messageTime:(0,M.toNanoSec)(t.header.stamp),frameId:this.renderer.normalizeFrameId(t.header.frame_id),pose:(0,N.N2)(),settingsPath:["topics",e],settings:l,topic:e,poseArrayMessage:t,originalMessage:s,axes:[],arrows:[]}),this.add(r),this.renderables.set(e,r)}this.#a(r,t,s,n,r.userData.settings)}#n(e,t,s){const n=e.userData.settings.axisScale*(1/xs),r=Math.min(e.userData.axes.length,t.poses.length);for(let a=0;a<r;a++){const o=e.userData.axes[a];o.visible=!0,o.scale.set(n,n,n)}for(let a=e.userData.axes.length;a<t.poses.length;a++){const o=new ws(s,this.renderer);e.userData.axes.push(o),e.add(o),o.scale.set(n,n,n)}for(let a=t.poses.length;a<e.userData.axes.length;a++){const o=e.userData.axes[a];o.visible=!1}}#r(e,t,s,n,r){const a=l=>{const d=l/(t.poses.length-1),h=qi(mp,n,r,d);return yl(e.userData.settings.arrowScale,h)},o=Math.min(e.userData.arrows.length,t.poses.length);for(let l=0;l<o;l++){const d=a(l),h=e.userData.arrows[l];h.visible=!0,h.update(d,void 0)}for(let l=e.userData.arrows.length;l<t.poses.length;l++){const d=a(l),h=new Ii(s,d,void 0,this.renderer);e.userData.arrows.push(h),e.add(h)}for(let l=t.poses.length;l<e.userData.arrows.length;l++){const d=e.userData.arrows[l];d.visible=!1}}#a(e,t,s,n,r){e.userData.receiveTime=n,e.userData.messageTime=(0,M.toNanoSec)(t.header.stamp),e.userData.frameId=this.renderer.normalizeFrameId(t.header.frame_id),e.userData.poseArrayMessage=t,e.userData.originalMessage=s;const{topic:a,settings:o}=e.userData,l=r.type!==o.type||r.axisScale!==o.axisScale||!Ki(r.arrowScale,o.arrowScale)||!Ki(r.gradient,o.gradient)||e.userData.arrows.length===0&&e.userData.axes.length===0;e.userData.settings=r;const d=R(fp,r.gradient[0]),h=R(pp,r.gradient[1]);if(l)switch(e.userData.settings.type){case"axis":e.removeArrows(),e.removeLineStrip();break;case"arrow":e.removeAxes(),e.removeLineStrip();break;case"line":{e.removeArrows(),e.removeAxes();const f=Ml(t,r.lineWidth,d,h);if(!e.userData.lineStrip){const m=new rr(a,f,void 0,this.renderer);e.userData.lineStrip=m,e.add(m)}e.userData.lineStrip.update(f,void 0)}break}switch(r.type){case"axis":this.#n(e,t,a);for(let f=0;f<t.poses.length;f++)Cl(e.userData.axes[f],t.poses[f]);break;case"arrow":this.#r(e,t,a,d,h);for(let f=0;f<t.poses.length;f++)Cl(e.userData.arrows[f],t.poses[f]);break;case"line":{const f=Ml(t,r.lineWidth,d,h);e.userData.lineStrip?.update(f,void 0);break}}}}function cr(i){return i!=null&&os.has(i.schemaName)?"line":vl}function Cl(i,e){const t=e.position,s=e.orientation;i.position.set(t.x,t.y,t.z),i.quaternion.set(s.x,s.y,s.z,s.w),i.updateMatrix()}function Ml(i,e,t,s){const n=[];for(let r=0;r<i.poses.length;r++){const a=r/(i.poses.length-1);n.push(qi(ee(),t,s,a))}return{header:i.header,ns:"",id:0,type:E.LINE_STRIP,action:le.ADD,pose:(0,N.N2)(),scale:{x:e,y:1,z:1},color:hp,lifetime:dp,frame_locked:!0,points:i.poses.map(r=>r.position),colors:n,text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function yp(i){return{header:Le(i.header),poses:i.poses?.map(e=>te(e))??[]}}function vp(i){return{header:Le(i.header),poses:i.poses?.map(e=>te(e?.pose))??[]}}function Tp(i){return{header:{stamp:ce(i.timestamp),frame_id:i.frame_id??""},poses:i.poses?.map(te)??[]}}function Sp(i,e){const{topic:t,message:s}=i;if(s.poses){const n=e.normalizeFrameId(s.header?.frame_id??"");for(const r of s.poses){const a=e.normalizeFrameId(r?.header?.frame_id??"");if(n!==a)return e.settings.errors.addToTopic(t,cp,`Path poses must all have the same frame_id. "${n}" != "${a}"`),!1}}return!0}var Dl=b(20414);const Al=new c.Pa4(1,0,0),El=new c.Pa4;function Pl(i){return{header:{frame_id:"",stamp:{sec:0,nsec:0}},ns:"",id:0,type:E.ARROW,action:le.ADD,pose:(0,Dl.N2)(),scale:{x:2,y:.25,z:.25},color:i==="pose_estimate"?{r:0,g:1,b:1,a:1}:{r:1,g:0,b:1,a:1},lifetime:dt,frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function xp(){return{header:{frame_id:"",stamp:{sec:0,nsec:0}},ns:"",id:0,type:E.SPHERE,action:le.ADD,pose:(0,Dl.N2)(),scale:{x:.25,y:.25,z:.25},color:{r:1,g:1,b:0,a:1},lifetime:dt,frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}class wp extends J.d{#e;#t;publishClickType="point";state="idle";#s;#i;constructor(e){super("foxglove.PublishClickTool",e),this.#e=new Ci("",xp(),void 0,this.renderer),this.#t=new Ii("",Pl(this.publishClickType),void 0,this.renderer),this.#e.visible=!1,this.#e.mesh.userData.picking=!1,this.#t.visible=!1,this.#t.shaftMesh.userData.picking=!1,this.#t.headMesh.userData.picking=!1,this.add(this.#e),this.add(this.#t),this.#n("idle")}dispose(){super.dispose(),this.#t.dispose(),this.#e.dispose(),this.renderer.input.removeListener("click",this.#a),this.renderer.input.removeListener("mousemove",this.#r)}setPublishClickType(e){this.publishClickType=e,this.#t.update(Pl(this.publishClickType),void 0),this.dispatchEvent({type:"foxglove.publish-type-change"})}start(){this.#n("place-first-point")}stop(){this.#n("idle")}#n(e){switch(this.state=e,e){case"idle":this.#s=this.#i=void 0,this.renderer.input.removeListener("click",this.#a),this.renderer.input.removeListener("mousemove",this.#r),this.dispatchEvent({type:"foxglove.publish-end"});break;case"place-first-point":this.renderer.input.addListener("click",this.#a),this.renderer.input.addListener("mousemove",this.#r),this.dispatchEvent({type:"foxglove.publish-start"});break;case"place-second-point":break}this.#o()}#r=(e,t,s)=>{if(t){switch(this.state){case"idle":break;case"place-first-point":(this.#s??=new c.Pa4).copy(t);break;case"place-second-point":(this.#i??=new c.Pa4).copy(t);break}this.#o()}};#a=(e,t,s)=>{if(t){switch(this.state){case"idle":break;case"place-first-point":this.#s=t.clone(),this.publishClickType==="point"?(this.dispatchEvent({type:"foxglove.publish-submit",publishClickType:this.publishClickType,point:{x:this.#s.x,y:this.#s.y,z:this.#s.z}}),this.#n("idle")):this.#n("place-second-point");break;case"place-second-point":if(this.#i=t.clone(),this.#s&&this.publishClickType!=="point"){const n=this.#s.clone(),r=new c._fP().setFromUnitVectors(Al,El.subVectors(this.#i,this.#s).normalize());this.dispatchEvent({type:"foxglove.publish-submit",publishClickType:this.publishClickType,pose:{position:{x:n.x,y:n.y,z:n.z},orientation:{x:r.x,y:r.y,z:r.z,w:r.w}}})}this.#n("idle");break}this.#o()}};#o(){this.publishClickType==="point"?(this.#t.visible=!1,this.#s?(this.#e.visible=!0,this.#e.position.copy(this.#s)):this.#e.visible=!1):(this.#e.visible=!1,this.#s?(this.#t.visible=!0,this.#t.position.copy(this.#s),this.#i?this.#t.quaternion.setFromUnitVectors(Al,El.subVectors(this.#i,this.#s).normalize()):this.#t.quaternion.set(0,0,0,1)):this.#t.visible=!1),this.renderer.queueAnimationFrame()}}var _l=b(86073),W;(function(i){i.CUBES="CUBES",i.MODELS="MODELS",i.LINES="LINES",i.CYLINDERS="CYLINDERS",i.ARROWS="ARROWS",i.SPHERES="SPHERES",i.TEXTS="TEXTS",i.TRIANGLES="TRIANGLES"})(W||(W={}));const Ip=[W.CUBES,W.MODELS,W.LINES,W.CYLINDERS,W.ARROWS,W.SPHERES,W.TEXTS,W.TRIANGLES],Cp="INVALID_DELETION_TYPE",Mp={[W.CUBES]:"cubes",[W.MODELS]:"models",[W.LINES]:"lines",[W.CYLINDERS]:"cylinders",[W.ARROWS]:"arrows",[W.SPHERES]:"spheres",[W.TEXTS]:"texts",[W.TRIANGLES]:"triangles"};class Dp extends K{primitivePool;pickable=!1;#e=new Map;constructor(e,t,s,n){super(e,s,n),this.primitivePool=t}dispose(){this.children.length=0,this.#i()}updateSettings(){for(const e of this.#e.values())for(const t of Object.values(e))t.updateSettings(this.userData.settings)}setColorScheme(e){for(const t of this.#e.values())for(const s of Object.values(t))s.setColorScheme(e)}startFrame(e,t,s){if(this.visible=this.userData.settings.visible,!this.visible){this.renderer.settings.errors.clearTopic(this.topic);return}for(const n of this.#e.values())for(const r of Object.values(n)){const a=r.userData.entity;if(!a)continue;const o=r.userData.expiresAt;if(o!=null&&e>o){this.#s(a.id);break}const l=this.renderer.normalizeFrameId(a.frame_id),d=a.frame_locked?e:(0,M.toNanoSec)(a.timestamp),h=(0,bi.S)(r,this.renderer.transformTree,t,s,l,e,d);r.visible=h;const f=this.userData.topic;if(h)this.renderer.settings.errors.removeFromTopic(f,Fe.o);else{const m=(0,Fe.v)(t,s,l);this.renderer.settings.errors.addToTopic(f,Fe.o,m)}}}addOrUpdateEntity(e,t){let s=this.#e.get(e.id);s||(s={},this.#e.set(e.id,s));for(const n of Ip){const r=e[Mp[n]].length>0;let a=s[n];r?(a||(a=this.primitivePool.acquire(n),a.name=`${e.id}:${n} on ${this.topic}`,a.userData.settingsPath=this.userData.settingsPath,a.setColorScheme(this.renderer.colorScheme),s[n]=a,this.add(a)),a.update(this.userData.topic,e,this.userData.settings,t)):a&&(this.remove(a),delete s[n],this.primitivePool.release(n,a))}}deleteEntities(e){switch(e.type){case A.SceneEntityDeletionType.MATCHING_ID:this.#s(e.id);break;case A.SceneEntityDeletionType.ALL:this.#i();break;default:this.renderer.settings.errors.addToTopic(this.topic,Cp,`Invalid deletion type ${e.type}`)}}#t(e){for(const[t,s]of Object.entries(e))s&&(this.remove(s),this.primitivePool.release(t,s))}#s(e){const t=this.#e.get(e);t&&this.#t(t),this.#e.delete(e)}#i(){for(const e of this.#e.values())this.#t(e);this.#e.clear()}}const Ap={showOutlines:!0,visible:!1,color:void 0,selectedIdVariable:void 0};class yt extends K{constructor(e,t,s={receiveTime:-1n,messageTime:-1n,frameId:"",pose:Kn(),settings:Ap,settingsPath:[],entity:void 0}){super(e,t,s)}update(e,t,s,n){this.userData.topic=e,this.userData.entity=t,this.userData.settings=s,this.userData.receiveTime=n}idFromMessage(){return this.userData.entity?.id}selectedIdVariable(){return this.getSettings()?.selectedIdVariable}getSettings(){if(this.userData.topic!=null)return this.userData.settings}details(){return this.userData.entity??{}}setColorScheme(e){}prepareForReuse(){this.userData.entity=void 0,this.userData.pose=Kn()}addError(e,t){this.renderer.settings.errors.add(this.userData.settingsPath,e,t)}clearErrors(){this.userData.settingsPath.length>0&&this.renderer.settings.errors.clearPath(this.userData.settingsPath)}}class Mi extends c.Wid{onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.vertexShader=e.vertexShader.replace("#include <color_pars_vertex>",`
        #include <color_pars_vertex>
        attribute float instanceOpacity;
        varying float vInstanceOpacity;
        `).replace("#include <color_vertex>",`
        #include <color_vertex>
        vInstanceOpacity = instanceOpacity;
        `),e.fragmentShader=e.fragmentShader.replace("#include <color_pars_fragment>",`
        #include <color_pars_fragment>
        varying float vInstanceOpacity;
        `).replace("#include <color_fragment>",`
        #include <color_fragment>
        diffuseColor.a = vInstanceOpacity * opacity;
        `)}}const Ll=new c.Ilk,dr=new c.Pa4,hr=new c.Pa4,Rl=new c.yGw,Di=new c._fP,Ep=ee();class Pp extends yt{#e;#t;#s;#i;#n;#r;#a;#o=new Mi({metalness:0,roughness:1,dithering:!0});#l;#d;#c;constructor(e){super("",e,void 0),this.#l=16,this.#a=new c.lb7(new Float32Array(this.#l),1),this.#e=e.sharedGeometry.getGeometry(`${this.constructor.name}-shaft`,_p).clone(),this.#e.setAttribute("instanceOpacity",this.#a),this.#n=new c.SPe(this.#e,this.#o,this.#l),this.#n.count=0,this.add(this.#n),this.#t=e.sharedGeometry.getGeometry(`${this.constructor.name}-head`,Lp).clone(),this.#t.setAttribute("instanceOpacity",this.#a),this.#r=new c.SPe(this.#t,this.#o,this.#l),this.#r.count=0,this.add(this.#r);const t=e.sharedGeometry.getGeometry(`${this.constructor.name}-shaftedges`,()=>Nl(this.#e));this.#s=new c.L5s().copy(t),this.#s.setAttribute("instanceMatrix",this.#n.instanceMatrix),this.#d=new c.ejS(this.#s,e.instancedOutlineMaterial),this.#d.frustumCulled=!1,this.#d.userData.picking=!1,this.add(this.#d);const s=e.sharedGeometry.getGeometry(`${this.constructor.name}-headedges`,()=>Ol(this.#t));this.#i=new c.L5s().copy(s),this.#i.setAttribute("instanceMatrix",this.#r.instanceMatrix),this.#c=new c.ejS(this.#i,e.instancedOutlineMaterial),this.#c.frustumCulled=!1,this.#c.userData.picking=!1,this.add(this.#c)}#h(e){if(e>this.#l){const t=Math.ceil(e*1.5)+16;this.#l=t,this.#a=new c.lb7(new Float32Array(this.#l),1),this.#n.removeFromParent(),this.#n.dispose(),this.#n=new c.SPe(this.#e,this.#o,this.#l),this.#e.setAttribute("instanceOpacity",this.#a),this.add(this.#n),this.#r.removeFromParent(),this.#r.dispose(),this.#r=new c.SPe(this.#t,this.#o,this.#l),this.#t.setAttribute("instanceOpacity",this.#a),this.add(this.#r),this.#s.dispose();const s=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-shaftedges`,()=>Nl(this.#e));this.#s=new c.L5s().copy(s),this.#s.instanceCount=t,this.#s.setAttribute("instanceMatrix",this.#n.instanceMatrix),this.#d.geometry=this.#s,this.#i.dispose();const n=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-headedges`,()=>Ol(this.#t));this.#i=new c.L5s().copy(n),this.#i.instanceCount=t,this.#i.setAttribute("instanceMatrix",this.#r.instanceMatrix),this.#c.geometry=this.#i}}#u(e){let t=!1;this.#h(e.length);const s=this.userData.settings.color?R(Ep,this.userData.settings.color):void 0;let n=0;for(const r of e){const a=s??r.color;a.a<1&&(t=!0),this.#n.setColorAt(n,be(Ll,a)),this.#r.setColorAt(n,be(Ll,a)),this.#a.setX(n,a.a),Di.set(r.pose.orientation.x,r.pose.orientation.y,r.pose.orientation.z,r.pose.orientation.w),this.#n.setMatrixAt(n,Rl.compose(dr.set(r.pose.position.x,r.pose.position.y,r.pose.position.z),Di,hr.set(r.shaft_length,r.shaft_diameter,r.shaft_diameter))),dr.add(hr.set(r.shaft_length,0,0).applyQuaternion(Di)),this.#r.setMatrixAt(n,Rl.compose(dr,Di,hr.set(r.head_length,r.head_diameter,r.head_diameter))),n++}this.#o.transparent!==t&&(this.#o.transparent=t,this.#o.depthWrite=!t,this.#o.needsUpdate=!0),this.#n.count===0&&e.length>0&&(this.#o.needsUpdate=!0),this.#n.count=e.length,this.#r.count=e.length,this.#s.instanceCount=e.length,this.#i.instanceCount=e.length,this.#n.instanceMatrix.needsUpdate=!0,this.#r.instanceMatrix.needsUpdate=!0,this.#a.needsUpdate=!0,this.#n.instanceColor&&(this.#n.instanceColor.needsUpdate=!0),this.#r.instanceColor&&(this.#r.instanceColor.needsUpdate=!0)}dispose(){this.#o.dispose(),this.#n.dispose(),this.#r.dispose(),this.#e.dispose(),this.#t.dispose(),this.#s.dispose(),this.#i.dispose()}update(e,t,s,n){if(super.update(e,t,s,n),t){const r=(0,M.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#u(t.arrows),this.#c.visible=s.showOutlines??!0,this.#d.visible=s.showOutlines??!0}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function _p(){const i=new c.fHI(.5,.5,1,16);return i.rotateZ(-Math.PI/2).translate(.5,0,0),i.computeBoundingSphere(),i}function Nl(i){const e=new c.TOt(i,40);return e.computeBoundingSphere(),e}function Lp(){const i=new c.b_z(.5,1,16);return i.rotateZ(-Math.PI/2).translate(.5,0,0),i.computeBoundingSphere(),i}function Ol(i){const e=new c.TOt(i,40);return e.computeBoundingSphere(),e}const Rp=new c.Ilk,Np=new c.Pa4,Op=new c.Pa4,Fp=new c.yGw,Up=new c._fP,zp=ee();class kp extends yt{#e;#t;#s=new Mi({metalness:0,roughness:1,dithering:!0});#i;#n;#r;#a;#o;constructor(e){super("",e),this.#a=e.sharedGeometry.getGeometry(`${this.constructor.name}-cube`,Gp).clone(),this.#i=16,this.#e=new c.SPe(this.#a,this.#s,this.#i),this.#t=new c.lb7(new Float32Array(this.#i),1),this.#a.setAttribute("instanceOpacity",this.#t),this.#e.count=0,this.add(this.#e),this.#o=e.sharedGeometry.getGeometry(`${this.constructor.name}-edges`,()=>Bp(this.#a)),this.#n=new c.L5s().copy(this.#o),this.#n.setAttribute("instanceMatrix",this.#e.instanceMatrix),this.#r=new c.ejS(this.#n,e.instancedOutlineMaterial),this.#r.frustumCulled=!1,this.#r.userData.picking=!1,this.add(this.#r)}#l(e){if(e>this.#i){const t=Math.trunc(e*1.5)+16;this.#i=t,this.#e.removeFromParent(),this.#e.dispose(),this.#e=new c.SPe(this.#a,this.#s,this.#i),this.#t=new c.lb7(new Float32Array(this.#i),1),this.#a.setAttribute("instanceOpacity",this.#t),this.add(this.#e),this.#n.dispose(),this.#n=new c.L5s().copy(this.#o),this.#n.instanceCount=t,this.#n.setAttribute("instanceMatrix",this.#e.instanceMatrix),this.#r.geometry=this.#n}}#d(e){let t=!1;this.#l(e.length);const s=this.userData.settings.color?R(zp,this.userData.settings.color):void 0;let n=0;for(const r of e){const a=s??r.color;a.a<1&&(t=!0),this.#e.setColorAt(n,be(Rp,a)),this.#t.setX(n,a.a),this.#e.setMatrixAt(n,Fp.compose(Np.set(r.pose.position.x,r.pose.position.y,r.pose.position.z),Up.set(r.pose.orientation.x,r.pose.orientation.y,r.pose.orientation.z,r.pose.orientation.w),Op.set(r.size.x,r.size.y,r.size.z))),n++}this.#s.transparent!==t&&(this.#s.transparent=t,this.#s.depthWrite=!t,this.#s.needsUpdate=!0),this.#e.count===0&&e.length>0&&(this.#s.needsUpdate=!0),this.#e.count=e.length,this.#n.instanceCount=e.length,this.#e.instanceMatrix.needsUpdate=!0,this.#t.needsUpdate=!0,this.#e.instanceColor&&(this.#e.instanceColor.needsUpdate=!0)}dispose(){this.#e.dispose(),this.#a.dispose(),this.#s.dispose(),this.#n.dispose()}update(e,t,s,n){if(super.update(e,t,s,n),t){const r=(0,M.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#d(t.cubes),this.#r.visible=s.showOutlines??!0}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function Gp(){const i=new c.DvJ(1,1,1);return i.computeBoundingSphere(),i}function Bp(i){const e=new c.TOt(i,40);return e.computeBoundingSphere(),e}const jp=new c.Ilk,$p=new c.Pa4,Vp=new c.Pa4,Wp=new c.yGw,Hp=new c._fP,Zp=ee();class Yp extends yt{#e;#t;#s;#i;#n;#r;#a=new Qp;#o=new Jp;#l=new qp;#d;#c;#h;constructor(e){super("",e),this.#t=e.sharedGeometry.getGeometry(`${this.constructor.name}-cylinder`,Kp).clone(),this.#d=16,this.#e=new c.SPe(this.#t,this.#o,this.#d),this.#e.userData.pickingMaterial=this.#l,this.#i=new c.lb7(new Float32Array(this.#d),1),this.#r=new c.lb7(new Float32Array(this.#d),1),this.#n=new c.lb7(new Float32Array(this.#d),1),this.#t.setAttribute("instanceOpacity",this.#i),this.#t.setAttribute("instanceBottomScale",this.#r),this.#t.setAttribute("instanceTopScale",this.#n),this.#e.count=0,this.add(this.#e),this.#s=e.sharedGeometry.getGeometry(`${this.constructor.name}-edges`,()=>Xp(this.#t)),this.#c=new c.L5s().copy(this.#s),this.#c.setAttribute("instanceMatrix",this.#e.instanceMatrix),this.#c.setAttribute("instanceBottomScale",this.#r),this.#c.setAttribute("instanceTopScale",this.#n),this.#h=new c.ejS(this.#c,this.#a),this.#h.frustumCulled=!1,this.#h.userData.picking=!1,this.add(this.#h)}setColorScheme(e){this.#a.color.copy(e==="dark"?Ji:Xi),this.#a.needsUpdate=!0}#u(e){if(e>this.#d){const t=Math.trunc(e*1.5)+16;this.#d=t,this.#i=new c.lb7(new Float32Array(this.#d),1),this.#r=new c.lb7(new Float32Array(this.#d),1),this.#n=new c.lb7(new Float32Array(this.#d),1),this.#t.setAttribute("instanceOpacity",this.#i),this.#t.setAttribute("instanceBottomScale",this.#r),this.#t.setAttribute("instanceTopScale",this.#n),this.#e.removeFromParent(),this.#e.dispose(),this.#e=new c.SPe(this.#t,this.#o,this.#d),this.#e.userData.pickingMaterial=this.#l,this.add(this.#e),this.#c.dispose(),this.#c=new c.L5s().copy(this.#s),this.#c.instanceCount=t,this.#c.setAttribute("instanceMatrix",this.#e.instanceMatrix),this.#c.setAttribute("instanceBottomScale",this.#r),this.#c.setAttribute("instanceTopScale",this.#n),this.#h.geometry=this.#c}}#m(e){let t=!1;this.#u(e.length);const s=this.userData.settings.color?R(Zp,this.userData.settings.color):void 0;let n=0;for(const r of e){const a=s??r.color;a.a<1&&(t=!0),this.#e.setColorAt(n,be(jp,a)),this.#i.setX(n,a.a),this.#r.setX(n,r.bottom_scale),this.#n.setX(n,r.top_scale),this.#e.setMatrixAt(n,Wp.compose($p.set(r.pose.position.x,r.pose.position.y,r.pose.position.z),Hp.set(r.pose.orientation.x,r.pose.orientation.y,r.pose.orientation.z,r.pose.orientation.w),Vp.set(r.size.x,r.size.y,r.size.z))),n++}this.#o.transparent!==t&&(this.#o.transparent=t,this.#o.depthWrite=!t,this.#o.needsUpdate=!0),this.#e.count===0&&e.length>0&&(this.#o.needsUpdate=!0),this.#e.count=e.length,this.#c.instanceCount=e.length,this.#e.instanceMatrix.needsUpdate=!0,this.#i.needsUpdate=!0,this.#r.needsUpdate=!0,this.#n.needsUpdate=!0,this.#e.instanceColor&&(this.#e.instanceColor.needsUpdate=!0)}dispose(){this.#e.dispose(),this.#t.dispose(),this.#o.dispose(),this.#l.dispose(),this.#a.dispose(),this.#c.dispose()}update(e,t,s,n){if(super.update(e,t,s,n),t){const r=(0,M.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#m(t.cylinders),this.#h.visible=s.showOutlines??!0}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function Kp(){const i=new c.fHI(.5,.5,1,16);return i.rotateX(Math.PI/2),i.computeBoundingSphere(),i}function Xp(i){const e=new c.TOt(i,40);return e.computeBoundingSphere(),e}function ur(i){return i.replace("#include <color_pars_vertex>",`
  #include <color_pars_vertex>
  attribute float instanceBottomScale, instanceTopScale;
  `).replace("#include <begin_vertex>",`
  #include <begin_vertex>
  transformed.xy *= mix(instanceBottomScale, instanceTopScale, transformed.z + 0.5);
  `)}class Jp extends Mi{constructor(){super({metalness:0,roughness:1,dithering:!0})}onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.vertexShader=ur(e.vertexShader)}}class Qp extends c.nls{constructor(){super(),this.defines??={},this.defines.USE_INSTANCING=!0}onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.vertexShader=ur(e.vertexShader)}}class qp extends c.jyz{constructor(){super({vertexShader:ur(c.WdD.meshbasic_vert),fragmentShader:`
          uniform vec4 objectId;
          void main() {
            gl_FragColor = objectId;
          }
        `,uniforms:{objectId:{value:[NaN,NaN,NaN,NaN]}}})}}const em=ee();class tm extends yt{#e=[];constructor(e){super("",e)}#t(e){this.clear();let t=0;for(t;t<e.length;t++){const s=e[t];if(s.points.length===0)continue;let n=this.#e[t];n==null&&(n=new sm(s,this.renderer.input.canvasSize),this.#e.push(n)),n.setPrimitive(s),n.setSettings(this.userData.settings),n.update(),n.position.set(s.pose.position.x,s.pose.position.y,s.pose.position.z),n.quaternion.set(s.pose.orientation.x,s.pose.orientation.y,s.pose.orientation.z,s.pose.orientation.w),this.add(n)}}dispose(){for(const e of this.#e)e.dispose(),e.removeFromParent();this.clear(),this.#e.length=0}update(e,t,s,n){if(super.update(e,t,s,n),t){const r=(0,M.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#t(t.lines)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}const Fl=5;class sm extends c.Tme{#e;#t;#s;#i;#n;#r=!0;#a;#o=!0;#l;#d=!0;#c;#h;constructor(e,t){super(),this.#i=new Dt({worldUnits:!e.scale_invariant,linewidth:e.thickness,transparent:this.#r,depthWrite:!this.#r,resolution:t.clone()}),this.#i.lineWidth=e.thickness,this.#n=new om,this.#n.resolution.set(t.x,t.y),this.#n.worldUnits=!e.scale_invariant,this.#n.lineWidth=e.scale_invariant?Math.max(e.thickness,Fl):e.thickness,this.#n.needsUpdate=!0}setSettings(e){this.#d||=this.#c!==e.color,this.#c=e.color}setPrimitive(e){this.#o||=this.#l!==e,this.#l=e}update(){if(this.#l==null){this.visible=!1;return}this.visible=!0;const e=this.#l.type===A.LineType.LINE_LOOP,t=this.#l.type===A.LineType.LINE_LIST,s=this.#l.indices.length>0,n=(s?this.#l.indices.length:this.#l.points.length)+(e?1:0),r=n*3;if(this.#o){if(this.#e==null||this.#h!==this.#l.type||!this.#t||this.#t.length<r){switch(this.#e!=null&&(this.#e.dispose(),this.#t=void 0,this.#s=void 0),this.#a!=null&&this.#a.removeFromParent(),this.#h=this.#l.type,this.#l.type){case A.LineType.LINE_STRIP:case A.LineType.LINE_LOOP:{const o=new jt.L;this.#e=o,this.#t=new Float32Array(r),this.#a=new hi.w(o,this.#i);break}case A.LineType.LINE_LIST:{this.#e=new ps.z,this.#t=new Float32Array(r),this.#a=new fs.w(this.#e,this.#i);break}}this.#a.userData.pickingMaterial=this.#n,this.userData.pickingMaterial=this.#n,this.add(this.#a)}(0,q.assert)(this.#t,"Position buffer must be initialized"),(0,q.assert)(this.#e,"Geometry must be initialized"),this.#e.instanceCount=t?n>>>1:e?n:Math.max(n-1,0),s?nm(this.#t,this.#l):im(this.#t,this.#l),this.#e.setPositions(this.#t)}if(this.#d||this.#o){const a=this.#c?R(em,this.#c):this.#l.colors.length===0?this.#l.color:void 0;if(a==null){(0,q.assert)(this.#e,"Line Group geometry must exist"),this.#i.color.setRGB(1,1,1);const o=n*4;(this.#s==null||this.#s.length<o)&&(this.#s=new Float32Array(o)),this.#i.vertexColors=!0,this.#i.color.setRGB(1,1,1),this.#i.opacity=1,this.#i.uniforms.opacity.value=1,s?am(this.#s,this.#l):rm(this.#s,this.#l);const l=new c.$TI(this.#s,t?8:4,1);this.#e.setAttribute("instanceColorStart",new c.kB5(l,4,0)),this.#e.setAttribute("instanceColorEnd",new c.kB5(l,4,4))}else{this.#i.vertexColors=!1;const o=this.#i.color;be(o,a),this.#i.setOpacity(a.a)}this.#u()}this.#o=!1,this.#d=!1}#u(){this.#l!=null&&(this.#i.lineWidth=this.#l.thickness,this.#i.transparent=this.#r,this.#i.worldUnits=!this.#l.scale_invariant,this.#i.needsUpdate=!0,this.#n.worldUnits=!this.#l.scale_invariant,this.#n.lineWidth=this.#l.scale_invariant?Math.max(this.#l.thickness,Fl):this.#l.thickness,this.#n.uniformsNeedUpdate=!0,this.#n.needsUpdate=!0)}dispose(){this.#a?.removeFromParent(),this.#e?.dispose(),this.#i.dispose(),this.#n.dispose()}}function im(i,e){let t=0;(0,q.assert)(i.length>=e.points.length*3,`positionsOut must have a length (${i.length})  >= to primitive.points.length (${e.points.length}) * 3`);for(const{x:n,y:r,z:a}of e.points)i[t++]=n,i[t++]=r,i[t++]=a;e.type===A.LineType.LINE_LOOP&&i.length>3&&i.copyWithin(t,0,3)}function nm(i,e){const t=e.indices;(0,q.assert)(i.length>=e.indices.length*3,`positionsOut must have a length (${i.length})  >= to primitive.indices.length (${e.indices.length}) * 3`);let s=0;for(const r of t){const{x:a,y:o,z:l}=e.points[r];i[s++]=a,i[s++]=o,i[s++]=l}e.type===A.LineType.LINE_LOOP&&i.length>3&&i.copyWithin(s,0,3)}function rm(i,e){(0,q.assert)(i.length>=e.colors.length*4,`colorsOut buffer must have a length (${i.length}) >= to the primitive.colors.length (${e.colors.length}) * 4`),(0,q.assert)(e.colors.length>0,"invariant: expected not to be using vertex colors");let t=0;for(const{r:n,g:r,b:a,a:o}of e.colors)i[t++]=F(n),i[t++]=F(r),i[t++]=F(a),i[t++]=o;e.type===A.LineType.LINE_LOOP&&i.length>4&&i.copyWithin(t,0,4)}function am(i,e){const t=e.indices;(0,q.assert)(t.length>0,"Indices must have length"),(0,q.assert)(i.length>=t.length*4,`colorsOut buffer must have a length (${i.length}) >= to primitive.indices.length (${e.indices.length}) * 4`),(0,q.assert)(e.colors.length>0,"Invariant: expected not to be using vertex colors");let s=0;for(const r of t){const{r:a,g:o,b:l,a:d}=e.colors[r];i[s++]=F(a),i[s++]=F(o),i[s++]=F(l),i[s++]=d}e.type===A.LineType.LINE_LOOP&&i.length>4&&i.copyWithin(s,0,4)}class om extends Dt{constructor(){super({worldUnits:!1,vertexColors:!1,linewidth:0,transparent:!1}),this.uniforms.objectId={value:[NaN,NaN,NaN,NaN]}}onBeforeCompile(e,t){super.onBeforeCompile(e,t),e.fragmentShader=`
      uniform vec4 objectId;
      void main() {
        gl_FragColor = objectId;
      }
    `}}var lm=b(41613);function Ul(i){i instanceof c.Wid&&(i.map?.dispose(),i.lightMap?.dispose(),i.aoMap?.dispose(),i.emissiveMap?.dispose(),i.bumpMap?.dispose(),i.normalMap?.dispose(),i.displacementMap?.dispose(),i.roughnessMap?.dispose(),i.metalnessMap?.dispose(),i.alphaMap?.dispose(),i.envMap?.dispose()),i.dispose()}function Ps(i){i.traverse(e=>{if(e instanceof c.Kj0)if(e.geometry.dispose(),Array.isArray(e.material))for(const t of e.material)t instanceof c.F5T&&Ul(t);else e.material instanceof c.F5T&&Ul(e.material)})}function zl(i){const e=[];i.traverse(t=>{const s=t;s.isLight===!0&&e.push(s)});for(const t of e)t.dispose(),t.removeFromParent()}function kl(i,e){i.traverse(t=>{if(!(t instanceof c.Kj0))return;const s=t;if(Array.isArray(s.material))for(const n of s.material)Gl(n);else Gl(s.material);s.material=e,s.geometry.attributes.normal||s.geometry.computeVertexNormals()})}function Gl(i){i.map?.dispose(),i.lightMap?.dispose(),i.aoMap?.dispose(),i.emissiveMap?.dispose(),i.bumpMap?.dispose(),i.normalMap?.dispose(),i.displacementMap?.dispose(),i.roughnessMap?.dispose(),i.metalnessMap?.dispose(),i.alphaMap?.dispose(),i.envMap?.dispose(),i.dispose()}const cm=ee(),Jt="MODEL_FETCH_FAILED";function dm(i,e){if(i.length!==e.length)return!1;for(let t=0;t<i.length;t++)if(i[t]!==e[t])return!1;return!0}class hm extends yt{#e=new Map;#t=new Map;#s=0;constructor(e){super("",e)}async#i(e,t,s,n,r){let a;if(t){const l=t.findIndex(d=>s(d.primitive,e));l>=0&&(a=t.splice(l,1)[0])}if(a)return this.#o(a,e),a;const o=n(e);try{const l=await this.#a(o,{overrideMediaType:e.media_type.length>0?e.media_type:void 0});l&&(a={model:Bl(l),cachedModel:l,primitive:e},this.#o(a,e))}finally{r(o)}return a}#n(e){this.clear();const t=++this.#s,s=this.#t;this.#t=new Map;const n=this.#e;this.#e=new Map,Promise.all(e.map(async r=>{let a,o,l;if(r.url.length===0){const d=(0,lm.kn)(r.data);a=n.get(d),o=this.#e.get(d),o||(o=[],this.#e.set(d,o));try{l=await this.#i(r,a,(h,f)=>h.media_type===f.media_type&&dm(h.data,f.data),h=>URL.createObjectURL(new Blob([h.data],{type:h.media_type})),h=>{URL.revokeObjectURL(h)})}catch(h){this.renderer.settings.errors.add(this.userData.settingsPath,Jt,`Unhandled error loading model from ${r.data.byteLength}-byte data: ${h.message}`)}}else{a=s.get(r.url),o=this.#t.get(r.url),o||(o=[],this.#t.set(r.url,o));try{l=await this.#i(r,a,(d,h)=>d.url===h.url&&d.media_type===h.media_type,d=>d.url,d=>{})}catch(d){this.renderer.settings.errors.add(this.userData.settingsPath,Jt,`Unhandled error loading model from "${r.url}": ${d.message}`)}}t===this.#s&&l&&(o.push(l),this.add(l.model),this.renderer.queueAnimationFrame())})).then(()=>{this.renderer.settings.errors.remove(this.userData.settingsPath,Jt)}).catch(console.error).finally(()=>{for(const r of s.values())for(const a of r)a.model.removeFromParent(),this.#l(a);for(const r of n.values())for(const a of r)a.model.removeFromParent(),this.#l(a);this.#r(),this.renderer.queueAnimationFrame()})}dispose(){for(const e of this.#t.values())for(const t of e)this.#l(t);this.#t.clear();for(const e of this.#e.values())for(const t of e)this.#l(t);this.#e.clear()}update(e,t,s,n){if(super.update(e,t,s,n),t){const r=(0,M.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#n(t.models)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}#r(){const e=this.getSettings()?.showOutlines??!0;this.traverse(t=>{t instanceof c.ejS&&t.name===_n&&(t.visible=e)})}async#a(e,t){const s=await this.renderer.modelCache.load(e,{overrideMediaType:t.overrideMediaType},n=>{this.renderer.settings.errors.add(this.userData.settingsPath,Jt,`Error loading model from "${e}": ${n.message}`)});if(!s){this.renderer.settings.errors.hasError(this.userData.settingsPath,Jt)||this.renderer.settings.errors.add(this.userData.settingsPath,Jt,`Failed to load model from "${e}"`);return}return s}#o(e,t){const s=this.userData.settings.color?R(cm,this.userData.settings.color):t.override_color?t.color:void 0;if(s){e.material||(e.material=new c.Wid({metalness:0,roughness:1,dithering:!0}),kl(e.model,e.material)),be(e.material.color,s);const n=s.a<1;e.material.opacity=s.a,e.material.transparent=n,e.material.depthWrite=!n,e.material.needsUpdate=!0}else e.material&&(e.model=Bl(e.cachedModel),e.material=void 0);e.model.scale.set(t.scale.x,t.scale.y,t.scale.z),e.model.position.set(t.pose.position.x,t.pose.position.y,t.pose.position.z),e.model.quaternion.set(t.pose.orientation.x,t.pose.orientation.y,t.pose.orientation.z,t.pose.orientation.w)}#l(e){e.material?.dispose(),Ps(e.model),Ps(e.cachedModel)}}function Bl(i){const e=i.clone(!0);return zl(e),new c.ZAu().add(e)}const um=new c.Ilk,fm=new c.Pa4,pm=new c.Pa4,mm=new c.yGw,gm=new c._fP,bm=ee();class ym extends yt{#e;#t;#s;#i=new Mi({metalness:0,roughness:1,dithering:!0});#n;constructor(e){super("",e),this.#e=e.sharedGeometry.getGeometry(this.constructor.name,vm).clone(),this.#n=16,this.#t=new c.SPe(this.#e,this.#i,this.#n),this.#s=new c.lb7(new Float32Array(this.#n),1),this.#e.setAttribute("instanceOpacity",this.#s),this.#t.count=0,this.add(this.#t)}#r(e){if(e>this.#n){const t=Math.trunc(e*1.5)+16;this.#n=t,this.#t.removeFromParent(),this.#t.dispose(),this.#t=new c.SPe(this.#t.geometry,this.#i,this.#n),this.#s=new c.lb7(new Float32Array(this.#n),1),this.#e.setAttribute("instanceOpacity",this.#s),this.add(this.#t)}}#a(e){let t=!1;this.#r(e.length);const s=this.userData.settings.color?R(bm,this.userData.settings.color):void 0;let n=0;for(const r of e){const a=s??r.color;a.a<1&&(t=!0),this.#t.setColorAt(n,be(um,a)),this.#s.setX(n,a.a),this.#t.setMatrixAt(n,mm.compose(fm.set(r.pose.position.x,r.pose.position.y,r.pose.position.z),gm.set(r.pose.orientation.x,r.pose.orientation.y,r.pose.orientation.z,r.pose.orientation.w),pm.set(r.size.x,r.size.y,r.size.z))),n++}this.#i.transparent!==t&&(this.#i.transparent=t,this.#i.depthWrite=!t,this.#i.needsUpdate=!0),this.#t.count===0&&e.length>0&&(this.#i.needsUpdate=!0),this.#t.count=e.length,this.#t.instanceMatrix.needsUpdate=!0,this.#s.needsUpdate=!0,this.#t.instanceColor&&(this.#t.instanceColor.needsUpdate=!0)}dispose(){this.#t.dispose(),this.#e.dispose(),this.#i.dispose()}update(e,t,s,n){if(super.update(e,t,s,n),t){const r=(0,M.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#a(t.spheres)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function vm(){const i=new c.xo$(.5,16,16);return i.computeBoundingSphere(),i}const Tm=ee();class Sm extends yt{#e;#t=[];constructor(e){super("",e),this.#e=e.labelPool}#s(e){const t=this.#t.length;if(e>t)for(let s=t;s<e;s++){const n=this.#e.acquire();this.#t.push(n),this.add(n)}}#i(e){this.#s(e.length);const t=this.userData.settings.color?R(Tm,this.userData.settings.color):void 0;let s=0;for(const n of e){const r=t??n.color,a=this.#t[s];if(!a)throw new Error("invariant: labels array smaller than requested");a.setText(n.text),a.setColor(F(r.r),F(r.g),F(r.b)),Hs(r.r,r.g,r.b)<.5?a.setBackgroundColor(1,1,1):a.setBackgroundColor(0,0,0),a.setOpacity(r.a),a.setLineHeight(n.font_size),a.setBillboard(n.billboard),a.setSizeAttenuation(!n.scale_invariant),a.quaternion.set(n.pose.orientation.x,n.pose.orientation.y,n.pose.orientation.z,n.pose.orientation.w),a.position.set(n.pose.position.x,n.pose.position.y,n.pose.position.z),s++}if(s<this.#t.length)for(const n of this.#t.splice(s))this.#e.release(n)}dispose(){for(const e of this.#t)this.#e.release(e)}update(e,t,s,n){if(super.update(e,t,s,n),t){const r=(0,M.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#i(t.texts)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}const xm=ee(),jl=new c.Ilk,$l={r:0,g:1,b:0,a:1},wm="INVALID_COLOR_LENGTH",Im="INVALID_POINT";class Cm extends yt{#e=[];constructor(e){super("",e)}#t(e){for(;e>this.#e.length;)this.#e.push(Mm())}#s(e){this.#t(e.length),this.clear();let t=0;for(const s of e){const n=this.#e[t];if(!n)continue;const{geometry:r,material:a}=n;let o=!1,l=!1,d=!1;r.resize(s.points.length),r.attributes.position||r.createAttribute("position",Float32Array,3),r.attributes.normal||r.createAttribute("normal",Float32Array,3);const h=r.attributes.position,f=this.userData.settings.color?R(xm,this.userData.settings.color):s.colors.length===0?s.color:void 0;!f&&!r.attributes.color&&r.createAttribute("color",Uint8Array,4,!0);const m=r.attributes.color;for(let u=0;u<s.points.length;u++){const x=s.points[u];if(!Dm(x)){this.addError(`${this.name}-${Im}`,`Entity: ${this.userData.entity?.id}.triangles[${t}](1st index) - Point definition at index ${u} is not finite`);continue}if(l=l||h.getX(u)!==x.x||h.getY(u)!==x.y||h.getZ(u)!==x.z,h.setXYZ(u,x.x,x.y,x.z),!f&&m&&s.colors.length>0){const y=s.colors[u]??$l;u===s.points.length-1&&y===$l&&this.addError(`${this.name}-${wm}`,`Entity: ${this.userData.entity?.id}.triangles[${t}](1st index) - Colors array should be same size as points array, showing #00ff00 instead`);const C=F(y.r),T=F(y.g),I=F(y.b),_=y.a;d=d||m.getX(u)!==C||m.getY(u)!==T||m.getZ(u)!==I||m.getW(u)!==_,m.setXYZW(u,C,T,I,_),!o&&_<1&&(o=!0)}}if(l&&(r.computeVertexNormals(),r.computeBoundingSphere(),r.attributes.position.needsUpdate=!0),d&&(r.attributes.color.needsUpdate=!0),!a.vertexColors&&!f&&s.colors.length>0)a.vertexColors=!0,a.color.setRGB(1,1,1),a.opacity=1,r.attributes.color.needsUpdate=!0,a.needsUpdate=!0;else if(f){o=f.a<1;const u=be(jl,f);(a.vertexColors||!a.color.equals(u)||n.material.opacity!==f.a)&&(a.vertexColors=!1,a.color.copy(jl),n.material.opacity=f.a,a.needsUpdate=!0)}a.transparent!==o&&(a.transparent=o,a.depthWrite=!o,a.needsUpdate=!0);const g=s.indices;if(g.length>0){if(!r.index||r.index.count<g.length){const u=new Uint32Array(Math.round(g.length*1.5)+16);u.set(g),r.index=new c.TlE(u,1),r.index.count=g.length}else{const u=r.index.array;let x=!1;for(let y=0;y<g.length;y++)u[y]!==g[y]&&(u[y]=g[y],x=!0);r.index.needsUpdate=x}r.setDrawRange(0,g.length)}else r.index=null;n.position.set(s.pose.position.x,s.pose.position.y,s.pose.position.z),n.quaternion.set(s.pose.orientation.x,s.pose.orientation.y,s.pose.orientation.z,s.pose.orientation.w),this.add(n),t++}}dispose(){for(const e of this.#e)e.geometry.dispose(),e.material.dispose();this.clear(),this.#e.length=0,this.clearErrors()}update(e,t,s,n){if(super.update(e,t,s,n),t){const r=(0,M.toNanoSec)(t.lifetime);this.userData.expiresAt=r===0n?void 0:n+r,this.#s(t.triangles)}}updateSettings(e){this.update(this.userData.topic,this.userData.entity,e,this.userData.receiveTime)}}function Mm(){return new c.Kj0(new At,new c.Wid({metalness:0,roughness:1,flatShading:!0,side:c.ehD}))}function Dm(i){return Number.isFinite(i.x)&&Number.isFinite(i.y)&&Number.isFinite(i.z)}const Am={[W.CUBES]:kp,[W.MODELS]:hm,[W.LINES]:tm,[W.CYLINDERS]:Yp,[W.ARROWS]:Pp,[W.SPHERES]:ym,[W.TEXTS]:Sm,[W.TRIANGLES]:Cm};class Em{renderer;#e=new Map;#t=!1;constructor(e){this.renderer=e}acquire(e){if(this.#t)throw new Error(`Attempt to acquire PrimitiveType.${e} after PrimitivePool was disposed`);const t=this.#e.get(e)?.pop();return t?(t.prepareForReuse(),t):new Am[e](this.renderer)}release(e,t){if(this.#t){t.dispose();return}const s=this.#e.get(e);s?s.push(t):this.#e.set(e,[t])}dispose(){for(const e of this.#e.values())for(const t of e)t.dispose();this.#e.clear(),this.#t=!0}setColorScheme(e){for(const t of this.#e.values())for(const s of t)s.setColorScheme(e)}}const Ai={showOutlines:!0,visible:!1,color:void 0,selectedIdVariable:void 0};class Pm extends J.d{#e=new Em(this.renderer);constructor(e){super("foxglove.SceneEntities",e)}getSubscriptions(){return[{type:"schema",schemaNames:bn,subscription:{handler:this.#t}}]}settingsNodes(){const e=this.renderer.config.topics,t=[];for(const s of this.renderer.topics??[]){if(!j(s,bn))continue;const n=e[s.name]??{},r={label:s.name,icon:"Shapes",order:s.name.toLocaleLowerCase(),fields:{color:{label:"Color",input:"rgba",value:n.color},showOutlines:{label:"Show outlines",input:"boolean",value:n.showOutlines??Ai.showOutlines},selectedIdVariable:{label:"Selection Variable",input:"string",help:"When selecting a SceneEntity, this global variable will be set to the entity ID",value:n.selectedIdVariable,placeholder:Wi}},visible:n.visible??Ai.visible,handler:this.handleSettingsAction};t.push({path:["topics",s.name],node:r})}return t}startFrame(e,t,s){for(const n of this.renderables.values())n.startFrame(e,t,s)}setColorScheme(e,t){for(const s of this.renderables.values())s.setColorScheme(e)}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const s=t[1],n=this.renderables.get(s);if(n){const r=this.renderer.config.topics[s];n.userData.settings={...Ai,...r},n.updateSettings()}};#t=e=>{const t=e.topic,s=e.message;for(const n of s.deletions??[])if(n){const r=Lm(n);this.#s(t).deleteEntities(r)}for(const n of s.entities??[])if(n){const r=_m(n);this.#s(t).addOrUpdateEntity(r,(0,M.toNanoSec)(e.receiveTime))}};#s(e){let t=this.renderables.get(e);if(!t){const s=this.renderer.config.topics[e];t=new Dp(e,this.#e,this.renderer,{receiveTime:-1n,messageTime:-1n,frameId:"",pose:(0,N.N2)(),settingsPath:["topics",e],topic:e,settings:{...Ai,...s}}),this.renderables.set(e,t),this.add(t)}return t}dispose(){super.dispose(),this.#e.dispose()}}function _m(i){return{timestamp:ce(i.timestamp),frame_id:i.frame_id??"",id:i.id??"",lifetime:ce(i.lifetime),frame_locked:i.frame_locked??!1,metadata:i.metadata?.map(e=>({key:e?.key??"",value:e?.value??""}))??[],arrows:i.arrows?.map(Rm)??[],cubes:i.cubes?.map(Nm)??[],spheres:i.spheres?.map(Om)??[],cylinders:i.cylinders?.map(Fm)??[],lines:i.lines?.map(Um)??[],triangles:i.triangles?.map(zm)??[],texts:i.texts?.map(km)??[],models:i.models?.map(Gm)??[]}}function Lm(i){return{timestamp:ce(i.timestamp),type:i.type??A.SceneEntityDeletionType.MATCHING_ID,id:i.id??""}}function Rm(i){return{pose:te(i?.pose),shaft_length:i?.shaft_length??.8,shaft_diameter:i?.shaft_diameter??.1,head_length:i?.head_length??.2,head_diameter:i?.head_diameter??.2,color:et(i?.color)}}function Nm(i){return{pose:te(i?.pose),size:Ve(i?.size),color:et(i?.color)}}function Om(i){return{pose:te(i?.pose),size:Ve(i?.size),color:et(i?.color)}}function Fm(i){return{pose:te(i?.pose),size:Ve(i?.size),bottom_scale:i?.bottom_scale??1,top_scale:i?.top_scale??1,color:et(i?.color)}}function Um(i){return{type:i?.type??A.LineType.LINE_STRIP,pose:te(i?.pose),thickness:i?.thickness??.05,scale_invariant:i?.scale_invariant??!1,points:i?.points?.map(Ve)??[],color:et(i?.color),colors:hn(i?.colors),indices:i?.indices?.map(e=>e??NaN)??[]}}function zm(i){return{pose:te(i?.pose),points:i?.points?.map(Ve)??[],color:et(i?.color),colors:hn(i?.colors),indices:i?.indices?.map(e=>e??NaN)??[]}}function km(i){return{pose:te(i?.pose),billboard:i?.billboard??!0,font_size:i?.font_size??(i?.scale_invariant??!1?16:.25),scale_invariant:i?.scale_invariant??!1,color:et(i?.color),text:i?.text??""}}function Gm(i){return{pose:te(i?.pose),scale:Ve(i?.scale),color:et(i?.color),override_color:i?.override_color??!1,url:i?.url??"",media_type:i?.media_type??"",data:kt(i?.data)}}var Bm=b(87373);const jm=["fixed","continuous","revolute","planar","prismatic","floating"];function $m(i){const e=new DOMParser,t=i instanceof XMLDocument?i:e.parseFromString(i,"text/xml");for(let s=0;s<t.children.length;s++){const n=t.children[s];if(n.nodeName==="robot")return Vm(n)}throw new Error("No robot found in URDF")}function Vm(i){const e=i.getAttribute("name")??void 0;if(e==null)throw new Error("<robot> name is missing");const t=new Map,s=new Map,n=new Map;for(let r=0;r<i.children.length;r++){const a=i.children[r],o=a.getAttribute("name");if(o!=null)switch(a.nodeName){case"link":t.set(o,Wm(a));break;case"joint":s.set(o,Zm(a));break;case"material":n.set(o,Vl(a));break}}return{name:e,links:t,joints:s,materials:n}}function Wm(i){const e=i.getAttribute("name")??void 0;if(e==null)throw new Error(`missing attribute "name" in ${i}`);const t={name:e,visuals:[],colliders:[]};for(let s=0;s<i.children.length;s++){const n=i.children[s];switch(n.nodeName){case"inertial":t.inertial=Hm(n);break;case"visual":t.visuals.push(Ym(n));break;case"collision":t.colliders.push(Km(n));break}}return t}function Hm(i){let e,t,s;for(let n=0;n<i.children.length;n++){const r=i.children[n];switch(r.nodeName){case"origin":e=Ei(r);break;case"mass":t=Qm(r);break;case"inertia":s=Xm(r);break}}if(t==null||s==null)throw new Error("<inertial> must have mass and inertia");return{origin:e??Pi(),mass:t,inertia:s}}function Zm(i){const e=i.getAttribute("name")??void 0,t=i.getAttribute("type")??void 0;let s,n,r,a,o,l,d,h,f;if(e==null)throw new Error(`missing attribute "name" in ${i}`);if(!jm.includes(t??""))throw new Error(`invalid joint type "${t}" in ${i}`);for(let m=0;m<i.children.length;m++){const p=i.children[m];switch(p.nodeName){case"origin":s=Ei(p);break;case"parent":n=p.getAttribute("link")??void 0;break;case"child":r=p.getAttribute("link")??void 0;break;case"axis":if(a=_s(p,"xyz"),a==null)throw new Error(`missing attribute "xyz" in ${p}`);break;case"calibration":o={rising:He(p,"rising"),falling:He(p,"falling")};break;case"dynamics":l={damping:He(p,"damping")??0,friction:He(p,"friction")??0};break;case"limit":d={lower:He(p,"lower")??0,upper:He(p,"upper")??0,effort:ze(p,"effort"),velocity:ze(p,"velocity")};break;case"mimic":{const g=p.getAttribute("joint")??void 0;if(g==null)throw new Error(`missing attribute "joint" in ${p}`);h={joint:g,multiplier:He(p,"multiplier")??1,offset:He(p,"offset")??0};break}case"safety_controller":f={softLowerLimit:He(p,"soft_lower_limit")??0,softUpperLimit:He(p,"soft_upper_limit")??0,kPosition:He(p,"k_position")??0,kVelocity:ze(p,"k_velocity")};break}}if(n==null||r==null)throw new Error(`missing parent or child in ${i}`);return{name:e,jointType:t,origin:s??Pi(),parent:n,child:r,axis:a??{x:1,y:0,z:0},calibration:o,dynamics:l,limit:d,mimic:h,safetyController:f}}function Ym(i){const e=i.getAttribute("name")??void 0;let t,s,n;for(let r=0;r<i.children.length;r++){const a=i.children[r];switch(a.nodeName){case"origin":t=Ei(a);break;case"geometry":s=Wl(a);break;case"material":n=Vl(a);break}}if(s==null)throw new Error("<visual> must have geometry");return{name:e,origin:t??Pi(),geometry:s,material:n}}function Km(i){const e=i.getAttribute("name")??void 0;let t,s;for(let n=0;n<i.children.length;n++){const r=i.children[n];switch(r.nodeName){case"origin":t=Ei(r);break;case"geometry":s=Wl(r);break}}if(s==null)throw new Error("<collision> must have geometry");return{name:e,origin:t??Pi(),geometry:s}}function Vl(i){const e=i.getAttribute("name")??void 0;let t,s;for(let n=0;n<i.children.length;n++){const r=i.children[n];switch(r.nodeName){case"color":t=Jm(r,"rgba");break;case"texture":s=r.getAttribute("filename")??void 0;break}}return{name:e,color:t,texture:s}}function Xm(i){const e=ze(i,"ixx"),t=ze(i,"ixy"),s=ze(i,"ixz"),n=ze(i,"iyy"),r=ze(i,"iyz"),a=ze(i,"izz");return{ixx:e,ixy:t,ixz:s,iyy:n,iyz:r,izz:a}}function Wl(i){if(i.children.length<1)throw new Error("<geometry> must contain box, cylinder, sphere, or mesh");const e=i.children[0];switch(e.nodeName){case"box":{const t=_s(e,"size");if(t==null)throw new Error(`missing attribute "size" in ${i}`);return{geometryType:"box",size:t}}case"cylinder":{const t=ze(e,"length"),s=ze(e,"radius");return{geometryType:"cylinder",length:t,radius:s}}case"sphere":return{geometryType:"sphere",radius:ze(e,"radius")};case"mesh":{const t=e.getAttribute("filename")??void 0,s=_s(e,"scale");if(t==null)throw new Error(`missing attribute "filename" in ${i}`);return{geometryType:"mesh",filename:t,scale:s}}default:throw new Error("<geometry> must contain box, cylinder, sphere, or mesh")}}function Ei(i){const e=_s(i,"xyz")??{x:0,y:0,z:0},t=_s(i,"rpy")??{x:0,y:0,z:0};return{xyz:e,rpy:t}}function _s(i,e){const t=i.getAttribute(e)?.trim().split(/\s+/);if(t?.length!==3)return;const[s,n,r]=t;return{x:parseFloat(s),y:parseFloat(n),z:parseFloat(r)}}function Jm(i,e){const t=i.getAttribute(e)?.trim().split(/\s+/);if(t?.length!==4)return;const[s,n,r,a]=t;return{r:parseFloat(s),g:parseFloat(n),b:parseFloat(r),a:parseFloat(a)}}function ze(i,e){const t=i.getAttribute(e);if(t==null)throw new Error(`missing attribute "${e}" in ${i}`);return parseFloat(t)}function He(i,e){const t=i.getAttribute(e);if(t!=null)return parseFloat(t)}function Qm(i){if(i.textContent==null)throw new Error(`expected float value in "${i}"`);return parseFloat(i.textContent)}function Pi(){return{xyz:{x:0,y:0,z:0},rpy:{x:0,y:0,z:0}}}async function qm(i,e){const t=new Bm.$;t.rospackCommands={find:n=>`package://${n}`},t.getFileContents=e;const s=await t.parse(i);return $m(s)}function Hl(i){const e=i.x,t=i.y,s=i.z,n=Math.cos(s*.5),r=Math.sin(s*.5),a=Math.cos(e*.5),o=Math.sin(e*.5),l=Math.cos(t*.5),d=Math.sin(t*.5),h=n*a*l+r*o*d,f=n*o*l-r*a*d,m=n*a*d+r*o*l,p=r*a*l-n*o*d;return{x:f,y:m,z:p,w:h}}function eg(i,e,t){const s=Array(36).fill(0);return s[6*0+0]=Math.pow(i,2),s[6*1+1]=Math.pow(e,2),s[6*5+5]=Math.pow(t,2),s}var Zl=b(61969);class Yl extends Oe{#e;#t;constructor(e,t,s,n){super(e,t,s,n);const r=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-cube`,Kl),a=this.renderer.sharedGeometry.getGeometry(`${this.constructor.name}-cube-edges`,()=>tg(r));this.#e=new c.Kj0(r,Ht(t.color)),this.#e.castShadow=!0,this.#e.receiveShadow=!0,this.add(this.#e),this.#t=new c.ejS(a,n.outlineMaterial),this.#t.userData.picking=!1,this.#e.add(this.#t),this.update(t,s)}dispose(){this.#e.material.dispose()}update(e,t){super.update(e,t);const s=this.userData.marker,n=s.color.a<1;n!==this.#e.material.transparent&&(this.#e.material.transparent=n,this.#e.material.depthWrite=!n,this.#e.material.needsUpdate=!0),this.#t.visible=this.getSettings()?.showOutlines??!0,be(this.#e.material.color,s.color),this.#e.material.opacity=s.color.a,this.scale.set(s.scale.x,s.scale.y,s.scale.z)}}function Kl(){const i=new c.DvJ(1,1,1);return i.computeBoundingSphere(),i}function tg(i){const e=new c.TOt(i,40);return e.computeBoundingSphere(),e}class Xl extends Oe{#e;#t;constructor(e,t,s,n){super(e,t,s,n);const r=Ht(t.color),a=n.sharedGeometry.getGeometry(`${this.constructor.name}-cylinder-${n.maxLod}`,()=>sg(n.maxLod));this.#e=new c.Kj0(a,r),this.#e.castShadow=!0,this.#e.receiveShadow=!0,this.add(this.#e);const o=n.sharedGeometry.getGeometry(`${this.constructor.name}-edges-${n.maxLod}`,()=>ig(a));this.#t=new c.ejS(o,n.outlineMaterial),this.#t.userData.picking=!1,this.#e.add(this.#t),this.update(t,s)}dispose(){this.#e.material.dispose()}update(e,t){super.update(e,t);const s=this.userData.marker,n=s.color.a<1;n!==this.#e.material.transparent&&(this.#e.material.transparent=n,this.#e.material.depthWrite=!n,this.#e.material.needsUpdate=!0),this.#t.visible=this.getSettings()?.showOutlines??!0,be(this.#e.material.color,s.color),this.#e.material.opacity=s.color.a,this.scale.set(s.scale.x,s.scale.y,s.scale.z)}}function sg(i){const e=kh(i),t=new c.fHI(.5,.5,1,e);return t.rotateX(Math.PI/2),t.computeBoundingSphere(),t}function ig(i){const e=new c.TOt(i,40);return e.computeBoundingSphere(),e}const Ls="MESH_FETCH_FAILED";class Jl extends Oe{#e;#t;#s=0;constructor(e,t,s,n){super(e,t,s,n),this.#t=Ht(t.color),this.update(t,s,!0)}dispose(){this.#e&&Ps(this.#e),this.#t.dispose()}update(e,t,s){const n=this.userData.marker;super.update(e,t);const r=this.userData.marker,a=r.color.a<1;if(a!==this.#t.transparent&&(this.#t.transparent=a,this.#t.depthWrite=!a,this.#t.needsUpdate=!0),be(this.#t.color,r.color),this.#t.opacity=r.color.a,s===!0||r.mesh_resource!==n.mesh_resource){const o=++this.#s,l={useEmbeddedMaterials:r.mesh_use_embedded_materials},d=this.renderer.settings.errors;this.#e&&(this.remove(this.#e),Ps(this.#e),this.#e=void 0),this.#n(r.mesh_resource,l).then(h=>{if(h){if(this.#s!==o){Ps(h);return}this.#e=h,this.add(h),this.#i(),this.renderer.settings.errors.remove(this.userData.settingsPath,Ls),this.renderer.queueAnimationFrame()}}).catch(h=>{d.add(this.userData.settingsPath,Ls,`Unhandled error loading mesh from "${r.mesh_resource}": ${h.message}`)})}this.#i(),this.scale.set(r.scale.x,r.scale.y,r.scale.z)}#i(){const e=this.getSettings()?.showOutlines??!0;this.traverse(t=>{t instanceof c.ejS&&t.name===_n&&(t.visible=e)})}async#n(e,t){const s=await this.renderer.modelCache.load(e,{},r=>{this.renderer.settings.errors.add(this.userData.settingsPath,Ls,`Error loading mesh from "${e}": ${r.message}`)});if(!s){this.renderer.settings.errors.hasError(this.userData.settingsPath,Ls)||this.renderer.settings.errors.add(this.userData.settingsPath,Ls,`Failed to load mesh from "${e}"`);return}const n=s.clone(!0);return zl(n),t.useEmbeddedMaterials||kl(n,this.#t),n}}var ng="../../packages/studio-base/src/panels/ThreeDeeRender/renderables/Urdfs.ts";const Qt=Y.ZP.getLogger(ng),Rs="foxglove.Urdf",Ze="/robot_description",_t="param:/robot_description",Ql="/robot_description",rg="/robot_description (parameter)",Lt="ValidSrc",ql="FetchUrdf",fr="ParseUrdf",_i=Math.PI/180,ke=180/Math.PI,pr="#ffffff",ag=R(ee(),pr),og={x:1,y:1,z:1},ec=["X","Y","Z"],lg=["R","P","Y"],vt={visible:!1,frameLocked:!0,instanceId:"invalid",displayMode:"auto",label:"URDF",fallbackColor:pr},Ye={visible:!0,frameLocked:!0,label:"URDF",instanceId:"invalid",layerId:Rs,sourceType:"url",url:"",filePath:"",parameter:"",topic:"",framePrefix:"",displayMode:"auto",fallbackColor:pr},tc=new Set(["std_msgs/String","std_msgs/msg/String"]),Li=new c.Pa4,sc=new c.Pa4,ic=new c._fP,cg=new c._fP,mr=new c.USm;var Ns;(function(i){i[i.Use=0]="Use",i[i.Ignore=1]="Ignore"})(Ns||(Ns={}));class dg extends K{dispose(){this.removeChildren(),this.userData.urdf=void 0,super.dispose()}removeChildren(){for(const e of this.userData.renderables.values())e.dispose();this.children.length=0,this.userData.renderables.clear()}}class hg extends J.d{#e=new Map;#t=new Map;#s=new Map;#i=new TextDecoder;#n=new Map;constructor(e){super("foxglove.Urdfs",e),e.on("parametersChange",this.#u),e.addCustomLayerAction({layerId:Rs,label:D.ZP.t("threeDee:addURDF"),icon:"PrecisionManufacturing",handler:this.#m});for(const[t,s]of Object.entries(e.config.layers))s?.layerId===Rs&&this.#p({instanceId:t,urdf:void 0})}getSubscriptions(){return[{type:"topic",topicName:Ze,subscription:{handler:this.#d}},{type:"schema",schemaNames:jr,subscription:{handler:this.#h}},{type:"schema",schemaNames:tc,subscription:{shouldSubscribe:this.#c,handler:this.#d}}]}settingsNodes(){const e=[],t={label:"Display mode",input:"select",options:[{label:"Auto",value:"auto"},{label:"Visual",value:"visual"},{label:"Collision",value:"collision"}]},s={label:"Color",help:"Fallback color used in case a link does not specify any color itself",input:"rgb"};if(this.renderer.topicsByName?.get(Ze)!=null){const a=this.renderer.config.topics[Ze]??{},o={displayMode:{...t,value:a.displayMode??vt.displayMode},fallbackColor:{...s,value:a.fallbackColor??vt.fallbackColor}};e.push({path:["topics",Ze],node:{label:Ze,icon:"PrecisionManufacturing",fields:o,visible:a.visible??vt.visible,handler:this.#a,children:br(this.#t.get(Ze),this.renderer.transformTree,this.#s)}})}if(this.renderer.parameters?.get(Ql)!=null){const a=this.renderer.config.topics[_t]??{},o={displayMode:{...t,value:a.displayMode??vt.displayMode},fallbackColor:{...s,value:a.fallbackColor??vt.fallbackColor}};e.push({path:["topics",_t],node:{label:rg,icon:"PrecisionManufacturing",fields:o,visible:a.visible??vt.visible,handler:this.#a,children:br(this.#t.get(_t),this.renderer.transformTree,this.#s)}})}for(const[a,o]of Object.entries(this.renderer.config.layers))if(o?.layerId===Rs){const l=o,d={sourceType:{label:"Source",input:"select",value:l.sourceType??Ye.sourceType,options:[{label:"URL",value:"url"},{label:"File path (Desktop only)",value:"filePath",disabled:!(0,Zl.Z)()},{label:"Parameter",value:"param"},{label:"Topic",value:"topic"}]},url:l.sourceType==="url"?{label:"URL",input:"string",placeholder:"package://",help:"package:// URL or http(s) URL pointing to a Unified Robot Description Format (URDF) XML file",value:l.url??Ye.url}:void 0,filePath:l.sourceType==="filePath"?{label:"File path",input:"string",help:"Absolute file path (desktop app only)",value:l.filePath??Ye.filePath,disabled:!(0,Zl.Z)()}:void 0,topic:l.sourceType==="topic"?{label:"Topic",input:"autocomplete",value:l.topic??Ye.topic,items:(0,z.Z)(this.renderer.topics??[],h=>tc.has(h.schemaName)?h.name:void 0)}:void 0,parameter:l.sourceType==="param"?{label:"Parameter",input:"autocomplete",value:l.parameter??Ye.parameter,items:(0,z.Z)(this.renderer.parameters??[],([h,f])=>typeof f=="string"?h:void 0)}:void 0,label:{label:"Label",input:"string",value:l.label??Ye.label},framePrefix:{label:"Frame prefix",input:"string",help:"Prefix to apply to all frame names (also often called tfPrefix)",placeholder:"Frame prefix",value:l.framePrefix??""},displayMode:{...t,value:l.displayMode??Ye.displayMode},fallbackColor:{...s,value:l.fallbackColor??vt.fallbackColor}};e.push({path:["layers",a],node:{label:l.label??"Grid",icon:"PrecisionManufacturing",fields:d,visible:l.visible??Ye.visible,actions:[{type:"action",id:"duplicate",label:"Duplicate"},{type:"action",id:"delete",label:"Delete"}],order:o.order,handler:this.#o,children:br(this.#t.get(a),this.renderer.transformTree,this.#s)}})}return e}removeAllRenderables(){this.#r()}#r(){for(const[e,t]of this.#e)this.#y(e,t);for(const[e,t]of this.#t)this.#S(e,t)}startFrame(e,t,s){for(const n of this.renderables.values()){const r=n.userData.settingsPath;let a=!1;if(n.visible=n.userData.settings.visible,!n.visible){this.renderer.settings.errors.clearPath(r);continue}for(const o of n.userData.renderables.values()){const l=e,d=o.userData.frameId;if(!(0,bi.S)(o,this.renderer.transformTree,t,s,d,e,l)){const f=(0,Fe.v)(t,s,d);this.renderer.settings.errors.add(r,Fe.o,f),a=!0}}a||this.renderer.settings.errors.remove(r,Fe.o)}}#a=e=>{if(e.action==="update"){this.#l(e);return}};#o=e=>{const t=e.payload.path;if(e.action==="perform-node-action"&&t.length===2){const s=t[1];if(e.payload.id==="delete"){this.renderer.updateConfig(a=>{delete a.layers[s]});const n=this.renderables.get(s);n&&(n.dispose(),this.remove(n),this.renderables.delete(s));const r=this.#t.get(s);if(r)for(const{parent:a,child:o}of r)this.renderer.removeTransform(o,a,0n);this.#e.delete(s),this.#t.delete(s),this.#r(),this.updateSettingsTree(),this.renderer.updateCustomLayersCount()}else if(e.payload.id==="duplicate"){const n=(0,Aa.Z)(),r={...this.renderer.config.layers[s],instanceId:n};this.renderer.updateConfig(o=>{o.layers[n]=r});const a=this.renderables.get(s);this.#p({instanceId:n,urdf:a?.userData.urdf}),this.updateSettingsTree(),this.renderer.updateCustomLayersCount()}}else e.action==="update"&&this.#l(e)};#l=e=>{const t=e.payload.path;if(t.length===5&&t[2]==="joints"){const s=t[1],n=t[3],r=this.#t.get(s);if(!r)return;const a=r.find(m=>m.joint.name===n);if(!a)return;const o=a.joint,l=this.renderer.transformTree.getOrCreateFrame(a.child),d=`frame:${l.id}`,h=o.jointType==="revolute"||o.jointType==="continuous",f=Li.set(o.axis.x,o.axis.y,o.axis.z);if(h){const m=e.payload.value,p=ic.setFromAxisAngle(f,m*_i),g=mr.setFromQuaternion(p);l.offsetEulerDegrees=[g.x*ke,g.y*ke,g.z*ke],this.saveSetting(["transforms",d,"rpyCoefficient"],l.offsetEulerDegrees)}else{const m=e.payload.value;f.multiplyScalar(m),l.offsetPosition=[f.x,f.y,f.z],this.saveSetting(["transforms",d,"xyzOffset"],l.offsetPosition)}}else if(t.length===3){this.saveSetting(t,e.payload.value);const[s,n,r]=t,a=this.renderables.get(n);let o=a?.userData.urdf;if(r==="url"||r==="filePath")this.#v({instanceId:n,urdf:void 0});else if(r==="parameter")o=this.renderer.parameters?.get(e.payload.value),this.#v({instanceId:n,urdf:o,forceReload:!0});else if(r==="framePrefix")this.#v({instanceId:n,urdf:o,forceReload:!0});else if(r==="displayMode"||r==="visible"||r==="fallbackColor")this.#p({instanceId:n,urdf:o,forceReload:!0});else if(r==="sourceType"){const l=e.payload.value;l==="topic"?o=a?.userData.topic?this.#n.get(a.userData.topic):void 0:l==="param"?o=a?.userData.parameter?this.renderer.parameters?.get(a.userData.parameter):void 0:o=void 0,this.#p({instanceId:n,urdf:o,forceReload:!0})}else r==="topic"?(o=this.#n.get(e.payload.value),this.#p({instanceId:n,urdf:o})):this.#p({instanceId:n,urdf:o})}};#d=e=>{const t=e.topic,s=e.message.data;if(typeof s!="string")return;this.#n.set(t,s),t===Ze&&this.#p({instanceId:Ze,urdf:s});const n=(0,z.Z)(this.renderables,([r,a])=>a.userData.sourceType==="topic"&&a.userData.topic===t?r:void 0);for(const r of n)this.#p({instanceId:r,urdf:s})};#c=e=>Array.from(this.renderables.values()).some(t=>t.userData.sourceType==="topic"&&t.userData.topic===e);#h=e=>{const t=e.message,s=t.name??[],n=t.position??[],r=(0,M.toNanoSec)(e.receiveTime);for(let a=0;a<s.length;a++){const o=s[a],l=n[a]??0,d=this.#s.get(o)?.timestamp;(d==null||r>=d)&&this.#s.set(o,{timestamp:r,position:l})}};#u=e=>{const t=e?.get(Ql);typeof t=="string"&&this.#p({instanceId:_t,urdf:t});for(const[s,n]of this.renderables.entries()){const r=n.userData.settings.sourceType,a=n.userData.settings.parameter;if(r==="param"&&a!=null){const o=e?.get(a);typeof o=="string"&&this.#p({instanceId:s,urdf:o})}}};#m=e=>{Qt.info(`Creating ${Rs} layer ${e}`);const t={...Ye,instanceId:e};this.renderer.updateConfig(s=>{const r=1+(Ao.Z(Object.values(s.layers),a=>a?.order)?.order??0);s.layers[e]={...t,order:r}}),this.#p({instanceId:e,urdf:void 0}),this.updateSettingsTree()};#f(e,t){const s=this.renderables.get(e);if(!s)throw new Error("_fetchUrdf() should only be called for existing renderables");if(!bg(t)){const n=s.userData.settingsPath;this.renderer.settings.errors.add(n,Lt,`Invalid URDF URL: "${t}"`);return}if(this.renderer.settings.errors.remove(s.userData.settingsPath,Lt),!(s.userData.sourceType==="url"&&s.userData.url===t||s.userData.sourceType==="filePath"&&`file://${s.userData.filePath}`===t)){if(s.userData.fetching){if(s.userData.fetching.url===t)return;s.userData.fetching.control.abort()}Qt.debug(`Fetching URDF from ${t}`),s.userData.fetching={url:t,control:new AbortController},this.renderer.fetchAsset(t,{signal:s.userData.fetching.control.signal}).then(n=>{Qt.debug(`Fetched ${n.data.length} byte URDF from ${t}`),this.renderer.settings.errors.remove(["layers",e],ql),this.#p({instanceId:e,urdf:this.#i.decode(n.data)})}).catch(n=>{const r=n,a=!r.message.startsWith("Failed to fetch"),o=`Failed to load URDF from "${t}"${a?`: ${r.message}`:""}`;this.renderer.settings.errors.add(["layers",e],ql,o)})}}#b(e){const t=e===Ze||e===_t,s=t?vt:Ye,n=t?this.renderer.config.topics[e]:this.renderer.config.layers[e];return{...s,...n,instanceId:e}}#p(e){const{instanceId:t,urdf:s}=e,n=e.forceReload??!1;let r=this.renderables.get(t);const a=this.#b(t);if(r&&s&&!n&&r.userData.urdf===s){r.userData.settings=a;return}const o=this.#t.get(t)??[];for(const T of o)this.renderer.removeTransform(T.child,T.parent,0n);this.#t.delete(t),this.#e.delete(t),this.updateSettingsTree();const l=t===Ze||t===_t,d=this.renderer.fixedFrameId??"",h=l?["topics",t]:["layers",t],f=a.sourceType,m=a.url,p=a.filePath,g=a.parameter,u=a.topic,x=a.framePrefix,y=a.label??Ye.label;if(y!==r?.userData.settings.label&&this.renderer.updateConfig(T=>{const I=T.layers[t];I&&(I.label=y)}),r||(r=new dg(t,this.renderer,{urdf:s,url:s!=null?m:void 0,filePath:s!=null?p:void 0,fetching:void 0,renderables:new Map,receiveTime:0n,messageTime:0n,frameId:d,pose:(0,N.N2)(),settingsPath:h,settings:a,sourceType:f,topic:u,parameter:g}),this.add(r),this.renderables.set(t,r)),r.userData.urdf=s,r.userData.url=s!=null&&f==="url"?m:void 0,r.userData.filePath=s!=null&&f==="filePath"?p:void 0,r.userData.sourceType=f,r.userData.topic=u,r.userData.parameter=g,r.userData.settings=a,r.userData.fetching=void 0,(!s||n)&&r.removeChildren(),s)this.renderer.settings.errors.remove(r.userData.settingsPath,Lt);else{const T=r.userData.settingsPath;if(this.renderer.settings.errors.remove(T,fr),this.renderer.settings.errors.remove(T,Fe.o),f==="url")m!=null?this.#f(t,m):this.renderer.settings.errors.add(T,Lt,`Invalid URDF URL: "${m}"`);else if(f==="filePath")if(p!=null)this.#f(t,`file://${p}`);else{const I=`Invalid File Path: "${p}"`;this.renderer.settings.errors.add(T,Lt,I)}else f==="param"?this.renderer.settings.errors.add(T,Lt,`Invalid Parameter: "${g}"`):f==="topic"&&this.renderer.settings.errors.add(T,Lt,`Invalid Topic: "${u}"`);return}const C=r;ug(s,async T=>await this.#g(T),x).then(T=>{this.#T(C,T),this.renderer.settings.errors.remove(C.userData.settingsPath,fr),this.renderer.queueAnimationFrame()}).catch(T=>{const I=T;Qt.error(`Failed to parse URDF: ${I.message}`),this.renderer.settings.errors.add(h,fr,`Failed to parse URDF: ${I.message}`)})}#v=Va.Z(this.#p.bind(this),500);#T(e,{robot:t,frames:s,transforms:n}){const r=this.renderer,a=e.userData.settings,o=a.instanceId,l=a.displayMode,d=a.fallbackColor?R(ee(),a.fallbackColor):void 0;this.#y(o,s),this.#S(o,n),this.updateSettingsTree(),e.removeChildren();const h=(f,m,p)=>{const g=e.userData.url,u=fg({visual:p,robot:t,id:m,frameId:f,renderer:r,baseUrl:g,fallbackColor:d});u.userData.settingsPath=e.userData.settingsPath,e.userData.renderables.set(u.name,u),e.add(u)};for(const f of t.links.values()){const m=f.name,p=l!=="collision",g=l==="collision"||l==="auto"&&f.visuals.length===0;if(p)for(let u=0;u<f.visuals.length;u++)h(m,u,f.visuals[u]);if(g)for(let u=0;u<f.colliders.length;u++)h(m,u,f.colliders[u])}}#y(e,t){this.#e.set(e,t);for(const s of t)this.renderer.addCoordinateFrame(s)}#S(e,t){this.#t.set(e,t);const n=e===Ze||e===_t?["topics",e]:["layers",e];for(const{parent:r,child:a,translation:o,rotation:l}of t)this.renderer.addTransform(r,a,0n,o,l,n)}async#g(e){try{Qt.debug(`fetch(${e}) requested`);const t=await this.renderer.fetchAsset(e);return this.#i.decode(t.data)}catch(t){throw new Error(`Failed to fetch "${e}": ${t}`)}}}async function ug(i,e,t){const s=n=>`${t}${n}`;try{Qt.debug(`Parsing ${i.length} byte URDF`);const n=await qm(i,e);t&&(n.links=new Map([...n.links].map(([o,l])=>[s(o),{...l,name:s(l.name)}])),n.joints=new Map([...n.joints].map(([o,l])=>[o,{...l,parent:s(l.parent),child:s(l.child)}])));const r=Array.from(n.links.values(),o=>o.name),a=Array.from(n.joints.values(),o=>{const l=o.origin.xyz,d=Hl(o.origin.rpy);return{parent:o.parent,child:o.child,translation:l,rotation:d,joint:o}});return{robot:n,frames:r,transforms:a}}catch(n){throw new Error(`Failed to parse ${i.length} byte URDF: ${n}`)}}function fg(i){const{visual:e,robot:t,id:s,frameId:n,renderer:r,baseUrl:a,fallbackColor:o}=i,l=`${n}-${s}-${e.geometry.geometryType}`,d=Hl(e.origin.rpy),h={position:e.origin.xyz,orientation:d},f=pg(e,t)??o??ag,m=e.geometry.geometryType;switch(m){case"box":{const p=e.geometry.size,g=gr(n,E.CUBE,h,p,f);return new Yl(l,g,void 0,r)}case"cylinder":{const p=e.geometry,g={x:p.radius*2,y:p.radius*2,z:p.length},u=gr(n,E.CUBE,h,g,f);return new Xl(l,u,void 0,r)}case"sphere":{const p=e.geometry,g={x:p.radius*2,y:p.radius*2,z:p.radius*2},u=gr(n,E.CUBE,h,g,f);return new Ci(l,u,void 0,r)}case"mesh":{const g=e.geometry.filename.toLowerCase().endsWith(".dae")?Ns.Use:Ns.Ignore,u=mg(n,h,g,e.geometry,a,f);return new Jl(l,u,void 0,r)}default:throw new Error(`Unrecognized visual geometryType: ${m}`)}}function pg(i,e){if(i.material){if(i.material.color)return i.material.color;if(i.material.name)return e.materials.get(i.material.name)?.color}}function gr(i,e,t,s,n){return{header:{frame_id:i,stamp:{sec:0,nsec:0}},ns:"",id:0,type:e,action:le.ADD,pose:t,scale:s,color:n,lifetime:{sec:0,nsec:0},frame_locked:!0,points:[],colors:[],text:"",mesh_resource:"",mesh_use_embedded_materials:!1}}function mg(i,e,t,s,n,r){const a=s.scale??og;return{header:{frame_id:i,stamp:{sec:0,nsec:0}},ns:"",id:0,type:E.MESH_RESOURCE,action:le.ADD,pose:e,scale:a,color:r,lifetime:{sec:0,nsec:0},frame_locked:!0,points:[],colors:[],text:"",mesh_resource:new URL(s.filename,n).toString(),mesh_use_embedded_materials:t===Ns.Use}}const gg=["https:","http:","file:","data:","package:"];function bg(i){try{const e=new URL(i);return gg.includes(e.protocol)}catch{return!1}}function br(i,e,t){if(!i)return{};const s={};for(const{joint:r}of i){const a=r.child,o=e.getOrCreateFrame(a),{x:l,y:d,z:h}=r.origin.xyz,{x:f,y:m,z:p}=r.origin.rpy,{x:g,y:u,z:x}=r.axis,y={};switch(y.jointType={label:"Type",input:"string",readonly:!0,value:r.jointType},r.jointType){case"fixed":break;case"continuous":case"revolute":{const C=r.limit?r.limit.lower*ke:-180,T=r.limit?r.limit.upper*ke:180;let I;const _=t.get(r.name)?.position;if(o.offsetEulerDegrees){const P=yg(o.offsetEulerDegrees);I=Tg(P,r.axis)*ke}y.manual={label:"Manual angle",input:"number",precision:tt,step:1,min:C,max:T,value:I},_!=null&&(y.jointState={label:"JointState angle",input:"number",precision:tt,min:C,max:T,readonly:!0,value:_*ke});break}case"prismatic":{const C=r.limit?.lower,T=r.limit?.upper,I=o.offsetPosition?vg(o.offsetPosition,r.axis):void 0,_=t.get(r.name)?.position;y.manual={label:"Manual position",input:"number",precision:V,step:.01,min:C,max:T,value:I},_!=null&&(y.jointState={label:"JointState position",input:"number",precision:V,min:C,max:T,readonly:!0,value:_});break}case"floating":case"planar":break}if(y.position={label:"Position",input:"vec3",labels:ec,precision:V,readonly:!0,value:[l,d,h]},y.rotation={label:"Rotation",input:"vec3",labels:lg,precision:tt,readonly:!0,value:[f*ke,m*ke,p*ke]},y.parent={label:"Parent",input:"string",readonly:!0,value:r.parent},y.child={label:"Child",input:"string",readonly:!0,value:r.child},r.jointType!=="fixed"&&(y.axis={label:"Axis",input:"vec3",labels:ec,precision:V,readonly:!0,value:[g,u,x]}),r.calibration){const{rising:C,falling:T}=r.calibration;y.calibration={label:"Calibration",input:"vec2",labels:["\u2191","\u2193"],readonly:!0,value:[C,T]}}if(r.dynamics){const{damping:C,friction:T}=r.dynamics;y.damping={label:"Damping",input:"number",precision:V,readonly:!0,value:C},y.friction={label:"Friction",input:"number",precision:V,readonly:!0,value:T}}if(r.limit){const{effort:C,velocity:T}=r.limit;if(r.jointType!=="continuous"&&r.jointType!=="fixed"){const{upper:I,lower:_}=r.limit,P=r.jointType==="revolute",L=P?I*ke:I,G=P?_*ke:_;y.limit={label:"Limit",input:"vec2",labels:["\u2191","\u2193"],readonly:!0,precision:P?tt:V,value:[L,G]}}y.effort={label:"Limit effort",input:"number",precision:V,readonly:!0,value:C},y.velocity={label:"Limit velocity",input:"number",precision:V,readonly:!0,value:T}}if(r.mimic){const{joint:C,multiplier:T,offset:I}=r.mimic;y.mimicJoint={label:"Mimic joint",input:"string",readonly:!0,value:C},y.mimicMultiplier={label:"Mimic multiplier",input:"number",precision:V,readonly:!0,value:T},y.mimicOffset={label:"Mimic offset",input:"number",precision:V,readonly:!0,value:I}}if(r.safetyController){const{softUpperLimit:C,softLowerLimit:T,kPosition:I,kVelocity:_}=r.safetyController;y.softLimit={label:"Soft limit",input:"vec2",labels:["\u2191","\u2193"],readonly:!0,value:[C,T]},y.kPosition={label:"k_position",input:"number",precision:V,readonly:!0,value:I},y.kVelocity={label:"k_velocity",input:"number",precision:V,readonly:!0,value:_}}s[r.name]={label:r.name,fields:y,defaultExpansionState:"collapsed"}}return{joints:{label:"Joints",defaultExpansionState:"collapsed",children:s}}}function yg(i){return mr.set(i[0]*_i,i[1]*_i,i[2]*_i),ic.setFromEuler(mr)}function vg(i,e){const t=Li.set(i[0],i[1],i[2]),s=sc.set(e.x,e.y,e.z);t.projectOnVector(s);const n=t.length();return(t.dot(s)<0?-1:1)*n}function Tg(i,e){const t=Li.set(i.x,i.y,i.z),s=sc.set(e.x,e.y,e.z),n=t.projectOnVector(s),r=cg.set(n.x,n.y,n.z,i.w);r.normalize();const a=2*Math.acos(r.w);return(Li.set(r.x,r.y,r.z).dot(s)<0?-1:1)*a}var Ie=b(3890);const yr={...yi,stixelsEnabled:!1};function Sg(i){switch(i){case Ie.PointFieldDataType.UINT8:return A.NumericType.UINT8;case Ie.PointFieldDataType.INT8:return A.NumericType.INT8;case Ie.PointFieldDataType.UINT16:return A.NumericType.UINT16;case Ie.PointFieldDataType.INT16:return A.NumericType.INT16;case Ie.PointFieldDataType.UINT32:return A.NumericType.UINT32;case Ie.PointFieldDataType.INT32:return A.NumericType.INT32;case Ie.PointFieldDataType.FLOAT32:return A.NumericType.FLOAT32;case Ie.PointFieldDataType.FLOAT64:return A.NumericType.FLOAT64;default:return A.NumericType.UNKNOWN}}class xg{#e=new Map;decode(e){if(e.packets.length===0)return;const t=e.packets[0],s=Ie.RawPacket.InferModel(t.data);if(s==null)return;const n=(0,M.toSec)(e.header.stamp),r=Ie.RawPacket.MAX_POINTS_PER_PACKET*e.packets.length,a=new Ie.PointCloud({stamp:n,maxPoints:r}),o=this.getTransformer(s);for(const l of e.packets)o.unpack(new Ie.RawPacket(l.data),n,(0,M.toSec)(l.stamp),a);if(a.trim(),!(a.width===0||a.height===0))return{timestamp:e.header.stamp,frame_id:e.header.frame_id,pose:(0,N.N2)(),point_stride:a.point_step,fields:a.fields.map(l=>({name:l.name,offset:l.offset,type:Sg(l.datatype)})),data:a.data}}getTransformer(e){let t=this.#e.get(e);return t!=null||(t=new Ie.Transformer(new Ie.Calibration(e)),this.#e.set(e,t)),t}}class wg extends J.d{#e=new Map;#t=new xg;constructor(e){super("foxglove.VelodyneScans",e)}getSubscriptions(){return[{type:"schema",schemaNames:rn,subscription:{handler:this.#s}}]}settingsNodes(){const e=this.renderer.config.topics,t=this.handleSettingsAction,s=[];for(const n of this.renderer.topics??[]){if(!j(n,rn))continue;const r=e[n.name]??{},a=this.#e.get(n.name)??Oo,o=Wn(n,a,r);o.fields.stixelsEnabled={label:"Stixel view",input:"boolean",value:r.stixelsEnabled??yr.stixelsEnabled},o.handler=t,o.icon="Points",s.push({path:["topics",n.name],node:o})}return s}handleSettingsAction=e=>{const t=e.payload.path;if(e.action!=="update"||t.length!==3)return;this.saveSetting(t,e.payload.value);const s=t[1],n=this.renderables.get(s);if(n){const r=this.renderer.config.topics[s],a={...yr,...r};n.updatePointCloud(n.userData.latestPointCloud,n.userData.latestOriginalMessage,a,n.userData.receiveTime)}};startFrame(e,t,s){for(const n of this.renderables.values())n.startFrame(e,t,s)}#s=e=>{const{topic:t}=e,s=(0,M.toNanoSec)(e.receiveTime),n=this.#t.decode(e.message);if(!n)return;let r=this.renderables.get(t);if(!r){const o=this.renderer.config.topics[t],l={...yr,...o};l.colorField==null&&(Fo(l,n,{supportsPackedRgbModes:!1}),this.renderer.updateConfig(g=>{const u={...o};u.colorField=l.colorField,u.colorMode=l.colorMode,u.colorMap=l.colorMap,g.topics[t]=u}));const d=Zn(l),h=ko(l),f=Go(l),m=nr(l),p=(0,M.toNanoSec)(n.timestamp);r=new Qo(t,this.renderer,{receiveTime:s,messageTime:p,frameId:this.renderer.normalizeFrameId(n.frame_id),pose:(0,N.N2)(),settingsPath:["topics",t],settings:l,topic:t,latestPointCloud:n,latestOriginalMessage:e.message,material:d,pickingMaterial:h,instancePickingMaterial:f,stixelMaterial:m}),this.add(r),this.renderables.set(t,r)}let a=this.#e.get(e.topic);(!a||a.length!==n.fields.length)&&(a=n.fields.map(o=>o.name),this.#e.set(e.topic,a),this.updateSettingsTree()),r.updatePointCloud(n,e.message,r.userData.settings,s)}}const Ig=4,vr=new c.yGw;class nc extends c.SPe{#e;constructor(e,t,s=Ig){super(e,t,0),this.#e=s,this.#i()}set(e,t,s,n){const r=e.length;this.#t(r);const a=this.instanceColor.array;for(let o=0;o<r;o++){const l=e[o],d=s[o]??n;vr.makeTranslation(l.x,l.y,l.z),vr.scale(t),this.setMatrixAt(o,vr),a[o*3+0]=d.r*255|0,a[o*3+1]=d.g*255|0,a[o*3+2]=d.b*255|0}this.instanceMatrix.needsUpdate=!0,this.instanceColor&&(this.instanceColor.needsUpdate=!0)}#t(e){for(;e>=this.#e;)this.#s();this.count=e,this.instanceMatrix.count=e,this.instanceColor.count=e}#s(){this.#e=this.#e+Math.trunc(this.#e/2)+16,this.#i()}#i(){const e=this.instanceMatrix.array,t=this.instanceColor?.array,s=new Float32Array(this.#e*16),n=new Uint8ClampedArray(this.#e*3);e.length>0&&s.set(e),t&&t.length>0&&n.set(t),this.instanceMatrix=new c.lb7(s,16),this.instanceColor=new c.lb7(n,3,!0),this.instanceMatrix.setUsage(c.dj0),this.instanceColor.setUsage(c.dj0)}}class Cg extends Oe{#e;constructor(e,t,s,n){super(e,t,s,n);const r=so(t),a=n.sharedGeometry.getGeometry("RenderableCube",Kl);this.#e=new nc(a,r,t.points.length),this.#e.castShadow=!0,this.#e.receiveShadow=!0,this.add(this.#e),this.update(t,s)}dispose(){this.#e.material.dispose()}update(e,t){const s=this.userData.marker;super.update(e,t);const n=this.userData.marker,r=ne(n);r!==ne(s)&&(this.#e.material.transparent=r,this.#e.material.depthWrite=!r,this.#e.material.needsUpdate=!0),this.#e.set(n.points,n.scale,n.colors,n.color)}}class Mg extends Oe{#e;#t;constructor(e,t,s,n){super(e,t,s,n),this.#e=new At,this.#e.createAttribute("position",Float32Array,3),this.#e.createAttribute("color",Uint8Array,4,!0),this.#t=new c.woe(this.#e,Jh(t)),this.add(this.#t),this.update(t,s)}dispose(){this.#t.material.dispose()}update(e,t){const s=this.userData.marker;super.update(e,t);const n=this.userData.marker,r=ne(n);r!==ne(s)&&(this.#t.material.transparent=r,this.#t.material.depthWrite=!r,this.#t.material.needsUpdate=!0),this.#t.material.size=n.scale.x;const a=n.points.length;this.#e.resize(a),this.#s(n,a),this.#i(n,a)}#s(e,t){const s=this.#e.getAttribute("position"),n=s.array;for(let r=0;r<t;r++){const a=e.points[r];n[r*3+0]=a.x,n[r*3+1]=a.y,n[r*3+2]=a.z}s.needsUpdate=!0}#i(e,t){const s=this.#e.getAttribute("color"),n=s.array;this._markerColorsToLinear(e,t,(r,a)=>{n[4*a+0]=r[0]*255|0,n[4*a+1]=r[1]*255|0,n[4*a+2]=r[2]*255|0,n[4*a+3]=r[3]*255|0}),s.needsUpdate=!0}}class Dg extends Oe{#e;constructor(e,t,s,n){super(e,t,s,n);const r=n.sharedGeometry.getGeometry(`RenderableSphere-${n.maxLod}`,()=>hl(n.maxLod)),a=so(t);this.#e=new nc(r,a,t.points.length),this.#e.castShadow=!0,this.#e.receiveShadow=!0,this.add(this.#e),this.update(t,s)}dispose(){this.#e.material.dispose()}update(e,t){const s=this.userData.marker;super.update(e,t);const n=this.userData.marker,r=ne(n);r!==ne(s)&&(this.#e.material.transparent=r,this.#e.material.depthWrite=!r,this.#e.material.needsUpdate=!0),this.#e.set(n.points,n.scale,n.colors,n.color)}}class Ag extends Oe{#e;constructor(e,t,s,n){super(e,t,s,n),this.#e=n.labelPool.acquire(),this.#e.setBillboard(!0),this.add(this.#e),this.update(t,s)}dispose(){this.renderer.labelPool.release(this.#e)}update(e,t){super.update(e,t);const s=this.userData.marker;this.#e.setText(s.text),this.#e.setColor(F(s.color.r),F(s.color.g),F(s.color.b)),Hs(s.color.r,s.color.g,s.color.b)<.5?this.#e.setBackgroundColor(1,1,1):this.#e.setBackgroundColor(0,0,0),this.#e.setOpacity(s.color.a),this.#e.setLineHeight(s.scale.z),this.#e.userData.pose=s.pose}}const Eg="NOT_DIVISIBLE",Pg="EMPTY",_g="COLORS_MISMATCH",Lg="INVALID_POINT",lt={r:0,g:0,b:0,a:0};class Rg extends Oe{#e;constructor(e,t,s,n){super(e,t,s,n),this.#e=new c.Kj0(new At,Xh(t)),this.#e.castShadow=!0,this.#e.receiveShadow=!0,this.add(this.#e),this.update(t,s)}dispose(){this.#e.material.dispose(),this.#e.geometry.dispose()}update(e,t){const s=this.userData.marker;super.update(e,t);const n=this.userData.marker;let r=n.points.length;if(r===0){this.renderer.settings.errors.addToTopic(this.userData.topic,Pg,"TRIANGLE_LIST: points is empty"),this.#e.geometry.resize(0);return}if(r%3!==0){const f=`${n.ns.length>0?n.ns+":":""}${n.id}`;this.renderer.settings.errors.addToTopic(this.userData.topic,Eg,`TRIANGLE_LIST: points.length ${r} is not divisible by 3 for marker ${f}`),r=Math.floor(r/3)*3}if(n.colors.length!==0&&n.colors.length!==r){const f=`${n.ns.length>0?n.ns+":":""}${n.id}`;this.renderer.settings.errors.addToTopic(this.userData.topic,_g,`TRIANGLE_LIST: colors.length ${n.colors.length} != points.length ${r} for marker ${f}`)}const a=ne(n);a!==ne(s)&&(this.#e.material.transparent=a,this.#e.material.depthWrite=!a,this.#e.material.needsUpdate=!0);const o=this.#e.geometry;o.resize(r),o.attributes.position||o.createAttribute("position",Float32Array,3),o.attributes.normal||o.createAttribute("normal",Float32Array,3),o.attributes.color||o.createAttribute("color",Uint8Array,4,!0);const l=o.attributes.position,d=o.attributes.color;let h=!1;for(let f=0;f<r;f++){const m=n.points[f];if(!Ng(m)){this.renderer.settings.errors.addToTopic(this.userData.topic,Lg,`TRIANGLE_LIST: point at index ${f} is not finite`);continue}h=h||l.getX(f)!==m.x||l.getY(f)!==m.y||l.getZ(f)!==m.z,l.setXYZ(f,m.x,m.y,m.z),Ut(lt,n.colors[f]??n.color),h=h||d.getX(f)!==lt.r||d.getY(f)!==lt.g||d.getZ(f)!==lt.b||d.getW(f)!==lt.a,d.setXYZW(f,lt.r,lt.g,lt.b,lt.a)}h&&(l.needsUpdate=!0,d.needsUpdate=!0,o.computeVertexNormals(),o.computeBoundingSphere())}}function Ng(i){return Number.isFinite(i.x)&&Number.isFinite(i.y)&&Number.isFinite(i.z)}const Og={[E.ARROW]:Ii,[E.CUBE]:Yl,[E.SPHERE]:Ci,[E.CYLINDER]:Xl,[E.LINE_STRIP]:rr,[E.LINE_LIST]:zn,[E.CUBE_LIST]:Cg,[E.SPHERE_LIST]:Dg,[E.POINTS]:Mg,[E.TEXT_VIEW_FACING]:Ag,[E.MESH_RESOURCE]:Jl,[E.TRIANGLE_LIST]:Rg};class Fg{renderer;#e=new Map;constructor(e){this.renderer=e}acquire(e,t,s,n){const r=this.#e.get(e);if(r){const o=r.pop();if(o)return o.userData.settingsPath=["topics",t],o.userData.settings={visible:!0,frameLocked:s.frame_locked},o.userData.topic=t,o.name=We(t,s.ns,s.id),o.update(s,n),o}return new Og[e](t,s,n,this.renderer)}release(e){const t=e.userData.marker.type,s=this.#e.get(t);s?s.push(e):this.#e.set(t,[e])}dispose(){for(const e of this.#e.values())for(const t of e)t.dispose();this.#e.clear()}}var Ug="../../packages/studio-base/src/panels/ThreeDeeRender/Renderer.ts";const ue=Y.ZP.getLogger(Ug),zg=10,rc=new c.Ilk(ja.light.background?.default),ac=new c.Ilk(ja.dark.background?.default),Tr=0,Sr=1,Ri=["general","followTf"],oc="NO_FRAME_SELECTED",kg="TF_OVERFLOW",lc="CYCLE_DETECTED",cc="FOLLOW_FRAME_NOT_FOUND",dc="foxglove.Renderer",Gg=new c.Ilk,hc=new c.FM8;Object.defineProperty(En.iT.prototype,"vertexShaderKey",{get(){return"LabelMaterial-VertexShader"},enumerable:!0,configurable:!0}),Object.defineProperty(En.iT.prototype,"fragmentShaderKey",{get(){return this.picking?"LabelMaterial-FragmentShader-picking":"LabelMaterial-FragmentShader"},enumerable:!0,configurable:!0});class Bg extends ri.Z{interfaceMode;#e;gl;maxLod=ve.High;debugPicking;config;settings;topics;topicsByName;parameters;variables=new Map;sceneExtensions=new Map;schemaHandlers=new Map;topicHandlers=new Map;#t=new Map;#s;#i;#n;input;outlineMaterial=new c.nls({dithering:!0});instancedOutlineMaterial=new th({dithering:!0});cameraHandler;#r;measurementTool;publishClickTool;ros=!1;#a;#o;#l;#d;colorScheme="light";modelCache;transformTree=new N.v8;coordinateFrameList=[];currentTime=0n;fixedFrameId;followFrameId;labelPool=new En.$A({fontFamily:$a.R.MONOSPACE});markerPool=new Fg(this);sharedGeometry=new Uh;#c=new c.FM8;#h=!1;#u=!1;#m;#f;#b;#p;constructor(e){super(),c.Tme.DEFAULT_UP=new c.Pa4(0,0,1);const t=this.interfaceMode=e.interfaceMode,s=this.#e=e.canvas,n=this.config=e.config;if(this.#p=e.fetchAsset,this.debugPicking=e.debugPicking??!1,this.settings=new Nh(Vg(this.interfaceMode)),this.settings.on("update",()=>this.emit("settingsTreeChange",this)),this.settings.setNodesForKey(dc,[]),this.updateCustomLayersCount(),this.gl=new c.CP7({canvas:s,alpha:!0,antialias:!0}),!this.gl.capabilities.isWebGL2)throw new Error("WebGL2 is not supported");this.gl.outputEncoding=c.knz,this.gl.toneMapping=c.uL9,this.gl.autoClear=!1,this.gl.info.autoReset=!1,this.gl.shadowMap.enabled=!1,this.gl.shadowMap.type=c.dwk,this.gl.sortObjects=!0,this.gl.setPixelRatio(window.devicePixelRatio);let r=s.width,a=s.height;s.parentElement&&(r=s.parentElement.clientWidth,a=s.parentElement.clientHeight,this.gl.setSize(r,a)),this.modelCache=new Th({ignoreColladaUpAxis:n.scene.ignoreColladaUpAxis??!1,meshUpAxis:n.scene.meshUpAxis??Pn,edgeMaterial:this.outlineMaterial,fetchAsset:this.#p}),this.#s=new c.xsS,this.#i=new c.Ox3,this.#i.position.set(1,1,1),this.#i.castShadow=!0,this.#i.layers.enableAll(),this.#i.shadow.mapSize.width=2048,this.#i.shadow.mapSize.height=2048,this.#i.shadow.camera.near=.5,this.#i.shadow.camera.far=500,this.#i.shadow.bias=-1e-5,this.#n=new c.vmT(16777215,16777215,.5),this.#n.layers.enableAll(),this.#s.add(this.#i),this.#s.add(this.#n),this.input=new nh(s,()=>this.cameraHandler.getActiveCamera()),this.input.on("resize",h=>{this.#L(h)}),this.input.on("click",h=>{this.#k(h)}),this.#a=new Mh(this.gl,this.#s),this.#l=new Eh(this),this.#o=new c.xsS,this.#o.add(this.#l);const o=zh(this.gl.capabilities),l=this.gl.getDrawingBufferSize(hc);ue.debug(`Initialized ${l.width}x${l.height} renderer (${o}x MSAA)`),this.measurementTool=new of(this),this.publishClickTool=new wp(this);const d=l.width/l.height;switch(t){case"image":this.#r=new Nd(this,{canvasSize:this.input.canvasSize,setHasCalibrationTopic:h=>{h?this.#R():this.#w()}}),this.cameraHandler=this.#r,this.#r.addEventListener("hasModifiedViewChanged",()=>{this.emit("resetViewChanged",this)}),this.#g(this.cameraHandler);break;case"3d":this.cameraHandler=new Kh(this,this.#e,d),this.#g(this.cameraHandler),this.#g(new _l.Q(this)),this.#g(new Lu(this)),this.#g(new su(this));break}this.#g(new ou(this)),this.#g(new mu(this,{visible:t==="3d"})),this.#g(new Du(this)),this.#g(new rf(this)),this.#g(new Pm(this)),this.#g(new Vd(this)),this.#g(new Zu(this)),this.#g(new vf(this)),this.#g(new Lf(this)),this.#g(new jf(this)),this.#g(new ip(this)),this.#g(new bp(this)),this.#g(new hg(this)),this.#g(new wg(this)),this.#g(this.measurementTool),this.#g(this.publishClickTool),t==="image"&&n.imageMode.calibrationTopic==null?this.#w():(this.#A(),this.#I()),this.#T(),this.setCameraState(n.cameraState),this.animationFrame()}#v=()=>{ue.debug(`devicePixelRatio changed to ${window.devicePixelRatio}`),this.#L(this.input.canvasSize),this.#T()};#T(){this.#b=window.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this.#b.addEventListener("change",this.#v,{once:!0})}dispose(){ue.warn("Disposing renderer"),this.#b?.removeEventListener("change",this.#v),this.removeAllListeners(),this.settings.removeAllListeners(),this.input.removeAllListeners();for(const e of this.sceneExtensions.values())e.dispose();this.sceneExtensions.clear(),this.sharedGeometry.dispose(),this.modelCache.dispose(),this.labelPool.dispose(),this.markerPool.dispose(),this.#a.dispose(),this.input.dispose(),this.gl.dispose()}cameraSyncError(){return this.#f}setCameraSyncError(e){this.#f=e,this.cameraHandler.updateSettingsTree()}getPixelRatio(){return this.gl.getPixelRatio()}setCurrentTime(e){this.currentTime=e}handleSeek(e){const t=this.currentTime<e;this.clear({clearTransforms:t,resetAllFramesCursor:t})}clear({clearTransforms:e,resetAllFramesCursor:t}={clearTransforms:!1,resetAllFramesCursor:!1}){e===!0&&this.#x(),t===!0&&this.#S(),this.settings.errors.clear();for(const s of this.sceneExtensions.values())s.removeAllRenderables();this.queueAnimationFrame()}#y={index:-1,lastReadMessage:void 0,cursorTimeReached:void 0};#S(){this.#y={index:-1,lastReadMessage:void 0,cursorTimeReached:void 0},this.emit("resetAllFramesCursor",this)}handleAllFramesMessages(e){if(!e||e.length===0)return!1;const t=(0,M.fromNanoSec)(this.currentTime),s=e[this.#y.index];this.#y.lastReadMessage!=null&&s!=null&&this.#y.lastReadMessage!==s&&this.#S();let n=this.#y.index,r=this.#y.cursorTimeReached,a=this.#y.lastReadMessage;n=Math.min(n,e.length-1);let o,l=!1;for(;n<e.length-1;){if(n++,o=e[n],(0,M.isLessThan)(t,o.receiveTime)){r=t,n--;break}l||(l=!0),this.addMessageEvent(o),a=o,n===e.length-1&&(r=o.receiveTime)}return l?(this.#y={index:n,cursorTimeReached:r,lastReadMessage:a},!0):!1}#g(e){if(this.sceneExtensions.has(e.extensionId))throw new Error(`Attempted to add duplicate extensionId "${e.extensionId}"`);this.sceneExtensions.set(e.extensionId,e),this.#s.add(e)}updateConfig(e){this.config=(0,re.Uy)(this.config,e),this.emit("configChange",this)}#A(){const t=this.config.scene.transforms?.enablePreloading??!0;this.#C(aa,{handler:this.#G,shouldSubscribe:()=>!0,preload:t}),this.#C(oa,{handler:this.#B,shouldSubscribe:()=>!0,preload:t}),this.#C(en,{handler:this.#j,shouldSubscribe:()=>!0,preload:t}),this.#C(Br,{handler:this.#$,shouldSubscribe:()=>!0,preload:t}),this.off("resetAllFramesCursor",this.#x),t&&this.on("resetAllFramesCursor",this.#x)}#x=()=>{this.transformTree.clear()};#I(e){const t=e?Array.from(this.sceneExtensions.values()).filter(e):this.sceneExtensions.values();for(const s of t){const n=s.getSubscriptions();for(const r of n)switch(r.type){case"schema":this.#C(r.schemaNames,r.subscription);break;case"topic":this.#M(r.topicName,r.subscription);break}}}#D(){this.topicHandlers.clear(),this.schemaHandlers.clear(),this.emit("topicHandlersChanged",this),this.emit("schemaHandlersChanged",this)}#C(e,t){for(const s of e){let n=this.schemaHandlers.get(s);n||(n=[],this.schemaHandlers.set(s,n)),n.push(t)}this.emit("schemaHandlersChanged",this)}#M(e,t){let s=this.topicHandlers.get(e);s||(s=[],this.topicHandlers.set(e,s)),s.push(t),this.emit("topicHandlersChanged",this)}#w=()=>{(0,q.assert)(this.#r,"Image mode extension should be defined when calling enable Image only mode"),this.clear({clearTransforms:!0,resetAllFramesCursor:!0}),this.#D(),this.#I(e=>e===this.#r),this.settings.addNodeValidator(this.#E)};#R=()=>{this.settings.removeNodeValidator(this.#E),this.clear({clearTransforms:!0,resetAllFramesCursor:!0}),this.#D(),this.#I(),this.#A()};#E=(e,t)=>{const{path:s,node:n}=e;s[0]==="topics"&&(n.visible===!0?t.addToTopic(s[1],"IMAGE_ONLY_TOPIC","Camera calibration information is required to display 3D topics"):t.removeFromTopic(s[1],"IMAGE_ONLY_TOPIC"))};addCustomLayerAction(e){const t=e.handler,s=(0,Aa.Z)(),n={type:"action",id:`${e.layerId}-${s}`,label:e.label,icon:e.icon};this.#t.set(e.layerId,{action:n,handler:t}),this.#N()}#N(){this.settings.setNodesForKey(dc,[this.#O(),this.#F()])}#O(){return{path:["topics"],node:{enableVisibilityFilter:!0,label:D.ZP.t("threeDee:topics"),defaultExpansionState:"expanded",actions:[{id:"show-all",type:"action",label:D.ZP.t("threeDee:showAll")},{id:"hide-all",type:"action",label:D.ZP.t("threeDee:hideAll")}],children:this.settings.tree().topics?.children,handler:this.#V}}}#F(){const e=Object.keys(this.config.layers).length;return{path:["layers"],node:{label:`${D.ZP.t("threeDee:customLayers")}${e>0?` (${e})`:""}`,children:this.settings.tree().layers?.children,actions:Array.from(this.#t.values()).map(s=>s.action),handler:this.#W}}}setPickingEnabled(e){this.#h=e,e||this.setSelectedRenderable(void 0)}setColorScheme(e,t){this.colorScheme=e;const s=t?Qi(Gg,t):void 0;for(const n of this.sceneExtensions.values())n.setColorScheme(e,s);e==="dark"?(this.gl.setClearColor(s??ac),this.outlineMaterial.color.set(Ji),this.outlineMaterial.needsUpdate=!0,this.instancedOutlineMaterial.color.set(Ji),this.instancedOutlineMaterial.needsUpdate=!0,this.#l.setColor(ac,.8)):(this.gl.setClearColor(s??rc),this.outlineMaterial.color.set(Xi),this.outlineMaterial.needsUpdate=!0,this.instancedOutlineMaterial.color.set(Xi),this.instancedOutlineMaterial.needsUpdate=!0,this.#l.setColor(rc,.8))}setTopics(e){if(this.topics!==e){this.topics=e,this.topicsByName=e?new Map(e.map(t=>[t.name,t])):void 0,this.emit("topicsChanged",this);for(const t of this.sceneExtensions.values())this.settings.setNodesForKey(t.extensionId,t.settingsNodes())}}setParameters(e){const t=this.parameters!==e;this.parameters=e,t&&this.emit("parametersChange",e,this)}updateCustomLayersCount(){const e=Object.keys(this.config.layers).length,t=`Custom Layers${e>0?` (${e})`:""}`;this.settings.setLabel(["layers"],t)}setCameraState(e){this.cameraHandler.setCameraState(e)}getCameraState(){return this.cameraHandler.getCameraState()}canResetView(){return this.#r?.hasModifiedView()??!1}resetView(){this.#r?.resetViewModifications(),this.queueAnimationFrame()}getCurrentImage(){return this.#r?.getLatestImage()}setSelectedRenderable(e){if(this.#d===e)return;const t=this.#d;t&&($g(t.renderable),ue.debug(`Deselected ${t.renderable.id} (${t.renderable.name})`)),this.#d=e,e&&(jg(e.renderable),ue.debug(`Selected ${e.renderable.id} (${e.renderable.name}) (instance=${e.instanceIndex})`,e.renderable)),this.emit("selectedRenderable",e,this),this.debugPicking||this.animationFrame()}addMessageEvent(e){const{message:t}=e,s=t,n=t,r=t,a=t;if(s.header){const o=s.header.frame_id??"";this.addCoordinateFrame(o)}else if(Array.isArray(n.markers)){for(const o of n.markers)if(o){const l=o.header?.frame_id??"";this.addCoordinateFrame(l)}}else if(Array.isArray(r.entities)){for(const o of r.entities)if(o){const l=o.frame_id??"";this.addCoordinateFrame(l)}}else typeof a.frame_id=="string"&&this.addCoordinateFrame(a.frame_id);uc(e,this.topicHandlers.get(e.topic)),uc(e,this.schemaHandlers.get(e.schemaName))}normalizeFrameId(e){return!this.ros||!e.startsWith("/")?e:e.slice(1)}addCoordinateFrame(e){const t=this.normalizeFrameId(e);this.transformTree.hasFrame(t)||(this.transformTree.getOrCreateFrame(t),this.coordinateFrameList=this.transformTree.frameList(),this.emit("transformTreeUpdated",this))}#P(e){const t=e.parent_frame_id,s=e.child_frame_id,n=(0,M.toNanoSec)(e.timestamp),r=e.translation,a=e.rotation;this.addTransform(t,s,n,r,a)}#_(e){const t=this.normalizeFrameId(e.header.frame_id),s=this.normalizeFrameId(e.child_frame_id),n=(0,M.toNanoSec)(e.header.stamp),r=e.transform.translation,a=e.transform.rotation;this.addTransform(t,s,n,r,a)}addTransform(e,t,s,n,r,a){const o=n,l=r,d=new N.wx([o.x,o.y,o.z],[l.x,l.y,l.z,l.w]),h=this.transformTree.addTransform(t,e,s,d);h===N.ug.UPDATED&&(this.coordinateFrameList=this.transformTree.frameList(),this.emit("transformTreeUpdated",this)),h===N.ug.CYCLE_DETECTED&&(this.settings.errors.add(["transforms",`frame:${t}`],lc,`Transform tree cycle detected: Received transform with parent "${e}" and child "${t}", but "${t}" is already an ancestor of "${e}". Transform message dropped.`),a&&this.settings.errors.add(a,lc,`Attempted to add cyclical transform: Frame "${e}" cannot be the parent of frame "${t}". Transform message dropped.`));const f=this.transformTree.getOrCreateFrame(t);f.transformsSize()===f.maxCapacity&&this.settings.errors.add(["transforms",`frame:${t}`],kg,`[Warning] Transform history is at capacity (${f.maxCapacity}), old TFs will be dropped`)}removeTransform(e,t,s){this.transformTree.removeTransform(e,t,s),this.coordinateFrameList=this.transformTree.frameList(),this.emit("transformTreeUpdated",this)}animationFrame=()=>{this.#m=void 0,this.#u||(this.#U(this.currentTime),this.#u=!1)};queueAnimationFrame(){this.#m==null&&(this.#m=requestAnimationFrame(this.animationFrame))}setFollowFrameId(e){this.followFrameId!==e&&ue.debug(`Setting followFrameId to ${e}`),this.followFrameId=e}async fetchAsset(e,t){return await this.#p(e,t)}#U=e=>{this.#u=!0,this.currentTime=e,this.#Z(),this.#z(),this.#Y(),this.gl.clear(),this.emit("startFrame",e,this);const t=this.cameraHandler.getActiveCamera();t.layers.set(Tr);const s=this.followFrameId&&this.transformTree.frame(this.followFrameId)?this.followFrameId:N.W$.FALLBACK_FRAME_ID,n=this.fixedFrameId??N.W$.FALLBACK_FRAME_ID;for(const r of this.sceneExtensions.values())r.startFrame(e,s,n);this.gl.render(this.#s,t),this.#d&&(this.gl.render(this.#o,t),this.gl.clearDepth(),t.layers.set(Sr),this.gl.render(this.#s,t)),this.emit("endFrame",e,this),this.gl.info.reset()};#z(){const e=this.followFrameId!=null?this.transformTree.frame(this.followFrameId):void 0;if(e==null){this.fixedFrameId=void 0;return}const s=e.root().id;this.fixedFrameId!==s&&(this.fixedFrameId==null?ue.debug(`Setting fixed frame to ${s}`):ue.debug(`Changing fixed frame from "${this.fixedFrameId}" to "${s}"`),this.fixedFrameId=s)}#L=e=>{this.gl.setPixelRatio(window.devicePixelRatio),this.gl.setSize(e.width,e.height),this.cameraHandler.handleResize(e.width,e.height,window.devicePixelRatio);const t=this.gl.getDrawingBufferSize(hc);ue.debug(`Resized renderer to ${t.width}x${t.height}`),this.animationFrame()};#k=e=>{if(!this.#h){this.setSelectedRenderable(void 0);return}if(this.measurementTool.state!=="idle"||this.publishClickTool.state!=="idle")return;this.setSelectedRenderable(void 0);const t=this.cameraHandler.getActiveCamera(),s=[];let n;for(;(n=this.#H(e))&&s.length<zg&&(s.push(n),!this.debugPicking);)n.renderable.visible=!1,this.gl.render(this.#s,t);for(const r of s)r.renderable.visible=!0;this.debugPicking||this.animationFrame(),ue.debug(`Clicked ${s.length} renderable(s)`),this.emit("renderablesClicked",s,e,this)};#G=({message:e})=>{const t=Zr(e);this.#P(t)};#B=({message:e})=>{const t=zc(e);for(const s of t.transforms)this.#P(s)};#j=({message:e})=>{const t=Uc(e);for(const s of t.transforms)this.#_(s)};#$=({message:e})=>{const t=Hr(e);this.#_(t)};#V=e=>{const t=e.payload.path;if(e.action!=="perform-node-action"||t.length!==1||t[0]!=="topics")return;ue.debug(`handleTopicsAction(${e.payload.id})`);const s=n=>{for(const r of this.sceneExtensions.values())for(const a of r.settingsNodes())a.path[0]==="topics"&&r.handleSettingsAction({action:"update",payload:{path:[...a.path,"visible"],input:"boolean",value:n}})};e.payload.id==="show-all"?s(!0):e.payload.id==="hide-all"&&s(!1)};#W=e=>{const t=e.payload.path;if(e.action!=="perform-node-action"||t.length!==1||t[0]!=="layers")return;ue.debug(`handleCustomLayersAction(${e.payload.id})`);const s=e.payload.id,n=s.slice(0,-37),r=s.slice(-36),a=this.#t.get(n);if(!a)throw new Error(`No custom layer action found for "${n}"`);const{label:o,icon:l}=a.action;this.addCustomLayerAction({layerId:n,label:o,icon:l,handler:a.handler}),a.handler(r),this.updateCustomLayersCount()};#H(e){const t=this.#a.pick(e.x,e.y,this.cameraHandler.getActiveCamera(),{debug:this.debugPicking,disableSetViewOffset:this.interfaceMode==="image"});if(t===-1){ue.debug("Picking did not return an object");return}const s=this.#s.getObjectById(t);let n,r=s;for(;r;)r.pickable===!0&&(n=r),r=r.parent??void 0;if(!n){ue.warn(`No Renderable found for objectId ${t} (name="${s?.name}" uuid=${s?.uuid})`);return}ue.debug(`Picking pass returned ${n.id} (${n.name})`,n);let a;return n.pickableInstances&&(a=this.#a.pickInstance(e.x,e.y,this.cameraHandler.getActiveCamera(),n,{debug:this.debugPicking,disableSetViewOffset:this.interfaceMode==="image"}),a=a===-1?void 0:a,ue.debug("Instance picking pass on",n,"returned",a)),{renderable:n,instanceIndex:a}}#Z(){if(this.followFrameId==null){this.settings.errors.add(Ri,oc,D.ZP.t("threeDee:noCoordinateFramesFound"));return}if(this.settings.errors.remove(Ri,oc),!this.transformTree.frame(this.followFrameId)){this.settings.errors.add(Ri,cc,D.ZP.t("threeDee:frameNotFound",{frameId:this.followFrameId}));return}this.settings.errors.remove(Ri,cc)}#Y(){const e=this.input.canvasSize;this.#c.equals(e)||(this.#c.copy(e),this.#s.traverse(t=>{if(t.material){const n=t.material;n.uniforms?.resolution&&(n.uniforms.resolution.value.copy(e),n.uniformsNeedUpdate=!0)}}))}}function uc(i,e){if(e)for(const t of e)t.handler(i)}function jg(i){i.layers.set(Sr),i.traverse(e=>{e.layers.set(Sr)})}function $g(i){i.layers.set(Tr),i.traverse(e=>{e.layers.set(Tr)})}function Vg(i){const e=[];return e.push(i==="image"?"imageMode":"general","scene"),i==="image"&&e.push("imageAnnotations"),i==="3d"&&e.push("cameraState"),e.push("transforms","topics","layers"),i==="3d"&&e.push("publish"),Object.fromEntries(e.map(t=>[t,{}]))}const fc=(0,S.createContext)(void 0);function pc(){return(0,S.useContext)(fc)??void 0}function qt(i,e,t){const s=pc(),n=t??s;(0,S.useEffect)(()=>(n?.addListener(i,e),()=>void n?.removeListener(i,e)),[e,i,n])}var Wg=b(72994),Hg=b(47746),xr=b(87037),mc=b(3925),Ni=b(80078),wr=b(83993),Ir=b(82056),Zg=b(38677),Yg=b(72283),Kg=b(74595),Xg=b(68588),Jg=b(10047),Qg=b(72970),qg=b(78324),Cr=b(15328);function e0(i){return(0,v.jsx)(Cr.Z,{...i,children:(0,v.jsxs)("g",{children:[(0,v.jsx)("circle",{cx:"12.03",cy:"18.5",r:"2"}),(0,v.jsx)("path",{d:"M13.28,13.15V5H17L12,0,7.08,5h3.7v8.2a5.5,5.5,0,1,0,2.5,0ZM12,22a3.5,3.5,0,1,1,3.5-3.5A3.5,3.5,0,0,1,12,22Z"})]})})}function t0(i){return(0,v.jsx)(Cr.Z,{...i,children:(0,v.jsxs)("g",{children:[(0,v.jsx)("circle",{cx:"12",cy:"12",r:"2"}),(0,v.jsx)("path",{d:"M12,17.5A5.5,5.5,0,1,1,17.5,12,5.51,5.51,0,0,1,12,17.5Zm0-9A3.5,3.5,0,1,0,15.5,12,3.5,3.5,0,0,0,12,8.5Z"})]})})}function s0(i){return(0,v.jsx)(Cr.Z,{...i,children:(0,v.jsxs)("g",{children:[(0,v.jsx)("path",{d:"M.23,8.71l7.85,7.41L12,13.29l4,2.83,7.85-7.41S20.8,4,12,4,.23,8.71.23,8.71Z",opacity:"0.2"}),(0,v.jsx)("circle",{cx:"12.03",cy:"18.5",r:"2"}),(0,v.jsx)("path",{d:"M13.28,13.15V5H17L12,0,7.08,5h3.7v8.2a5.5,5.5,0,1,0,2.5,0ZM12,22a3.5,3.5,0,1,1,3.5-3.5A3.5,3.5,0,0,1,12,22Z"}),(0,v.jsx)("path",{d:"M16,16.12,14.6,14.67l1.46-1.37,1.37,1.45Zm2.18-2.06-1.37-1.45,1.45-1.37,1.37,1.45ZM20.34,12,19,10.55l1.45-1.37,1.38,1.45ZM22.52,10,21.15,8.49l1.31-1.24,1.37,1.46Z"}),(0,v.jsx)("path",{d:"M8.08,16.12,6.63,14.75,8,13.3l1.46,1.37ZM5.9,14.06,4.45,12.69l1.37-1.45,1.45,1.37ZM3.72,12,2.27,10.63,3.64,9.18l1.45,1.37ZM1.54,10,.23,8.71,1.6,7.25,2.91,8.49Z"})]})})}var i0=b(84877);function n0(i){const[e,t]=(0,S.useState)(!1),s=(0,S.useCallback)(n=>{i.current&&(n.type==="mouseenter"?t(!0):t(!1))},[i]);return(0,S.useEffect)(()=>{const n=i.current;if(!n)return;const r=n.closest(`.${i0.D}`);return r?.addEventListener("mouseenter",s),r?.addEventListener("mouseleave",s),()=>{r?.removeEventListener("mouseenter",s),r?.removeEventListener("mouseleave",s)}},[i,s]),e}var r0=b(28904),a0=b(55433),o0=b(24957),gc=b(68434),Mr=b(89820),l0=b(39075),c0=b(60012),bc=b(30650),Dr=b(93812),d0=b(84803),h0=b(11701);function Ar(i){return typeof i=="object"&&i&&"toJSON"in i?i.toJSON():i}function u0({interactionData:i,selectedObject:e,timezone:t}){const s=(0,h0.lk)(),n=i?.topic??"",r=Ar(e),a=l0.Z(r,"interactionData");return n.length===0?(0,v.jsx)(Dr.Z,{paddingY:1,children:(0,v.jsx)(bc.ZP,{data:e,shouldExpandNode:(o,l,d)=>d<2,invertTheme:!1,postprocessValue:Ar,theme:{...s,tree:{margin:0}},hideRoot:!0})}):(0,v.jsx)(Dr.Z,{paddingY:1,children:(0,v.jsx)(bc.ZP,{data:a,shouldExpandNode:()=>!1,invertTheme:!1,theme:{...s,tree:{margin:0,whiteSpace:"pre-line"}},hideRoot:!0,getItemString:(o,l,d,h,f)=>(0,d0.D)(o,l,d,h,f,t),postprocessValue:Ar,labelRenderer:(o,l,d,h)=>{const f=c0.Z(o);return(0,v.jsx)("span",{style:{padding:"0 4px 0 0"},children:f})},valueRenderer:o=>(0,v.jsx)("span",{children:o})})})}const yc=u0;var f0=b(69526),p0=b(35109),m0=b(2784);function g0({addPanel:i,topic:e}){const t=m0.useCallback(()=>{i({position:"sibling",type:"RawMessages",updateIfExists:!0,getState:s=>({...s,topicPath:e})})},[i,e]);return(0,v.jsx)(p0.Z,{onClick:t,title:"Open in Raw Message panel",children:(0,v.jsxs)(Dr.Z,{direction:"row",alignItems:"center",justifyContent:"space-between",padding:1,children:[(0,v.jsx)(gc.Z,{variant:"body2",children:e}),(0,v.jsx)(f0.Z,{fontSize:"small",color:"primary"})]})})}var b0=b(2784);const y0="Selected object",v0=b0.memo(function({addPanel:e,selectedObject:t,interactionsTabType:s,setInteractionsTabType:n,timezone:r}){const a=t?.object.interactionData,o=a?.originalMessage,l=a?.instanceDetails;return(0,v.jsx)(Mr.ZP,{tooltip:"Inspect objects",icon:(0,v.jsx)(o0.BaF,{}),selectedTab:s,onSelectTab:d=>{n(d)},children:(0,v.jsx)(Mr.KV,{name:y0,children:(0,v.jsx)(Mr.CW,{children:o?(0,v.jsxs)(v.Fragment,{children:[a.topic&&(0,v.jsx)(g0,{addPanel:e,topic:a.topic}),l?(0,v.jsx)(yc,{selectedObject:l,timezone:r}):(0,v.jsx)(v.Fragment,{}),(0,v.jsx)(yc,{selectedObject:o,interactionData:a,timezone:r})]}):(0,v.jsx)(gc.Z,{variant:"body2",color:"text.disabled",gutterBottom:!0,children:"Click an object in the 3D view to select it."})})})})});function T0(i){return(0,v.jsx)(v0,{...i})}const S0=(i,e)=>{if(i!=null)return i.metadataByIndex?.[e]},x0=i=>i?.instanceIndex!=null&&i.object.metadataByIndex!=null&&S0(i.object,i.instanceIndex)!=null||i?.object;function w0({interactiveObject:i,selectObject:e}){const t=x0(i),s=(0,S.useCallback)(()=>{e(i)},[i,e]);return(0,v.jsx)(Ni.Z,{"data-test":"InteractionContextMenuItem",onClick:s,children:t.interactionData?.topic})}function I0({clickedObjects:i=[],clickedPosition:e={clientX:0,clientY:0},onClose:t,selectObject:s}){return(0,v.jsx)(mc.Z,{open:!0,onClose:t,anchorReference:"anchorPosition",anchorPosition:{top:e.clientY,left:e.clientX},MenuListProps:{dense:!0},children:i.map((n,r)=>(0,v.jsx)(w0,{interactiveObject:n,selectObject:s},r))})}let Ge,Er,Pr,_r,Lr,Rr=0,Nr=0,Or=0,Fr=0;function C0(i){Rr=Math.max(Rr,i.gl.info.render.calls),Nr=Math.max(Nr,i.gl.info.render.triangles),Or=Math.max(Or,i.gl.info.memory.textures),Fr=Math.max(Fr,i.gl.info.memory.geometries),Er?.update(i.gl.info.render.calls,Rr),Pr?.update(i.gl.info.render.triangles,Nr),_r?.update(i.gl.info.memory.textures,Or),Lr?.update(i.gl.info.memory.geometries,Fr),Ge?.update()}function M0(){const[i,e]=(0,S.useState)(null);return qt("endFrame",(t,s)=>{C0(s)}),(0,S.useEffect)(()=>{if(i)return Ge=new D0,Ge.dom.style.position="relative",Ge.dom.style.zIndex="auto",Er=new es("draws","red","black"),Pr=new es("tris","cyan","black"),_r=new es("textures","yellow","black"),Lr=new es("geometries","green","black"),Ge.addPanel(Er),Ge.addPanel(Pr),Ge.addPanel(_r),Ge.addPanel(Lr),i.appendChild(Ge.dom),Ge.showPanel(0),()=>{if(Ge)try{i.removeChild(Ge.dom)}catch{}}},[i]),(0,v.jsx)("div",{ref:e})}class D0{#e=0;#t;dom;#s;#i;#n;#r;constructor(){this.#t=document.createElement("div"),this.#t.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",this.#t.addEventListener("click",e=>{e.preventDefault(),this.showPanel(++this.#e%this.#t.children.length)},!1),this.dom=this.#t,this.#s=performance.now(),this.#i=this.#s,this.#n=this.addPanel(new es("MS","#9480ed","#1e1a2f")),this.#r=this.addPanel(new es("MB","#f08","#201")),this.showPanel(0)}addPanel(e){return this.#t.appendChild(e.dom),e}showPanel(e){for(let t=0;t<this.#t.children.length;t++){const s=this.#t.children[t];s.style.display=t===e?"block":"none"}this.#e=e}begin=()=>{this.#s=performance.now()};end=()=>{const e=performance.now();if(this.#n.update(e-this.#s,1e3/30),e>=this.#i+1e3){this.#i=e;const t=performance.memory;this.#r.update(t.usedJSHeapSize/1048576,t.jsHeapSizeLimit/1048576)}return e};update=()=>{this.#s=this.end()}}class es{dom;#e;#t=1/0;#s=0;#i;#n;#r;constructor(e,t,s){this.#i=e,this.#n=t,this.#r=s;const n=Math.round(window.devicePixelRatio),r=80*n,a=48*n,o=3*n,l=2*n,d=3*n,h=15*n,f=74*n,m=30*n,p=document.createElement("canvas");p.width=r,p.height=a,p.style.cssText="width:80px;height:48px";const g=p.getContext("2d");g.font=`bold ${9*n}px Helvetica,Arial,sans-serif`,g.textBaseline="top",g.fillStyle=s,g.fillRect(0,0,r,a),g.fillStyle=t,g.fillText(e,o,l),g.fillRect(d,h,f,m),g.fillStyle=s,g.globalAlpha=.9,g.fillRect(d,h,f,m),this.dom=p,this.#e=g}update(e,t){const s=Math.round(window.devicePixelRatio),n=80*s,r=3*s,a=2*s,o=3*s,l=15*s,d=74*s,h=30*s;this.#t=Math.min(this.#t,e),this.#s=Math.max(this.#s,e),this.#e.fillStyle=this.#r,this.#e.globalAlpha=1,this.#e.fillRect(0,0,n,l),this.#e.fillStyle=this.#n,this.#e.fillText(`${Math.round(e)} ${this.#i} (${Math.round(this.#t)}-${Math.round(this.#s)})`,r,a),this.#e.drawImage(this.dom,o+s,l,d-s,h,o,l,d-s,h),this.#e.fillRect(o+d-s,l,s,h),this.#e.fillStyle=this.#r,this.#e.globalAlpha=.9,this.#e.fillRect(o+d-s,l,s,Math.round((1-e/t)*h))}}var A0="../../packages/studio-base/src/panels/ThreeDeeRender/RendererOverlay.tsx";const E0=Y.ZP.getLogger(A0),Oi={pose:(0,v.jsx)(e0,{fontSize:"inherit"}),point:(0,v.jsx)(t0,{fontSize:"inherit"}),pose_estimate:(0,v.jsx)(s0,{fontSize:"inherit"})},P0=(0,Qg.ZL)()(i=>({iconButton:{position:"relative",fontSize:"1rem !important",pointerEvents:"auto",aspectRatio:"1","& svg:not(.MuiSvgIcon-root)":{fontSize:"1rem !important"}},rulerIcon:{transform:"rotate(45deg)"},threeDeeButton:{fontFamily:$a.R.MONOSPACE,fontFeatureSettings:i.typography.caption.fontFeatureSettings,fontSize:i.typography.caption.fontSize,fontWeight:i.typography.fontWeightBold,lineHeight:"1em"},resetViewButton:{position:"absolute",bottom:0,right:0,marginBottom:i.spacing(1),marginRight:i.spacing(1)}}));function _0(i){const e=(0,Pe.z)(),{enqueueSnackbar:t}=(0,Kg.Ds)(),{t:s}=(0,Xg.$G)("threeDee"),{classes:n}=P0(),[r,a]=(0,S.useState)({clientX:0,clientY:0}),[o,l]=(0,S.useState)([]),[d,h]=(0,S.useState)(void 0),[f,m]=(0,S.useState)(void 0),p=pc();(0,S.useEffect)(()=>{p&&p.setPickingEnabled(f!=null)},[f,p]),qt("renderablesClicked",(se,fe)=>{const pe=i.canvas.getBoundingClientRect();a({clientX:pe.left+fe.x,clientY:pe.top+fe.y}),l(se),h(se.length===1?se[0]:void 0)});const[g,u]=(0,S.useState)(p?.canResetView()??!1);qt("resetViewChanged",(0,S.useCallback)(()=>{u(p?.canResetView()??!1)},[p]));const x=(0,S.useCallback)(()=>{p?.resetView()},[p]),y=i.enableStats?(0,v.jsx)("div",{id:"stats",style:{position:"absolute",top:"10px",left:"10px"},children:(0,v.jsx)(M0,{})}):void 0,C=(0,S.useMemo)(()=>o.map(se=>({object:{pose:se.renderable.pose,scale:se.renderable.scale,color:void 0,interactionData:{topic:se.renderable.name,highlighted:void 0,renderable:se.renderable}},instanceIndex:se.instanceIndex})),[o]),T=(0,S.useMemo)(()=>d?{object:{pose:d.renderable.pose,interactionData:{topic:d.renderable.topic,highlighted:!0,originalMessage:d.renderable.details(),instanceDetails:d.instanceIndex!=null?d.renderable.instanceDetails(d.instanceIndex):void 0}},instanceIndex:d.instanceIndex}:void 0,[d]);(0,S.useEffect)(()=>{p?.setSelectedRenderable(d)},[p,d]);const I=(0,S.useRef)(null),[_,P]=(0,S.useState)(!1),L=Oi[i.publishClickType],G=(0,S.useCallback)(()=>{P(!0)},[]),Z=(0,Jg.Z)(G),Te=(0,Hg.Z)(),Ke=i.interfaceMode==="3d"&&i.canPublish&&p?.fixedFrameId!=null&&(0,v.jsxs)(v.Fragment,{children:[(0,v.jsxs)(xr.Z,{...Z,color:i.publishActive?"info":"inherit",title:i.publishActive?"Click to cancel":"Click to publish",ref:I,onClick:i.onClickPublish,"data-testid":"publish-button",style:{fontSize:"1rem",pointerEvents:"auto"},children:[L,(0,v.jsx)("div",{style:{borderBottom:"6px solid currentColor",borderRight:"6px solid transparent",bottom:0,left:0,height:0,width:0,margin:Te.spacing(.25),position:"absolute"}})]}),(0,v.jsxs)(mc.Z,{id:"publish-menu",anchorEl:I.current,anchorOrigin:{vertical:"top",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"right"},open:_,onClose:()=>{P(!1)},MenuListProps:{dense:!0},children:[(0,v.jsxs)(Ni.Z,{selected:i.publishClickType==="pose_estimate",onClick:()=>{i.onChangePublishClickType("pose_estimate"),P(!1)},children:[(0,v.jsx)(wr.Z,{children:Oi.pose_estimate}),(0,v.jsx)(Ir.Z,{disableTypography:!0,children:"Publish pose estimate"})]}),(0,v.jsxs)(Ni.Z,{selected:i.publishClickType==="pose",onClick:()=>{i.onChangePublishClickType("pose"),P(!1)},children:[(0,v.jsx)(wr.Z,{children:Oi.pose}),(0,v.jsx)(Ir.Z,{disableTypography:!0,children:"Publish pose"})]}),(0,v.jsxs)(Ni.Z,{selected:i.publishClickType==="point",onClick:()=>{i.onChangePublishClickType("point"),P(!1)},children:[(0,v.jsx)(wr.Z,{children:Oi.point}),(0,v.jsx)(Ir.Z,{disableTypography:!0,children:"Publish point"})]})]})]}),Ur=g&&(0,v.jsx)(Zg.Z,{className:n.resetViewButton,variant:"contained",color:"secondary",onClick:x,"data-testid":"reset-view",children:s("resetView")}),{onDownloadImage:ss}=i,Fs=(0,S.useCallback)(async()=>{const se=p?.getCurrentImage();if(!se)return;const{topic:fe,image:pe,rotation:Rt,flipHorizontal:Us,flipVertical:zi}=se,Nt="header"in pe?pe.header.stamp:pe.timestamp;let Be;try{if("format"in pe)Be=await sa(pe);else{const ns=new ImageData(pe.width,pe.height);td(pe,se,ns.data),Be=await createImageBitmap(ns)}const Tt=Rt===90||Rt===270?Be.height:Be.width,zs=Rt===90||Rt===270?Be.width:Be.height,is=document.createElement("canvas");is.width=Tt,is.height=zs;const St=is.getContext("2d");if(!St)throw new Error("Unable to create rendering context for image download");St.translate(Tt/2,zs/2),St.scale(Us?-1:1,zi?-1:1),St.rotate(Rt/180*Math.PI),St.translate(-Be.width/2,-Be.height/2),St.drawImage(Be,0,0);const ks=await new Promise((ns,rs)=>{is.toBlob(js=>{js?ns(js):rs(`Failed to create an image from ${Tt}x${zs} canvas`)},"image/png")}),Bs=`${fe.replace(/^\/+/,"")}-${Nt.sec}-${Nt.nsec}`;e.logEvent(r0.q.IMAGE_DOWNLOAD),ss?ss(ks,Bs):(0,a0.G)([{blob:ks,fileName:Bs}])}catch(Tt){E0.error(Tt),t(Tt.toString(),{variant:"error"})}},[p,ss,t,e]),ct=(0,S.useCallback)(()=>[{type:"item",label:"Download image",onclick:Fs,disabled:p?.getCurrentImage()==null}],[Fs,p]),Fi=(0,S.useRef)(null),Ui=n0(Fi);return(0,v.jsxs)(v.Fragment,{children:[i.interfaceMode==="image"&&(0,v.jsx)(qg.i,{getItems:ct}),(0,v.jsxs)("div",{ref:Fi,style:{position:"absolute",top:"10px",right:"10px",display:"flex",flexDirection:"column",alignItems:"flex-end",gap:10,pointerEvents:"none"},children:[(i.interfaceMode==="3d"||Ui)&&(0,v.jsx)(T0,{addPanel:i.addPanel,selectedObject:T,interactionsTabType:f,setInteractionsTabType:m,timezone:i.timezone}),i.interfaceMode==="3d"&&(0,v.jsxs)(Yg.Z,{square:!1,elevation:4,style:{display:"flex",flexDirection:"column"},children:[(0,v.jsx)(xr.Z,{className:n.iconButton,color:i.perspective?"info":"inherit",title:i.perspective?"Switch to 2D camera":"Switch to 3D camera",onClick:i.onTogglePerspective,children:(0,v.jsx)("span",{className:n.threeDeeButton,children:"3D"})}),(0,v.jsx)(xr.Z,{"data-testid":"measure-button",className:n.iconButton,color:i.measureActive?"info":"inherit",title:i.measureActive?"Cancel measuring":"Measure distance",onClick:i.onClickMeasure,children:(0,v.jsx)(Wg.ZHY,{className:n.rulerIcon})}),Ke]})]}),C.length>1&&!T&&(0,v.jsx)(I0,{onClose:()=>{l([])},clickedPosition:r,clickedObjects:C,selectObject:se=>{if(se){const fe=se.object.interactionData.renderable,pe=se.instanceIndex;l([]),h({renderable:fe,instanceIndex:pe})}}}),y,Ur]})}var vc=b(38215);const L0=new Map(["geometry_msgs/Point","geometry_msgs/PointStamped","geometry_msgs/Pose","geometry_msgs/PoseStamped","geometry_msgs/PoseWithCovariance","geometry_msgs/PoseWithCovarianceStamped","geometry_msgs/Quaternion","std_msgs/Header"].map(i=>[i,vc.ros1[i]])),R0=new Map(["geometry_msgs/Point","geometry_msgs/PointStamped","geometry_msgs/Pose","geometry_msgs/PoseStamped","geometry_msgs/PoseWithCovariance","geometry_msgs/PoseWithCovarianceStamped","geometry_msgs/Quaternion","std_msgs/Header"].map(i=>[i,vc.ros2galactic[i]]));function N0(i,e){return{header:{stamp:(0,M.fromDate)(new Date),frame_id:e},point:{x:i.x,y:i.y,z:0}}}function O0(i,e){return{header:{stamp:(0,M.fromDate)(new Date),frame_id:e},pose:i}}function F0(i,e,t,s,n){return{header:{stamp:(0,M.fromDate)(new Date),frame_id:e},pose:{covariance:eg(t,s,n),pose:i}}}var U0="../../packages/studio-base/src/panels/ThreeDeeRender/ThreeDeeRender.tsx";const Os=Y.ZP.getLogger(U0),z0={width:"100%",height:"100%",display:"flex",position:"relative"};function Tc(i,e,t,s){const[n,r]=(0,S.useState)(()=>i?.[e]??s());return(0,S.useEffect)(()=>{if(!i)return;const a=()=>{r(()=>i[e])};return a(),i.addListener(t,a),()=>{i.removeListener(t,a)}},[i,t,e]),n}function k0(i){const{context:e,interfaceMode:t,onDownloadImage:s,debugPicking:n}=i,{initialState:r,saveState:a,unstable_fetchAsset:o}=e,[l,d]=(0,S.useState)(()=>{const w=r,$=Ce.Z(ae.Z(Wt.d),w?.cameraState),U=Ce.Z(ae.Z(_l.B),w?.publish),ie=w?.transforms??{};return{cameraState:$,followMode:w?.followMode??"follow-pose",followTf:w?.followTf,scene:w?.scene??{},transforms:ie,topics:w?.topics??{},layers:w?.layers??{},publish:U,imageMode:w?.imageMode??{}}}),h=(0,je.Z)(l),{cameraState:f}=l,m=l.scene.backgroundColor,[p,g]=(0,S.useState)(null),[u,x]=(0,S.useState)(void 0),y=(0,S.useRef)(void 0);(0,S.useEffect)(()=>{const w=p?new Bg({canvas:p,config:h.current,interfaceMode:t,fetchAsset:o,debugPicking:n}):void 0;return x(w),y.current=w,()=>{y.current?.dispose(),y.current=void 0}},[p,h,l.scene.transforms?.enablePreloading,t,o,n]),(0,S.useEffect)(()=>{e.EXPERIMENTAL_setMessagePathDropConfig({getDropStatus(w){return t!=="image"?{canDrop:!1}:!w.isTopic||w.rootSchemaName==null?{canDrop:!1}:ii.has(w.rootSchemaName)?{canDrop:!0,effect:"replace"}:Mn.has(w.rootSchemaName)?{canDrop:!0,effect:"add"}:{canDrop:!1}},handleDrop(w){d($=>(0,re.Uy)($,U=>{w.rootSchemaName!=null&&(ii.has(w.rootSchemaName)?U.imageMode.imageTopic=w.path:(U.imageMode.annotations??={},U.imageMode.annotations[w.path]??={},U.imageMode.annotations[w.path].visible=!0))}))}})},[e,t]);const[C,T]=(0,S.useState)(),[I,_]=(0,S.useState)(),[P,L]=(0,S.useState)(),[G,Z]=(0,S.useState)(),[Te,ts]=(0,S.useState)(),[Ke,Ur]=(0,S.useState)(),[ss,Fs]=(0,S.useState)(!1),[ct,Fi]=(0,S.useState)(),[Ui,se]=(0,S.useState)(void 0),fe=(0,S.useRef)({needsRender:!1}),[pe,Rt]=(0,S.useState)(),Us=Tc(u,"schemaHandlers","schemaHandlersChanged",()=>new Map),zi=Tc(u,"topicHandlers","topicHandlersChanged",()=>new Map);(0,S.useEffect)(()=>{const w=()=>{if(u){const $=u.getCameraState();if(!$)return;u.setCameraState($),d(U=>({...U,cameraState:$})),l.scene.syncCamera===!0&&e.setSharedPanelState({cameraState:$,followMode:l.followMode,followTf:u.followFrameId})}};return u?.addListener("cameraMove",w),()=>void u?.removeListener("cameraMove",w)},[l.scene.syncCamera,l.followMode,e,u?.followFrameId,u]);const Nt=(0,S.useCallback)(w=>{Ee.unstable_batchedUpdates(()=>{if(u){const $=u.getCameraState();u.settings.handleAction(w);const U=u.getCameraState();U!==$&&l.scene.syncCamera===!0&&e.setSharedPanelState({cameraState:U,followMode:l.followMode,followTf:u.followFrameId})}})},[l.followMode,l.scene.syncCamera,e,u]),[Be,Tt]=(0,S.useState)(void 0),zs=(0,S.useCallback)(w=>{Tt(w.settings.tree())},[]);qt("settingsTreeChange",zs,u);const is=(0,S.useCallback)(w=>{d(w.config)},[]);qt("configChange",is,u);const St=(0,S.useCallback)(w=>{const $=w?.renderable.idFromMessage(),U=w?.renderable.selectedIdVariable();U&&e.setVariable(U,$),e.setVariable(Wi,$)},[e]);qt("selectedRenderable",St,u),(0,S.useEffect)(()=>{e.updatePanelSettingsEditor({actionHandler:Nt,enableFilter:!0,nodes:Be??{}})},[Nt,e,Be]),(0,S.useEffect)(()=>{u&&(u.config=l,fe.current.needsRender=!0)},[l,u]),(0,S.useEffect)(()=>{u&&(u.setTopics(P),fe.current.needsRender=!0)},[P,u]),(0,S.useEffect)(()=>{u&&(u.ros=e.dataSourceProfile==="ros1"||e.dataSourceProfile==="ros2")},[e.dataSourceProfile,u]);const ks=(0,O.y1)(w=>{a(w)},1e3,{leading:!1,trailing:!0,maxWait:1e3});(0,S.useEffect)(()=>ks(l),[l,ks]),(0,S.useEffect)(()=>{t==="image"&&e.setDefaultPanelTitle(l.imageMode.imageTopic)},[t,e,l.imageMode.imageTopic]),(0,S.useLayoutEffect)(()=>{e.onRender=(w,$)=>{Ee.unstable_batchedUpdates(()=>{if(w.currentTime&&Ur(w.currentTime),w.didSeek===!0&&Fs(!0),Rt(()=>$),T(w.colorScheme),w.appSettings){const U=w.appSettings.get(me.o.TIMEZONE);_(typeof U=="string"?U:void 0)}L(w.topics),Fi(w.sharedPanelState),Z(w.parameters),Sc(w.currentFrame),ts(w.currentFrame),Sc(w.allFrames),se(w.allFrames)})},e.watch("allFrames"),e.watch("colorScheme"),e.watch("currentFrame"),e.watch("currentTime"),e.watch("didSeek"),e.watch("parameters"),e.watch("sharedPanelState"),e.watch("topics"),e.watch("appSettings"),e.subscribeAppSettings([me.o.TIMEZONE])},[e,u]);const[Gs,Bs]=(0,S.useState)(void 0);(0,S.useEffect)(()=>{if(!P){Bs(void 0);return}const w=[],$=(U,ie,xt)=>{let Ae=ie.shouldSubscribe?.(U.name);Ae==null&&(l.topics[U.name]?.visible===!0||l.imageMode.annotations?.[U.name]?.visible===!0?Ae=!0:Ae=!1),Ae&&w.push({topic:U.name,preload:ie.preload,convertTo:xt})};for(const U of P){for(const ie of zi.get(U.name)??[])$(U,ie);for(const ie of Us.get(U.schemaName)??[])$(U,ie);for(const ie of U.convertibleTo??[])for(const xt of Us.get(ie)??[])$(U,xt,ie)}w.sort((U,ie)=>U.topic.localeCompare(ie.topic)),Bs(U=>H.Z(U,w)?U:w)},[P,l.topics,l.imageMode.calibrationTopic,l.imageMode.imageTopic,Us,zi,l.imageMode.annotations,l.layers]),(0,S.useEffect)(()=>{Gs&&(Os.debug(`Subscribing to [${Gs.map(w=>JSON.stringify(w)).join(", ")}]`),e.subscribe(Gs))},[e,Gs]),(0,S.useEffect)(()=>{u&&u.setParameters(G)},[G,u]),(0,S.useEffect)(()=>{const w=Ke?(0,M.toNanoSec)(Ke):void 0;if(!u||w==null)return;const $=u.currentTime;u.setCurrentTime(w),ss&&(u.handleSeek($),Fs(!1))},[Ke,u,ss]),(0,S.useEffect)(()=>{C&&u&&(u.setColorScheme(C,m),fe.current.needsRender=!0)},[m,C,u]),(0,S.useEffect)(()=>{if(!u||!Ke)return;u.handleAllFramesMessages(Ui)&&(fe.current.needsRender=!0)},[u,Ke,Ui]),(0,S.useEffect)(()=>{if(!(!u||!Te)){for(const w of Te)u.addMessageEvent(w);fe.current.needsRender=!0}},[Te,u]),(0,S.useEffect)(()=>{H.Z(f,u?.getCameraState())||(u?.setCameraState(f),fe.current.needsRender=!0)},[f,u]),(0,S.useEffect)(()=>{if(!(!u||ct==null||l.scene.syncCamera!==!0))if(ct.followMode!==l.followMode)u.setCameraSyncError(`Follow mode must be ${ct.followMode} to sync camera.`);else if(ct.followTf!==u.followFrameId)u.setCameraSyncError(`Display frame must be ${ct.followTf} to sync camera.`);else{const w=ct.cameraState;u.setCameraState(w),fe.current.needsRender=!0,d($=>({...$,cameraState:w})),u.setCameraSyncError(void 0)}},[l.scene.syncCamera,l.followMode,u,u?.followFrameId,ct]),(0,S.useEffect)(()=>{u&&fe.current.needsRender&&(u.animationFrame(),fe.current.needsRender=!1)}),(0,S.useEffect)(()=>{pe?.()},[pe]);const ns=(0,S.useCallback)(w=>{e.layout.addPanel(w)},[e.layout]),[rs,js]=(0,S.useState)(!1);(0,S.useEffect)(()=>{const w=()=>{js(!0)},$=()=>{js(!1)};return u?.measurementTool.addEventListener("foxglove.measure-start",w),u?.measurementTool.addEventListener("foxglove.measure-end",$),()=>{u?.measurementTool.removeEventListener("foxglove.measure-start",w),u?.measurementTool.removeEventListener("foxglove.measure-end",$)}},[u?.measurementTool]);const $0=(0,S.useCallback)(()=>{rs?u?.measurementTool.stopMeasuring():(u?.measurementTool.startMeasuring(),u?.publishClickTool.stop())},[rs,u]),[ki,wc]=(0,S.useState)(!1);(0,S.useEffect)(()=>{u?.publishClickTool.publishClickType!==l.publish.type&&(u?.publishClickTool.setPublishClickType(l.publish.type),u?.publishClickTool.stop())},[l.publish.type,u]);const Xe=(0,S.useMemo)(()=>({goal:l.publish.poseTopic,point:l.publish.pointTopic,pose:l.publish.poseEstimateTopic}),[l.publish.poseTopic,l.publish.pointTopic,l.publish.poseEstimateTopic]);(0,S.useEffect)(()=>{const w=e.dataSourceProfile==="ros2"?R0:L0;return e.advertise?.(Xe.goal,"geometry_msgs/PoseStamped",{datatypes:w}),e.advertise?.(Xe.point,"geometry_msgs/PointStamped",{datatypes:w}),e.advertise?.(Xe.pose,"geometry_msgs/PoseWithCovarianceStamped",{datatypes:w}),()=>{e.unadvertise?.(Xe.goal),e.unadvertise?.(Xe.point),e.unadvertise?.(Xe.pose)}},[Xe,e,e.dataSourceProfile]);const Gi=(0,je.Z)(l.publish);(0,S.useEffect)(()=>{const w=()=>{wc(!0)},$=ie=>{const xt=u?.followFrameId;if(xt==null){Os.warn("Unable to publish, renderFrameId is not set");return}if(!e.publish){Os.error("Data source does not support publishing");return}if(e.dataSourceProfile!=="ros1"&&e.dataSourceProfile!=="ros2"){Os.warn("Publishing is only supported in ros1 and ros2");return}try{switch(ie.publishClickType){case"point":{const Ae=N0(ie.point,xt);e.publish(Xe.point,Ae);break}case"pose":{const Ae=O0(ie.pose,xt);e.publish(Xe.goal,Ae);break}case"pose_estimate":{const Ae=F0(ie.pose,xt,Gi.current.poseEstimateXDeviation,Gi.current.poseEstimateYDeviation,Gi.current.poseEstimateThetaDeviation);e.publish(Xe.pose,Ae);break}}}catch(Ae){Os.info(Ae)}},U=()=>{wc(!1)};return u?.publishClickTool.addEventListener("foxglove.publish-start",w),u?.publishClickTool.addEventListener("foxglove.publish-submit",$),u?.publishClickTool.addEventListener("foxglove.publish-end",U),()=>{u?.publishClickTool.removeEventListener("foxglove.publish-start",w),u?.publishClickTool.removeEventListener("foxglove.publish-submit",$),u?.publishClickTool.removeEventListener("foxglove.publish-end",U)}},[e,Gi,Xe,u?.followFrameId,u?.publishClickTool]);const V0=(0,S.useCallback)(()=>{ki?u?.publishClickTool.stop():(u?.publishClickTool.start(),u?.measurementTool.stopMeasuring())},[ki,u]),zr=(0,S.useCallback)(()=>{const w=u?.getCameraState()?.perspective??!1;Nt({action:"update",payload:{input:"boolean",path:["cameraState","perspective"],value:!w}})},[Nt,u]),W0=(0,S.useCallback)(w=>{w.key==="3"&&(zr(),w.stopPropagation(),w.preventDefault())},[zr]),H0=e.dataSourceProfile==="ros1"||e.dataSourceProfile==="ros2",Z0=e.publish!=null&&H0;return(0,v.jsx)(Fd.Z,{isDark:C==="dark",children:(0,v.jsxs)("div",{style:z0,onKeyDown:W0,children:[(0,v.jsx)("canvas",{ref:g,style:{position:"absolute",top:0,left:0,...(rs||ki)&&{cursor:"crosshair"}}}),(0,v.jsx)(fc.Provider,{value:u,children:(0,v.jsx)(_0,{interfaceMode:t,canvas:p,addPanel:ns,enableStats:l.scene.enableStats??!1,perspective:l.cameraState.perspective,onTogglePerspective:zr,measureActive:rs,onClickMeasure:$0,canPublish:Z0,publishActive:ki,onClickPublish:V0,publishClickType:u?.publishClickTool.publishClickType??"point",onChangePublishClickType:w=>{u?.publishClickTool.setPublishClickType(w),u?.publishClickTool.start()},timezone:I,onDownloadImage:s})})]})})}function Sc(i){if(i)for(const e of i){const t=e.message;"toJSON"in t&&(e.message=t.toJSON())}}function G0(i,e){const{crash:t,forwardedAnalytics:s,interfaceMode:n,onDownloadImage:r,debugPicking:a}=i;return Ee.render((0,v.jsx)(S.StrictMode,{children:(0,v.jsx)(Se.o,{onError:t,children:(0,v.jsx)(It,{forwardedAnalytics:s,children:(0,v.jsx)(k0,{context:e,interfaceMode:n,onDownloadImage:r,debugPicking:a})})})}),e.panelElement),()=>{Ee.unmountComponentAtNode(e.panelElement)}}function xc(i,e){const t=(0,st.iY)(),s=wt(),n=(0,S.useMemo)(()=>G0.bind(void 0,{crash:t,forwardedAnalytics:s,interfaceMode:i,onDownloadImage:e.onDownloadImage,debugPicking:e.debugPicking}),[t,s,i,e.onDownloadImage,e.debugPicking]);return(0,v.jsx)(Qe._,{config:e.config,highestSupportedConfigVersion:1,saveConfig:e.saveConfig,initPanel:n})}const B0=(0,_e.Z)(Object.assign(xc.bind(void 0,"image"),{panelType:"Image",defaultConfig:{}})),j0=(0,_e.Z)(Object.assign(xc.bind(void 0,"3d"),{panelType:"3D",defaultConfig:{}}))},84803:($s,Je,b)=>{b.d(Je,{D:()=>Qe});var v=b(52322),S=b(1547),Ee=b(8220),st=b(60351),Se=b(59635),xe=b(96995);const it=new xe._fP,Pe=new xe.USm;function wt(ae,H,je,O){return it.set(ae,H,je,O),Pe.setFromQuaternion(it,"XYZ"),[xe.M8C.radToDeg(Pe.x),xe.M8C.radToDeg(Pe.y),xe.M8C.radToDeg(Pe.z)]}const It=20*365*24*60*60,_e=["string","number","bigint","boolean"];function Qe(ae,H,je,O,Y,M){if(typeof H!="object"||H==null)return(0,v.jsxs)("span",{children:[je," ",O]});const me=Object.keys(H);if(me.length===2){const{sec:z,nsec:k}=H;if(typeof z=="number"&&typeof k=="number")return z<It?(0,Se.LU)({sec:z,nsec:k}):(0,v.jsx)("span",{children:(0,Se.WU)({sec:z,nsec:k},M)})}if(me.length===2){const{x:z,y:k}=H;if(typeof z=="number"&&typeof k=="number"){const qe=Math.sqrt(z*z+k*k);return(0,v.jsxs)("span",{children:["norm = ",qe.toFixed(2)," ",re(z,k)]})}const{key:Q,value:$e}=H;if(Q!=null&&$e!=null&&_e.includes(typeof Q)&&_e.includes(typeof $e))return`${Q}: ${$e}`}else if(me.length===3){const{x:z,y:k,z:Q}=H;if(typeof z=="number"&&typeof k=="number"&&typeof Q=="number"){const $e=Math.sqrt(z*z+k*k+Q*Q);return(0,v.jsxs)("span",{children:["norm = ",$e.toFixed(2)," ",Q===0?re(z,k):void 0]})}}else if(me.length===4){const{x:z,y:k,z:Q,w:$e}=H;if(typeof z=="number"&&typeof k=="number"&&typeof Q=="number"&&typeof $e=="number"){const[Bi,ji,$i]=wt(z,k,Q,$e);return(0,v.jsxs)("span",{children:["rpy = [",Ce(Bi),", ",Ce(ji),", ",Ce($i),"]"]})}const{r:qe,g:Ot,b:ge,a:nt}=H;if(typeof qe=="number"&&typeof Ot=="number"&&typeof ge=="number"&&typeof nt=="number")return(0,v.jsx)("span",{children:(0,S.Z)({r:qe*255,g:Ot*255,b:ge*255,a:nt}).toHex8String()})}const c=(0,Ee.Z)(me,z=>{const k=H[z];if((0,st.Q)(z)&&(k==null||_e.includes(typeof k)))return`${z}: ${k}`}).join(", ");return(0,v.jsxs)("span",{children:[je," ",c.length>0?c:O]})}function re(ae,H){if(!(ae===0&&H===0))return(0,v.jsx)("span",{style:{transform:`rotate(${Math.atan2(-H,ae)}rad)`,display:"inline-block"},children:"\u2192"})}function Ce(ae,H=2){return Number(ae.toFixed(H))}}}]);

//# sourceMappingURL=4248.25ae92b6dc5042bf2af2.js.map